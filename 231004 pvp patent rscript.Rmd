---
title: "230618 patent pvp rscript"
output: html_document
date: "2023-06-18"
---
# libraries
```{r  }
require(tidyverse)

```

# get patent data
```{r }
require(patentsview)
```

## test patent function
```{r }

```

### with patents and all endpoints

#### first get patents; as of 23/06/18, pto.gov seems to limit returned data from patents endpoint; need to use all endpoints "patents", "inventors", "assignees", "locations", "cpc_subsections", "uspc_mainclasses", or "nber_subcategories".
 
```{r }

cornfields <-  c("assignee_organization", "appcit_app_number", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type", "citedby_patent_number" ,"citedby_patent_title","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_sequence", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_average_processing_time" ,"patent_processing_time", "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

cornquery <-   (search_pv(
    query =  paste0(
        '{"_and":[
          {"_eq":{"patent_year":"', "2021",'"}},
          {"_or":[
            {"_text_all":{"patent_title":"', "corn", '"}} 
          ]}

          
  ]}'
    ),
    endpoint = "patents" , 
    fields = cornfields, 
    all_pages = TRUE, 
  method = "POST"
))$data$patents %>% unnest()
# Create a field list
```

#### second  get assignee
```{R }

cornquery2 <-   (search_pv(
    query =  paste0(
      
              '{"_eq":{"patent_number":"',10165744,'"}}' 
 
    ),
    endpoint = "assignees" , 
    fields = c("assignee_organization",   "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract",      "cpc_category"  , "cpc_group_title", "cpc_group_id",  "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,     "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$assignees%>% unnest()
```
#### third  get inventor
```{R }

cornquery3 <-   (search_pv(
    query =  paste0(
     
             '{"_eq":{"patent_number":"',10165744,'"}}' 

    ),
    endpoint = "inventors" , 
    fields =c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type",  "cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$inventors%>% unnest( "patents")
```

#### fourth locations
```{R }

cornquery4 <-   (search_pv(
    query =  paste0(
     
             '{"_eq":{"patent_number":"',10165744,'"}}' 

    ),
    endpoint = "cpc_subsections" , 
    fields =  c("assignee_organization", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,   "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$cpc_subsections%>% unnest( "patents")

cornquery4 %>% gather(key = measure, value = value, -patent_number) %>% View()

```

```{r }
cornquery_bind <- bind_rows(
  cornquery,cornquery2, cornquery3, cornquery4
)  %>% gather(key = measure, value = value, -patent_number) %>% distinct() %>% 
  filter(
    !value  %in% c("NANA", NULL, NA ,"NULL", "NA")
  )

```

<!-- #### fifth uspc_mainclasses -->
<!-- ```{R } -->

<!-- cornquery5 <-   (search_pv( -->
<!--     query =  paste0( -->

<!--              '{"_eq":{"patent_number":"',10165744,'"}}'  -->

<!--     ), -->
<!--     endpoint = "nber_subcategories" ,  -->
<!--     # fields =  c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ), -->
<!--     all_pages = TRUE,  -->
<!--   method = "POST" -->
<!-- ))$data$nber_subcategories%>% unnest( "patents") -->
<!-- ``` -->

## start loops
```{r}



dates <- tibble( 
  startdate = 
    seq(as.Date('1970-01-01'), as.Date('2022-01-01'), by = 'years') ) %>% 
  mutate(
    enddate = lead(startdate)
  ) %>% 
  filter(
    !is.na(enddate)
  )


```

```{r }
actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  require(tm)
  str_squish(stripWhitespace(actual_punc_rem(tolower(x))))
}

```

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)

# https://docs.ropensci.org/patentsview/articles/writing-queries.html


veglist <- jsonlite::fromJSON(
  "https://raw.githubusercontent.com/dariusk/corpora/master/data/foods/vegetables.json"
)[[2]]

fruitlist <-  jsonlite::fromJSON(
  "https://raw.githubusercontent.com/amitbet/fruits/master/fruit.json"
)[[2]]

selectnasscroplist <- readxl::read_excel(
  "//jna_nol/asus/msi/work/farmer welfare/nass/220619 select nass vars.xlsx"
)

croplist <- bind_rows(
  tibble(
    crop = veglist
  ),
  tibble(
    crop = fruitlist
  ), 
  tibble(
    crop = selectnasscroplist$shortname
  )
) %>% 
  distinct()

```


### callpatents function 6/17 
```{r }
func_callpatentviewr_2 <- function(currentcrop = croplist, numlist = c(1970:2022), savefolder, numworker = 90, savefileoutfunc) {
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
require(future.callr)
plan(callr)
  require(patentsview)
  plan("callr", workers =numworker)

actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  str_squish(tm::stripWhitespace(actual_punc_rem(tolower(x))))
}

numworker = 90
currentcrop = "corn"
currentcrop = c(croplist$crop , "soybean", "soy", "dicamba", "glyphosat", "glufosinate", "soybean cyst nematode", "soy")
numlist = c(1970:2022)


plan("callr", workers =numworker)


fieldsinterest_patents = c("assignee_organization", "appcit_app_number", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type", "citedby_patent_number" ,"citedby_patent_title","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_sequence", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_average_processing_time" ,"patent_processing_time", "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_cpc_subsections = c("assignee_organization", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,   "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_cpc_subsections_detail = c("cpc_subgroups", "assignees" , "inventors" ,"applications" ,  "nbers", "gov_interests", "lawyers", "examiners")

fieldsinterest_inventors= c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type",  "cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_inventors_detail = c("assignees" ,"applications" , "cpcs", "nbers", "gov_interests", "lawyers", "examiners")


 fieldsinterest_assignees = c("assignee_organization",   "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract",      "cpc_category"  , "cpc_group_title", "cpc_group_id",  "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,     "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )
fieldsinterest_assignees_detail = c("inventors" ,"applications" , "cpcs", "nbers", "gov_interests", "lawyers", "examiners")

 
savefolder = "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/output patents/230618_output"
savefileoutfunc = "230619_saveall"
fieldsinterest_vec <-   c("cpc_subsections", "inventors", "assignees")
fieldsinterest_list <- list(
 fieldsinterest_cpc_subsections, fieldsinterest_inventors,  fieldsinterest_assignees
)  
 fieldsinterest_list_detail <- list(
   fieldsinterest_cpc_subsections_detail, 
   fieldsinterest_inventors_detail, 
   fieldsinterest_assignees_detail
 )

if(!exists(savefolder))
{
  dir.create(savefolder)
}

    process_file_patents <- function( currentk, fieldsinterest_send_safe = fieldsinterest_patents, endpointtype= "patents", saveoutfolder, saveoutfile) {
      
  #     currentk =  (called_df_patent %>%
  # filter(K == 2021))$current_query_title %>% paste(collapse = "")
  #     endpointtype = "patents"
  #    fieldsinterest_send_safe = fieldsinterest_patents
      
  saveoutfile_string = paste0(
    saveoutfile, "_", 
    as.numeric(gsub("\\D", "", currentk)), "_",
    cleantext_text(
      gsub(
  ".*patent_title|.*patent_abstract", "" , currentk
  )
    )
     
  )
  
      
searchedpv_df <-patentsview::search_pv(
        query = currentk ,
        endpoint = endpointtype, 
        fields = fieldsinterest_send_safe, 
        all_pages = TRUE, 
        method = "POST"
      )
# Sys.sleep(.2)

if(endpointtype== "patents")
{
  outputdf <- searchedpv_df$data$patents 
}
# if(endpointtype== "assignees")
# {
#   outputdf <- searchedpv_df$data$assignees%>% unnest("patents" ) 
# }
# if(endpointtype== "inventors")
# {
#   outputdf <- searchedpv_df$data$inventors%>% unnest( "patents")
# }
# if(endpointtype=="cpc_subsections" )
# {
#   outputdf <- searchedpv_df$data$cpc_subsections%>% unnest( "patents")
# }
 write_rds(
   outputdf,
   paste0(
  saveoutfolder, "/", endpointtype,saveoutfile_string,  ".Rds"
  )
 )


outputdf
# searchedpv_df
}
safer_process_file_patent  <- possibly(process_file_patents, otherwise = NULL)
  


    process_file_patentsnum_LU <- function( currentk, fieldsinterest_send_safe = fieldsinterest_patents, endpointtype= "patents", saveoutfolder, saveoutfile) {
      
    #   currentk =  (called_df_patent_title_ul_distinctnum %>% 
    # mutate(
    #     patentnumquery = #"3931757"
    #   paste0('{"_eq":{"patent_number":"', "3931757",'"}}' )
    # ) )$patentnumquery[1]
    #   endpointtype = "assignees"
    #  fieldsinterest_send_safe = current_fieldinterest_list
      
  saveoutfile_string = paste0(
    cleantext_text(gsub(".*number","",  currentk))
     
  )
  
      
searchedpv_df <-patentsview::search_pv(
        query = currentk ,
        endpoint = endpointtype, 
        fields = fieldsinterest_send_safe, 
        all_pages = TRUE, 
        method = "POST"
      )
# Sys.sleep(.2)

if(endpointtype== "assignees")
{
  outputdf <- searchedpv_df$data$assignees%>% unnest("patents" ) 
}
if(endpointtype== "inventors")
{
  outputdf <- searchedpv_df$data$inventors%>% unnest( "patents")
}
if(endpointtype=="cpc_subsections" )
{
  outputdf <- searchedpv_df$data$cpc_subsections%>% unnest( "patents")
}
 write_rds(
   outputdf,
   paste0(
  saveoutfolder , "/", endpointtype[1],saveoutfile_string,  ".Rds"
  )
 )


outputdf
# searchedpv_df
}

 
safer_process_file_patentsnum_LU <- possibly(process_file_patentsnum_LU, otherwise = NULL)
  
  
#   listreturn <- list()
# books_sparse <- p %>%
#   count(docnum, word) %>%
#   cast_sparse(docnum, word, n)
currentcrop <- croplist$crop
rm(j)
rm(patentsgloballist)
patentsgloballist <- list()
j <- 1
while(j <= length(currentcrop))
{
  patentfunc_cropcurrent <- currentcrop[j]
  
  
called_df_foldercrop <- paste0(
  savefolder, "/", patentfunc_cropcurrent
)
if(!exists(called_df_foldercrop))
{
  dir.create(called_df_foldercrop)
}

  
  called_df_patent <-  crossing(
  K = numlist %>% unique(), 
  patentcall_croplist = patentfunc_cropcurrent
) %>% 
  mutate(
    current_query_title = 
      paste0(
        '{"_and":[
          {"_eq":{"patent_year":"',K,'"}},
          {"_text_all":{"patent_title":"', patentfunc_cropcurrent, '"}}
  ]}'
      ), 
  
  current_query_abstract = 
    paste0(
      '{"_and":[
          {"_eq":{"patent_year":"',K,'"}},
          {"_text_all":{"patent_abstract":"', patentfunc_cropcurrent, '"}}
  ]}'
    )
  ) 

called_df_patent_title <- called_df_patent %>% 
  # filter(K%in% c(2020, 1990,2010)) %>%
    # filter(K == 2010) %>%

   mutate(

    calledpatents_df = (furrr::future_map(
      current_query_title,
      ~safer_process_file_patent(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = fieldsinterest_patents,
         endpointtype= "patents",
         saveoutfolder = called_df_foldercrop,
         saveoutfile ="title"

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )
called_df_patent_abstract <- called_df_patent %>% 
  # filter(K%in% c(2020, 1990,2010)) %>%
    # filter(K == 2010) %>%

   mutate(

    calledpatents_df = (future_map(
      current_query_abstract,
      ~safer_process_file_patent(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = fieldsinterest_patents,
         endpointtype= "patents",
         saveoutfolder = called_df_foldercrop,
         saveoutfile ="abstract"

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )

# called_df_patent_title%>%
#   filter(
#     !is.null(calledpatents_df), !calledpatents_df %in% c(NULL,FALSE)
#   ) %>% View()
# 
#   unnest(
#     cols = "calledpatents_df"
#   ) %>% View()
# 
# called_df_patent_abstract%>%
#   unnest(
#     cols = "calledpatents_df"
#   ) %>% View()
called_df_patent_title_ul <-  called_df_patent_title %>% 
  bind_rows(
    called_df_patent_abstract
  ) %>%
  filter(
    !is.null(calledpatents_df), !calledpatents_df %in% c(NULL,FALSE)
  )  %>% 
  unnest(
    cols = "calledpatents_df"
  )  %>% 
  distinct()
  
if(!nrow(called_df_patent_title_ul)>=1)
{
  j <- j+1
  next
}

called_df_patent_title_ul_distinctnum <- called_df_patent_title_ul %>% 
  select(patent_number) %>% 
  distinct()

rm(i)
i <- 1
rm(current_called_list)
current_called_list <- list()
while(i <= length( fieldsinterest_vec))
{
  current_fieldinterest_list <- fieldsinterest_list[[i]]
  current_fieldsinterest_vec <- fieldsinterest_vec[i]
  current_fieldsinterest_listdetail <- fieldsinterest_list_detail[[i]]
  
  current_foldersaveas <- paste0(
    called_df_foldercrop, "/", current_fieldsinterest_vec
  )
  if(!exists(current_foldersaveas))
{
  dir.create(current_foldersaveas)
}

  current_called_dfinterest <- called_df_patent_title_ul_distinctnum %>% 
    mutate(
  patentnumquery = paste0('{"_eq":{"patent_number":"',patent_number,'"}}' )
) %>% 
     mutate(

    calledpatents_df = (furrr::future_map(
      patentnumquery,
     ~safer_process_file_patentsnum_LU(
        # ~ process_file_patentsnum_LU(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = current_fieldinterest_list,
         endpointtype= current_fieldsinterest_vec,
         saveoutfolder = current_foldersaveas,
         saveoutfile =current_fieldsinterest_vec

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )
  
  current_called_dfinterest_unnest <- current_called_dfinterest%>%
    tibble() %>% 
    select(-patentnumquery) %>%  
    rename(
      patentnumquery = patent_number
    )%>%  
    filter(
      !is.null(calledpatents_df)
    ) %>% 
    unnest(calledpatents_df )
  if(!nrow(current_called_dfinterest_unnest)>=1)
{
  i <- i+1
  next
}

q<- 1
rm(current_called_dfinterest_unnestlist)
current_called_dfinterest_unnestlist <- list()
while(q <= length(current_fieldsinterest_listdetail ))
{
  if(q ==1)
  {
    current_called_dfinterest_unnestlist[[q]] <- current_called_dfinterest_unnest  %>% 
    # distinct()%>% 
    unnest(
      c(current_fieldsinterest_listdetail[q])
    )
  }
  
    if(q >1)
  {
      current_called_dfinterest_unnestlist[[q]] <- current_called_dfinterest_unnestlist[[q-1]]  %>% 
    # distinct()%>% 
    unnest(
      c(current_fieldsinterest_listdetail[q])
    )

    }
  q <- q+1
  
}
current_called_dfinterest_unnestlist_bindrow <-  current_called_dfinterest_unnestlist[[q-1]] %>% 
  distinct()


  current_called_list[[i]] <- current_called_dfinterest_unnestlist_bindrow  
i <- i+1
    
}

called_df_patent_title_ul_names <-tibble(
  coltype=  sapply(called_df_patent_title_ul , class) , 
  colname = called_df_patent_title_ul %>% names()
)%>% filter(coltype == "list")
current_called_list_bindrow_pre <-  current_called_list %>% 
    bind_rows()
rm(q)
rm(current_called_list_unnestlist)
# currentcalled is ul unnested properly
current_called_list_unnestlist<- list()
q <- 1

while(q <= nrow(called_df_patent_title_ul_names ))
{
current_called_df_patent_title_ul_names <- called_df_patent_title_ul_names$colname[q]
   if(q ==1)
  {
    current_called_list_unnestlist[[q]] <- called_df_patent_title_ul  %>% 
    # distinct()%>% 
    unnest(
      c(current_called_df_patent_title_ul_names)
    )
  }
  
    if(q >1)
  {
      current_called_list_unnestlist[[q]] <- current_called_list_unnestlist[[q-1]]  %>% 
    # distinct()%>% 
    unnest(
      c(current_called_df_patent_title_ul_names)
    )

    }
  q <- q+1
}
if( nrow(called_df_patent_title_ul_names )==0 )
{
  current_called_list_bindrow <- called_df_patent_title_ul %>% 
    bind_rows(
      current_called_list_bindrow_pre
    )
}
if( !nrow(called_df_patent_title_ul_names )==0 )
{
  current_called_list_bindrow <- current_called_list_unnestlist[[q-1]] %>% 
    bind_rows(
      current_called_list_bindrow_pre
    )
}
# current_called_list_bindrow <-  current_called_list %>% 
#     bind_rows()%>% 
#   bind_rows(
#     called_df_patent_title_ul %>% 
#       unnest(c("inventors"))%>% 
#       unnest(c("assignees"))%>% 
#       unnest(c("applications"))%>% 
#       unnest(c("application_citations"))%>% 
#       unnest(c("citedby_patents"))%>% 
#       unnest(c("cpcs"))%>% 
#       unnest(c("nbers"))%>% 
#       unnest(c("gov_interests"))%>% 
#       unnest(c("lawyers"))%>% 
#       unnest(c("examiners")) 
#   )

if(!"appcit_app_number" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      appcit_app_number = NA
    )
}
if(!"citedby_patent_number" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      citedby_patent_number = NA
    )
}
if(!"citedby_patent_title" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      citedby_patent_title = NA
    )
}
if(!"cpc_sequence" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      cpc_sequence = NA
    )
}

current_called_list_bindrow_sum <- current_called_list_bindrow %>% 
  mutate(
    crop= patentfunc_cropcurrent, 
    patent_year =  lubridate::year(ymd(patent_date))
  ) %>% 
  # select(
  #   -K, -current_query, -patent_average_processing_time, -patent_processing_time
  # ) %>% 
  # rename(
  #   patent_year = year#, 
  #   # patent_decade = decade,
  #   # assignee_organization_namestandard = Namestandard
  # ) %>% 
  group_by(crop, patent_number, patent_abstract, patent_date, patent_title, patent_type, patent_year, assignee_organization
)  %>% 
  summarise(
        app_number = paste(unique(app_number), collapse = "] ") , 
    app_id = paste(unique(app_id), collapse = "] ") ,
    appcit_app_number   = paste(unique(appcit_app_number  ), collapse = "] ") ,

    assignee_state_fips = paste(unique(assignee_state_fips), collapse = "] "), 
    assignee_county_fips = paste(unique(assignee_county_fips), collapse = "] "),
    assignee_country = paste(unique(assignee_country), collapse = "] "), 
    assignee_longitude = paste(unique(assignee_longitude), collapse = "] "), 
    assignee_latitude = paste(unique(assignee_latitude), collapse = "] "), 
    assignee_city = paste(unique(assignee_city), collapse = "] "), 
    assignee_total_num_patents = paste(unique(assignee_total_num_patents), collapse = "] "), 
        citedby_patent_number  = paste(unique(citedby_patent_number ), collapse = "] ") ,
         citedby_patent_title  = paste(unique( citedby_patent_title ), collapse = "] ") ,

     cpc_category = paste(unique(cpc_category), collapse = "] "), 
    cpc_subsection_title = paste(unique(cpc_subsection_title), collapse = "] "), 

    cpc_group_title = paste(unique(cpc_group_title), collapse = "] "), 
    cpc_group_id = paste(unique(cpc_group_id), collapse = "] "), 
    cpc_sequence = paste(unique(cpc_sequence), collapse = "] "), 
    cpc_subgroup_id = paste(unique(cpc_subgroup_id), collapse = "] "), 
     cpc_subgroup_title = paste(unique( cpc_subgroup_title), collapse = "] "), 
    cpc_subsection_title = paste(unique(cpc_subsection_title), collapse = "] "), 

    cpc_total_num_assignees = paste(unique(cpc_total_num_assignees), collapse = "] "), 
    cpc_total_num_patents = paste(unique(cpc_total_num_patents), collapse = "] "), 
    cpc_subgroup_title = paste(unique(cpc_subgroup_title), collapse = "] "), 
    examiner_id = paste(unique(examiner_id), collapse = "] ") , 
    lawyer_id = paste(unique(lawyer_id), collapse = "] ") , 
    nber_category_id = paste(unique(nber_category_id), collapse = "] ") , 
    nber_category_title = paste(unique(nber_category_title), collapse = "] ") , 
    nber_subcategory_id
    = paste(unique(nber_subcategory_id), collapse = "] ") , 
    nber_subcategory_title = paste(unique(nber_subcategory_title), collapse = "] ") ,
    nber_total_num_assignees = paste(unique(nber_total_num_assignees, collapse = "] ")) , 
    nber_total_num_patents = paste(unique(nber_total_num_patents), collapse = "] ") 
    



  ) %>% 
  ungroup()
# 
# current_called_list_bindrow_sum_REMOVE <- current_called_list_bindrow_sum %>%
#   gather(
#     key = measure,
#     value = value,
#     -patent_number
#   ) %>%
#   group_by(
#     patent_number, measure
#   )  %>%
#   summarise(
#     numunique = length(unique(value))
#   ) %>%
#   ungroup() %>%
#   group_by(
#     measure
#   ) %>%
#   summarise(
#     avgunique = sum(numunique, na.rm = TRUE)
#   ) %>%
#   ungroup() %>%
#   arrange(
#     -avgunique
#   )
# (current_called_list_bindrow_sum_REMOVE %>% 
#   filter(
#     avgunique == 6742
#   ))$measure %>% unique() %>% paste(collapse = ", ")
 current_called_list_bindrow_sum %>% 
data.table::fwrite(

   paste0(savefolder,"/",  savefileoutfunc,patentfunc_cropcurrent, ".csv"
)
)

 # write_rds(
 #   called_df_patent_title_ul, 
 #   file=paste0(
 #  savefolder, "/", "allpatents",  ".Rds"
 #  )
 # )
patentsgloballist[[j]] <- current_called_list_bindrow_sum
  j <- j+1
}
patentsgloballist_bindrows <- patentsgloballist %>%   bind_rows()
patentsgloballist_bindrows%>% 
  write_rds(
    .,
   file=paste0(
  savefolder, "/", "allpatents",  ".Rds"
  )
 )
  patentsgloballist_bindrows
}

```

### use callpatents function
```{r }

```

### make sure that abstract title say crop and 

## isolate patents of interest
```{r }
soycropquery_unnest_230619 <- func_callpatentviewr_2(currentcrop = croplist, numlist = c(1970:2022), savefolder ="//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/output patents/230618_output" , numworker = 90, savefileoutfunc ="230619_saveall" ) 

soycropquery_unnest_230619 <- patentsgloballist_bindrows
soycropquery_unnest_230619 <- read_rds(
  paste0(
    "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/output patents/230618_output/230619_saveall.rds" 
  )
)
```


## download patents
```{R }
downloadpatentspdffunc <- function(dlpatents_df, dlpatents_outputfolder,   dlpatentsnumworker = 90  ){
  
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
  require(pdftools)
  options(future.globals.maxSize= 891289600)
require(tesseract)
  # cropdf = narrowtoread
  #  typecomp =c("msi", "asus")
  # writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent"
  # usedpidf = 200
#   callr(
# expr,
# envir = parent.frame(),
# substitute = TRUE,
# globals = TRUE,
# label = NULL,
# workers = availableCores(),
# ...
# )
require(future.callr)
  
  # cl <- makePSOCKcluster(detectCores() - 2)

plan("callr", workers =dlpatentsnumworker)

actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  str_squish(tm::stripWhitespace(actual_punc_rem(tolower(x))))
}

numworker = 90

if(!exists(dlpatents_outputfolder ))
{
dir.create(
  dlpatents_outputfolder
)
}
  
    saferprocess_file <- function( currentk ,safe_dlpatents_df=dlpatents_df, writefolderoutdf) {

dlpatents_df_filter <- safe_dlpatents_df[currentk,] %>% 
  mutate( 
     outputname = paste0(
    crop_shortname, "_", patent_type_orig, "_", patent_decade, "_samplerownum",  crop_decade_patenttype_rownum,"_",
    
    patent_number, ".pdf"
  )    
  )

savefilename = dlpatents_df_filter$outputname[1]
      # searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
      #    currentk,  dpi =  usedpidf_df
      # )
 
      
      download.file(
        dlpatents_df_filter$url[1], 
        paste0(
         writefolderoutdf ,"/", savefilename
        ), 
        mode = "wb"
      )
 # https://apps.ams.usda.gov/CMS//AdobeImages/008300115.pdf
      # download.file(
      #   "https://apps.ams.usda.gov/CMS//AdobeImages/008300115.pdf", 
      #   paste0(
      #     "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/download patents pvps/230720 sample 10","/230720testdl.pdf"
      #   ), 
      #   mode = "wb"
      # )


    }
    
    safer_calc_dist <- possibly(
  saferprocess_file, 
  otherwise = 
    NA
)
    alreadycompletedf_func <- tibble(
      filelist = list.files(
        path = paste0(
          dlpatents_outputfolder
        ),

        pattern = "pdf",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".pdf|.*_","", filelist ), 
        fullname_file = paste0(dlpatents_outputfolder,"/", filelist) 
      ) #%>% 
      # filter(
      #   filesize >=filesizemax
      # )
    set.seed(123)
    
    # cropdf  <-  pvp_url %>%  head(1)
  
    # dfsamp <- feather::read_feather("X:/msi/work/farmer welfare/seed/PVP/writepvp/201900258.feather")
    
    readthese_func <- dlpatents_df %>% 
      filter(
        !patent_number %in% c(alreadycompletedf_func$alreadydone)
      )  

out<-   readthese_func %>%
     mutate(
       k = row_number() 
     ) %>% 
     # head(1) %>% 
  mutate(
    topic_model = future_map(
    k, ~safer_calc_dist( 
      ., 
       writefolderoutdf = dlpatents_outputfolder 
     
    )#,  
      # seed    =  TRUE)
  ) 
  )

# set.seed(dlpatents_setseed)
 

}
```

```{r }

convert_to_doc_output <- function( current_text, output_folder, outputname = "example_toc.docx"){
  require(htm2txt)
  require("officer")
  rm(i)
  i <- 1
    outputparams <- c(
    
    # "commentId",
    "organization",
    "NAME",
    "citystate",
    # "firstName", 
    # "lastName", 
    # "city", 
    # "stateProvinceRegion", 
    "receiveDate", 
    "linkfinal", 
    "citation",
    "comment", 
    "contents"
    
  )
    current_text <- current_text %>% 
      # filter(
      #   docketId == "AMS-FTPP-21-0044"
      #   # grepl("AMS-FTPP-21-0044",commentId, perl = TRUE )
      # ) %>% 
      mutate(
        NAME = paste0(
              firstName,  " ",  lastName

        ), 
        citystate = paste0(
                        city,  ", ",  stateProvinceRegion

 
        ), 
        orgname = coalesce(
          organization, NAME
        ), 
        citation = paste0(
          toupper(lastName), ", ", 
          toupper(firstName), ", ", 
          toupper(organization), ", ", 
          "Comments on Proposed Rule: Transparency in Poultry Grower Contracting and Tournaments, (Aug. 2022), ", "https://www.regulations.gov/comment/",  commentId, "."
          
        ), 
        citation = gsub("ANONYMOUS, ANONYMOUS, ", "ANONYMOUS, ", citation), 

        citation = gsub("NA, NA, |^NA, | NA, ", " ", citation), 
        citation = str_squish(citation)
      ) %>% 
      group_by(
        commentId,
            organization,
    NAME,
    orgname,
    citystate,
    # firstName, 
    # lastName, 
    # city, 
    # stateProvinceRegion, 
    receiveDate,
        citation

      ) %>% 
      summarise(
            linkfinal = paste( unique(linkfinal), collapse = "; "), 
                        comment = paste( unique(comment), collapse = "; "), 

                        contents = paste( unique(contents), collapse = "; ")
 
      ) %>% 
      ungroup()
          outputdoc <- read_docx()    |>
            body_add_toc()


  # list_of_docs <- list()
  while(i  <= nrow(current_text))
  {
    current_text_row <- current_text[i, ] %>% 
      mutate(
          contents = gsub(
      "Error in file", "", 
      htm2txt(contents)
    )
  ) %>% 
  mutate(
   across(everything(), ~gsub("NA, NA|^NA$", "", .x ))
  )

    
    current_comment_id <- current_text_row$commentId[1]
    # rm(outputdoc)
          
      outputdoc <- outputdoc    |>
             body_add_break() |>

  body_add_par(current_comment_id, style = "heading 1") 

    rm(j)
    j <- 1
    while(j <= length(outputparams))
    {
      if( j ==1)
      {
        orgname_current <-current_text_row$orgname[1]
        
              outputdoc <- outputdoc    |>
  body_add_par(orgname_current, style = "heading 2") 

      }
      
      outputparams_current <- outputparams[j]
      current_text_row_select <- current_text_row %>% 
        select(
           outputparams[j]
        )
      
colnames(current_text_row_select) <- "currentfield"
outputparams_current_text <- current_text_row_select$currentfield[1] %>% 
      htm2txt()%>% 
  gsub("NA, NA|^NA$", "", . )
  
  #     if(outputparams_current == "linkfinal")
  #     {
  #       linktext =              
  #         fpar(
  #                hyperlink_ftext(
  #                  text = htm2txt(outputparams_current_text),
  #                  # pos  = "after",
  #                  href = htm2txt(outputparams_current_text)
  #                )
  # 
  # 
  #              )
  # 
  #       
  #          outputdoc <-    outputdoc|>
  # 
  #      body_add_fpar(
  #        fpar(
  #  ftext(
  #        paste0(
  #          toupper(
  #            gsub(
  #              "contents", "attachment_text", 
  #              
  #              gsub(
  #                "linkfinal", "attachmentlink", 
  #                outputparams_current
  #              )
  #            ) 
  #          ), ": "
  #        ) , 
  #    prop = shortcuts$fp_bold(font.size = 14)
  #    ) 
  #  )#, 
  #     #   style = "Normal"
  #      ) |>
  #        # style = "Normal"
  #            body_add_fpar(
  #            #  fpar(
  #                linktext
  #                # hyperlink_ftext(
  #                #   text = outputparams_current_text, 
  #                #   # pos  = "after",
  #                #   href = outputparams_current_text
  #                # )
  #                
  #                
  #         #     )
  #            )
  #          
  # 
  #     }
  #   
  # if(outputparams_current != "linkfinal" )
  #     {
   outputdoc <-    outputdoc|>
       body_add_fpar(
         fpar(
   ftext(
         paste0(
           toupper(
             gsub(
               "contents", "attachment_text", 
               
               gsub(
                 "linkfinal", "attachmentlink", 
                 outputparams_current
               )
             ) 
           ), ": "
         ) , 
     prop = shortcuts$fp_bold(font.size = 14)
     ) 
   )#, 
      #   style = "Normal"
       ) %>% 
     body_add(
       outputparams_current_text#, style = "Normal"
     )
   
              
# 
#   }
    j <- j+1
     }
    
i <- i+1
  }
  print(outputdoc, target = paste0( output_folder, outputname) )
current_text %>% 
  mutate(
    contents = substr(contents, 1, 32766), 
    comment = htm2txt(comment), 
    contents = gsub(
      "Error in file", "", 
      htm2txt(contents)
    )
  ) %>% 
  mutate(
   across(everything(), ~gsub("NA, NA|^NA$", "", .x ))
  )%>% 
  writexl::write_xlsx(
    paste0( output_folder, gsub("docx","xlsx", outputname) 
  )
  )
  
  
}
comments_detail_df_pdf_seedretail %>% 
        filter(
        docketId == "AMS-FTPP-21-0044"
        # grepl("AMS-FTPP-21-0044",commentId, perl = TRUE )
      ) %>%
  # head() %>%

convert_to_doc_output(
  current_text =., 
  output_folder = "X:/msi/work/RFI/psa/regulations-public-comments/",
  outputname = "Rule_1_comments_and_attachments_14_citation.docx"
)

```


### test download


### get previous downloads and bind rows

#### function to filter for 
```{r }

soycropquery_unnest_220917 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220917uspto_queryplants_crop.xlsx", sheet = "Sheet1"

) 
soycropquery_unnest_df <- soycropquery_unnest_230619 %>% 
  mutate(
     abstract_title = paste0(patent_abstract, ". ", patent_title)
   ) %>% 
  bind_rows(
    soycropquery_unnest_220917 
)%>% 
    filter(
    (
      grepl(
      "inbred|cultivar|variety|line|hybrid", abstract_title, ignore.case = TRUE,
      perl = TRUE
    )
    |(
      grepl(
        "A01H", cpc_group_id, ignore.case = TRUE,
        perl = TRUE
      )

    )
  )
  ) %>% 
  mutate(
    rownum = row_number()
  ) %>% 
  group_by(rownum)  %>% 
  mutate(
    discard_byaoh = 
      case_when(
        (nchar( cpc_group_id)>=2)&(!(
      grepl(
        "A01H", cpc_group_id, ignore.case = TRUE,
        perl = TRUE
      ) )
      )~  "discard", 
      TRUE ~ "keep"
      )
  ) %>% 
  ungroup() %>% 
  filter(
    discard_byaoh == "keep"
  )

```

### standardize cropname func
```{r }
## uses the name as lu bait; outputs a shortname

standardizenames_crop <- function(zz, zzwhichcol_to_rename, zzcroplistrfdf =croplistLU221126_2 ){
  
  zzdontwantthese <-c("crop_shortname", "crop_type", "crop_type2")
 #  
 # zz <- pvppatent_combine_url_filter
 # zzwhichcol_to_rename <- zz$crop_orig
 #  zzcroplistrfdf =croplistLU221126_2
  
  
  zzcroplistrfdf_2 <- zzcroplistrfdf %>% 
    bind_rows(
      zzcroplistrfdf %>% 
        select(
          -`Common Name`
        )%>% 
        mutate(
          `Common Name` = shortname
        )
    ) %>% 
    group_by(
      `Common Name`, shortname
    ) %>% 
    slice(1)%>% 
    ungroup()
 

  zzcleantextcrop <- function(xcleantextcrop){
     gsub(" ", "",
  tolower(
    cleantext_text(
       str_squish(
     xcleantextcrop)
   
  ) 
    )
   
     )
  } 
   
 zz_df <- zz %>% 
    #make sure 
    select(
      -any_of(c(zzdontwantthese))
    ) %>% 
  cbind(
    tibble(
      renamedcol = zzwhichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = zzcleantextcrop(renamedcol) 
   )%>% 
   left_join(
     zzcroplistrfdf_2 %>% 
       rename(
         Name = `Common Name`
       ) %>% 
       mutate(
         Name = zzcleantextcrop(Name) , 
         shortname = cleantext_text(str_squish(tolower(shortname)))
       )%>% 
       group_by(
         Name 
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   # mutate(
   #   # renamedcol = str_squish(toupper(Namestandard)),
   #   shortname = str_squish(tolower(shortname))
   # ) %>% 
   rename(
     crop_shortname = shortname,
     crop_type = type,
     crop_type2 = type2
   )
 
 
 # zz_df %>% 
 #   filter(
 #     (!(nchar(crop_shortname)>=2))|(is.na(crop_shortname))
 #   ) %>% 
 #   View()
 
 # rm(zz)
 # rm(zzcroplistrfdf)
 # rm(zzcroplistrfdf_2)
 # rm(zz_df)
 # rm(zzdontwantthese)
 # rm(zzwhichcol_to_rename)
 # rm(zzcleantextcrop)
# #  
#  zz_df %>% 
#    filter(
#      is.na( )
#    )
 zz_df
}
```


#### crop lu 
```{r }
croplistLU221126 <- readxl::read_excel(
  "//jna_nol/asus/msi/work/farmer welfare/seed/crop names LU/230902cropnameLU.xlsx.xlsx"
) %>% 
  # mutate(
  #   `Common Name` = str_squish(tolower(`Common Name`)), 
  #   shortname = str_squish(tolower(shortname)) , 
  #       shortname_220913 = str_squish(tolower(shortname_220913)) 
  # 
  # )%>% 
  
  select(
    `Common Name`, shortname,shortname_220913, type,type2
  ) %>% 
  distinct()

croplistLU221126_2 <- croplistLU221126  %>% 
  # bind_rows(
  #    croplistLU221126 %>%
  #      mutate(
  #        `Common Name` = shortname
  #      ) %>%
  #      distinct()
  # 
  # 
  # ) %>%
  bind_rows(
     croplistLU221126 %>% 
       mutate(
         `Common Name` = shortname, 
         shortname = shortname
       ) %>% 
       distinct()
      
  
  ) %>% 
  group_by(
     `Common Name`, shortname
  ) %>% 
  slice(1) %>% 
  ungroup()

```

##### create a new crop  lu func

```{r }
## uses the name as lu bait; outputs a shortname

standardizenames_crop_createlu <- function(tt_df, tt_whichcol_to_rename, tt_croplistrfdf =croplistLU221126_2, tt_outputfolderas, tt_outputfileas ){
  
  if(!dir.exists(tt_outputfolderas)){
    dir.create(tt_outputfolderas)
  }
 
tt_standardnames <- standardizenames_crop(zz = tt_df, whichcol_to_rename = tt_whichcol_to_rename, croplistrfdf =tt_croplistrfdf ) %>% 
    filter(
    is.na(crop_type)
  ) %>% 
  select(
    crop_orig
  ) %>% 
  distinct()  %>% 
  rename(
    `Common Name` = crop_orig
  ) %>% 
  bind_rows(
    tt_croplistrfdf
  ) %>% 
  mutate(
    `Common Name` =  gsub(" ", "", cleantext_text(str_squish(tolower(`Common Name`))))
  )%>% 
  arrange(
     `Common Name`
  ) %>% 
  group_by(
    `Common Name` , shortname, shortname_220913
  ) %>% 
  slice(1) %>%
 

 tt_standardnames %>% 
   writexl::write_xlsx(
    paste0(
       tt_outputfolderas, "/",tt_outputfileas, ".xlsx"
    )
   )
 
 # zz_df %>% 
 #   filter(
 #     (!(nchar(crop_shortname)>=2))|(is.na(crop_shortname))
 #   ) %>% 
 #   View()
 
 
 
}
```

```{r }

pvppatent_combine_url_filter  %>% 
standardizenames_crop_createlu(tt_df = . , tt_whichcol_to_rename = .$crop_orig, tt_croplistrfdf =croplistLU221126_2, tt_outputfolderas = "//jna_nol/asus/msi/work/farmer welfare/seed/crop names LU" , tt_outputfileas = "230902cropnameLU.xlsx" )

```


```{r }
patent_url  <- soycropquery_unnest_df  %>%  
  mutate(
    url = paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    )
  )%>%       
  select(
    patent_number, url
  )  %>% 
  distinct()
    alreadycompletedf_patent <- tibble(
      filelist = list.files(
       path = "X:/msi/work/farmer welfare/seed/Patents/writepatent",
        pattern = "feather",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".feather","", filelist )
      )
    set.seed(123)
    set.seed(123)
    
     
    narrowtoread_patent <- patent_url %>%
      mutate(
        registernum = patent_number
        #   gsub(
        #   ".*AdobeImages/|.pdf", "", url
        # )
      ) %>%
      filter(
        !registernum %in% c(alreadycompletedf_patent$alreadydone)#,
        # !is.na(patent_year)
      )  %>%
      group_by(
        registernum
      ) %>% 
      slice(1) %>% 
      ungroup() %>% 
      select(
        registernum, url
      )%>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    rownum = row_number(),
    assign = case_when(
      rownum <= (nrow(.)/2)~ "msi",
      TRUE ~ "asus"
    )
  )
```

### furrr function
```{r }
func_callpatentviewr_dl <- function(cropdf, typecomp = "msi", writefolderout = "X:/msi/work/farmer welfare/seed/PVP/writepvp", usedpidf = 200, numworker = 100, filesizemax = 20000) {
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
  require(pdftools)
  options(future.globals.maxSize= 891289600)
require(tesseract)
  # cropdf = narrowtoread
  #  typecomp =c("msi", "asus")
  # writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent"
  # usedpidf = 200
#   callr(
# expr,
# envir = parent.frame(),
# substitute = TRUE,
# globals = TRUE,
# label = NULL,
# workers = availableCores(),
# ...
# )
require(future.callr)
  
  # cl <- makePSOCKcluster(detectCores() - 2)

plan("callr", workers =numworker)
  # require(patentsview)
  

    saferprocess_file <- function( currentk , writefolderoutdf, usedpidf_df) {
      # currentk ="https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/6127608"
      
# searchedpv_df <- suppressMessages(textreadr::read_pdf(
#          currentk,ocr = TRUE, trim = TRUE, dpi = usedpidf
#       )
# )
      
      searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
         currentk,  dpi =  usedpidf_df
      )
)

#             searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
#           "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/10004195",  dpi =  usedpidf  
#       )
# )

# if( length(searchedpv_df)>=1)
# {
#   
# }
nameout <- gsub(
  ".*AdobeImages/|.pdf|.*downloadPdf/", "", currentk
)
tibble(
  text   =  searchedpv_df,
  patent_number = nameout
) %>% 
  group_by(
    patent_number
  ) %>% 
  summarise(
    text = paste(text,   collapse = " ")
  )  %>% 
  ungroup() %>%  
   feather::write_feather(
     paste0(
       # "X:/msi/work/farmer welfare/seed/Patents/writepatent/",
       writefolderout,"/",
       nameout,".feather"
     )
     
   )
# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/",
#        nameout,".feather"
#      )
# )

# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/200100164.feather"
#      )
# )

 # searchedpv_df
 # Sys.sleep(.1)
gc()
#   
    }
    
    safer_calc_dist <- possibly(
  saferprocess_file, 
  otherwise = 
    NA
)
    alreadycompletedf_func <- tibble(
      filelist = list.files(
        path = paste0(
          writefolderout
        ),

        pattern = "feather",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".feather","", filelist ), 
        fullname_file = paste0(writefolderout,"/", filelist),
   filesize =      file.size( fullname_file  )
      ) %>% 
      filter(
        filesize >=filesizemax
      )
    set.seed(123)
    
    # cropdf  <-  pvp_url %>%  head(1)
  
    # dfsamp <- feather::read_feather("X:/msi/work/farmer welfare/seed/PVP/writepvp/201900258.feather")
    
    readthese_func <- cropdf %>% 
      filter(
        !registernum %in% c(alreadycompletedf_func$alreadydone)
      ) %>%
      filter(
         assign %in% c(typecomp ) 
      )
    
  #   narrowtoread <- cropdf %>%
  #     mutate(
  #       registernum = gsub(
  #         ".*AdobeImages/|.pdf", "", url
  #       )
  #     ) %>% 
  #     filter(
  #       !registernum %in% c(alreadycompletedf$alreadydone)
  #     ) #  %>% 
  # #   arrange(runif(n())) %>% # randomize the order
  # # mutate(
  # #   rownum = row_number(), 
  # #   assign = case_when(
  # #     rownum <= (nrow(.)/2)~ "msi", 
  # #     TRUE ~ "asus"
  # #   )
  # # )%>% 
  # # filter(
  # #  assign = typecomp
  # # )
  # 
  #   
    # sampledf   <- feather::read_feather("X:/msi/work/farmer welfare/seed/Patents/writepatent/10004195.feather")
    
   readthese_func %>%
     # head(1) %>% 
  mutate(
    topic_model = future_map(
    url, ~safer_calc_dist( 
      ., 
      writefolderoutdf = writefolderout, 
      usedpidf_df = usedpidf
     
    )#,  
      # seed    =  TRUE)
  ) 
  )
   
   # safer_calc_dist( 
   #    "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/10004195", 
   #    writefolderoutdf = writefolderout, 
   #    usedpidf_df = usedpidf
   #   
   #  )
    # cropdf_read
      
}
func_callpatentviewr_dl(cropdf = narrowtoread_patent,  typecomp = c("msi", "asus"), writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent", usedpidf = 200, numworker = 90 , filesizemax = 10000)
# func_callpatentviewr(cropdf = narrowtoread, c("msi", "asus") )
# func_callpatentviewr(cropdf = narrowtoread, c("msi", "asus") )

# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/201800341.feather"
#      )
# )

```

# read in patent text
```{r }
patentpvp_text <-  tibble(
   
   filename = list.files(
        "X:/msi/work/farmer welfare/seed/Patents/writepatent",
        pattern = "feather",
        full.names = TRUE

      ) 
   )%>%
    mutate(
      dfcall = 
      purrr::map(filename, ~possibly(~feather::read_feather(.x),otherwise=NA)(.x)) 
    ) #%>% 

  patentpvp_text_unnest <- patentpvp_text %>% 
    unnest() %>%
      mutate(
        registernum = gsub(
          ".*AdobeImages/|.pdf|.*/|.feather", "", filename
        )#,
        # patent_number = case_when(
        #   patent_type == "PVP" & substr(1,2,registernum)=="00" ~ 
        # )
      ) %>% 
    group_by(
      registernum, filename
    ) %>% 
    summarise(
      text = paste(text, collapse = ". ")
    ) %>% 
    ungroup()

```

# combine patents with pvp

## helper functions
```{r }

## standardize cropname func
 
standardizenames_crop <- function(zz, whichcol_to_rename){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     croplistLU221126 %>% 
       rename(
         Name = `Common Name`
       ) %>% 
       mutate(
         Name = str_squish(tolower(Name)), 
         shortname = str_squish(tolower(shortname)) 
       )%>% 
       group_by(
         Name,shortname
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     shortname = str_squish(tolower(shortname))
   ) %>% 
   rename(
     crop_shortname = shortname,
     crop_type = type,
     crop_type2 = type2
   )
 zz_df
}
```

## combine
```{r }
pvp_230705 <- readxl::read_excel(
  "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230614 PVPOApplicationStatus.xlsx"
) %>% 
  filter(
    !is.na(`Years Protected`)
  ) %>% 
  mutate(
    numstr = nchar(`Application #`),
    url = case_when(
      numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",`Application #`, ".pdf"), 
       numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",`Application #`, ".pdf")
      
      
    )
  ) %>% 
      mutate(
        crop = `Common Name`,
        patent_year =  as.integer(gsub(".*/", "", `Issued Date`)),
        # this step alters patent number to simply 
       patent_number = gsub(
          ".*AdobeImages/|.pdf", "", url
        ),
    abstract_title = paste0(
            
      `Variety Name`, ". ", `Experimental Name`, ". ", `Common Name` 
    )
  ) %>%  
      select(
        patent_number,  abstract_title, crop , patent_year, Applicant
      )%>%  
    distinct() %>% 
      mutate(
    patent_type = "PVP",
    patent_type_orig = "PVP"
  ) %>%

  standardizenames_crop(
    ., 
    whichcol_to_rename =.$crop 
    )%>%
   # select(
   #   -crop
   # )%>%
   # rename(
   #   # crop_spec = crop,
   #   crop = crop_type
   # )%>% 
    distinct() 

patent_pvp_combine_230705long <- soycropquery_unnest_df %>% 
  rename(
    Applicant = assignee_organization
  ) %>% 
  select(
    -gamma, -terms, -terms_tfidf, -topic, -rownum, -discard_byaoh
   # any_of(names(pvp_230705 ))
  )  %>%

  standardizenames_crop(
    ., 
    whichcol_to_rename =.$crop 
    )%>%
   # select(
   #   -crop
   # )%>%
   # rename(
   #   # crop_spec = crop,
   #   crop = crop_type
   # )%>% 
    distinct()%>% 
  
  mutate(rownum = row_number()) %>% 
  group_by(rownum)%>% 
  filter(
    grepl(crop_shortname , abstract_title, perl = TRUE, ignore.case =TRUE )
  ) %>% 
  ungroup() %>% 
 
  mutate(
    url = paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    ), 
    patent_type_orig = "patent"
  ) %>% 
  bind_rows(
    pvp_230705 %>% 
  mutate(
    numstr = nchar(patent_number),
    url = case_when(
      numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",patent_number, ".pdf"), 
       numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",patent_number, ".pdf")
      
      
    )
  ) %>% 
    select(
      -numstr
    )
  )%>% 
  group_by(
    patent_number, crop, Applicant
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(
    patent_decade =  lubridate::year(lubridate::round_date( as.Date(ISOdate(patent_year, 12, 31)), "10 years"))
  )
```

#### write out

```{R }

trunccatestr2 <- function(x){
  substr(x, 1,32766)
  
}

removenafunc <- function(x){
  # substr(x, 1,32766)
 str_squish(gsub("] NA|^NA$|. NA. |^NA]" ,"", x))
}

set.seed(123)
patent_pvp_combine_230705sample <- patent_pvp_combine_230705long %>%
  filter(
    crop_shortname  %in% c(
      "corn" , "soybean" , "lettuce", "potato"
    )
  ) %>% 
  group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    sample_prioritynum = row_number()
  ) %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type,  patent_decade, patent_number, url, Applicant,  abstract_title, everything()
  ) %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  ) %>% 
    ungroup() %>% 

  mutate_if(
    is.character, removenafunc
  ) %>% 
  cbind(
    tibble(
      start_claim_description_text ="", 
      stop_Claim_description_text = ""
    )
  )%>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, start_claim_description_text, stop_Claim_description_text, everything()
  )

writexl::write_xlsx(
   list(
     "sample_crops" = patent_pvp_combine_230705sample,
     "sheet2Name" = patent_pvp_combine_230705long %>% 
       inner_join(
         patent_pvp_combine_230705sample %>% 
           select(
             sample_prioritynum, crop_shortname,patent_type, patent_decade, patent_number, url
           )
       )  %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  )%>%
       bind_rows(
         patent_pvp_combine_230705long %>% 
           anti_join(
         patent_pvp_combine_230705sample %>% 
           select(
             crop_shortname,patent_type, patent_decade, patent_number, url
           ) 
       )
       ) %>% 
       
  mutate_if(
    is.character, trunccatestr2
  ) %>% 
   mutate_if(
    is.character, removenafunc
  )   %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, everything()
    ) %>% 
   rename(
   crop_origname =  crop 
   )
 ),
     "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230705_patent_pvpcombine_sample_potato.xlsx"
  
)

set.seed(123)

patent_pvp_combine_230705long %>% 
  mutate_if(
    is.character, trunccatestr2
  ) %>% 
  
  writexl::write_xlsx(
    "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230705_patent_pvpcombine.xlsx"
  )
patent_pvp_combine_230705 <- readxl::read_excel(
    "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230705_patent_pvpcombine.xlsx"
  ) %>%  
  select(
    any_of(pvp_230705 %>% names())
  )
 

```

# Predict variety 

## test keras tensorflow
```{r }
# https://smltar.com/dldnn.html#kickstarter
kickstarter <-  read_csv(
  "https://github.com/EmilHvitfeldt/smltar/raw/master/data/kickstarter.csv.gz"
) 

pvppatent_combine <- readxl::read_excel(
    "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230705_patent_pvpcombine.xlsx", 
      guess_max = 40000
  ) 

# this is the knowns
pvppatent_filter <- pvppatent_combine%>% 
  # f(
  #   patent_type_orig 
  # )
  filter(
    patent_type != "PVP" ,
    nchar(cpc_group_id ) >=3
  ) %>% 
  # mutate(
  #   nchar_cpc = nchar(cpc_group_id )
  # ) 
  left_join(
    patentpvp_text_unnest, 
    by = c("patent_number" = "registernum")
  ) %>% 
  mutate(
    blurb = paste0(abstract_title, ". ", text  ),
    created_at = as.Date(ISOdate(patent_year, 12, 31)) ,
    state = 
      case_when(
        
        grepl(
          "A01H6|A01H5", cpc_subgroup_id, ignore.case = TRUE,
          perl = TRUE
        ) ~  1,
        TRUE ~ 0
      ) 
  ) %>% 
  select(
    blurb, 
    state, 
    created_at, 
    patent_number
  )

#this includes unknowns
pvppatent_all <-pvppatent_combine%>% 
  # f(
  #   patent_type_orig 
  # )
  filter(
        patent_type != "PVP" ,
   !patent_number %in% c(pvppatent_filter$patent_number)
  ) %>% 
  # mutate(
  #   nchar_cpc = nchar(cpc_group_id )
  # ) 
  left_join(
    patentpvp_text_unnest, 
    by = c("patent_number" = "registernum")
  ) %>% 
  mutate(
    blurb = paste0(abstract_title, ". ", text  ),
    created_at = as.Date(ISOdate(patent_year, 12, 31)) ,
    state = 
      case_when(
        
        grepl(
          "A01H6|A01H5", cpc_subgroup_id, ignore.case = TRUE,
          perl = TRUE
        ) ~  1,
        TRUE ~ 0
      ) 
  ) %>% 
  select(
    blurb, 
    state, 
    created_at, 
    patent_number
  )
```

```{r }
kickstarter <- pvppatent_filter# %>% 
  # select(
  #   -patent_number
  # )
kickstarter_full  <- pvppatent_all# %>% 
  # select(
  #   -patent_number
  # )
```

```{r }
  # rename(
  # blurb = abstract_title
  # )

library(tidymodels)
set.seed(1234)
kickstarter_split <- kickstarter %>%
  filter(nchar(blurb) >= 15) %>%
  initial_split()

kickstarter_train_patentnum <- training(kickstarter_split)
kickstarter_test_patentnum <- testing(kickstarter_split)

kickstarter_train <- kickstarter_train_patentnum %>% 
  select(-patent_number)
kickstarter_test <- kickstarter_test_patentnum%>% 
  select(-patent_number)

```

### dnn
```{r }
library(textrecipes)

max_words <- 2e4
max_length <- 30

# max_words <- 2e4
# max_length <- 30

kick_rec <- recipe(~ blurb  , data = kickstarter_train) %>%
  # update_role(patent_number, new_role = "id")  %>%
  step_tokenize(blurb) %>%
  step_tokenfilter(blurb, max_tokens = max_words) %>%
  step_sequence_onehot(blurb, sequence_length = max_length)
# kick_rec
kick_prep <-  prep(kick_rec)
kick_train <- bake(kick_prep, new_data = NULL, composition = "matrix")
kick_matrix <- bake(kick_prep, new_data = NULL, composition = "matrix")

# kick_full <- 
```


```{r }
require(tidymodels)
set.seed(234)
kick_val <- validation_split(kickstarter_train, strata = state)

kick_analysis <- bake(kick_prep, new_data = analysis(kick_val$splits[[1]]),
                      composition = "matrix")
kick_assess <- bake(kick_prep, new_data = assessment(kick_val$splits[[1]]),
                    composition = "matrix")
```

```{r }

state_analysis <- analysis(kick_val$splits[[1]]) %>% pull(state)
state_assess <- assessment(kick_val$splits[[1]]) %>% pull(state)
```

```{r }
require(keras)

final_mod <- keras_model_sequential() %>%
  layer_embedding(input_dim = max_words + 1, output_dim = 16,
                  input_length = max_length) %>%
  layer_conv_1d(filter = 32, kernel_size = 7,
                strides = 1, activation = "relu") %>%
  layer_global_max_pooling_1d() %>%
  layer_dense(units = 64, activation = "relu") %>%
  layer_dense(units = 1, activation = "sigmoid")
final_mod %>%
  compile(
    optimizer = "adam",
    loss = "binary_crossentropy",
    metrics = c("accuracy")
  )

final_history <- final_mod %>%
  fit(
    kick_matrix,
    kickstarter_train$state,
    epochs = 10,
    validation_split = 0.1,
    batch_size = 512,
    verbose = FALSE
  )
```

```{r }
library(dplyr)

keras_predict <- function(model, baked_data, response) {
  predictions <- predict(model, baked_data)[, 1]
  tibble(
    .pred_1 = predictions,
    .pred_class = if_else(.pred_1 < 0.5, 0, 1),
    state = response
  ) %>%
    mutate(across(c(state, .pred_class),            ## create factors
                  ~ factor(.x, levels = c(1, 0))))  ## with matching levels
}

# val_res <- keras_predict(simple_cnn_model, kick_assess, state_assess)
# val_res

```


```{r }
kick_matrix_test <- bake(kick_prep, new_data = kickstarter_test,
                         composition = "matrix")
final_res <- keras_predict(final_mod, kick_matrix_test, kickstarter_test$state)
final_res %>% metrics(state, .pred_class, .pred_1)

final_res %>%
  conf_mat(state, .pred_class) %>%
  autoplot(type = "heatmap")
```

<!-- ```{r } -->
<!-- kick_matrix_alltrain <- bake(kick_prep, new_data = kickstarter, -->
<!--                          composition = "matrix") -->
<!-- final_res_alltrain <- keras_predict(final_mod, kick_matrix_alltrain, kickstarter$state) -->
<!-- final_res %>% metrics(state, .pred_class, .pred_1) -->


<!-- ``` -->



```{r }
kickstarter_full_nchar15 <- kickstarter_full %>%
  filter(nchar(blurb) >= 15) %>% 
  select(
    -patent_number
  )

kick_matrix_full <- bake(kick_prep, new_data = kickstarter_full_nchar15,
                         composition = "matrix")
final_res_full  <- keras_predict(final_mod,kick_matrix_full, kickstarter_full_nchar15$state)
# final_res %>% metrics(state, .pred_class, .pred_1)

# final_res_full %>%
#   conf_mat(state, .pred_class) %>%
#   autoplot(type = "heatmap")

final_matchings <- final_res_full %>% 
  cbind(
    kickstarter_full %>% 
      select(patent_number) 
  ) %>% 
  mutate(
    # keras_predict = 
    #   
    #   paste0(
    #     "predict", 
    #     gsub(
    #       "0", "_not_variety.cultivar.related", 
    #       gsub(
    #       "1", "_yes_variety.cultivar.related",   .pred_class
    #       )
    #         
    #       )
    #     
    #   ), 
    ifcpc_A01H6_known = "unknown", 
    valueuse_ifcpc_A01H6 = as.numeric(as.character(.pred_class)), 
    keras_predict = "predicted"
  ) %>% 
  mutate(
    state = as.numeric(as.character(state))#, 
    # valueuse_ifcpc_A01H6 
  )%>% 
  bind_rows(
    kickstarter_train_patentnum %>% 
      mutate(
        keras_predict = "train", 
        valueuse_ifcpc_A01H6 =state, 
        ifcpc_A01H6_known = "known" 
      ) %>% 
      select(-state) %>% 
      
      bind_rows(
        kickstarter_test_patentnum %>% 
          cbind(
            final_res %>% 
              select(
                .pred_class, .pred_1
              )
          ) %>% 
      mutate(
        keras_predict = "test", 
        valueuse_ifcpc_A01H6 =state, 
        ifcpc_A01H6_known = "known" , 
        .pred_class = .pred_class 
      )
      )%>% 
      mutate(
       ifcpc_A01H6_known = "known"
      )
  ) %>% 
  select(
        keras_predict, 
        valueuse_ifcpc_A01H6 , 
        ifcpc_A01H6_known , 
        .pred_1, 
        .pred_class,
        patent_number
  )
final_matchings %>% 
  writexl::write_xlsx(
    "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/230720 deeplearn if cultivar/230819_finalmatchings.xlsx"
  )

final_matchings %>% 
  group_by(patent_number) %>% 
  mutate(
    totalnum = n()
  ) %>% 
  filter(
    totalnum >=2
  ) %>% View()
```

## write out xlsx and sample

```{r }
pvppatent_combine_url <- pvppatent_combine %>% 
 
  mutate(
        numstr = nchar(patent_number),
        patent_type_orig = 
          case_when(
        patent_type == "PVP" ~ "PVP", 
        TRUE ~ "Patent"
          ),
    url =
      case_when(
        patent_type == "PVP" & numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",patent_number, ".pdf"), 
         patent_type == "PVP" & numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",patent_number, ".pdf"), 
        TRUE ~ 
        paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    ) 
      ), 
   patent_decade = lubridate::year(lubridate::round_date( as.Date(ISOdate(patent_year, 12, 31)), "10 years"))
  ) %>% 

    select(
      -numstr
    ) %>% 
  left_join(
    final_matchings %>% 
      group_by(patent_number) %>% 
      slice(1) %>% 
      ungroup(), 
    by = c("patent_number")
  ) %>% 
  select(
   crop_shortname,patent_type_orig,patent_type,  patent_decade, patent_number, url, Applicant,  abstract_title, `keras_predict`:`.pred_class`, everything()
  ) 

```


### write it out feather
```{r }
pvppatent_combine_url %>% feather::write_feather(
  "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230820_pvppatent_combine_url.feather"
)

```

#### read back in pvp patent combine
```{R }
pvppatent_combine_url <-feather::read_feather(
  "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230820_pvppatent_combine_url.feather"
)

   pvppatent_combine_url_filter <- pvppatent_combine_url %>% 
  filter(
    (valueuse_ifcpc_A01H6 == 1)|(patent_type_orig == "PVP")
  ) %>% 
     select(
       -assignee_organization_namestandard
     )%>% 
     mutate(
       applicant_upper = toupper(cleantext_text(Applicant))
     ) %>% 
     select(-contains("crop_")) %>%       
    standardizenames_crop(
        ., 
        zzwhichcol_to_rename =.$crop 
    )%>%
    # select(
    #     -crop
    # )%>%
    rename(
      crop_orig = crop,
        crop = crop_shortname
    ) 
   pvppatent_combine_url_filter %>% 
     filter(
       is.na(crop)
     )%>% View()
   
     pvppatent_combine_url_filter %>% 
       select(
         crop_orig, contains("crop")
       ) %>%
       distinct() %>% 
       group_by(
         crop_orig, crop
       )  %>% 
       filter(
         n()>=2
       ) %>% View()
     
     #%>% 
  #   select(-Applicant) #%>% 
  #  standardizenames_companies(., whichcol_to_rename = .$applicant_clean  )%>%
  # rename(
  #   # namestandard_acquired_lower = renamedcol,
  #   namestandard_applicant_clean= Namestandard
  # )    
```


### write out various forms
####  write into small dfs
```{r }

write_into_small_csv_func <- function(x, xfolder, xnumrows = 20000, xnumworker){
  require(parallel)
  require(furrr)
  require(tidyverse)
  # require(tidytext)
require(callr)
require(future.callr)
  options(future.globals.maxSize= 891289600)
set.seed(123)
require(tidyverse)
  plan("callr", workers =xnumworker)

if(!exists(xfolder))
{
  dir.create(xfolder)
}
  # require(patentsview)

x %>%
  mutate(group = (row_number() - 1) %/% !! xnumrows) %>%
  group_split(group) %>%
  future_map(.f = ~data.table::fwrite(
    .x, file = paste0(xfolder, "/", 'file ', unique(.x$group), '.csv')))

  
}

### output it
 
 
pvppatent_combine_url_filter %>% 
write_into_small_csv_func(x= ., xfolder = "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/230814 split patents", xnumrows = 5000,xnumworker = 90)
  

```


#### sample

##### runif
```{r }
set.seed(123)
pvppatent_combine_url_runif <- pvppatent_combine_url %>%
  filter(
    crop_shortname  %in% c(
      "corn" , "soybean" , "lettuce", "potato"
    )
  ) %>% 
  group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    sample_prioritynum = row_number()
  ) %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type,  patent_decade, patent_number, url, Applicant,  abstract_title, `keras_predict`:`.pred_class`, everything()
  ) %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  ) %>% 
    ungroup() %>% 

  mutate_if(
    is.character, removenafunc
  ) %>% 
    mutate_if(
    is.character, trunccatestr2
  ) %>% 

  # cbind(
  #   tibble(
  #     start_claim_description_text ="", 
  #     stop_Claim_description_text = ""
  #   )
  # )%>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, everything()
  )


```

##### sample 5
```{r }
pvppatent_combine_url_sample5 <- pvppatent_combine_url_runif %>% 
  filter(
    (valueuse_ifcpc_A01H6 == 1)|(patent_type_orig == "PVP")
  ) %>% 
    group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
  slice(1:20) %>%
  ungroup()  %>%
      group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
mutate(
  crop_decade_patenttype_rownum = str_pad( row_number(), width = 4, "left", "0")
) %>%
  ungroup() %>%
  cbind(
    tibble(
      start_claim_description_text ="",
      stop_Claim_description_text = ""
    )
    ) %>%
  select(
   crop_decade_patenttype_rownum, sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, start_claim_description_text,stop_Claim_description_text,  everything()
  )

```

```{r }
writexl::write_xlsx(
   list(
     "sample_crops" = pvppatent_combine_url_sample5,
     "sheet2Name" = pvppatent_combine_url_runif ),
     "//jna_nol/asus/msi/work/farmer welfare/seed/PVP/230720_patent_pvpcombine_sample.xlsx"
  

)

```

 
```{r }

downloadpatentspdffunc(dlpatents_df = pvppatent_combine_url_sample5, dlpatents_outputfolder = "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/download patents pvps/230720 sample 10" , dlpatentsnumworker = 90)
```
<!-- ```{r } -->
<!-- library(keras) -->

<!-- dense_model <- keras_model_sequential() %>% -->
<!--   layer_embedding(input_dim = max_words + 1, -->
<!--                   output_dim = 12, -->
<!--                   input_length = max_length) %>% -->
<!--   layer_flatten() %>% -->
<!--   layer_dense(units = 32, activation = "relu") %>% -->
<!--   layer_dense(units = 1, activation = "sigmoid") -->
<!-- # compile model before fitting  -->
<!-- dense_model %>% compile( -->
<!--   optimizer = "adam", -->
<!--   loss = "binary_crossentropy", -->
<!--   metrics = c("accuracy") -->
<!-- ) -->
<!-- dense_history <- dense_model %>% -->
<!--   fit( -->
<!--     x = kick_train, -->
<!--     y = kickstarter_train$state, -->
<!--     batch_size = 512, -->
<!--     epochs = 20, -->
<!--     validation_split = 0.25, -->
<!--     verbose = FALSE -->
<!--   ) -->
<!-- ``` -->

<!-- ### cnn -->
<!-- ```{r } -->


<!-- simple_cnn_model <- keras_model_sequential() %>% -->
<!--   layer_embedding(input_dim = max_words + 1, output_dim = 16, -->
<!--                   input_length = max_length) %>% -->
<!--   layer_conv_1d(filter = 32, kernel_size = 5, activation = "relu") %>% -->
<!--   layer_global_max_pooling_1d() %>% -->
<!--   layer_dense(units = 64, activation = "relu") %>% -->
<!--   layer_dense(units = 1, activation = "sigmoid") -->

<!-- simple_cnn_model %>% compile( -->
<!--   optimizer = "adam", -->
<!--   loss = "binary_crossentropy", -->
<!--   metrics = c("accuracy") -->
<!-- ) -->

<!-- cnn_history <- simple_cnn_model %>% fit( -->
<!--   x = kick_analysis, -->
<!--   y = state_analysis, -->
<!--   batch_size = 512, -->
<!--   epochs = 10, -->
<!--   validation_data = list(kick_assess, state_assess) -->
<!-- ) -->
<!-- ``` -->


# merger inclusion

<!-- ## read merger data -->
<!-- ```{r } -->
<!-- mergerdata220918 <- readxl::read_excel( -->
<!--   "X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx",  -->
<!--   sheet = "Sheet1" -->

<!-- ) %>%  -->
<!--   mutate( -->
<!--     acquired_clean =toupper(cleantext_text(Firm_acquired) ) ,  -->
<!--     acquirer_clean = toupper(cleantext_text(Firm_acquirer) ) -->
<!--   ) -->

<!-- ``` -->


## remake name standard lu

<!-- ```{r } -->
<!-- # lu_conames220917 <- readxl::read_excel( -->
<!-- #   "X:/msi/work/farmer welfare/seed/220915 rename Lu seed cos.xlsx", sheet = "final LU Seeds w table - acquis" -->
<!-- # ) %>%  -->
<!-- #   mutate( -->
<!-- #     Name = toupper(cleantext_text(Name) ) ,  -->
<!-- #     Namestandard = toupper(cleantext_text(Namestandard) ) -->
<!-- #   ) %>%  -->
<!-- #   distinct() -->
<!-- require(readxl) -->
<!-- lu_conames_out230705_match <- readxl::read_excel( -->
<!--   "X:/msi/work/farmer welfare/seed/230706 rename Lu seed cos.xlsx",  -->
<!--   range = cell_cols("A:D") -->
<!-- ) %>%  -->
<!--   filter(nchar(Applicant)>=2) %>%  -->
<!--   mutate( -->
<!--     Applicant = toupper(cleantext_text(Applicant) ) ,  -->
<!--     Namestandard = toupper(cleantext_text(Namestandard) ) -->
<!--   ) %>%  -->
<!--   distinct() -->

<!-- ``` -->

### output new lu 

#### append country name func simple
```{r }
appendcountrynamefunc_simple <- function(qq_countrypath,qq_colnamefirmname, qqattachnamesdf){
    qq_countrydf <- readxl::read_excel(
    qq_countrypath
  ) %>% 
      select(
       Namestandard, `alpha-2`, likely_country
      ) %>% 
      distinct()
    qqattachnamesdf %>% 
      cbind(
        tibble(
          qqfirmnamestandard= qq_colnamefirmname
        )
      )  %>% 
      left_join(
        qq_countrydf, 
        by = c("qqfirmnamestandard" ="Namestandard" )
      ) %>% 
      select(
        -qqfirmnamestandard
      ) %>% 
      mutate(
        `alpha-2` = replace_na(`alpha-2`, "NA"),
         likely_country = replace_na(likely_country, "name not found")

      )
    
}
```

#### append country name func - in new lu
```{r }
## the purpose of this function is simply to create a country standardname and countryname and countryabbr lu
appendcountrynamefunc <- function(qq_countrypath, qq_countrylu =countryLU, qq_sendthrumergers, qq_z_patentpvp, qq_prevnamesmatch, qq_z_mergerhistory){
  # qq_z_patentpvp = q_
  # qq_sendthrumergers = soycropquery_merger
  # qq_z_patentpvp_clean = z_patentpvp_clean
  # qq_countrylu = countryLU
  # qq_prevnamesmatch = lu_conames_out230705_match
  # qq_prevnamesmatch = y_prevLU2
  #   qq_z_patentpvp <- z_patentpvp
  #   qq_z_mergerhistory <-x_mergedata
  # 
  # qq_countrypath = "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230908 rename Lu seed cos.xlsx"
  qq_countrydf <- readxl::read_excel(
    qq_countrypath
  ) %>%
    filter(
      !is.na(`alpha-2`)
    )%>% 
    select(
      Namestandard, `alpha-2`
    ) %>%
    distinct() 
  
  
  # this includes merger names not in 
  qq_z_mergerhistory_standard <- qq_z_mergerhistory %>% 
            mutate(
          applicant_upper = cleanupper(Applicant) 
        )   %>%
    select(
      -Applicant
    ) %>%
        # standardizenames_companies()
        # standardizenames_companies(zzluconames_df = lu_conames_out230705_match)
        standardizenames_companies(
          zz=., 
          whichcol_to_rename =.$applicant_upper, 
          zzluconames_df = qq_prevnamesmatch
        )#%>% 
# 
#   qq_z_mergerhistory_countryacquirer <- qq_z_mergerhistory_standard %>% 
#     group_by(
#       
#     )
  
  # take all those whose names are in mergerhistory
  qq_z_mergerhistory_standard_in_qq_countrydf <- qq_countrydf %>% 
    filter(
      Namestandard %in% c(qq_z_mergerhistory_standard$Namestandard )
    ) %>%
    left_join(
      qq_countrylu  %>%  
        select(`alpha-2`,  name)%>% 
        distinct(),
      by  =  c(  "alpha-2")
    )%>% 
    rename(
      likely_country = name, 
      firmname = Namestandard
    ) 
  
  qq_sendthrumergers_country <- qq_sendthrumergers %>% 
    mutate(
      inventor =   name_standard_patent2
    ) %>% 
    gather(
      key  = firmtype,   
      value   =  firmname,
      c("col_acquirer_new","name_standard_patent2"   )
    )   %>%  
    left_join(
      qq_countrydf %>% 
        select(
          Namestandard, `alpha-2`
        ) %>% 
        distinct(), 
      by = c("firmname" = "Namestandard" )
    )  %>%
    left_join(
      qq_countrylu  %>%  
        select(`alpha-2`,  name)%>% 
        distinct(),
      by  =  c(  "alpha-2")
    ) %>% 
    rename(
      likely_country = name 
    ) %>% 
    select(
      -`alpha-2`
    )
  
  qq_z_patentpvp_filter_namescountryfill <-qq_sendthrumergers_country %>% 
    bind_rows(
      qq_z_patentpvp %>%
        
        mutate(
          applicant_upper = cleanupper(Applicant) 
        )   %>%
        # standardizenames_companies()
        # standardizenames_companies(zzluconames_df = lu_conames_out230705_match)
        standardizenames_companies(
          zz=., 
          whichcol_to_rename =.$applicant_upper, 
          zzluconames_df = qq_prevnamesmatch
        ) %>% 
        mutate(
          inventor = Namestandard
        ) %>% 
        filter(
          !is.na(Namestandard )#, 
          # !is.na(assignee_country ),
          # nchar(assignee_country)>=1, 
          # assignee_country!= "NA"
        ) %>% 
        rename(
          firmname = Namestandard
        )%>% 
        filter(
          !(firmname %in% c(qq_countrydf$Namestandard))
        ) %>% 
        mutate(
          assignee_country_standard = gsub(
            "] NA|NA", "", assignee_country
            
          )
        )%>%
        left_join(
          qq_countrylu  %>%  
            select(`alpha-2`,  name)%>% 
            distinct(),
          by  =  c("assignee_country_standard"=   "alpha-2")
        ) %>% 
        # select(
        #   -likely_country
        # ) %>% 
        rename(
          likely_country = name#, 
          # `alpha-2` = assignee_country_standard
        ) %>% 
        select(
          any_of(names(qq_sendthrumergers_country ))
        )
      
    ) %>% 
    group_by(
      firmname
    )  %>%
    mutate(
      total_patent_number = length(unique(patent_number))
    )%>%
    group_by(
      firmname, likely_country
    )  %>%
    mutate(
      total_patent_number_country = length(unique(patent_number))
    )%>%
    ungroup()%>%
    mutate(
      name = 
        gsub("Namibia|NAMIBIA NA", "", likely_country)
    ) %>%
    mutate(
      likely_country = cleanupper(likely_country)
    ) %>% 
    left_join(
      qq_countrylu  %>%  
        select(`alpha-2`,  name)%>%
        mutate(
          name = cleanupper(name)
        )  %>% 
        distinct(),
      by  =  c("likely_country"=   "name")
    ) %>%
    rename(
      countryabbr = `alpha-2`
    )%>%
    group_by(
      firmname,crop, patent_year, total_patent_number, likely_country,countryabbr, total_patent_number_country
    ) %>%
    summarise(
      numpatent_year =length(unique(patent_number ))
    ) %>%
    ungroup()   %>%  
    # mutate(
    #   countryabbrletter   =  gsub("[^A-Za-z]","",  countryabbr),
    #   countryabbrnum  =  gsub("[^0-9]","",  countryabbr)
    # )  %>% 
    mutate(
      # patent_info = paste0(crop, " ", patent_year," " ,  numpatent_year),
      country_info =  paste0(countryabbr, " ", crop, " ", patent_year," " ,  numpatent_year),
      countryinfo_short = paste0(countryabbr, " ", total_patent_number_country),
      countryinfo_long = paste0(likely_country, " ", total_patent_number_country),
      
    ) %>%
    group_by(
      firmname, total_patent_number
    ) %>%
    summarise(
      # patent_info = paste(patent_info %>% unique(), collapse = "; "),
      patent_info = paste(country_info %>% unique(), collapse = "; "),
      country_info = paste(countryinfo_short %>% unique(), collapse = "; "),
      countryinfo_long= paste(countryinfo_long %>% unique(), collapse = "; ")
      
      
    ) %>%
    ungroup()%>% 
    mutate(
      likely_country =str_squish(
        cleanupper(
          gsub(
            " \\d+","",  countryinfo_long
          )
        )
        
      ),
      likely_country =  gsub("NAMIBIA NA", "", likely_country)
    )   %>% 
    
    left_join(
      qq_countrylu  %>%  
        select(`alpha-2`,  name)%>%
        mutate(
          name = cleanupper(name)
        )  %>% 
        distinct(),
      by  =  c("likely_country"=   "name")
    ) # 
#   rm(qq_z_patentpvp)
#   rm(qq_countrylu)
#   rm(qq_prevnamesmatch)
#   rm(qq_sendhthrumergers)
#   rm(qq_sendthrumergers_country)
#   rm(qq_z_patentpvp)
#   rm(qq_z_patentpvp_clean)
#   rm(qq_z_patentpvp_filter_namescountryfill)
# rm(qq_countrydf)
# rm(qq_sendthrumergers)
  # rm(qq_z_mergerhistory)
  # rm(qq_z_mergerhistory_standard)
  # rm(qq_z_mergerhistory_standard_in_qq_countrydf)
qq_z_patentpvp_filter_namescountryfill %>% 
  bind_rows(
    qq_z_mergerhistory_standard_in_qq_countrydf  %>%
      filter(
        !firmname %in% c(qq_z_patentpvp_filter_namescountryfill$firmname)
      )%>%
        mutate(
          likely_country = cleanupper(likely_country)
        )
      
  ) %>% 
  select(
    firmname, likely_country, `alpha-2`, country_info, countryinfo_long
  )
}

 

 
  
```

#### outputnew lu actual func
```{r }

outputnewnamelu <- function(x_mergedatapath, y_prevLUpath, z_patentpvp, q_countrypath,q_countrylu = countryLU, writeoutnewLUfolder, writeoutnewLUfolderfilename, q_sendthrumergers){
  
  require(readxl)
  
  # x_mergedatapath ="X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx"
  # y_prevLUpath = "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230908 rename Lu seed cos.xlsx"
  # writeoutnewLUfolder = "X:/msi/work/farmer welfare/seed/company names LU"
  # z_patentpvp = pvppatent_combine_url_filter
  # writeoutnewLUfolderfilename = "230910 rename Lu seed cos"
  # q_countrypath= "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230908 rename Lu seed cos.xlsx"
  # q_sendthrumergers = soycropquery_merger
 cleanupper <- function(x){
   toupper(cleantext_text(x))
 }
  if(!dir.exists(writeoutnewLUfolder))
  {
    dir.create( writeoutnewLUfolder)
  }
 
 
 x_mergedata_pre <-  readxl::read_excel(
   x_mergedatapath, 
   sheet = "Sheet1"
   
 ) %>% 
   mutate(
     acquired_upper=cleanupper(Firm_acquired)  , 
     acquirer_upper = cleanupper(Firm_acquirer)
   ) %>% 
   
   select(
     acquired_upper, acquirer_upper, Year
   ) %>% 
   distinct() %>% 
   gather(
     key = category, 
     value = Applicant, 
     acquired_upper:acquirer_upper
   )
 
  x_mergedata <- x_mergedata_pre%>% 
   select(
     Applicant, Year
   ) %>% 
   distinct() %>% 
   filter(
     !is.na( Applicant)
   ) %>%
    group_by(
     Applicant
   ) %>% 
   summarise(
     total_patent_number = length(unique(Year))
   ) %>% 
   ungroup() 
 
  y_prevLU <- readxl::read_excel(
    y_prevLUpath, 
    range = cell_cols("A:B")
  ) %>% 
    filter(nchar(Applicant)>=2) %>% 
    filter(nchar(Namestandard)>=2) %>% 
    mutate(
      Applicant = cleanupper(Applicant) , 
      Namestandard = cleanupper(Namestandard )
    ) %>% 
    distinct()
  
  y_prevLU2 <- y_prevLU %>% 
    bind_rows(
      y_prevLU %>% 
        filter(
          !Namestandard %in% c( y_prevLU$Applicant)
        ) %>% 
        mutate(
          Applicant = Namestandard
        )
    )
  
  y_prevLU2_isinventorname_or_mergename <- z_patentpvp %>%
        
        mutate(
          applicant_upper = cleanupper(Applicant) 
        )   %>%
        # standardizenames_companies()
        # standardizenames_companies(zzluconames_df = lu_conames_out230705_match)
        standardizenames_companies(
          zz=., 
          whichcol_to_rename =.$applicant_upper, 
          zzluconames_df = y_prevLU2
        ) 
    
  
  z_patentpvp_clean <- z_patentpvp %>% 
  select(
    Applicant,patent_type, patent_number, patent_year, crop
  ) %>% 
  mutate(
    Applicant = cleanupper(Applicant) 
  ) %>% 
    filter(
      nchar(Applicant )>=2
    ) %>% 
  group_by(
    Applicant
  ) %>% 
  mutate(
    total_patent_number = length(unique(patent_number))
  )%>% 
  group_by(
    Applicant,crop, patent_year, total_patent_number
  ) %>% 
  summarise(
    numpatent_year =length(unique(patent_number ))
  ) %>% 
  ungroup() %>%  
  mutate(
    patent_info = paste0(crop, " ", patent_year," " ,  numpatent_year)
  ) %>% 
  group_by(
    Applicant, total_patent_number
  ) %>% 
  summarise(
    patent_info = paste(patent_info %>% unique(), collapse = "; ")
  ) %>% 
  ungroup() 
  
  # these are names from patents and mergedata that need standard names
# y_prevLU_names_i_donthave <-   z_patentpvp_clean %>% 
#         filter(
#           !Applicant %in% c(y_prevLU2$Applicant )
#         ) %>% 
#     bind_rows(
#       x_mergedata %>% 
#         filter(
#           !Applicant %in% c(y_prevLU2$Applicant )
#         ) 
#     )
  
# these are applicant names from patents and mergedata that are all i need

y_prevLU_names_i_want <-  z_patentpvp_clean %>% 
    bind_rows(
      x_mergedata
    ) 

y_prevLU_writeout <- y_prevLU2%>% 
  filter(
    !is.na(Namestandard ), nchar(Namestandard)>=2
  ) %>% 
  left_join(
    z_patentpvp_clean , 
    by = c("Applicant")
  ) %>% 
    bind_rows(
      z_patentpvp_clean %>% 
        filter(
          !Applicant %in% c(y_prevLU2$Applicant )
        )
    )%>% 
    bind_rows(
      x_mergedata %>% 
        filter(
          !Applicant %in% c(y_prevLU2$Applicant )
        ) 
    ) %>% 
  group_by(
    Applicant
  ) %>% 
  slice(1) %>% 
  ungroup()  %>% 
  arrange(
    Applicant
  ) 

z_countryLU <- 
appendcountrynamefunc(qq_countrypath =q_countrypath , qq_countrylu =countryLU, qq_sendthrumergers = q_sendthrumergers, qq_z_patentpvp = z_patentpvp, qq_prevnamesmatch =y_prevLU2, qq_z_mergerhistory = x_mergedata )

z_countryLU_withapplicant <- z_countryLU %>% 
  left_join(
    y_prevLU_writeout %>% 
      select(
        Applicant, Namestandard
      ) %>% 
      distinct(), 
    by = c("firmname" = "Namestandard")
  )

y_prevLU_writeout_w_country <- y_prevLU_writeout %>% 
  left_join(
    z_countryLU  , 
    by = c("Namestandard" = "firmname")
  ) %>% 
  left_join(
    y_prevLU_names_i_want %>% 
      bind_rows(
        z_countryLU_withapplicant
        )  %>% 
          select(
            Applicant
          ) %>% 
          distinct() %>% 
          mutate(
            is_name_i_need= "yes"
      ) %>% 
      select(
        Applicant, is_name_i_need
      ) %>% 
      distinct(), 
    by = c("Applicant")
  ) %>% 
  select(
    Applicant, Namestandard,likely_country, `alpha-2`,countryinfo_long, everything(),is_name_i_need
  )  

# %>% 
#    standardizenames_companies(
#           zz=., 
#           whichcol_to_rename =.$Applicant, 
#           zzluconames_df = y_prevLU2
#         ) 

# 
# y_prevLU_writeout %>% 
#   filter(
#     !(nchar(Namestandard ) >=2)
#   ) %>% 
#   View()
   y_prevLU_writeout_w_country %>% 
     writexl::write_xlsx(
       paste0(
          writeoutnewLUfolder, "/", 
          writeoutnewLUfolderfilename,
          ".xlsx"
       )
      
     )
  
}

```
####  use output func
```{r }

# "\\jna_nol\asus\msi\work\farmer welfare\seed\company names LU\230828 rename Lu seed cos.xlsx"
outputnewnamelu(
  x_mergedatapath ="X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx" ,
  y_prevLUpath = "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230910 rename Lu seed cos.xlsx", 
  writeoutnewLUfolder = "X:/msi/work/farmer welfare/seed/company names LU",
  z_patentpvp = pvppatent_combine_url_filter,
  writeoutnewLUfolderfilename = "230910b rename Lu seed cos", 
  q_countrypath= "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230910 rename Lu seed cos.xlsx",
  q_countrylu = countryLU,
  q_sendthrumergers = soycropquery_merger
  )

outputnewnamelu(
  x_mergedatapath ="X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx" ,
  y_prevLUpath = "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230908 rename Lu seed cos.xlsx", 
  writeoutnewLUfolder = "X:/msi/work/farmer welfare/seed/company names LU",
  z_patentpvp = pvppatent_combine_url_filter,
  writeoutnewLUfolderfilename = "230909 rename Lu seed cos", 
  q_countrypath= "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230908 rename Lu seed cos.xlsx",
  q_countrylu = countryLU,
  q_sendthrumergers = soycropquery_merger
  )
```


<!-- ```{r } -->


<!-- lu_conames_out230705  <- patent_pvp_combine_230705 %>%  -->
<!--   select( -->
<!--     Applicant,patent_type, patent_number, patent_year, crop -->
<!--   ) %>%  -->
<!--   mutate( -->
<!--     Applicant = toupper(cleantext_text(Applicant) )  -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--     Applicant -->
<!--   ) %>%  -->
<!--   mutate( -->
<!--     total_patent_number = length(unique(patent_number)) -->
<!--   )%>%  -->
<!--   group_by( -->
<!--     Applicant,crop, patent_year, total_patent_number -->
<!--   ) %>%  -->
<!--   summarise( -->
<!--     numpatent_year =length(unique(patent_number )) -->
<!--   ) %>%  -->
<!--   ungroup() %>%   -->
<!--   mutate( -->
<!--     patent_info = paste0(crop, " ", patent_year," " ,  numpatent_year) -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--     Applicant, total_patent_number -->
<!--   ) %>%  -->
<!--   summarise( -->
<!--     patent_info = paste(patent_info %>% unique(), collapse = "; ") -->
<!--   ) %>%  -->
<!--   ungroup()  %>%  -->
<!--   bind_rows( -->
<!--     mergerdata220918 %>%  -->
<!--       select( -->
<!--         contains("_clean" ) -->
<!--       )  %>%  -->
<!--       gather( -->
<!--        key =  key,  -->
<!--        value = Applicant,  -->
<!--        contains("_clean" ) -->
<!--       ) %>%  -->
<!--       select( -->
<!--         Applicant -->
<!--       ) -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--     Applicant -->
<!--   ) %>%  -->
<!--   slice(1) %>%  -->
<!--   ungroup() %>%  -->
<!--   #  -->
<!--   # group_by( -->
<!--   #   Applicant -->
<!--   # ) %>%  -->
<!--   # summarise( -->
<!--   #   numpatent = length(unique(patent_number )) -->
<!--   # ) %>%  -->
<!--   # ungroup() %>%  -->
<!--   left_join( -->
<!--     lu_conames_out230705_match , -->
<!--     by = c("Applicant" = "Applicant") -->

<!--   ) %>%  -->
<!--   arrange( -->
<!--     Applicant -->
<!--   ) %>%  -->
<!--   distinct() -->
<!--   # lu_conames_out230705 %>%  -->
<!--   #   select( -->
<!--   #     Applicant, Namestandard, everything() -->
<!--   #   )%>%  -->
<!--   #   writexl::write_xlsx( -->
<!--   #      "X:/msi/work/farmer welfare/seed/230706 rename Lu seed cos.xlsx" -->
<!--   #  -->
<!--   #        ) -->

<!--     lu_conames_out230705 %>%  -->
<!--     select( -->
<!--       Applicant, Namestandard, everything() -->
<!--     )%>%  -->
<!--     writexl::write_xlsx( -->
<!--        "X:/msi/work/farmer welfare/seed/230707 rename Lu seed cos.xlsx" -->
<!--     ) -->




<!-- ``` -->

```{r }
require(readxl)
  lu_conames_out230705_match <- readxl::read_excel(
     "X:/msi/work/farmer welfare/seed/company names LU/230910c rename Lu seed cos.xlsx", 
      range = cell_cols("A:D")
  ) %>% 
  filter(nchar(Applicant)>=2)
 
  lu_conames_out230705_match <- lu_conames_out230705_match   %>% 
  bind_rows(
    # this helps put the namestandard as a lookup
    lu_conames_out230705_match %>% 
      select(
        Namestandard
      ) %>% 
      mutate(
        Applicant = Namestandard
      )
      
  ) %>% 
    select(
      Applicant, Namestandard
    )%>% 
  distinct()
  


```

## useful standard name functions



### standardize firm name func
```{r }
standardizenames_companies <- function(zz, whichcol_to_rename, zzluconames_df){
  # whichcol_to_rename <- zz$acquirer_upper  
  # zz <- mergerdata220918 
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  )%>% 
   mutate(
     renamedcol1 = toupper(cleantext_text((renamedcol)))
   )
 
 # zz_df_uniquenames <- zz_df%>% 
 #   group_by(
 #     renamedcol1
 #   ) %>%  
 #   slice(1)%>% 
 #   ungroup()# %>% 
   # mutate(
   #   renamedcol1 = toupper(cleantext_text((renamedcol)))
   # )%>% 
   # group_by(
   #   renamedcol1
   # ) %>%  
   # slice(1)%>% 
   # ungroup()
 
zz_df_join <-zz_df %>% 
   left_join(
     zzluconames_df%>% 
       mutate(
         Name = toupper(cleantext_text(Applicant))
       )%>% 
       group_by(
         Name
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol1" = "Name"
     )
   )%>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     Namestandard = toupper(cleantext_text(Namestandard))
   )%>%   
   select(
     -contains("renamedcol")
   )
# zz_df_join <- zz_df %>% 
#   left_join(
#     zz_df_uniquenames_join %>% 
#       select(
#          Namestandard, renamedcol1, renamedcol
#       ) %>% 
#       distinct(), 
#    by = c("renamedcol" )
#   ) %>%   
#    select(
#      -contains("renamedcol")
#    )

# rm(zz_df_join)
# rm(zz)
# rm(zz_df)
# rm(zz_df_uniquenames)
# rm(zz_df_uniquenames_join)
# rm(whichcol_to_rename)
 zz_df_join
}

```

### import merger data
```{r }

mergerdata220918 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
)%>% 
  select(Firm_acquired, Firm_acquirer, Year, Crop, Column2)%>% 
  mutate(
    acquired_upper =toupper(cleantext_text(Firm_acquired) ) , 
    acquirer_upper = toupper(cleantext_text(Firm_acquirer) )
  )%>% 
  arrange(Year)%>% 
  mutate(
    idcol = paste0("merge", str_pad(string =row_number(), width = 5, pad = "0"))
  )
```

#### standardize co names
```{r }



mergerdata220918_names <- mergerdata220918 %>% 
  standardizenames_companies(
    ., 
    whichcol_to_rename =.$acquirer_upper , 
    zzluconames_df = lu_conames_out230705_match
    
    )%>%
  rename(
    # namestandard_acquirer_lower = renamedcol,
    namestandard_acquirer= Namestandard
  ) %>% 
  standardizenames_companies(
    ., 
    whichcol_to_rename = .$acquired_upper , 
    zzluconames_df = lu_conames_out230705_match 
  )%>%
  rename(
    # namestandard_acquired_lower = renamedcol,
    namestandard_acquired= Namestandard
  ) %>% 
  filter(
    # grepl(Column2,"yes", ignore.case = TRUE),
    # !is.na(Column2)
    tolower(Column2)=="yes"
  ) %>% 
  select(
    -acquired_upper, -acquirer_upper
  )
mergerdata220918_names_crop <- mergerdata220918_names %>% 
    standardizenames_crop(
    ., 
    zzwhichcol_to_rename =.$Crop,
    zzcroplistrfdf =croplistLU221126_2
    )%>%
   select(
     -Crop
   )%>%
   rename(
     crop = crop_shortname
   )  

```
#### check if any names not standardized
```{R }

mergerdata220918_names %>% 
  filter(
    (!namestandard_acquirer %in% c( lu_conames_out230705_match$Namestandard))|(!namestandard_acquired %in% c( lu_conames_out230705_match$Namestandard))
  ) %>% 
  View()

mergerdata220918_names  %>% 
  filter(
   (is.na(namestandard_acquirer) )|(is.na(namestandard_acquired) )
  ) %>% 
  select(
    contains("standard_"), everything()
  )%>% 
  View()

pvppatent_combine_url_filter  %>% 
  select(
    crop, shortname_220913
  ) %>% 
  distinct() %>% 
  filter(
   is.na(crop)
  )  %>% 
  View()


pvppatent_combine_url_filter  %>% 
    select(
        applicant_upper
    ) %>% 
    distinct() %>% 
    filter(
        
        (!applicant_upper %in% c( 
            (
                lu_conames_out230705_match %>% 
                    mutate(
                        Applicant=  toupper(cleantext_text(Applicant))
                    )
                
            )$Applicant)) 
    )  %>% 
    View()

```

## function for merger




## func to find lU 
### function to reduce down
```{r }

functionreduce_down_dups <- function(passthrudf, functionreduce_down_colthatisid = passthrudf$col_id_new, functionreduce_down_colthatiscrop = passthrudf$col_crop ,functionreduce_down_colthatisacquired = passthrudf$col_acquired ){
  # passthrudf <- sendthisoutdf_w_dup
  
passthrudf_prep <-  passthrudf%>% 
    cbind(
      tibble(
        functionreduce_down_colthatisidx = functionreduce_down_colthatisid
      ),
       tibble(
        functionreduce_down_colthatiscropx = functionreduce_down_colthatiscrop
      ),
       tibble(
        functionreduce_down_colthatisacquiredx = functionreduce_down_colthatisacquired
      )
      
    ) 
  
  passthrudf_wide <- passthrudf_prep %>% 
    select(functionreduce_down_colthatisidx,functionreduce_down_colthatiscropx, functionreduce_down_colthatisacquiredx, col_acquirer_new, ground_year)  %>%
    distinct() %>% 
    mutate(
      ground_year = paste0("YR_", ground_year)
    ) %>% 
    spread(
      key = ground_year, 
      value = col_acquirer_new
    ) 
  
  passthrudf_wide_colnames <-   passthrudf_wide %>% 
      select(contains("YR_")) %>% 
    names()
  
  passthrudf_wide_reduce <- passthrudf_wide %>% 
    replace(is.na(.), "none")%>% 
    group_by_at(c("functionreduce_down_colthatisacquiredx", "functionreduce_down_colthatiscropx", passthrudf_wide_colnames)) %>% 
    slice(1) %>% 
    ungroup() 
  
  passthru_df_reduce <- passthrudf_prep %>% 
    filter(
      functionreduce_down_colthatisidx %in% c(passthrudf_wide_reduce$functionreduce_down_colthatisidx)
    )
    
  # passthru_df_reduce <- passthrudf %>% 
  #   filter(
  #     !(col_id_new %in% c(passthrudf_wide_reduce$col_id_new))
  #   )
  # 
  # passthrudf_wide_reduce <- passthrudf_wide %>% 
  #   replace(is.na(.), "none")%>% 
  #   group_by_at(c("col_acquired", "col_crop", passthrudf_wide_colnames)) %>% 
  #   mutate(counter = n()) %>%
  #   ungroup() %>% 
  #   filter(
  #     counter >=2
  #   )
  
  passthru_df_reduce %>% 
    select(
      -contains("functionreduce_down")
    )
}
```

### func expand numrows in id
```{r }
func_expand_duprows_in_id <- function(x_expand_df, whichcolisid, prefix){
 # x_expand_df <- whichgetacquired_rename_withpast_direct 
 # whichcolisid<- x_expand_df$col_id_new2
 # prefix<- "dup"
 x_expand_df_expo_pre <- x_expand_df %>% 
   cbind(
     tibble(
       col_whichcolisid =whichcolisid
     )
   ) %>% 
   group_by(col_whichcolisid, ground_year) %>% 
   mutate(
     howmany = length(unique(col_acquirer_new))
   ) %>% 
   ungroup() %>% 
   group_by(
     col_whichcolisid
   ) %>% 
   mutate(
     max_number = max(howmany)
   ) %>% 
   ungroup()
 # x_expand_df_expo_pre %>% 
 #   filter(col_crop =="blueberry") %>% 
 #   arrange(
 #     col_id_new2, ground_year
 #   ) %>% 
 #   View()
 x_expand_df_expoed <- x_expand_df_expo_pre %>% 
   filter(howmany  <max_number ) %>% 
   slice(rep(row_number(), max_number))
  
  x_expand_df_expoed_reid <- x_expand_df_expo_pre %>% 
    bind_rows(
      x_expand_df_expoed  
    ) %>% 
    group_by(
      col_whichcolisid, ground_year
    ) %>% 
    arrange(
      col_acquirer_new
    ) %>% 
    mutate(
      col_whichcolisid_new = 
        case_when(
          max_number >=2 ~  paste0(col_whichcolisid ,prefix, row_number() ), 
          TRUE ~ paste0(col_whichcolisid)
        )
       
    ) %>% 
    ungroup() %>% 
    select(
      col_whichcolisid_new, everything(),-howmany, -max_number #,
      # c("col_whichcolisid_new", names(x_expand_df))
    )
    x_expand_df_expoed_reid

  
}

```

### func split row by semicolon
```{r }
splitrowbysemicolon <- function(x_splitrowdf, df_with_names_splitrowdf, whichcoltotrans, if_id_col= "no", currentit = 0, prefix = ""){
 outputthisdf <- x_splitrowdf %>% 
    mutate(
      temprowid = row_number()
             
           ) %>% 
    cbind(
      tibble(
      coltotrans=  whichcoltotrans
      )
    ) %>% 
           group_by(
             temprowid
             # col_crop, col_id, ground_year, newnametemp
           ) %>% 
           mutate(
             coltotransnew =  paste(sort(unique(coltotrans ),decreasing = TRUE) , collapse = "; ")
             
           ) %>%
           ungroup() %>% 
           separate_rows(coltotransnew, sep = "; ") %>%
           group_by_at(
             c("temprowid",  names(df_with_names_splitrowdf) )
           ) %>%
           summarise(coltotrans = paste(sort(unique(coltotransnew),decreasing = TRUE), collapse = "; "))%>%
           ungroup() %>% 
           select(
             -temprowid 
           )
  
  if(   if_id_col == "yes") 
 {
    outputthisdf <- outputthisdf%>% 
      # group_by(
      #   coltotrans, ground_year, col_acquirer_new, col_acquired
      # ) %>% 
      # slice(1) %>% 
      # ungroup() %>% 
      # group_by(
      #   coltotrans, ground_year
      # )%>% 
      # arrange(
      #   col_acquirer_new
      # ) %>% 
      mutate(
        coltotrans = paste0("{", currentit,prefix,  "}",  coltotrans)

        # coltotrans = paste0("{", currentit,"-", row_number(), "}",  coltotrans)
      ) %>% 
      ungroup()
  } 
 outputthisdf
}

```

### search function by company
```{r }
findids_with_textfunc <- function(findids_df, textstringdf, textstringcrop = "canola"){
  
       findids_with_textfunc_df <- findids_df %>% 
      filter(
        col_crop == textstringcrop
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 
findids_with_textfunc_ids <- findids_with_textfunc_df %>% 
  filter(grepl(textstringdf, col_acquirer_new, ignore.case = TRUE, perl = TRUE)) %>% 
  select(col_id_new) %>% 
  distinct()
findids_with_textfunc_df %>% 
  filter(
    col_id_new %in% c(findids_with_textfunc_ids$col_id_new)
  ) %>% 
  View()

  
}
```

## do it by year func
```{r }
# go up in years; if there was change that year, then change temp df and go up. Change name permanently. 
# list_of_sendthrus <- list()
# list_of_sendthrus <- sendthroughmergers_LUlist

findparentcompanyfunc_LU <- function(
    x,acquirercol, acquiredbycol,cropcol,  yearcol,idcol,   filenamergename = "221119try",folderoutname =   "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821"  ,sendcroplist = croplistLU221126_2  
    ){
 
  minyear = x$Year %>% min()
  maxyear = x$Year %>% max()
  #   x=mergerdata220918_names_crop
  # acquirercol =mergerdata220918_names_crop$namestandard_acquirer
  # acquiredbycol=mergerdata220918_names_crop$namestandard_acquired
  # cropcol=mergerdata220918_names_crop$crop
  # yearcol=mergerdata220918_names_crop$Year
  # idcol=mergerdata220918_names_crop$idcol
  # filenamergename = "230821try.feather"
  # minyear = mergerdata220918_names_crop$Year %>% min()
  # maxyear = mergerdata220918_names_crop$Year %>% max()
  # folderoutname =  "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821"
  # sendcroplist = croplistLU221126_2

  # df_patents = soycropquery_unnest_df_likelyplants_themed_short  %>%
  #   mutate(
  #     acquired_all_rowid = row_number()
  #   )
  # tickerflag = 0
  if(!dir.exists(folderoutname))
  {
    dir.create(folderoutname)
  }
  x_df <- x %>% 
    cbind(
      tibble(
        col_acquirer = acquirercol
      ),
      tibble(
        col_acquired = acquiredbycol
      ), 
      tibble(
        col_year = yearcol
      ), 
      tibble(
        col_crop = cropcol
      ),
      tibble(
        col_id = idcol
      )
    )%>% 
    select(
      starts_with("col_")
    )%>% 
    
  group_by(
    col_acquirer, col_acquired , col_year, col_id, col_crop
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(
    # Column2== "Yes",
    col_acquirer !=col_acquired 
  )# %>% 
    # group_by(
    #   col_acquired , col_year, col_id, col_crop
    # ) %>% 
    # mutate(
    #   col_id = paste0
    # )
  
  x_df2 <- x_df %>% 
    select(
      col_acquirer, col_acquired , col_year, col_crop,col_id
  )
    
  

  

  # lucrossing <- crossing(
  #   year_ground = minyear:maxyear,
  #   firmname = c(acquirercol,acquiredbycol )%>% unique(),
  #   crop =  c(
  #     df_patents$crop%>% unique(),
  #     (x_df %>% filter(!is.na(col_crop)))$col_crop %>% unique()
  # 
  #   )
  # )%>%
  #   distinct()
  
   
  
  currentyearmergers_cross_allyears_pre <- crossing(
    col_crop =c(
      sendcroplist$shortname %>% unique(), 
      (x_df %>% 
         filter(!is.na(col_crop)))$col_crop
    ) %>% unique()
  )%>% 
    mutate(
      joincol = "join"
    ) %>% 
    left_join(
      x_df2 %>% 
        filter(
          is.na(col_crop) 
        ) %>% 
        select(
          col_acquirer, col_acquired ,col_year, col_id
        ) %>% 
        distinct() %>% 
        mutate(
          joincol = "join"
        ),
      by = c("joincol")
    ) %>% 
    bind_rows(
      x_df2 %>% 
        filter(
          !is.na(col_crop) 
        ) %>% 
        select(
          col_acquirer, col_acquired , col_crop,col_year, col_id
        )
    ) %>% 
    select(
      -joincol
    ) %>% 
    group_by(
      col_acquirer, col_acquired , col_crop ,col_year, col_id
    ) %>% 
    slice(1) %>% 
    ungroup()%>% 
    mutate(
      col_id = paste0(col_id, "]", col_crop)
    ) 
  
currentyearmergers_cross_allyears<-   currentyearmergers_cross_allyears_pre%>% 
    group_by(
      col_acquirer, col_acquired , col_crop ,col_year, col_id
      )%>%
    mutate(
      repnum = maxyear - min(col_year) +1
    ) %>% 
     slice(rep(row_number(), repnum)) %>% 
  mutate(
    # rownum = row_number(),
    ground_year = row_number()-1 + col_year
  ) %>% 
  ungroup() %>% 
  select(
    -repnum
  ) 


#### examine
soycropquery_merger_stone <- currentyearmergers_cross_allyears %>%
  filter(
    grepl("chemchina", col_acquired,ignore.case = TRUE, perl = TRUE)
  ) %>%
      arrange(
       col_crop,ground_year
     ) 

     #%>% 
    # filter(
    #   grepl("stonevill", col_acquired, ignore.case=TRUE)
    # )
  # soycropquery_merger_stone <- currentyearmergers_cross_allyears %>% 

  
  # lucrossingtemp <- lucrossing
i <-1
# maxyear = 2022

yearsgothru = c(minyear:maxyear) %>% unique() %>% sort()
# tickerflag = 0
# sendthroughmergers_LU <- feather::read_feather(
#   "X:/msi/work/farmer welfare/seed/R analysis/merger/221105_merged_2001.feather"
# )
# i <-
rm(list_of_sendthrus)
list_of_sendthrus <- list()
  while(i <= length(yearsgothru))
  {
    currentyear = yearsgothru[i]
    # #remove this
    # currentyear <- 1987
    # i <- which(yearsgothru == currentyear)
    
    #
    if(i ==1)
    {
      list_of_sendthrus[[i]] <- currentyearmergers_cross_allyears %>% 
        mutate(
          #need to change name of acquirer 
          col_acquirer_new = col_acquirer, 
          col_acquired_new = col_acquired,
          col_id_new = col_id
        ) %>% 
        # group_by(
        #   col_crop, col_acquirer
        # ) %>% 
        mutate(
          old_acquirer = 
            paste0(
              col_year,"-", col_acquirer,"-",col_acquired
            ),
          newnametemp = old_acquirer
          
          
          # paste0(min(col_year), "-",col_acquirer )
        ) %>% 
        ungroup() 
      list_of_sendthrus[[i]] <- list_of_sendthrus[[i]] %>% 
        distinct() #%>% 
      # mutate(
      #   rowid_original = row_number()
      # )
      
      # sendthroughmergers_LU_current <- sendthroughmergers_LU %>% 
      #   filter(col_year == currentyear)
    }
    # if(i >1)
    # {
    #   sendthroughmergers_LU_current <- sendthroughmergers_LU %>% 
    #     filter(col_year == currentyear)
    # }
    # list_of_sendthrus[[i]]  <-  list_of_sendthrus[[i]]   %>% 
    # mutate(
    #   currentrowid = row_number()
    # )
    sendthroughmergers_LU_current <- list_of_sendthrus[[i]] %>% 
      filter(col_year == currentyear, ground_year == currentyear) # %>% 
    # mutate(
    #   currentrowid = row_number()
    # )
    # list_of_sendthrus[[i]] %>%
    #   filter(
    #     col_crop == "sugarbeet",
    #     col_acquired == toupper(  "sensako")
    #   ) %>% 
    #   arrange(col_id_new,ground_year) %>% View()
    # sendthroughmergers_LU_current %>%
    #   filter(
    #     col_crop == "sugarbeet",
    #     col_acquired == "SYNGENTA"
    #   ) %>% 
    #   arrange(col_id_new,ground_year) %>% View()
    #     list_of_sendthrus[[i]] %>% 
    #   filter(
    #     col_crop == "blueberry", 
    #     col_acquired == "STONEVILLE PEDIGREED SEED"
    #   ) %>% 
    #       View()

    
    if(nrow(sendthroughmergers_LU_current)<1)
    {
      rm(sendthroughmergers_LU_current)
      list_of_sendthrus[[i+1]] <- list_of_sendthrus[[i]]
      i <-i+1
      next
    }
# 
#     if(currentyear == 2018)
#     {
#       break
#     }

    # if(!nrow(sendthroughmergers_LU_current)<1)
    # {
    #   break    }
    # # if(nrow(sendthroughmergers_LU_current)>=1)
    # {
    #   # i <-i+1
    #   break
    # }
    # 
    # currentyearmergers <- x_df2 %>%
    #     filter(col_year == currentyear)
    
    # 
    # currentyearmergers_cross <- sendthroughmergers_LU_current %>% 
    #   filter(
    #     col_year == 
    #   )
    #   currentyearmergers_cross <- crossing(
    #     col_crop = lucrossing$crop %>% unique()
    #   )%>% 
    #     mutate(
    #       joincol = "join"
    #     ) %>% 
    #     left_join(
    #       #first create a frame with all crops and mergers that year
    #       sendthroughmergers_LU_current %>% 
    #         filter(
    #           is.na(col_crop) 
    #         ) %>% 
    #         select(
    #           name_new, col_acquired 
    #         ) %>% 
    #         mutate(
    #           joincol = "join"
    #         ),
    #       by = c("joincol")
    #     ) %>% 
    #     #bind it to those where we have specific crop
    #     bind_rows(
    #       sendthroughmergers_LU_current %>% 
    #         filter(
    #           !is.na(col_crop) 
                                                                                                                                                                                                                                    #         ) %>% 
    #         select(
    #           name_new, col_acquired , col_crop 
    #         )
    #     ) %>% 
    #     select(
    #       -joincol
    #     ) %>% 
    #     mutate(
    #       col_year = currentyear
    #     ) %>% 
    #     group_by(
    #       name_new, col_acquired , col_crop ,col_year
    #     ) %>% 
    #     slice(1) %>% 
    #     ungroup()
    
    
    # sendthroughmergers_LUnew <-  sendthroughmergers_LU %>% 
    #  filter(col_year > currentyear) %>% 
    #   filter(
    #     col_acquirer %in% c(sendthroughmergers_LU_current$col_acquired)
    #   )
    # 
    # sendthroughmergers_LUnew %>% filter(grepl("cal", col_acquirer, ignore.case=TRUE)) %>% View()
    
    # change those upstream     
    sendthroughmergers_LU_current_edit_pre <- sendthroughmergers_LU_current %>% 
      mutate(
        newnametemp = 
          case_when(
            col_acquirer_new == col_acquirer ~   paste0(
              col_year,"-", col_acquirer,"-",col_acquired
            ), 
            TRUE ~ paste0(
              col_year,"-", col_acquirer_new,"-",col_acquirer,"-",col_acquired
            )
          )  ,
        old_acquirer = newnametemp
      ) 
    
    
      ###   needs   to  be a checker THAT CHECKS IF THose within that year are acquired in that year. If yes, then changes over; if there are those that get acquired later, then retains those and makes duplicate 
  
  check_if_sameyear_acquired<-sendthroughmergers_LU_current_edit_pre  %>% 
    inner_join(
      sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        ) %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop","col_acquirer_new" )
    ) 
    check_if_sameyear_acquirer <-sendthroughmergers_LU_current_edit_pre %>% 
    inner_join(
      sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquirer_new
        ) %>% 
        rename(
          col_acquired  =col_acquirer_new
        ) %>% 
        distinct(),
      by = c("col_crop", "col_acquired" )
    ) %>% 
      anti_join(
        sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        )  %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop", "col_acquirer_new" )
      )

  if(nrow(check_if_sameyear_acquired) >= 1)
  {
    sendthroughmergers_LU_current_edit_replaceacquired <- 
      check_if_sameyear_acquired %>% 
      rename(
        col_acquirer_new1 = col_acquirer_new
      ) %>% 
      inner_join(
        check_if_sameyear_acquirer %>% 
          rename(
             newnametemp2 =  newnametemp
          ) %>% 
          select(
            col_acquirer_new, col_acquired, col_crop,  newnametemp2
          ) %>% 
          distinct(), 
        by = c("col_acquirer_new1" = "col_acquired", "col_crop")
      ) %>% 
      mutate(
         newnametemp =  paste0 ( newnametemp,"; " , newnametemp2)
      ) %>% 
      select(
        -newnametemp2, -col_acquirer_new1
      ) 
      
    
    sendthroughmergers_LU_current_edit_withfuture <- sendthroughmergers_LU_current_edit_pre%>% 
      filter(
        !col_id_new %in% c(sendthroughmergers_LU_current_edit_replaceacquired$col_id_new)
      ) %>% 
      
      bind_rows(
       sendthroughmergers_LU_current_edit_replaceacquired, 
        
        check_if_sameyear_acquired%>% 
          inner_join(
            x_df2 %>% 
              filter(col_year >currentyear) %>% 
              select( 
                col_crop, col_acquired
              ) %>% 
              rename(
                col_acquirer_new = col_acquired
              ) %>% 
              distinct(),
            by = c("col_crop", "col_acquirer_new"  )
          )
      ) %>% 
      anti_join(
        sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        )  %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop", "col_acquirer_new" )
      )
    
    
    sendthroughmergers_LU_current_edit_withfuture_dup <- sendthroughmergers_LU_current_edit_withfuture%>% 
      group_by(
        col_id_new, ground_year
      ) %>%
      mutate(
        count = length(unique(col_acquirer_new))
      ) %>%
      filter(
        count >=2
      ) 
    
# if(nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1  )
# {
# 
# 
#   print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
#    print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
#   print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
# #    sendthroughmergers_LU_current_edit_withfuture_expodup <-sendthroughmergers_LU_current_edit_withfuture    %>%
# #         func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>%
# #         ungroup() %>%
# #         select(
# #           -col_id_new
# #         ) %>%
# #         rename(
# #           col_id_new = col_whichcolisid_new
# #         )
# # sendthroughmergers_LU_current_edit_withfuture_expodup %>%
# #   filter(
# #     grepl("merge00488]", col_id_new, perl = TRUE),
# #     col_crop == "blueberry"
# #   )  %>%
# #   arrange(
# #     col_id_new, ground_year
# #   ) %>%
# #   View()
# break
# }
    sendthroughmergers_LU_current_edit_withfuture_reid <- sendthroughmergers_LU_current_edit_withfuture%>% 
      filter(!col_id_new %in% c(sendthroughmergers_LU_current_edit_withfuture_dup$col_id_new)) %>% 
      bind_rows(
        # this next step will 
        sendthroughmergers_LU_current_edit_withfuture %>% 
          filter(
            col_id_new %in% c(sendthroughmergers_LU_current_edit_withfuture_dup$col_id_new)
          ) %>% 
          group_by(col_id_new) %>% 
          arrange(col_acquirer_new) %>% 
          mutate(col_id_new = paste0(col_id_new, row_number())) %>% 
          ungroup()
        
        
      )

    sendthroughmergers_LU_current_edit <- sendthroughmergers_LU_current_edit_withfuture_reid  %>% 
        distinct()    
    
    

  # sendthroughmergers_LUnew_pre_names_newid_final_acquired <-  sendthroughmergers_LUnew_pre_names_newid_final %>% 
  #     filter(
  #       
  #       # grepl(
  #       #   paste(unique(check_if_sameyear_acquirer$col_id_new), collapse = "|"), 
  #       #   col_id_new, 
  #       #   perl = TRUE, ignore.case = TRUE
  #       # ), 
  #       ground_year >= currentyear
  #     ) 
  #   
  }
    if(!(nrow(check_if_sameyear_acquired) >= 1))
    {
      sendthroughmergers_LU_current_edit <- sendthroughmergers_LU_current_edit_pre %>% 
        distinct()
    }
# 
#     sendthroughmergers_LU_current_edit %>%
#       filter(
#         col_crop == "blueberry"
#       ) %>%
#       arrange(
#         col_id_new, ground_year
#       )%>%
#       View()
    # if(nrow(sendthroughmergers_LU_current_edit) >=2)
    # {
    #   break
    # }
    # more like which get transferred
    # whichgetacquired <-  list_of_sendthrus[[i]] %>% 
    #       filter(ground_year >= currentyear) %>% 
    #      inner_join(
    #        list_of_sendthrus[[i]]  %>%
    #          filter(
    #            col_year >= currentyear
    #          ) %>% 
    #          select(
    #            col_acquired_new, col_crop, col_acquirer_new 
    #          ) %>% 
    #          distinct(),
    #          # rename(
    #          #   col_acquirer_shouldnotbe = col_acquirer, 
    #          #   name_new_shouldnotbe = name_new
    #          # ),
    #        by = c("col_acquired" = "col_acquired_new", "col_crop" )
    #      )   %>% 
    #       mutate(
    #         newnametemp.x = paste0(
    #           newnametemp, "; ", newnametemp.x
    #           
    #         )
    #       ) %>% 
    #       select(
    #         -newnametemp
    #       ) %>% 
    #       rename(
    #        newnametemp = newnametemp.x, 
    #        old_acquirer = old_acquirer.x
    #       ) %>% 
    #       select(
    #         starts_with("col_"), ground_year, name_new, newnametemp, old_acquirer
    #       
    #       ) %>% 
    #       distinct()
    # sendthroughmergers_LUnew_pre <-  list_of_sendthrus[[i]] %>% 
    #   filter(ground_year >= currentyear) %>% 
    #      rename(
    #        col_id_new1 = col_id_new
    #      ) %>% 
    #   filter(
    #     grepl("mycogen", col_acquirer_new, ignore.case = TRUE, perl = TRUE)
    #   )
    # 
    sendthroughmergers_LUnew_pre_onlyid <-  list_of_sendthrus[[i]] %>% 
      filter(ground_year >= currentyear) %>% 
      rename(
        col_id_new1 = col_id_new
      ) %>% 
      # select(
      #   -col_id_new
      # ) %>%
      # mutate(
      #   old_acquired = col_acquired
      # ) %>% 
      inner_join(
        sendthroughmergers_LU_current_edit %>% 
          select(
            # -col_year,-col_acquirer, -ground_year , -col_id
            col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
            col_id_new
          ),
        # rename(
        #   name_new = col_acquirer
        # ), 
        by = c(
          "col_crop", "col_acquirer_new" = "col_acquired"
        )
      )
    # save.image("X:/msi/work/farmer welfare/seed/journal/221231 save both before merger and after troubleshoot.RData")
  sendthroughmergers_LUnew_pre <-    list_of_sendthrus[[i]] %>% 
      filter(ground_year >= currentyear) %>% 
      rename(
        col_id_new1 = col_id_new
      ) %>% 
    filter(col_id_new1 %in% c(sendthroughmergers_LUnew_pre_onlyid$col_id_new1))%>%
    left_join(
        sendthroughmergers_LU_current_edit %>% 
          select(
            # -col_year,-col_acquirer, -ground_year , -col_id
            col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
            col_id_new
          ),
        # rename(
        #   name_new = col_acquirer
        # ), 
        by = c(
          "col_crop", "col_acquirer_new" = "col_acquired"
        )
      ) %>% 
    mutate(
      col_acquirer_new.y = coalesce(col_acquirer_new.y, col_acquirer_new)
    ) %>% 
    group_by(
     col_id_new1 
    ) %>% 
    arrange(
      ground_year
    ) %>% 
    tidyr::fill(
      newnametemp.y, col_id_new
    ) %>% 
    tidyr::fill(
      col_id_new,  .direction = "up"
    ) %>% 
    ungroup() %>% 
      mutate(
        # newnametemp.y = coalesce( newnametemp.y, )
        newnametemp = 
          case_when(
            !is.na(newnametemp.y)~
          paste0( 
            newnametemp.y, 
            "; ", 
            newnametemp.x
            #gets the first year
            # substr(old_acquirer.x,1,4),
            # "-",
            #then gets current new acquirer
            # col_acquirer_new.y,
            # "-", 
            # col_acquirer_new,
            # gsub(".*-", "-",old_acquirer.x ), 
            #  "; ", newnametemp.y 
          ), 
          TRUE ~ newnametemp.x
          ),
        #col_id_new is from current year mergers
        #col_id_new1 is original from future merger
        #col_id_new2 is new 
        col_id_new2 = paste0(
          col_id_new1  , 
          "; ", col_id_new
        )
        
        # TRUE ~ newnametemp.y
        #,
        # col_id = col_id.x
      )  %>% 
      # select(
      #   -col_id_new1
      # ) %>% 
      select(
        -col_acquirer_new,-col_id_new
      )%>% 
      rename(
        # needs_to_change = col_acquirer_new, 
        col_acquirer_new = col_acquirer_new.y
      )    %>% 
      select(
        -newnametemp.x, -newnametemp.y, 
        -contains("old_acquirer"),
        -contains(".x"),  -contains(".y")
      ) %>%
      distinct() %>% 
      mutate(
        old_acquirer = paste0(
          newnametemp
          # paste0(
          #   col_year,"-", name_new.y,"-",col_acquirer,"-",col_acquired
          # ),
          # "; ", newnametemp
        )
      )
  # sendthroughmergers_LUnew_pre%>%
  #     filter(
  #       col_crop == "blueberry"
  #     ) %>%
  #     arrange(
  #       col_id_new1, ground_year
  #     )%>%
  #     View()
    #   if(nrow(sendthroughmergers_LUnew_pre) >=2)
    # {
    #   break
    # }

  ### Below is how it was previously; changed to above with left join, coalesce, and fill bc below step with inner join was omitting future acquisitions
    # sendthroughmergers_LUnew_pre <-  list_of_sendthrus[[i]] %>% 
    #   filter(ground_year >= currentyear) %>% 
    #   rename(
    #     col_id_new1 = col_id_new
    #   ) %>% 
    #   # select(
    #   #   -col_id_new
    #   # ) %>%
    #   # mutate(
    #   #   old_acquired = col_acquired
    #   # ) %>% 
    #   left_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
    #         col_id_new
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquirer_new" = "col_acquired"
    #     )
    #   )%>% 
    #   mutate(
    #     # newnametemp.y = coalesce( newnametemp.y, )
    #     newnametemp = 
    #       # case_when(
    #       #   !is.na(newnametemp.x)~ 
    #       paste0( 
    #         newnametemp.y, 
    #         "; ", 
    #         newnametemp.x
    #         #gets the first year
    #         # substr(old_acquirer.x,1,4),
    #         # "-",
    #         #then gets current new acquirer
    #         # col_acquirer_new.y,
    #         # "-", 
    #         # col_acquirer_new,
    #         # gsub(".*-", "-",old_acquirer.x ), 
    #         #  "; ", newnametemp.y 
    #       ),
    #     #col_id_new is from current year mergers
    #     #col_id_new1 is original from future merger
    #     #col_id_new2 is new 
    #     col_id_new2 = paste0(
    #       col_id_new1  , 
    #       "; ", col_id_new
    #     )
    #     
    #     # TRUE ~ newnametemp.y
    #     #,
    #     # col_id = col_id.x
    #   )  %>% 
    #   # select(
    #   #   -col_id_new1
    #   # ) %>% 
    #   select(
    #     -col_acquirer_new,-col_id_new
    #   )%>% 
    #   rename(
    #     # needs_to_change = col_acquirer_new, 
    #     col_acquirer_new = col_acquirer_new.y
    #   )    %>% 
    #   select(
    #     -newnametemp.x, -newnametemp.y, 
    #     -contains("old_acquirer"),
    #     -contains(".x"),  -contains(".y")
    #   ) %>%
    #   distinct()
    # 
    #   extract_df <-   sendthroughmergers_LUnew_pre %>%
    #     filter(
    #       col_crop == "blueberry", 
    #       col_acquired == "CARGILL"
    #     ) %>%
    # arrange(col_id_new2, ground_year)
  

  #   
  # extract_df<-  sendthroughmergers_LUnew_pre %>%
  #     filter(
  #       col_crop == "blueberry"
  #     ) %>% 
  #     arrange(
  #       col_id_new2, ground_year
  #     )%>%  
  #     View()
        # #     
  #              sendthroughmergers_LUnew_pre %>%
  #         group_by(
  #           col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new2
  #         ) %>%
  #         arrange(
  #           col_crop
  #         ) %>%
  #         slice(1) %>%
  #         ungroup() %>%
  #                     filter(
  #       grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #       col_id_new2, ground_year
  #     ) %>%
  #         View()
  # 
  #              
  #  extract_df<-  list_of_sendthrus[[i]]  %>%
  #     group_by(
  #         col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
  #     ) %>%
  #     arrange(
  #         col_crop
  #     ) %>%
  #     slice(1) %>%
  #     ungroup() %>%
  #     filter(
  #         grepl("SUNSEEDS", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #         col_id_new, ground_year
  #     )
  # extract_df %>%
  #     filter(
  #         !grepl("Hoechst", col_acquirer_new, perl = TRUE , ignore.case = TRUE)
  #     )%>%
  #     View()
  # 
  #  extract_df_agrevo <-  list_of_sendthrus[[i]]  %>%
  #     group_by(
  #         col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
  #     ) %>%
  #     arrange(
  #         col_crop
  #     ) %>%
  #     slice(1) %>%
  #     ungroup() %>%
  #     filter(
  #         grepl("agrevo", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #         col_id_new, ground_year
  #     )  
  
    # 
    #          sendthroughmergers_LUnew_pre %>%
    #            group_by(
    #              col_crop, col_acquired, col_acquirer_new
    #            ) %>%
    #            mutate(
    #              num = length(unique(col_id_new))
    #            ) %>%
    #            ungroup() %>%
    #            filter(
    #              num >=2
    #            )%>%
    #            View()
    # extract_df_pre <-   list_of_sendthrus[[i]] %>%
    # filter(
    #     col_acquired == "STONEVILLE PEDIGREED SEED",
    #     col_crop == "blueberry"
    # ) %>%
    # arrange(col_id_new, ground_year)
    # 
    # extract_df <- extract_df_pre %>% 
    #   filter(col_id_new %in% c(extract_df_pre$col_id_new))
      
    # sendthroughmergers_LUnew_notchangename_onlyid <-  list_of_sendthrus[[i]] %>% 
    #   # filter(
    #   #   !rowid_original %in% c(sendthroughmergers_LU_current_edit$rowid_original)
    #   # ) %>% 
    #   # # need to keep below 
    #   # filter(ground_year >= currentyear)  %>%
    #   # # mutate(
    #   # #   old_acquired = col_acquired
    #   # # ) %>% 
    #   anti_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquirer_new" = "col_acquired"
    #     )
    #   )  %>% 
    #   anti_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquired" = "col_acquired"
    #     )
    #   ) 
    # sendthroughmergers_LUnew_notchangename <- list_of_sendthrus[[i]] %>%  
    #   filter(
    #     (col_id_new %in% c(sendthroughmergers_LUnew_notchangename_onlyid$col_id_new))
    #   )
    # 
  sendthroughmergers_LUnew_pre_unique <- sendthroughmergers_LUnew_pre %>% 
    group_by(col_id_new2, newnametemp) %>% 
    slice(1) %>% 
    ungroup()# %>% 
    # mutate(
    #   col_id_new2old = col_id_new2, 
    #   newnametempold = newnametemp
    # )
      
    sendthroughmergers_LUnew_pre_tobind <-  sendthroughmergers_LUnew_pre_unique  %>% 
      splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "") %>%
      mutate(
        col_id_new2replace = coltotrans
      ) %>%
      select(
        -coltotrans
      )
    # 
    
    sendthroughmergers_LUnew_pre_names_unique <-sendthroughmergers_LUnew_pre_tobind %>% 
      splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$old_acquirer, if_id_col= "no")%>% 
      mutate(
        old_acquirer2replace = coltotrans
      ) %>% 
      select(
        -coltotrans
      )
    
    sendthroughmergers_LUnew_pre_names <- sendthroughmergers_LUnew_pre %>% 
      left_join(
        sendthroughmergers_LUnew_pre_names_unique %>% 
          select(
            col_id_new2replace, old_acquirer2replace, old_acquirer, col_id_new2
          ) %>% 
          distinct()   ,
        by = c("col_id_new2", "old_acquirer")
      ) %>% 
      select(-col_id_new2, -old_acquirer) %>% 
      rename(
        old_acquirer = old_acquirer2replace, 
        col_id_new2 = col_id_new2replace
      )
    
    # sendthroughmergers_LUnew_pre_names%>%
    # filter(
    #     col_crop == "blueberry"
    # ) %>%
    # arrange(
    #     col_id_new1, ground_year
    # )%>%
    # View()


    # 
    # sendthroughmergers_LUnew_pre_names <-sendthroughmergers_LUnew_pre_tobind %>% 
    #   mutate(
    #     old_acquirer = paste0(
    #       newnametemp
    #       # paste0(
    #       #   col_year,"-", name_new.y,"-",col_acquirer,"-",col_acquired
    #       # ),
    #       # "; ", newnametemp
    #     ),
    #     temprowid = row_number()
    #     
    #   ) %>% 
    #   group_by(
    #     temprowid
    #     # col_crop, col_id, ground_year, newnametemp
    #   ) %>% 
    #   mutate(
    #     old_acquirernew =  paste(sort(unique(old_acquirer ),decreasing = TRUE) , collapse = "; ")
    #     
    #   ) %>%
    #   ungroup() %>% 
    #   separate_rows(old_acquirernew, sep = "; ") %>%
    #   group_by_at(
    #     c("temprowid",  names(sendthroughmergers_LUnew_pre_tobind) )
    #   ) %>%
    #   summarise(old_acquirer = paste(sort(unique(old_acquirernew),decreasing = TRUE), collapse = "; "))%>%
    #   ungroup() %>% 
    #   select(
    #     -temprowid 
    #   )# %>%
    if(!(nrow(sendthroughmergers_LUnew_pre) >=1 ))
    {
      # rm(sendthroughmergers_LU_current_edit)
      # rm(sendthroughmergers_LUnew_pre)
      # list_of_sendthrus[[i+1]] <- list_of_sendthrus[[i]]
      # 
      #  i <-i+1
      #  next
      #doesn't really matter what is sent in so long (nrow is 0 so just send in empty frame)
      sendthroughmergers_LUnew_pre_names_newid_final <-  sendthroughmergers_LUnew_pre_names %>% 
        select(
         -contains("col_id_new2"), -contains("col_id_new1")
        ) %>% 
        distinct()
      
    sendthroughmergers_LUnew_notchangename1 <- list_of_sendthrus[[i]]
  
      
    }
    if(nrow(sendthroughmergers_LUnew_pre) >=1 )
    {
      # this step will join with previous instances by prev id. 
      sendthroughmergers_LUnew_pre_names_newid_finalpre <- sendthroughmergers_LUnew_pre_names  %>%
        #should this be 1 bc 1 is from list_of_sendthru[[i]]
        # should only be minyear; if maxyear, then will erroneously revert 
        group_by(col_id_new1) %>%
        mutate(
          minyear_in_id = min(ground_year)#,
          # maxyear_in_id = max(ground_year)
        ) %>%
        ungroup() %>%
        select(
          col_id_new2, col_id_new1 ,minyear_in_id#, maxyear_in_id
        ) %>%
        distinct() %>%
        inner_join(
          list_of_sendthrus[[i]], # %>%
            # filter(
            #   ground_year < currentyear
            # ),
          by = c("col_id_new1" =  "col_id_new")
        ) %>%
        filter(
          # this will pull those up to
          ground_year < minyear_in_id
        #  (ground_year <minyear_in_id)|(ground_year >maxyear_in_id)
        ) %>%
        select(
          -minyear_in_id#, -maxyear_in_id
        )

      sendthroughmergers_LUnew_pre_names_newid_final <-sendthroughmergers_LUnew_pre_names_newid_finalpre %>% 
        bind_rows(
          sendthroughmergers_LUnew_pre_names# %>% 
            # filter(
            #   !col_id_new2 %in% c(sendthroughmergers_LUnew_pre_names_newid_finalpre$col_id_new2)
            # )
        ) %>% 
        # select(
        #   
        # )
        # select(
        #   -col_id_new
        # ) %>% 
        rename(
          col_toreplaceprev = col_id_new1,
          col_id_new =  col_id_new2
        )  %>% 
        arrange(
          col_id_new, ground_year
        ) %>% 
        select(
         -contains("col_id_new2")
        ) %>% 
        distinct()
  
  extract_df_dup <-   sendthroughmergers_LUnew_pre_names_newid_final %>%
        filter(
          col_crop == "blueberry" 
        ) %>%
    arrange(col_id_new, ground_year) %>% 
    group_by(
      col_id_new, ground_year
    ) %>% 
    mutate(
      num = length(unique(col_acquirer_new))
    ) %>% 
    ungroup() %>% 
    filter(num>=2)
  
  if(nrow(extract_df_dup)>=2)
  {
    print("nrow sendthroughfinal is >=2")
        print("nrow sendthroughfinal is >=2")
    print("nrow sendthroughfinal is >=2")
    print("nrow sendthroughfinal is >=2")
    
 sendthroughmergers_LUnew_pre_names_newid_final_expodup <-sendthroughmergers_LUnew_pre_names_newid_final    %>% 
        func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>%
        ungroup() %>%
        select(
          -col_id_new
        ) %>%
        rename(
          col_id_new = col_whichcolisid_new
        )
 break
  }
  
  #
  #   extract_df <-   sendthroughmergers_LUnew_pre_names_newid_final %>%
  #       filter(
  #        # col_acquired == "STONEVILLE PEDIGREED SEED",
  #         col_crop == "blueberry"
  #       ) %>%
  #   arrange(col_id_new, ground_year)

  
        sendthroughmergers_LUnew_notchangename1 <- list_of_sendthrus[[i]] %>%  
          #first do top
      filter(
        !(col_id_new %in% c(sendthroughmergers_LUnew_pre$col_id_new1)) #,
        #these should be the same
        # !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_newid_final$col_toreplaceprev))
  
      )  
  # sendthroughmergers_LUnew_notchangename1%>%
  #   list_of_sendthrus[[i]] %>%   
  #       filter(
  #         col_crop == "blueberry" ,
  #         col_acquired == "STONEVILLE PEDIGREED SEED"
  #       ) %>%
  #   arrange(col_id_new, ground_year)%>% View()
        
  # recover if there are ends needed            
  # sendthroughmergers_LUnew_pre_names_newid_final_past <- sendthroughmergers_LUnew_pre_names_newid_final%>% 
  #     group_by(col_id_new) %>% 
  #       mutate(
  #         minyear_in_id = min(ground_year),
  #         maxyear_in_id = max(ground_year) 
  #       ) %>% 
  #       ungroup() %>% 
  #       select(
  #         col_id_new,col_toreplaceprev, col_acquired, minyear_in_id, maxyear_in_id
  #       ) %>% 
  #       distinct() %>% 
  #       inner_join(
  #         list_of_sendthrus[[i]], # %>%  
  #           # filter(
  #           #   ground_year < currentyear
  #           # ), 
  #         by = c("col_acquired" )
  #       ) %>% 
  #       filter(
  #         # this will pull those up to 
  #         (ground_year <minyear_in_id)|(ground_year >maxyear_in_id)
  #       ) %>% 
  #       select(
  #         -minyear_in_id, -maxyear_in_id
  #       )  
  
  
  
  # extract_df <- list_of_sendthrus[[i]] %>% 
  #   group_by(
  #     col_id_new, ground_year
  #   ) %>% 
  #   mutate(
  #     dup = n()
  #   ) %>% 
  #   filter(
  #     dup >=2
  #   ) 
      # 
      # sendthroughmergers_LUnew_pre_names_newid_final %>%
      #   filter(
      #     grepl("brownfie", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
      # #
      #     sendthroughmergers_LUnew_pre_names_newid_final %>%
      #       group_by(
      #         col_acquired, col_acquired_new, col_acquirer_new, ground_year
      #       ) %>% 
      #       arrange(
      #         col_crop
      #       ) %>% 
      #       slice(1) %>% 
      #       ungroup() %>% 
      #   arrange(
      #     col_id_new, ground_year
      #   ) %>% 
      #       View()
      #     
      # # #     
      #          list_of_sendthrus[[i]]  %>%
      # 
      #     # group_by(
      #     #   col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
      #     # ) %>%
      #     # arrange(
      #     #   col_crop
      #     # ) %>%
      #     # slice(1) %>%
      #     ungroup() %>%
      #                 filter(
      #   grepl("agrevo", col_acquired, perl = TRUE , ignore.case = TRUE),
      #   col_crop == "garlic"
      # )   %>%
      #            arrange(
      #              col_id_new, ground_year
      #            ) %>%
      #            View()
      # 
      # arrange(
      #   col_id_new, ground_year
      # ) %>%
      #     View()
  
  
        
        #         list_of_sendthrus[[i]] %>%
        #     group_by(
        #       col_acquired, col_acquired_new, col_acquirer_new, ground_year
        #     ) %>%
        #     arrange(
        #       col_crop
        #     ) %>%
        #     slice(1) %>%
        #     ungroup() %>%
        #                 filter(
        #   grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
        # ) %>%
        # 
        # arrange(
        #   col_id_new, ground_year
        # ) %>%
        #     View()
      # 
      #   filter(
      #     grepl("brownfie", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
      # 
      # 
      #     list_of_sendthrus[[i]] %>%
      #   filter(
      #     grepl("calgene", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
  
      #     sendthroughmergers_LUnew_pre_names_newid_final %>%
      #   filter(
      #     grepl("stonevil", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
  
    }
    
   
    # this joins previous instances to new id current, in case the original acquired had past merger history, eg calgene acquired by Mons in 1996 acquired stoneville in 1987 so this would only extend calgene back to the first year it appears (this is an optional step, because we dont actually know when company formed, just merger year)
    # sendthroughmergers_LUnew_pre_names_prev
    ### start of prev lu ##########
  #     sendthroughmergers_LUnew_pre_names_prev <-
  #       sendthroughmergers_LUnew_pre_names%>%
  #       group_by(col_id_new) %>%
  #       mutate(
  #         minyear_in_id = min(ground_year)
  #       ) %>%
  #       ungroup() %>%
  #       select(
  #         col_id_new, col_acquired, col_crop, minyear_in_id
  #       ) %>%
  #       mutate(
  #         col_acquired_old = col_acquired,
  #         col_id_new_old = col_id_new
  #       ) %>%
  #       # rename(
  #       #   col_id_new_old = col_id_new
  #       # )%>%
  #       distinct() %>%
  #       left_join(
  #         list_of_sendthrus[[i]] %>%
  #           # filter(ground_year < currentyear)   %>%
  #           rename(
  #             col_id_new_replace  =  col_id_new
  #           ),
  #         # select(
  #         #   -col_id_new
  #         # ),
  #         # select(
  #         #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
  #         # )%>%
  #         #is it acquired old or acquired_new? acquired_old bc only want to trace the path
  #         by = c("col_acquired_old" = "col_acquirer_new", "col_crop")
  # 
  #       )%>%
  #       filter(
  #         !is.na(col_acquirer),
  #         ground_year < minyear_in_id
  #       )%>%
  #       select(
  #         -minyear_in_id
  #       )%>%
  #       mutate(
  #         #this will be the new id name; remember col_id_new is still in use and will be used to pull in those in future
  #         col_id_new_toreplace= paste0(col_id_new_old, ";", col_id_new_replace)
  #       )%>%
  #       select(
  #         # should be remaining: col_id_new (old to act as LU) and col_id_new_toreplace
  #         -col_acquired_old,  -contains(".y"), -col_id_new_old, -col_id_new_replace
  #       )
  #     if(nrow(sendthroughmergers_LUnew_pre_names_prev) >=1)
  #     {
  #       break
  #       sendthroughmergers_LUnew_pre_names_prev_needreid <- sendthroughmergers_LUnew_pre_names_prev%>%
  #         splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new_toreplace)%>%
  #         mutate(
  #           col_id_new_toreplace = coltotrans
  #         ) %>%
  #         select(
  #           -coltotrans
  #         )
  # 
  # 
  #       sendthroughmergers_LUnew_pre_names_id_newid  <-  sendthroughmergers_LUnew_pre_names    %>%
  #         select(
  #           -col_id_new_toreplace
  #         )%>%
  #         # now rename future ids to that renamed previously
  #         inner_join(
  #           sendthroughmergers_LUnew_pre_names_prev_needreid %>%
  #             select(
  #               col_id_new_toreplace, col_id_new
  #             ) %>%
  #             distinct(),
  #           by = c("col_id_new")
  #         ) %>%
  #         #then actually bring the renamed prevs
  #         # select(
  #         #   -col_id_new
  #         # )%>%
  #         # rename(
  #         #   col_id_new = col_id_new_toreplace
  #         # ) %>%
  #         bind_rows(
  #           sendthroughmergers_LUnew_pre_names_prev_needreid# %>%
  #           # select(
  #           #   -col_id_new_toreplace
  #           # ) %>%
  #           # rename(
  #           #   col_id_new = col_id_new_toreplace
  #           # )
  #         ) %>%
  #         # select(-col_id_new) %>%
  #         rename(
  #           col_id_makesurenone = col_id_new,
  #           col_id_new = col_id_new_toreplace
  #         ) %>%
  #         # rename(
  #         #   col_id_makesurenone = col_id_new,
  #         #   col_id_new = col_id_new_toreplace
  #         # ) %>%
  #         arrange(
  #           col_id_new,ground_year
  #         )
  # 
  #       sendthroughmergers_LUnew_pre_names_newid_final <- sendthroughmergers_LUnew_pre_names_id_newid    %>%
  #         select(
  #           -col_id_makesurenone
  #         ) %>%
  #         # select(
  #         #   -col_id_new.x
  #         # ) %>%
  #         bind_rows(
  #           sendthroughmergers_LUnew_pre_names %>%
  #             filter(
  #               !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_id_newid$col_id_makesurenone))
  #             )
  #         )
  # 
  # 
  #       #
  #       #     sendthroughmergers_LUnew_pre_names_prevnewid  <-  sendthroughmergers_LUnew_pre_names_prev    %>%
  #       #       inner_join(
  #       #         sendthroughmergers_LUnew_pre_names_prev_needreid %>%
  #       #         select(
  #       #           col_id_new_toreplace, col_id_new
  #       #         ) %>%
  #       #           distinct(),
  #       #         by = c("col_id_new")
  #       #       ) %>%
  #       #       # select(
  #       #       #   -col_id_new
  #       #       # )%>%
  #       #       # rename(
  #       #       #   col_id_new = col_id_new_toreplace
  #       #       # ) %>%
  #       #       bind_rows(
  #       #         sendthroughmergers_LUnew_pre_names_prev_needreid# %>%
  #       #           # select(
  #       #           #   -col_id_new_toreplace
  #       #           # ) %>%
  #       #           # rename(
  #       #           #   col_id_new = col_id_new_toreplace
  #       #           # )
  #       #       ) %>%
  #       #       rename(
  #       #         col_id_makesurenone = col_id_new,
  #       #         col_id_new = col_id_new_toreplace
  #       #       )
  #       #
  #       #     sendthroughmergers_LUnew_pre_names_reid <-  sendthroughmergers_LUnew_pre_names_prevnewid    %>%
  #       # select(
  #       #   -col_id_makesurenone
  #       # ) %>%
  #       # # select(
  #       # #   -col_id_new.x
  #       # # ) %>%
  #       # bind_rows(
  #       #    sendthroughmergers_LUnew_pre_names %>%
  #       #     filter(
  #       #       !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_prevnewid$col_id_makesurenone))
  #       #     )
  #       # )
  #       #
  # 
  # 
  #       # select(
  #       #   -col_id_new.x
  #       # ) %>%
  #     }
  # 
  # 
  #     if(!nrow(sendthroughmergers_LUnew_pre_names_prev) >=1)
  #     {
  # 
  #       sendthroughmergers_LUnew_pre_names_newid_final <- sendthroughmergers_LUnew_pre_names
  #     }
  # }
  
    ### end prev lu ##########
    #  
    # list_of_sendthrus[[i]]  %>%
    #    filter(
    #      grepl("nunza", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #       grepl("nunhem",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #    )%>%
    #    View()
    
    # sendthroughmergers_LUnew_notchangename %>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #      grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    # sendthroughmergers_LUnew_pre_names_reid%>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #      grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    #  sendthroughmergers_LUnew_pre_names_reid%>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquired,   perl = TRUE, ignore.case=TRUE)#,
    #      # grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    
    
    whichgetacquired <-  list_of_sendthrus[[i]] %>% 
      filter(
        ground_year >= currentyear, 
        col_year >  currentyear
        
      ) %>%
            # if  the current 
      anti_join(
        x_df2 %>% 
          filter(
            col_year == currentyear, 
            nchar(col_crop)>=3
          ), 
        by = c(  "col_crop", "col_acquirer_new" = "col_acquired")
      ) %>% 

      rename(
        col_id_new1 = col_id_new
      ) %>% 
      # left_join(
      #   sendthroughmergers_LU_current_edit %>% 
      #     select(
      #       col_acquired, col_acquirer_new, col_id_new
      #     ) %>% 
      #     distinct() %>% 
      #     rename(
      #       sendthrough_colacquired = col_acquired, 
      #       sendthrough_colacquirer = col_acquirer_new,
      #       sendthrough_col_id_new = col_id_new
      #     ), 
      #   by = c("col_acquirer_new" = "sendthrough_colacquired")
      # ) %>% 
      # mutate(
      #   col_acquirer_new = coalesce(sendthrough_colacquirer, col_acquirer_new ), 
      #   col_id_new = coalesce
      # )
    #this step will retain 
    # mutate(
    #   old_acquired = col_acquired
    # ) %>% 
    #inner join is approp here bc these remain constant throughout
    inner_join(
      sendthroughmergers_LU_current_edit %>% 
        select(
          # -col_year,-col_acquirer, -ground_year , -col_id
          col_crop, col_acquired, col_id_new, newnametemp,  col_acquirer_new, old_acquirer, newnametemp, col_id_new#, col_year
        ) %>%
        # rename(
        #   col_year_sendthrough_current_edit = col_year 
        # ) %>% 
        distinct(),
      # rename(
      #   name_new = col_acquirer
      # ), 
      by = c(
        "col_crop", "col_acquired" = "col_acquired"
      )
    )   %>%
      mutate(
        newnametemp = 
          # case_when(
          #   !is.na(newnametemp.x)~ 
          paste0( 
            newnametemp.y, 
            "; ", 
            newnametemp.x
            #gets the first year
            # substr(old_acquirer.x,1,4),
            # "-",
            #then gets current new acquirer
            # col_acquirer_new.y,
            # "-", 
            # col_acquirer_new,
            # gsub(".*-", "-",old_acquirer.x ), 
            #  "; ", newnametemp.y 
          ),
        col_acquired_new = col_acquirer_new.y,
        col_acquirer_new  = col_acquirer_new.x,
        # col_acquirer_new  = 
        #   case_when(
        #     col_year_sendthrough_current_edit == col_year ~ col_acquirer_new.y,
        #     TRUE ~ col_acquirer_new.x,
        #   ),
        #just call them the same 
        #col_id_new is from current year mergers
        #col_id_new1 is original from future merger
        #col_id_new2 is new 
        
        col_id_new2 = paste0(col_id_new1, "; ", col_id_new)#,
        # col_id_oldprev = col_id_new1,
        # TRUE ~ newnametemp.y
        #,
        # col_id = col_id.x
      )  %>% 
      # rename(
      #    col_toreplaceprev = col_id_new1
      # ) %>% 
      # select(
      #   -col_id_new1
      # ) %>% 
      
      # TRUE ~ newnametemp.y
      #,
      # col_id = col_id.x
      filter(
        col_acquirer_new != col_acquirer_new.y   
      ) %>% 
      mutate(
        old_acquirer = newnametemp
      )%>% 
      select(
        -contains(".x"), -contains(".y")#, -contains("col_year_sendthrough_current_edit")
        # -col_acquirer_new.x, -col_acquirer_new.y, -old_acquirer.x, -old_acquirer.y, 
      ) 
    
    
    
    if(nrow(whichgetacquired ) >=1)
    {
      
      #first rename and reid if the col_acquirer_new changes
     whichgetacquired_changeacquirername_idonly <-  whichgetacquired %>% 
      inner_join(
        sendthroughmergers_LU_current_edit %>%
          select(
            col_acquired, col_acquirer_new, col_id_new, col_crop, newnametemp,old_acquirer
          ) %>%
          distinct() %>%
          rename(
            sendthrough_colacquired = col_acquired,
            sendthrough_colacquirer = col_acquirer_new,
            sendthrough_col_id_new = col_id_new, 
            sendthrough_col_newnametemp = newnametemp,
            sendthrough_col_old_acquirer = old_acquirer
          ),
        #if 
        by = c("col_acquirer_new" = "sendthrough_colacquired", "col_crop")
      ) %>%
        mutate(
          col_id_new3 = paste0(sendthrough_col_id_new, "; ", col_id_new2),
          old_acquirer = paste0(sendthrough_col_old_acquirer, "; ", old_acquirer),
          newnametemp = paste0(sendthrough_col_newnametemp, "; ", newnametemp),

          col_acquirer_new = sendthrough_colacquirer, 
          

        )%>% 
       select(
         -contains("sendthrough_col")
       )
     
     # this is ; some may not 
     whichgetacquired_changeacquirername <-  whichgetacquired %>% 
      left_join(
        sendthroughmergers_LU_current_edit %>%
          select(
            col_acquired, col_acquirer_new, col_id_new, col_crop, newnametemp,old_acquirer
          ) %>%
          distinct() %>%
          rename(
            sendthrough_colacquired = col_acquired,
            sendthrough_colacquirer = col_acquirer_new,
            sendthrough_col_id_new = col_id_new, 
            sendthrough_col_newnametemp = newnametemp,
            sendthrough_col_old_acquirer = old_acquirer
          ),
        #if 
        by = c("col_acquirer_new" = "sendthrough_colacquired", "col_crop")
      ) %>%
        mutate(
          col_id_new3 = paste0(sendthrough_col_id_new, "; ", col_id_new2),
          old_acquirer = paste0(sendthrough_col_old_acquirer, "; ", old_acquirer),
          newnametemp = paste0(sendthrough_col_newnametemp, "; ", newnametemp),

          col_acquirer_new = sendthrough_colacquirer, 
          

        )%>% 
       filter(
         col_id_new2 %in% c(whichgetacquired_changeacquirername_idonly$col_id_new2)
       )%>% 
       select(
         -contains("sendthrough_col")
       )
     
     #### commented out 2023/08/22
     if(nrow(whichgetacquired_changeacquirername)!=nrow(whichgetacquired_changeacquirername_idonly))
     {
       #because this has the potential to break/cut up things
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")

       break
     }

     whichgetacquired_withrename <- whichgetacquired %>% 
       filter(
         !(col_id_new2 %in% c(whichgetacquired_changeacquirername$col_id_new2))
       ) %>% 
       bind_rows(
         whichgetacquired_changeacquirername %>% 
           select(-col_id_new2) %>% 
           rename(
             col_id_new2 = col_id_new3
           )
         #potentially bind those that don't get a rename in future run
       )
      

      # then reid it 
      whichgetacquired_rename_id <- whichgetacquired_withrename %>% 
        splitrowbysemicolon(
          x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "w1")%>% 
        mutate(
          col_id_new2 = coltotrans#,
          # col_id_new = col_id_new_toreplace
        ) %>% 
        select(
          -coltotrans
        ) %>% 
        splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$old_acquirer, if_id_col= "no")%>% 
        mutate(
          old_acquirer = coltotrans
        ) %>% 
        select(
          -coltotrans
        )
      extract_df <-   whichgetacquired_rename_id%>%
    filter(
        col_crop == "blueberry" 
    ) %>%
    arrange(col_id_new2, ground_year) 

      
      #    
      # whichgetacquired_rename_id <- whichgetacquired %>% 
      #  mutate(
      #    temprowid = row_number()
      #  ) %>% 
      #  group_by(
      #    temprowid
      #    # col_crop, col_id, ground_year, newnametemp
      #  ) %>% 
      #  mutate(
      #          col_id_newnew =  paste(sort(unique(col_id_new ),decreasing = TRUE) , collapse = "; ")
      #          
      #        ) %>%
      #        ungroup() %>% 
      #        separate_rows(col_id_newnew, sep = "; ") %>%
      #        group_by_at(
      #          c("temprowid",  names(whichgetacquired) )
      #        ) %>%
      #        summarise(col_id_new = paste(sort(unique(col_id_newnew),decreasing = TRUE), collapse = "; "))%>%
      #        ungroup() %>% 
      #        select(
      #          -temprowid
      #        )      
      
      
      # whichgetacquired_rename <- whichgetacquired_rename_id %>% 
      #   mutate(
      #     temprowid = row_number()
      #   ) %>% 
      #   group_by(
      #     temprowid
      #     # col_crop, col_id, ground_year, newnametemp
      #   ) %>% 
      #   mutate(
      #           old_acquirernew =  paste(sort(unique(old_acquirer ),decreasing = TRUE) , collapse = "; ")
      #           
      #         ) %>%
      #         ungroup() %>% 
      #         separate_rows(old_acquirernew, sep = "; ") %>%
      #         group_by_at(
      #           c("temprowid",  names(sendthroughmergers_LUnew_pre_tobind) )
      #         ) %>%
      #         summarise(old_acquirer = paste(sort(unique(old_acquirernew),decreasing = TRUE), collapse = "; "))%>%
      #         ungroup() %>% 
      #         select(
      #           -temprowid
      #         )
      
      whichgetacquired_rename_withpast_direct_pre <-  whichgetacquired_rename_id %>%
        rename(
          col_id_fromsendthrough = col_id_new 
        ) %>% 
        # select(
        #   -col_id_new
        # ) %>% 
        group_by(col_id_new2)  %>% 
        mutate(
          minyear_in_id = min(ground_year) #, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        rename(
          col_id_new = col_id_new1
        ) %>% 
        select(
      col_id_new,minyear_in_id, col_id_new2 #  , maxyear_in_id
        ) %>% 
        # rename(
        #   col_acquired_old = col_acquired
        # )%>% 
        distinct() %>% 
        inner_join(
          list_of_sendthrus[[i]],# %>% 
            # rename(
            #   col_toreplaceprev = col_id_new
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c("col_id_new")
          
        )%>% 
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id
       
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        # group_by(
        #   col_id_new2, 
        # )
        select(
         -minyear_in_id# , -maxyear_in_id
        ) 
      
      whichgetacquired_rename_withpast_direct <- whichgetacquired_rename_withpast_direct_pre%>% 
        rename(
          col_toreplaceprev = col_id_new
        ) %>% 
        # select(-col_id_new) %>% 
        bind_rows(
          whichgetacquired_rename_id %>% 
            select(
              -col_id_new#,  -col_id_new2
            ) %>%
            rename(
              col_toreplaceprev = col_id_new1
            ) %>%
            filter(
              col_id_new2 %in% c(whichgetacquired_rename_withpast_direct_pre$col_id_new2 )
            )
        ) %>% 
        # select(
        #   -col_id_new
        # ) %>% 
        rename(
          # col_toreplaceprev = col_id_new1,
          col_id_new = col_id_new2
        )  %>% 
        mutate(
          # keep this to be used in next
          col_id_new2 = col_id_new
        )  %>% 
        splitrowbysemicolon(
          x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new, if_id_col= "yes", currentit = i, prefix = "w1d")%>% 
        select(
          -col_id_new
        )%>%
         mutate(
          col_id_new  = coltotrans#,
          # col_id_new = col_id_new_toreplace
        ) %>% 
        select(
          -coltotrans
        ) 
 
      
      whichgetacquired_rename_withpast_direct_reid <- whichgetacquired_rename_withpast_direct %>% 
        func_expand_duprows_in_id(., whichcolisid = .$col_id_new2, prefix = "dup") %>% 
        ungroup() %>% 
        select(
          -col_id_new2
        ) %>% 
        rename(
          col_id_new2 = col_whichcolisid_new
        ) 
        
      # if(nrow(whichgetacquired_rename_withpast_direct) >=1)
      # {
      #   break
      # }
       extract_df <-    whichgetacquired_rename_withpast_direct %>%
        arrange( col_id_new2 , ground_year)%>%
        filter(col_crop == "canola")  

      
 extract_df <-    whichgetacquired_rename_withpast_direct_reid %>%
        arrange( col_id_new2 , ground_year)%>%
        filter(col_crop == "canola")  %>% 
 filter(
   grepl("dup", col_id_new2)
 )
  # whichgetacquired_rename_withpast_direct %>%
  #   arrange( col_id_new , ground_year)  %>%
  #   filter(col_crop == "blueberry") %>% select(col_id_new, ground_year, everything()) %>%  View()

      
    # whichgetacquired_rename_withpast_direct_norepeat <- whichgetacquired_rename_withpast_direct %>% 
    #           group_by(
    #             col_id_new, ground_year
    #           ) %>% 
    #           mutate(counter = n()) %>% 
    #           filter(counter >=2 )%>% 
    #     arrange( col_id_new , ground_year)%>%
    #     filter(col_crop == "blueberry")
    #   
    #   whichgetacquired_rename_withpast_direct %>%
    #     filter(col_crop == "blueberry") %>%
    #     group_by(col_id_new) %>% 
    #     mutate(nelements = length(unique(c( ground_year)))) %>% 
    #     ungroup() %>% 
    #     filter(nelements == 26)%>% 
    #     arrange( col_id_new , ground_year) %>% 
    #   
    #     View()
    #   
    #     whichgetacquired_rename_withpast_direct %>%
    #     filter(col_crop == "blueberry") %>%
    #     group_by(col_id_new) %>% 
    #     mutate(nelements = length(unique(c( ground_year)))) %>% 
    #     ungroup() %>% 
    #       group_by(nelements) %>% 
    #       summarise(
    #         countn = n()
    #       )
    #     arrange( col_id_new , ground_year) %>% 
    #   
    #     View()
    
        # rename(
        #   col_id_new = coltotrans#,
        #   # col_id_new = col_id_new_toreplace
        # ) #%>% 
        # bind_rows(
        #   whichgetacquired_rename_withpast_direct
        # )
        
   whichgetacquired_rename_withpast_onlyid <-  whichgetacquired_rename_id %>% 
        group_by(col_id_new2) %>% 
        mutate(
          minyear_in_id = min(ground_year)#, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>% 
        rename(
          col_acquired_old = col_acquired
        )%>% 
        distinct() %>% 
        inner_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%  
            # filter(
            #   col_year  <  currentyear
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )
          
        )%>% 
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id
       
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )
 
   
         whichgetacquired_rename_withpast3 <-  whichgetacquired_rename_id %>% 
        group_by(col_id_new2) %>% 
        mutate(
          minyear_in_id = min(ground_year)#, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>% 
        rename(
          col_acquired_old = col_acquired
        )%>% 
        distinct() %>% 
        left_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%  
            # filter(
            #   col_year  <  currentyear
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )
          
        )%>% 
        filter(
          ground_year < minyear_in_id,
          col_id_new2 %in% c(whichgetacquired_rename_withpast_onlyid$col_id_new2)
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        mutate(
          col_acquired = col_acquired_old
        )%>% 
        select(
          -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
        )%>% 
        mutate(
          # col_id_new = col_id_new2, 
          #this will be the new id name
          col_id_new1 = col_id_new2,
          col_id_new2= paste0(col_id_new2, "; ", col_id_new),
          col_acquirer_new = col_acquired_new
        )   %>% 
        rename(
          col_toreplaceprev = col_id_new
        ) 

      # 
      # only includes past; and renames past IDs
         ### below is how it was previously 01/01/2023; switched over to getting id's first and rest and filling in, instead of just names (bc will omit those without names)
      whichgetacquired_rename_withpast <-  whichgetacquired_rename_id %>%
        group_by(col_id_new2) %>%
        mutate(
          minyear_in_id = min(ground_year)#,
          # maxyear_in_id = max(ground_year)
        ) %>%
        ungroup() %>%
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>%
        rename(
          col_acquired_old = col_acquired
        )%>%
        distinct() %>%
       left_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%
            # filter(
            #   col_year  <  currentyear
            # ), #%>%
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>%
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )

        )%>%
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id

          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>%
        mutate(
          col_acquired = col_acquired_old
        )%>%
        select(
          -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
        )%>%
        mutate(
          # col_id_new = col_id_new2,
          #this will be the new id name
          col_id_new1 = col_id_new2,
          col_id_new2= paste0(col_id_new2, "; ", col_id_new),
          col_acquirer_new = col_acquired_new
        )   %>%
        rename(
          col_toreplaceprev = col_id_new
        )
      
      if(nrow(whichgetacquired_rename_withpast3)!=nrow(whichgetacquired_rename_withpast)){
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        break
      }
      # c('
# $ col_id_new2       <chr> "{6w1}merge00…
# $ col_acquired_new  <chr> "LIMAGRAIN GE…
# $ col_crop          <chr> "agrotricum",…
# $ col_id_new1       <chr> "{6w1}merge00…
# $ col_acquirer      <chr> "LIMAGRAIN GE…
# $ col_acquired      <chr> "VILMORIN", "…
# $ col_year          <dbl> 1975, 1975, 1…
# $ col_id            <chr> "merge00291]a…
# $ ground_year       <dbl> 1975, 1976, 1…
# $ col_toreplaceprev <chr> "merge00291]a…
# $ old_acquirer      <chr> "1975-LIMAGRA…
# $ newnametemp       <chr> "1975-LIMAGRA…
# $ col_acquirer_new  <chr> "LIMAGRAIN GE…
# ')      

    
      if(nrow(whichgetacquired_rename_withpast) >=1)
      {
        # break
        
        #renames it
        whichgetacquired_rename_withpast_needreid <- whichgetacquired_rename_withpast%>% 
          splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "wp1")%>% 
          mutate(
            col_id_new2 = coltotrans
          ) %>% 
          select(
            -coltotrans
          )
        # whichgetacquired_rename_withpast_needreid_withpresent <- whichgetacquired_rename_withpast_needreid %>% 
        #   bind_rows(
        #     whichgetacquired_rename_id
        #   )
        # 
        
        
        whichgetacquired_rename_id_newid  <-  whichgetacquired_rename_id    %>% 
          select(
            -col_id_new1, -col_id_new
          )%>% 
          rename(
            col_id_new1 = col_id_new2
          )%>% 
          # now rename future ids to that renamed previously
          inner_join(
            whichgetacquired_rename_withpast_needreid %>% 
              select(
                col_id_new2, col_id_new1, col_toreplaceprev  
              ) %>% 
              distinct(),
            by = c("col_id_new1" = "col_id_new1")
          ) %>% 
          #then actually bring the renamed prevs
          # select(
          #   -col_id_new
          # )%>%
          # rename(
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          bind_rows(
            whichgetacquired_rename_withpast_needreid# %>%
            # select(
            #   -col_id_new_toreplace
            # ) %>%
            # rename(
            #   col_id_new = col_id_new_toreplace
            # )
          ) %>%
          # select(-col_id_new) %>% 
          rename(
            # col_id_makesurenone = col_id_new,
            # 
            # col_id_new = col_id_new_toreplace
            col_id_new = col_id_new2
          ) %>% 
          # rename(
          #   col_id_makesurenone = col_id_new,
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          arrange(
            col_id_new,ground_year
          )
        
        whichgetacquired_rename_id_newid_final <- whichgetacquired_rename_id_newid%>% 
          select(
            -col_id_new1
          ) %>% 
          bind_rows(
            whichgetacquired_rename_id %>%
              filter(
                !(col_id_new2 %in% c(whichgetacquired_rename_id_newid$col_id_new1)),
                !(col_id_new2 %in% c(whichgetacquired_rename_withpast_direct$col_id_new2))
                
              ) %>%
              select(  -col_id_new) %>%
                rename(
                  col_id_new = col_id_new2,
                  col_toreplaceprev = col_id_new1
                ),
            whichgetacquired_rename_withpast_direct %>% 
              select(-col_id_new2)  
                
                
                # %>% 
              # group_by(
              #   col_id_new, ground_year
              # ) %>% 
              # slice(1) %>% 
              # ungroup()
          ) %>% 
          distinct()
        
        
      extract_df <-  whichgetacquired_rename_id_newid_final %>%
          filter(
            col_crop == "blueberry"
          ) %>%
          arrange(
            col_id_new, ground_year
          ) 
        # select(
        #   -col_id_new.x
        # ) %>% 
      }
      
      
      if(!nrow(whichgetacquired_rename_withpast) >=1)
      {        
        whichgetacquired_rename_id_newid_final <- bind_rows(
            whichgetacquired_rename_id %>%
              filter(
                !(col_id_new2 %in% c(whichgetacquired_rename_withpast_direct$col_id_new2))
                
              ) %>%
              select(  -col_id_new) %>%
                rename(
                  col_id_new = col_id_new2,
                  col_toreplaceprev = col_id_new1
                ),
            whichgetacquired_rename_withpast_direct  %>% 
              select(-col_id_new2)  #%>% 
              # group_by(
              #   col_id_new, ground_year
              # ) %>% 
              # slice(1) %>% 
              # ungroup()
          ) %>% 
          distinct()
          # whichgetacquired_rename_id%>% 
          #     select(-col_id_new, -col_id_new1) %>% 
          #       rename(
          #         col_id_new = col_id_new2
          #       ) 
          
       }
      
      #  list_of_sendthrus[[i]]  %>%
      # group_by(
      #     col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
      # ) %>%
      # arrange(
      #     col_crop
      # ) %>%
      # slice(1) %>%
      # ungroup() %>%
      # filter(
      #     grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
      # ) %>%
      # 
      # arrange(
      #     col_id_new, ground_year
      # ) %>%
      # View()
  
      
      sendthroughmergers_LUnew_notchangename2 <- sendthroughmergers_LUnew_notchangename1 %>% 
        filter(
          # want to keep the below and only remove those that have been changed at top and bottom
          # !col_id_new %in% c(whichgetacquired_rename_id_newid_final$col_toreplaceprev),
          !col_id_new %in% c(whichgetacquired_rename_id$col_id_new1),
          !col_id_new %in% c(whichgetacquired_rename_withpast_direct$col_toreplaceprev)
        )
  
      
      
      sendthisoutdf <- bind_rows(
        
        sendthroughmergers_LUnew_pre_names_newid_final %>% 
          select(
            -contains("col_toreplaceprev")
          ), 
        whichgetacquired_rename_id_newid_final %>% 
          select(
             -contains("col_toreplaceprev")
          ) , 
        sendthroughmergers_LUnew_notchangename2
      ) %>% 
        select(
          -contains("col_id_new1"), -contains("col_id_new2"), -contains("col_id_new_toreplace"), -contains("col_toreplaceprev")
        )
      
    }
    
    if(!(nrow(whichgetacquired)>=1))
    {
      sendthisoutdf <- bind_rows(
        
        sendthroughmergers_LUnew_pre_names_newid_final %>% 
          select(
            -contains("col_toreplaceprev")
          ), 
        sendthroughmergers_LUnew_notchangename1
      )%>% 
      select(
         -contains("col_id_new1"), -contains("col_id_new2"), -contains("col_id_new_toreplace"), -contains("col_toreplaceprev")
      )
           
      
      
    }
    
    
    # list_of_sendthrus[[i+1]] %>%
    #   feather::write_feather(
    #     paste0(
    #       "X:/msi/work/farmer welfare/seed/R analysis/221215_merge/",
    #       currentyear, ".feather"
    #     )
    # 
    #   )
    sendthisoutdf_dup <- sendthisoutdf %>% 
      group_by(
        col_id_new, ground_year
      ) %>% 
      mutate(
        dup = n()
      ) %>% 
      filter(dup >=2) %>% 
      ungroup() #%>% 
    
    # extract_df <- sendthisoutdf %>% 
    #   filter(
    #     col_crop == "blueberry"
    #   ) %>% 
    #   arrange(
    #     col_id_new, ground_year
    #   ) %>% 
    #   filter(
    #     grepl("_", col_id_new, perl = TRUE)
    #   )
 extract_df <- sendthisoutdf_dup %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 
    
    # if(nrow(sendthisoutdf_dup)>=1)
    # {
    #         print("dup! heads up")
    # 
    #   break
    # }
    
    sendthisoutdf_dup_reid <- sendthisoutdf_dup %>% 
      group_by(
        col_id_new, ground_year
      ) %>% 
      arrange(
        col_acquirer_new
      ) %>% 
      mutate(
        col_id_new2 = paste0(  row_number(),"_", col_id_new)
      ) %>% 
      ungroup()
     extract_df <- sendthisoutdf_dup_reid %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 

    sendthisoutdf_w_dup <- sendthisoutdf %>% 
      filter(
        !col_id_new %in% c(sendthisoutdf_dup_reid$col_id_new)
      ) %>% 
      bind_rows(
        sendthisoutdf_dup_reid %>% 
          select(
            -col_id_new, -contains("dup")
          ) %>% 
          rename(
            col_id_new = col_id_new2
          )
      )
    
    # sendthisoutdf_w_dup<- list_of_sendthrus[[49]]
    sendthisoutdf_w_dup_removesame <- sendthisoutdf_w_dup %>% 
      functionreduce_down_dups(passthrudf =. )
    
         extract_df <- sendthisoutdf_w_dup_removesame %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 

    # sendthisoutdf_w_dup_final <- 
    
      # sendthisoutdf_w_dup_removesame %>%
      # feather::write_feather(
      #   paste0(
      #     "X:/msi/work/farmer welfare/seed/R analysis/221215_merge/",
      #     currentyear, ".feather"
      #   )
      # 
      # )

    
    list_of_sendthrus[[i+1]] <- sendthisoutdf_w_dup_removesame
    i <- i+1
    
    rm(extract_df)
    rm(whichgetacquired)
    rm(sendthroughmergers_LU_current_edit)
    rm(sendthroughmergers_LUnew_pre)
    rm(sendthroughmergers_LUnew)
    rm(sendthroughmergers_LUnew_pre_names)
    rm(sendthroughmergers_LUnew_pre_tobind)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LU_bind_withprev)
    rm(sendthroughmergers_LU_bind)
    rm(sendthroughmergers_LU_current)
    # rm(sendthroughmergers_LU_current_edit)
    rm(sendthroughmergers_LUnew)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LUnew_pre)
    rm(sendthroughmergers_LUnew_pre_names)
    rm(sendthroughmergers_LUnew_pre_names_newid_final)
    rm(sendthroughmergers_LUnew_pre_names_prev)
    rm(sendthroughmergers_LUnew_notchangename_id)
    rm(sendthroughmergers_LUnew_notchangename)
    
    rm(sendthroughmergers_LUnew_pre_names_newid_finalpre)
    rm(whichgetacquired_rename_withpast)
    rm(sendthroughmergers_LUnew_pre_names_newid_final)
    rm(whichgetacquired_rename_id_newid_final)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(whichgetacquired)
    rm(whichgetacquired_rename_id)
    rm(whichgetacquired_rename_id_newid)
    rm(whichgetacquired_rename_withpast)
    rm(whichgetacquired_rename_withpast_needreid)
    rm(sendthroughmergers_LUnew_notchangename2)
      rm(sendthroughmergers_LUnew_notchangename1)
      rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LUnew_notchangename_onlyid)
    
   rm(check_if_sameyear_acquirer)
    rm(check_if_sameyear_acquired)
    rm(sendthisoutdf_w_dup)
    rm(sendthisoutdf)
    rm(sendthisoutdf_dup_reid)
    rm(sendthisoutdf_dup)
    rm(whichgetacquired_rename_withpast_direct)
    rm(whichgetacquired_rename_withpast_direct_pre)
    rm(sendthroughmergers_LU_current)
    rm(sendthroughmergers_LU_current_edit_pre)
    rm(sendthisoutdf_w_dup_removesame)
    rm(sendthroughmergers_LU_current_edit_replaceacquired)
    rm(sendthroughmergers_LU_current_edit_withfuture)
    rm(sendthroughmergers_LU_current_edit_withfuture_dup)
    rm(sendthroughmergers_LU_current_edit_withfuture_reid)
    rm(whichgetacquired_changeacquirername)
    rm(whichgetacquired_withrename)
    rm(sendthroughmergers_LUnew_pre)
        rm(sendthroughmergers_LUnew_pre_onlyid)
                rm(sendthroughmergers_LUnew_pre_unique)
                rm(sendthroughmergers_LUnew_pre_names_unique)
rm(whichgetacquired_rename_withpast_onlyid)
rm(whichgetacquired_changeacquirername_idonly)
rm(whichgetacquired_rename_withpast3)
rm(whichgetacquired_rename_withpast_direct_reid)
    # sendthroughmergers_LU_bind %>% 
    #   filter(
    #     grepl("tick", col_id,perl = TRUE, ignore.case = TRUE)
    #     )%>% 
    #       View()
    
    
    # sendthroughmergers_LU%>%
    #   feather::write_feather(
    #     paste0(
    #        "X:/msi/work/farmer welfare/seed/R analysis/", folderoutname,"/221105_merged_",filenamergename,currentyear,".feather"
    #     )
    
    #  )
    gc()
    # i <- i+1
  }
# sendthroughmergers_LU %>% 
#   feather::w
# 
list_of_sendthrus
# sendthroughmergers_LU <-list_of_sendthrus[[i]]
}
```


### use function
```{r }
# sendthroughmergers_LU <-  
# list_of_sendthrus[[length(list_of_sendthrus)]]

sendthroughmergers_LU <-  
list_of_sendthrus[[i]]

sendthroughmergers_list <- mergerdata220918_names_crop %>% 
findparentcompanyfunc_LU(
  x=.,
  acquirercol =.$namestandard_acquirer, 
  acquiredbycol=.$namestandard_acquired,
  cropcol=.$crop, 
  yearcol=.$Year,
  idcol=.$idcol,
  filenamergename = "230910try.feather",
  # minyear = .$Year %>% min(), 
  # maxyear = 2022, 
  folderoutname =  "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230910" ,
  sendcroplist = croplistLU221126_2 
  )

 
#     x=mergerdata220918_names_crop
#   acquirercol =mergerdata220918_names_crop$namestandard_acquirer
#   acquiredbycol=mergerdata220918_names_crop$namestandard_acquired
#   cropcol=mergerdata220918_names_crop$crop
#   yearcol=mergerdata220918_names_crop$Year
#   idcol=mergerdata220918_names_crop$idcol
#   filenamergename = "230821try.feather"
#   minyear = mergerdata220918_names_crop$Year %>% min()
#   maxyear = mergerdata220918_names_crop$Year %>% max()
#   folderoutname =  "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821"
#   sendcroplist = croplistLU221126_2
# sendthroughmergers_list <- sendthroughmergers_LU
sendthroughmergers_LU  <-
sendthroughmergers_list[[(
 sendthroughmergers_list %>% length() )]]
sendthroughmergers_LU %>% 
  
  filter(col_crop=="corn") %>% 
  arrange(col_id_new, ground_year)  %>% 
  View()
sendthroughmergers_LU%>% 
  feather::write_feather(
    "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230910_sendthroughmergers_LU.feather"
  )

sendthroughmergers_LU  <- 
  feather::read_feather(
    "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230901_sendthroughmergers_LU.feather"
  )

# sendthroughmergers_LU_reduce <- sendthroughmergers_LU %>% 
#   group_by(
#     col_id_new
#   ) %>% 
#   mutate(
#     maxyear = max(ground_year)
#   ) %>% 
#   ungroup() %>%
#   filter(
#     maxyear==2022
#   ) %>% 
#   ungroup() %>% 
#   group_by(
#     col_acquired
#   ) %>% 
#   mutate(
#     minacq = min(ground_year)
#   )  %>% 
#   ungroup() %>% 
#   group_by(
#     col_id_new, col_acquired
#   ) %>% 
#   mutate(
#     minacq_per_id = min(ground_year)
#   ) %>% 
#   ungroup() %>% 
#   filter(
#      minacq_per_id==minacq
#   ) %>% 
#   ungroup() 

# sendthroughmergers_LU_reduce%>% 
#   feather::write_feather(
#     "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230821_sendthroughmergers_LU.feather"
#   )
  # x = mergerdata220918_names
  # acquirercol = mergerdata220918_names$namestandard_acquirer
  # acquiredbycol = mergerdata220918_names$namestandard_acquired
  # cropcol = mergerdata220918_names$Crop
  # yearcol = mergerdata220918_names$Year
  # idcol = mergerdata220918_names$idcol
  # filenamergename = "230821try"
  # folderoutname = "230821"
  # minyear = 1970
  # maxyear = 2022
  #     sendcroplist = croplistLU221126

```

#### check for errors
```{r }
sendthroughmergers_LU %>% 
  filter(
    grepl("NA;", old_acquirer, perl =TRUE)
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()
sendthroughmergers_LU %>% 
  filter(
    col_crop == "corn"
  ) %>%
  group_by(col_id_new) %>% 
  mutate(
    rangeyear = length(unique(ground_year)),
    supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))
     
  ) %>% 
  ungroup() %>% 
  filter(
    supposed_rangeyear!=rangeyear
  ) %>% 
  arrange(col_id_new, ground_year) %>% 
  View()
sendthroughmergers_LU %>% 
  filter(
    grepl("stoneville", ignore.case = TRUE, perl = TRUE, x = col_acquired),
    col_crop == "canola"
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()
sendthroughmergers_LU %>% 
  filter(
    col_crop == "onion", grepl( col_acquired, pattern = "illinois", ignore.case = TRUE)
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

```

### reduce 1 function - gcd

```{r }
# sendthroughLU may contain long (ie ABCDE and short DE and/or broken sequences ABDE of merger years. we want to find, for each given pattern of year-acquirernew/parent sequence, the longest unbroken string. This function attempts to 1. patch gaps and 2. find and consolidate senthroughmergersLU to only the longest unbroken string) 
# numworker is number of processor cores used
findgcd_merger <- function(findlowest_basedf, numworker =90){
  
  require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
require(future.callr)
plan(callr)
  require(patentsview)
require(tidytext)
  plan("callr", workers =numworker)
  options(future.globals.maxSize= 891289600)
  
  # needs java, either 64 bit or 32 bit (windows) or mac-specific vers installed and sys enviro pointing to folder with java.exe
Sys.setenv(JAVA_HOME="C:/Program Files/Java/jre-1.8") # for 64-bit version

  # qdap needed for beg2char func
  require(qdap)
  findlowest_basedf <- sendthroughmergers_LU
  # 
   numworker = 90
  # 
      findlowest_basedf_arrange <- findlowest_basedf%>% 
        group_by(
          col_id_new, col_acquired, col_crop
        ) %>%
        arrange(
          col_id_new, ground_year
        ) %>%
        ungroup() 
    
      # this narrows down to all strands possible , by unique col_id_new and col_acquirer_new
    findlowest_basedf_allstrings <-   findlowest_basedf %>% 
        mutate(
          # old_acquirer_2 =  gsub("^.*?\\; ", "", old_acquirer, perl = TRUE)
         old_acquirer_2 =  gsub(";.*", "", old_acquirer, perl = TRUE)

        ) %>% 
            select(
              -col_id_new
            ) %>% 
          group_by(
            col_acquired, col_crop,old_acquirer_2, ground_year, col_acquirer_new
          ) %>% 
          slice(1) %>% 
          ungroup()
    # this step takes the sendthrumergerslu arranged and finds those in which there is a gap; new column called old_acquirer_precedingacquisition is the desired preceding col_acquirer_new. Use this as bait to fill in gap using correct previous col_acquirer_new
      findlowest_basedf_cutstring <- findlowest_basedf_arrange %>% 
    # filter(
    #   col_id_new %in% c(findlowest_basedf_2LU_check_gaprepair$col_id_new )
    # ) %>% 
        group_by(
          col_id_new, col_acquired, col_crop
        ) %>%
        #         mutate(
        #   groundyears_included = paste(ground_year %>% unique())
        # ) %>% 
        filter(
          ground_year != lag(ground_year)+1 
        ) %>% 
        ungroup() %>% 
        mutate(
          old_acquirer_precedingacquisition = 
            gsub(".*-", "", 
            beg2char(newnametemp, "-", 2)
            )
        )
      # this step commented out would have taken those in which there are earlier chain for each col_acquired. However,  seems that sendthruLU does have the entire string. So, overal this function simply removes those with partial and keeps those with the longest running chain and fills in gaps
      # findlowest_basedf_arrange_earliest <- findlowest_basedf_arrange %>% 
      #   group_by(
      #     col_acquired, col_crop
      #   ) %>% 
      #   arrange(ground_year) %>% 
      # slice(1)%>% 
      #   ungroup()
      # 
      # findlowest_basedf_missingbegin <- findlowest_basedf_arrange %>%
      #   filter(
      #     !col_id_new %in% c(findlowest_basedf_cutstring$col_id_new )
      #   ) %>% 
      #   group_by(
      #     col_id_new 
      #   ) %>% 
      #   mutate(
      #     col_id_new_ground_year_min = min(ground_year)
      #   ) %>% 
      #   ungroup() %>% 
      #   left_join(
      #     findlowest_basedf_arrange_earliest %>% 
      #       rename(
      #        col_acquired_ground_year_min = ground_year
      #       ) %>% 
      #       select(col_acquired, col_crop, col_acquired_ground_year_min), 
      #     by = c("col_acquired", "col_crop")
      #   ) %>% 
      #   filter(
      #     col_id_new_ground_year_min >col_acquired_ground_year_min
      #   ) %>% 
      #   mutate(
      #     old_acquirer_precedingacquisition = 
      #       gsub(".*-", "", 
      #       beg2char(newnametemp, "-", 2)
      #       )
      #   )
      #   findlowest_basedf_cutstring_and_begin <-   findlowest_basedf_cutstring #%>%
        # bind_rows(
        #   findlowest_basedf_missingbegin %>% 
        #     select(
        #       any_of(names (findlowest_basedf_cutstring ))
        #     )
        # )  
# this is dataframe of all years from sendthroughLU that have gaps 
      findlowest_basedf_cutstring_ids <- findlowest_basedf_arrange%>%
        inner_join(
          findlowest_basedf_cutstring %>% 
            select(
              col_id_new, col_crop, col_acquired
            ) %>% 
            distinct(),  
          by = c("col_id_new", "col_crop",
"col_acquired")
        )
        findlowest_basedf_cutstring_ids_extract <- findlowest_basedf_cutstring_ids  %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"
          #           col_acquired == "STONEVILLE PEDIGREED SEED",
          # col_crop == "canola"


        )%>%
    arrange(col_id_new, ground_year) 

      # this is dataframe of all years from sendthroughLU that do not have gaps 
      findlowest_basedf_longstring <- findlowest_basedf_arrange %>% 
        anti_join(
          findlowest_basedf_cutstring %>% 
            select(
              col_id_new, col_crop
            ), 
          by = c("col_id_new", "col_crop")
        ) %>% 
        group_by(
          col_id_new, col_acquired, col_crop
        ) %>%
        arrange(
          col_id_new, ground_year
        ) %>%
        ungroup() # %>% 
        # mutate(
        #   old_acquirer_1 = gsub(";.*", "", old_acquirer, perl = TRUE)
        # )
      # findlowest_basedf_longstring_incutstring <- findlowest_basedf_longstring %>% 
      #   anti_join(
      #     findlowest_basedf_cutstring_ids %>%
      #       select(
      #         old_acquirer , col_crop, col_acquired, ground_year
      #       ) %>%
      #       distinct()
      #   ) %>% 
      #   inner_join(
      #     findlowest_basedf_cutstring_ids %>%
      #       select(
      #         old_acquirer , col_crop, col_acquired
      #       ) %>%
      #       distinct()
      #   )
      
      # this takes the cutstring IDs, makes a column called old_acquirer_2 which takes old_acquirer (contains complete chain of acquisitions) and unnests them to one per row, and=  grabs all possible fragments from findlowest_basedf_allstrings. Then removes those already in findlowest_basedf_cutstring_ids (cutIDs all years).
      # in the left join cutstring IDs step, grabs the terminus col_acquirer_new of the chain that will function as bait primary. Ie prioritizes filtering to col_acquirer_new in the newly joined gap years that equal the terminus col_acquirer_new of cutids 
    # the removethis steps calculates if the priority col_acquirer_new is identified in each year with duplicates;
    #  if not, if there is a duplicate without a priority, the last step uses old_acquirer_precedingacquisition as secondary bait to filter for the col_acquirer_new
      # findlowest_basedf_allstrings %>% 
      #   filter(
      #     col_acquired == "SENSAKO", 
      #     col_crop == "sugarbeet"
      #     
      #   ) %>%
      #   arrange(col_id_new, ground_year) %>%
      #   View() %>% View()
      # findlowest_basedf_cutstring_join %>% 
      #   filter(
      #     # col_acquired == "SENSAKO", 
      #     col_crop == "sugarbeet"
      #     
      #   )  %>%
      #   arrange(col_id_new, ground_year) %>%
      #   View() 
      # findlowest_basedf_cutstring %>% 
      #   filter(
      #     # col_acquired == "SENSAKO", 
      #     col_crop == "sugarbeet"
      #     
      #   )  %>%
      #   arrange(col_id_new, ground_year) %>%
      #   View()%>% View()
      
       # this is all fragments; narrow to only those in cutstring.  
        findlowest_basedf_allstrings_incutstring<-findlowest_basedf_allstrings  %>% 
         inner_join(
           findlowest_basedf_cutstring %>% 
        select(
          col_acquired, col_crop
        ) %>% 
          distinct(),
        by = c("col_acquired", "col_crop")
         )
        
       # this generates all of the possible routes
       findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer <-findlowest_basedf_allstrings_incutstring %>%
        tidytext::unnest_tokens(
          .,
          output = old_acquirer_2,
          input = old_acquirer,
          token = "regex",
          drop = FALSE,
          to_lower = FALSE,
          pattern = "; "
        )
       # findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer.all_colacquirernew <- findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer %>% 
       #   group_by(
       #     col_crop, col_acquired, ground_year, col_acquirer_new
       #   )
       
findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer_extract <-       findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer  %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"
          #           col_acquired == "STONEVILLE PEDIGREED SEED",
          # col_crop == "canola"


        )%>%
    arrange( ground_year) 
      
# takes cutstrring and chops up old acquirer so that we should have all old acquirer 2s
   findlowest_basedf_cutstring_tokenize_oldacq2 <-    findlowest_basedf_cutstring %>% 
        select(
          # sometimes old acquirer preceding is not enough; 
          col_id_new, col_acquired, col_crop,old_acquirer, old_acquirer_precedingacquisition
        ) %>% 
        # mutate(
        #   # old_acquirer_2 = sub("^.*?\\; ","", old_acquirer)
        #   old_acquirer_2 = sub(";.*","", old_acquirer)
        # 
        # ) %>% 
        distinct() %>% 
        tidytext::unnest_tokens(
          .,
          output = old_acquirer_2,
          input = old_acquirer,
          token = "regex",
          drop = TRUE,
          to_lower = FALSE,
          pattern = "; "
        ) %>% 
     mutate(
       yearoldacq2 = as.numeric(substr(old_acquirer_2, 1,4))
     )%>% 
     group_by(
       col_id_new
     ) %>% 
     arrange(
       # arranges these in most current merger; and takes those from the top
       # rev( old_acquirer_2)
       -(yearoldacq2)
       
     ) %>% 
     mutate(
       old_acquirer_2_priority = row_number()
     ) %>% 
     ungroup() %>% 
     select(
       -yearoldacq2
     )
   
   
   findlowest_basedf_cutstring_tokenize_oldacq2_extract <-        findlowest_basedf_cutstring_tokenize_oldacq2  %>%
        filter(
          # col_acquired == "STONEVILLE PEDIGREED SEED",
          # col_crop == "canola"
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )  
   
      findlowest_basedf_cutstring_tokenize_oldacq2_if_multipleacq <- findlowest_basedf_cutstring_tokenize_oldacq2 %>% 
     anti_join(
       findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer, 
      by = c("old_acquirer_2", "col_crop", "col_acquired" )
     ) %>% 
        mutate(
          rownum1 = row_number()
        ) %>% 
        group_by(rownum1)%>% 
        mutate(
          old_acquirer_2 = gsub(
            paste0(old_acquirer_precedingacquisition,"-" ),
            "",
            old_acquirer_2
            )
        ) %>% 
        ungroup() %>% 
        select(-rownum1)

findlowest_basedf_cutstring_tokenize_oldacq2_if_multipleacq_extract <- findlowest_basedf_cutstring_tokenize_oldacq2_if_multipleacq  %>%
        filter(
          # col_acquired == "STONEVILLE PEDIGREED SEED",
          # col_crop == "canola"
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )  
   findlowest_basedf_cutstring_tokenize_oldacq2_long <- findlowest_basedf_cutstring_tokenize_oldacq2 %>% 
     mutate(
       acquirer = gsub(".*-", "", beg2char(old_acquirer_2, "-", 2)), 
       acquired = gsub(".*-", "", old_acquirer_2 )
     ) %>% 
     gather(
      key =  firmname_type, 
      value = firmname,
      acquirer:acquired
     ) 
   
      
           findlowest_basedf_cutstring_tokenize_oldacq2_long  %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )  %>%
    View() 

   #%>% 
     # group_by(
     #   
     # )
      findlowest_basedf_cutstring_join <- findlowest_basedf_cutstring_tokenize_oldacq2%>%
        bind_rows(
          findlowest_basedf_cutstring_tokenize_oldacq2_if_multipleacq
        ) %>% 
        # select(-old_acquirer) %>% 
        # old acquirer 2 becomes the bait to pull in all fragments with it 
        left_join(
          findlowest_basedf_allstrings_incutstring_tokenizeoldacquirer , 
          by = c("old_acquirer_2", "col_crop", "col_acquired"  #, "old_acquirer_precedingacquisition" = "col_acquirer_new"
                 )
        ) %>% 
        # dont want to have the same as what we already have
        anti_join(
                  
          findlowest_basedf_cutstring_ids, 
          by = c("col_id_new", "ground_year", "col_acquired", "col_crop")
        )
      
             findlowest_basedf_cutstring_join  %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )%>%
    arrange( ground_year) %>%
    View() 

      
      findlowest_basedf_cutstring_join_withsingle  <- findlowest_basedf_cutstring_join %>% 
        #take those in which there is only one and
        
        group_by(
          col_id_new, ground_year
        )  %>% 
        filter(
          n()==1
        ) %>% 
        ungroup() %>% 
        # and bind it to those that have the col acquirer new or col acquired new be in the chain
        bind_rows(
          findlowest_basedf_cutstring_join %>% 
            inner_join(
              findlowest_basedf_cutstring_tokenize_oldacq2_long %>%  
                select(
                  col_id_new, firmname
                ) %>% 
                distinct(),
              by = c("col_id_new", "col_acquirer_new" = "firmname")
            )%>% 
            inner_join(
              findlowest_basedf_cutstring_tokenize_oldacq2_long %>%  
                select(
                  col_id_new, firmname
                ) %>% 
                distinct(),
              by = c("col_id_new", "col_acquired_new" = "firmname")
            )
        )
        
             findlowest_basedf_cutstring_join_withsingle  %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )%>%
    arrange( ground_year) %>%
    View() 
findlowest_basedf_cutstring_ids %>% 
          filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        )%>%
    arrange( ground_year) %>%
    View() 

        # group_by()
        # obtain the col acquirer new of each fragment; call that the terminus since we are filling in the gaps preceding the terminus. if the gap is the terminus, prefer that over other values. 
        # left_join(
        #   findlowest_basedf_cutstring %>% 
        #     select(
        #        col_id_new, col_acquired, col_acquirer_new, col_crop
        #     ) %>% 
        #     rename(
        #       terminal_acquirer = col_acquirer_new
        #     ) %>% 
        #     distinct(), 
        #   by = c("col_id_new", "col_acquired", "col_crop")
        # ) %>% 
        # group_by(col_id_new, ground_year, col_acquired)%>%
        # # see how many unique acquirers we have per year; needs to be narrowed to, in order of preference, rows that only have one col acquirer new; the terminus of each gap; or are 
        # mutate(
        #   num_acquirers = 
        #     # max(
        #     # row_number(),
        #     length(unique(col_acquirer_new))
        #   # )
        # ) %>% 
        # ungroup() %>% 
        # 
        # mutate(
        #   # 0 is remove; 1 is keep
        #   remove_this = 
        #     case_when(
        #       num_acquirers==1 ~ 1, 
        #       (num_acquirers==2) & (col_acquirer_new == terminal_acquirer) ~ 1,
        #       TRUE ~ 0
        #     )
        # ) %>% 
        # # mutate(
        # #   remove_this_mirror = case_when(
        # #     remove_this == 0 ~ 1,
        # #     TRUE ~ 0
        # #     
        # #   )
        # # )%>% 
        #  group_by(col_id_new, ground_year, col_acquired)%>% 
        # mutate(
        #   sum_removethis = sum(remove_this, na.rm = TRUE)
        # ) %>%
        # ungroup() %>% 
        # 
        # # group_by(col_id_new, ground_year, col_acquired)%>% 
        # # mutate(
        # #   sum_per_year = sum(remove_this, na.rm = TRUE)
        # # ) %>% 
        # ungroup() %>% 
        # mutate(
        #   remove_this2 = 
        #     case_when(
        #       remove_this >= 1 ~ 1, 
        #       # sum_per_year >=1 ~ 1,
        #       (
        #         (remove_this ==0) &
        #         (sum_removethis ==0) & ( col_acquirer_new == old_acquirer_precedingacquisition)
        #         )~ 1, 
        #       TRUE ~ 0
        #     )
        # )#%>% 
        # mutate(
        #   remove_this2_mirror = case_when(
        #     remove_this2 == 0 ~ 1,
        #     TRUE ~ 0
        #     
        #   )
        # )%>% 
        #         group_by(col_id_new, ground_year, col_acquired)%>% 
        # mutate(
        #   sum_removethis2 = sum(remove_this2, na.rm = TRUE)
        # ) %>%
        # ungroup()# %>%
        # old acquirer 2 was the bait; so we want to filter for those that were probably acquired. However, this 
        # mutate(
        # 
        #     old_acquirer3 = gsub(
        #       ".*-","",
        #       beg2char(old_acquirer_2, "-", 2 )
        #       ), 
        # 
        #    remove_this3 = 
        #     case_when(
        #       remove_this2 == 0 ~ 0, 
        #       # sum_per_year >=1 ~ 1,
        #       (
        #         (remove_this2 == 1) &
        #         (sum_removethis2==0) & ( col_acquirer_new == old_acquirer3)
        #         )~ 0, 
        #       TRUE ~ 1
        #     )
        # )
        # filter(
        #   (
        #     old_acquirer_precedingacquisition == col_acquirer_new
        #     
        #   )|(num_acquirers==1)
        # )
    
      findlowest_basedf_repairstring <-  findlowest_basedf_cutstring_ids %>% 
        bind_rows(
          findlowest_basedf_cutstring_join_withsingle %>% 
            group_by(
              col_id_new, ground_year
            ) %>% 
            arrange(old_acquirer_2_priority) %>% 
            slice(1) %>% 
            ungroup()  
         )    %>%
        filter(
          !is.na(ground_year)
        )
      findlowest_basedf_repairstring %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        ) %>%
        arrange(col_id_new, ground_year) %>%
        View()
      # 
      #       findlowest_basedf_repairstring %>% 
      #   filter(
      #     # col_acquired == "SENSAKO",
      #     col_crop == "cotton"
      #     
      #   ) %>%
      #   arrange(col_id_new, ground_year) %>%
      #   View()

      # double check that no duplicates emerged
 findlowest_basedf_repairstring_dup <- findlowest_basedf_repairstring %>% 
      group_by(ground_year, col_id_new) %>% 
   # mutate(
   #   numrows = n()
   # ) %>% 
      filter(
        n() >=2
        # length(unique(col_acquirer_new))>=2 
      ) 
 
 if(nrow(findlowest_basedf_repairstring_dup)>=1)
 {
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   
 }
 
 findlowest_basedf_repairstring_nodup <- findlowest_basedf_repairstring %>% 
      group_by(ground_year, col_id_new) %>% 
   slice(1) %>% 
   ungroup() 
 
findlowest_basedf_repairstring_nodup_ifgap <- findlowest_basedf_repairstring %>%
        mutate(
          id_acq = paste0( ground_year , "-", col_acquirer_new)
        ) %>%
        group_by(
          col_id_new,col_acquired, col_crop
        ) %>%
        mutate(
          countid = length(unique(id_acq)),

          id_acq= paste(sort( unique(id_acq)), collapse = ";")
        ) %>%
        ungroup() %>%  
       group_by(
         col_id_new
       ) %>% 
       mutate(
         maxyear = max(ground_year, na.rm = TRUE), 
         minyear = min(ground_year, na.rm = TRUE)
       ) %>% 
       ungroup() %>% 
       mutate(
         diffyear = maxyear - minyear +1 
       ) %>%
   filter(
     diffyear != countid
   )

 if(nrow(findlowest_basedf_repairstring_nodup_ifgap)>=1)
 {
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   print("nrow(findlowest_basedf_repairstring_dup)>=1")
   
 }


        findlowest_basedf_repairstring_nodup_ifgap %>%
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        ) %>%
  arrange(col_id_new, ground_year) %>%
         View()
# findlowest_basedf_repairstring_nodup %>% 
#         filter(
#           # col_acquired == "SENSAKO", 
#           col_crop == "sugarbeet"
# 
#         ) %>%
#   arrange(col_id_new, ground_year) %>%
#          View()
 # if(nrow(findlowest_basedf_repairstring_dup)  >= 2)
 # {
 #   break
 #   
 # }
  #      findlowest_basedf_repairstring_nodup %>% 
  #       filter(
  #         col_acquired == "SENSAKO", 
  #         col_crop == "sugarbeet"
  # 
  #       ) %>%
  # arrange(col_id_new, ground_year) %>%
  #        View()

 
  #   findlowest_basedf_repairstring  %>% 
  # filter(
  #   # grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
  #   col_crop == "blueberry"
  # ) %>%
  # arrange(col_id_new, ground_year) %>% 
  # View()

    #joins both sets 
findlowest_basedf_longstring_withcutrepair <-    findlowest_basedf_longstring %>% 
      bind_rows(
        findlowest_basedf_repairstring_nodup %>% 
          select(
            any_of(findlowest_basedf_longstring %>% names() )
          )
      )
    
# this will  find all the number of year-names in each string
      findlowest_basedf_longstring_sum <- findlowest_basedf_longstring_withcutrepair %>% 
        mutate(
          id_acq = paste0( ground_year , "-", col_acquirer_new)
        ) %>% 
        group_by(
          col_id_new,col_acquired, col_crop 
        ) %>% 
        summarise(
          countid = length(unique(id_acq)),
          
          id_acq= paste(sort( unique(id_acq)), collapse = ";") 
        ) %>% 
        ungroup() #%>% 
      
      # Below is 
 
      findlowest_basedf_2LU <-# findlowest_basedf
        findlowest_basedf_longstring_withcutrepair%>%
        mutate(
          id_acq = paste0( ground_year , "-", col_acquirer_new)
        ) %>%
        group_by(
          col_id_new,col_acquired, col_crop
        ) %>%
        mutate(
          countid = length(unique(id_acq)),

          id_acq= paste(sort( unique(id_acq)), collapse = ";")
        ) %>%
        ungroup() 
      
 findlowest_basedf_2LU_check_gaprepair <- findlowest_basedf_2LU     %>% 
       group_by(
         col_id_new
       ) %>% 
       mutate(
         maxyear = max(ground_year, na.rm = TRUE), 
         minyear = min(ground_year, na.rm = TRUE)
       ) %>% 
       ungroup() %>% 
       mutate(
         diffyear = maxyear - minyear +1 
       ) %>%
   filter(
     diffyear != countid
   )
if(nrow(findlowest_basedf_2LU_check_gaprepair)>=1)
{
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")
     print("nrow(findlowest_basedf_2LU_check_gaprepair)>=1")

  
}
 # findlowest_basedf_2LU %>%
 #   filter(
 #     col_crop == "sugarbeet", 
 #    grepl(
 #       "STONEVILLE", col_acquired, 
 #       ignore.case = TRUE, perl = TRUE
 #    ) 
 #     
 #   ) %>%
 #   
 #   arrange(col_id_new, ground_year) %>%
 #   View()
 
  # findlowest_basedf_2LU_check_gaprepair %>%
  #  filter(
  #    col_crop == "sugarbeet"
  #    
  #  ) %>%
  #  
  #  arrange(col_id_new, ground_year) %>%
  #  View()

 # mutate(
      #   id_acq= paste0(col_crop, "; ", id_acq)
      # )
      findlowest_basedf_3 <- findlowest_basedf_longstring_sum %>% 
        group_by(
          id_acq,col_acquired, col_crop
        ) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(
          rownum = row_number()
        )
      
     func_to_filter <- function(funcfilterxdf_k){
       # require(tidyverse)
       currentfinddf <-  findlowest_basedf_3[funcfilterxdf_k, ]
       currentfind <- currentfinddf$id_acq[1]
       currentcrop <- currentfinddf$col_crop[1]
       current_acquired <- currentfinddf$col_acquired[1]

       findlowest_basedf_2_current <-  findlowest_basedf_3%>% 
         filter(
           col_crop == currentcrop,
          col_acquired ==  current_acquired,
           grepl(
             currentfind, id_acq, perl = TRUE
           )
         )
       
       findlowest_basedf_2_current_reduce <- findlowest_basedf_2_current %>%
         slice(which.max(countid))
       
       # findlowest_basedf_2_sendout <- findlowest_basedf_2_current %>% 
       #   mutate(
       #     which_id_col_has_most = findlowest_basedf_2_current_reduce$col_id_new[1]
       #   ) %>% 
       #   distinct()
       findlowest_basedf_2_current_reduce$col_id_new[1]
       # findlowest_basedf_2_sendout 
     }
     
     listofpass_bindrows <-findlowest_basedf_3  %>%
       # head() %>% 
     # head(1) %>% 
  mutate(
    which_id_col_has_most = future_map(
    rownum, ~func_to_filter( 
      .
    )#,  
  ) ,
  .options = c(
    packages = c("tidyverse")
  )
  )  %>%
  mutate(
    which_id_col_has_most = as.character(which_id_col_has_most)
  )
  # i <-1
  # 
  #   rm(listofpass)
  # listofpass <- list()
  # while(i <= nrow(findlowest_basedf_3))
  # {
  #   findlowest_basedf_2_current <- findlowest_basedf_3  %>% 
  #      filter(
  #      grepl(
  #        findlowest_basedf_3$id_acq[i], id_acq, perl = TRUE
  #      )
  #     )
  #   findlowest_basedf_2_current_reduce <- findlowest_basedf_2_current %>%
  #     slice(which.max(countid))
  #   listofpass[[i]] <- findlowest_basedf_2_current %>% 
  #     mutate(
  #       which_id_col_has_most = findlowest_basedf_2_current_reduce$col_id_new[1]
  #     ) %>% 
  #     distinct()
  #   i <- i+1
  #   gc()
  #    
  # }
  # rm(i)
  # 
  # listofpass_bindrows <- listofpass %>% 
  #   bind_rows() %>% 
  #   distinct()

  findlowest_basedf_2LU_withbase <-    findlowest_basedf_2LU %>% 
    left_join(
        listofpass_bindrows %>% 
           select(id_acq, which_id_col_has_most, col_acquired,col_crop ) %>% 
           distinct() %>% 
          rename(col_id_new_distill =which_id_col_has_most ),
           by = c("id_acq", "col_acquired", "col_crop")
    ) %>% 
    distinct()
  
  ### the below are checking steps, to make doubly sure that there are no gaps in what we found 
     findlowest_basedf_2LU_withbase2 <- findlowest_basedf_2LU %>%  
       filter(
         col_id_new %in% c( listofpass_bindrows$which_id_col_has_most)
       )  %>% 
       group_by(
         col_id_new
       ) %>% 
       mutate(
         maxyear = max(ground_year), 
         minyear = min(ground_year)
       ) %>% 
       ungroup() %>% 
       mutate(
         diffyear = maxyear - minyear +1 
       )
     
 findlowest_basedf_2LU_withbase3reduce <-  findlowest_basedf_2LU_withbase2    %>% 
      functionreduce_down_dups(passthrudf =. )
     ## this is to check
     findlowest_basedf_2LU_withbase2_reid <- findlowest_basedf_2LU_withbase3reduce %>% 
       filter(
         diffyear != countid
       ) %>% 
       group_by(
         col_id_new
       ) %>% 
       filter(
         ground_year != lag(ground_year)+1
       ) %>% 
      ungroup()  
     
     if(nrow(findlowest_basedf_2LU_withbase2_reid)>=1)
     {
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       print("nrow(findlowest_basedf_2LU_withbase2_reid)>=1")
       
     }
     # findlowest_basedf_2LU_withbase2 %>% 
     #   filter(
     #     col_id_new %in% c( findlowest_basedf_2LU_withbase2_reid$col_id_new)
     #   ) %>% 
     #   View()
     # find_gapyearsfunc <<- 
     
# findlowest_basedf_2LU_withbase2 %>%
#   filter(
#     # grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
#     col_crop == "blueberry"
#   ) %>%
#   arrange(col_id_new, ground_year) %>%
#   View()
       
  # listofpass_bindrows %>% 
  #   feather::write_feather(
  #     writeoutfile
  #   )
  findlowest_basedf_2LU_withbase
}

### use it 
```

#### use reduce1 
```{r }
sendthroughmergers_LU_reduce <- sendthroughmergers_LU %>% 
  findgcd_merger(findlowest_basedf = ., numworker =90)
sendthroughmergers_LU_reduce <-findlowest_basedf_2LU_withbase
# sendthroughmergers_LU_reduce2  <- sendthroughmergers_LU_reduce %>% 
#   filter(
#     col_id_new %in% c(sendthroughmergers_LU_reduce$col_id_new_distill )
#   )
sendthroughmergers_LU_reduce %>% 
        filter(
          col_acquired == "ROYAL SLUIS",
          col_crop == "sugarbeet"

        ) %>%
  arrange(col_id_new, ground_year) %>%
         View()
sendthroughmergers_LU   %>% 
  filter(
    grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
    col_crop == "blueberry"
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

  sendthroughmergers_LU_reduce %>% 
    feather::write_feather(
      "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230910_sendthroughlureduce.feather"
    )
    sendthroughmergers_LU_reduce <-
    feather::read_feather(
      "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230901_sendthroughlureduce.feather"
    )

  
sendthroughmergers_LU_reduce <- sendthroughmergers_LU %>% 
  findgcd_merger(findlowest_basedf = . , numworker=90)  

```


### reduce2: join past and future acquired 
```{r }

joinpast_and_present_futureacquired_fromreduce <- function(findlowest_basedf2 = sendthroughmergers_LU_reduce, origfuncdc ){
  # #### 
  findlowest_basedf2 = sendthroughmergers_LU_reduce
  origfuncdc = sendthroughmergers_LU
  
  findlowest_basedf <-findlowest_basedf2 %>% 
    filter(!is.na(ground_year))
  findlowest_basedf_maxyear <-max( findlowest_basedf$ground_year)
  
  # findlowest_basedf_joined  %>% 
  # filter(
  #   # grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
  #   col_crop == "canola"
  # ) %>%
  # arrange(col_id_new, ground_year) %>% 
  # View()
  
  findlowest_basedf_joined <- findlowest_basedf2 %>% 
        filter(
          # takes only those col id news that are not the longest
      col_id_new != col_id_new_distill 
    ) %>% 

        group_by(col_id_new ) %>% 
        mutate(
          minyear_in_id = min(ground_year) , 
          maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new ,col_crop,   col_acquired, minyear_in_id  , maxyear_in_id, col_id_new_distill
        ) %>% 
        rename(
          col_id_new1 = col_id_new
        )%>%
        distinct() %>% 
    inner_join(
          findlowest_basedf %>% 
            select(
            col_id_new,  col_acquirer, col_acquired, col_year, col_id, ground_year, col_acquired_new, col_acquirer_new, newnametemp, old_acquirer, id_acq, countid
              # -col_id_new_distill
            ),# %>%
          by = c(
           "col_id_new_distill" = "col_id_new", "col_acquired"

          )
          
        )%>% 
        filter(
          # !is.na(col_acquirer),
          # ground_year < minyear_in_id
          ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        # mutate(
        #   col_acquired = col_acquired_old
        # )%>% 
        # select(
        #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
    # )%>% 
    mutate(
      # col_id_new = col_id_new2, 
      #this will be the new id name
      col_id_new2= paste0(col_id_new1, "; ", col_id_new_distill) 
    ) %>% 
    select(
      -minyear_in_id , -maxyear_in_id
    )%>% 
    distinct() 

  # this will rewrite col id new 2 into unique id 
  findlowest_basedf_joined_needreid <- findlowest_basedf_joined%>% 
    splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = 0, prefix = "fl1")%>% 
    mutate(
      col_id_new2 = coltotrans
    ) %>% 
    select(
      -coltotrans
    )
   # findlowest_basedf_joined_notin_atall  <-findlowest_basedf %>% 
   #          filter(
   #            col_id_new != col_id_new_distill
   #          )
   #   # this will reassign those old ids that are shorter chains into the new ids 
          findlowest_basedf_joined_final  <-
          # filter(
          #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_id_new1),
          #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_toreplaceprev)
          #   ) %>% 
          bind_rows(
            #this should be the max existing
            findlowest_basedf %>% 
              inner_join(
                findlowest_basedf_joined_needreid %>% 
                select(
                  col_id_new2, col_id_new1     
                ) %>% 
                distinct(),
              by = c("col_id_new" = "col_id_new1")
              )%>% 
              rename(
                col_id_new1 = col_id_new
              )%>% 
              # select(
              #   -id_acq, -countid
              # ) %>% 
              # should be col_acq max add on
            bind_rows(
              findlowest_basedf_joined_needreid 
            ) %>% 
              rename(
                col_id_new = col_id_new2
              ) #%>%
            # select(
            #   -col_id_new_distill 
            # )
          )
          
   findlowest_basedf_joined_final2 <- findlowest_basedf_joined_final       %>% 
            bind_rows(
              findlowest_basedf %>% 
            # filter(
            #   col_id_new != col_id_new_distill
            # ) %>% 
            anti_join(
              findlowest_basedf_joined_final %>%
                select(col_id_new1) %>%
                distinct(),
              by = c("col_id_new" = "col_id_new1")
            ) 
            ) %>% 
            select(
              -col_id_new_distill
            )%>% 
     distinct() 
   
   ### the below is to double check if findlowest_basedf_joined_final2 arrives at 
   # findlowest_basedf_joined_final2 %>% 
   #    filter(
   #      col_crop == "canola"
   #    ) %>% 
   #    arrange(
   #      col_id_new, ground_year
   #    ) %>%  View()
   findlowest_basedf_2LU_doublecheckifgap <- findlowest_basedf_joined_final2 %>%  
       group_by(
         col_id_new
       ) %>% 
       mutate(
         countid = length(unique(ground_year)),
         maxyear = max(ground_year), 
         minyear = min(ground_year)
       ) %>% 
       ungroup() %>% 
       mutate(
         diffyear = maxyear - minyear +1 
       )
     
 
 findlowest_basedf_2LU_doublecheckifgap_hasgap1 <- findlowest_basedf_2LU_doublecheckifgap %>% 
       filter(
         diffyear != countid
       ) 
  
    # findlowest_basedf_2LU_doublecheckifgap %>% 
    #   filter(
    #     col_id_new %in% c(findlowest_basedf_2LU_doublecheckifgap_hasgap1$col_id_new )#, 
    #     # col_crop == "canola"
    #   ) %>% 
    #   arrange(
    #     col_id_new, ground_year
    #   )%>% 
    #   View() 

 
     if(nrow(findlowest_basedf_2LU_doublecheckifgap_hasgap1)>=2)
   {
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
          print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")

   }

 findlowest_basedf_2LU_doublecheckifgap_hasgap <- findlowest_basedf_2LU_doublecheckifgap %>% 
       group_by(
         col_id_new
       ) %>% 
    arrange(
      ground_year
    ) %>% 
       filter(
         ground_year != lag(ground_year)+1
       ) %>% 
      ungroup()   %>% 
    arrange(
      col_id_new, ground_year
    )  
   if(nrow(findlowest_basedf_2LU_doublecheckifgap_hasgap)>=2)
   {
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
          print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")
     print("nrow(findlowest_basedf_2LU_doublecheckifgap)>=2 ")

   }
   
        findlowest_basedf_joined_final_reduce <-findlowest_basedf_joined_final2   %>% 
      # select(
      #   -col_id_new_distill
      # ) %>% 
      distinct()%>% 
        # func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>%
        # ungroup() %>%
        # select(
        #   -col_id_new
        # ) %>%
        # rename(
        #   col_id_new = col_whichcolisid_new
        # )%>% 

      functionreduce_down_dups(passthrudf =. ) %>% 
       select(
         names(origfuncdc)
       )
        
        
#  findlowest_basedf_joined_final2_maxyear <-findlowest_basedf_joined_final2  %>% 
#   group_by(
#     col_id_new
#   ) %>% 
#   mutate(
#     maxyear = max(ground_year)
#   ) %>% 
#   ungroup() %>%
#   filter(
#     maxyear==findlowest_basedf_maxyear
#   ) %>% 
#   ungroup() 
#    
#    # findlowest_basedf_joined_final2_maxyear       %>% 
#    #   filter(
#    #     !col_id_new %in% c(findlowest_basedf_joined_final2$col_id_new)
#    #   ) %>% View()
#    
#  findlowest_basedf_joined_final2_minyear <-findlowest_basedf_joined_final2_maxyear  %>% 
#   group_by(
#     col_acquired
#   ) %>% 
#   mutate(
#     minacq = min(ground_year)
#   )  %>% 
#   ungroup() %>% 
#   group_by(
#     col_id_new, col_acquired
#   ) %>% 
#   mutate(
#     minacq_per_id = min(ground_year)
#   ) %>% 
#   ungroup() %>% 
#   filter(
#      minacq_per_id==minacq
#   ) %>% 
#   ungroup() 
#  
#     
#    # findlowest_basedf_joined_final2_maxyear       %>% 
#    #   filter(
#    #     !col_id_new %in% c(findlowest_basedf_joined_final2_minyear$col_id_new)
#    #   ) %>% View()
# 
#  
# findlowest_basedf_joined_final2_minyear_rangeyear <- findlowest_basedf_joined_final2_maxyear%>% 
#        group_by(col_id_new) %>% 
#   mutate(
#     rangeyear = length(unique(ground_year)),
#     minyear = min(ground_year),
#     maxyear = max(ground_year),
#     yearspan = maxyear - minyear+1
#     # supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))
#      
#   ) %>% 
#   ungroup() %>% 
#   filter(
#     yearspan==rangeyear
#   ) 

   # findlowest_basedf_joined_final2_minyear       %>% 
   #   filter(
   #     !col_id_new %in% c(findlowest_basedf_joined_final2_minyear_rangeyear$col_id_new)
   #   ) %>% View()

    
            # findlowest_basedf_joined_final2   %>% 
            #   # group_by()
            #   slice( c(72041, 72050) ) %>% View()
                 



        # 
        #      rm(findlowest_basedf)
        # rm(findlowest_basedf_joined)
        # rm(findlowest_basedf_joined_final)
        # rm(findlowest_basedf_joined_final_reduce)
        # rm(findlowest_basedf_joined_final2)
        # rm(findlowest_basedf_joined_final2_maxyear)
        # rm(findlowest_basedf_joined_final2_minyear)
        # rm(findlowest_basedf_joined_final2_minyear_rangeyear)
        # rm(findlowest_basedf_joined_needreid)
        # rm(findlowest_basedf_2LU_doublecheckifgap)

     
     findlowest_basedf_joined_final_reduce
     
}

```

#### commented out below
##### commented out below
```{R }
          #    findlowest_basedf_joined_final_reduce %>%
          # filter(
          #   col_crop == "cotton"
          # ) %>%
          # arrange(
          #   col_id_new, ground_year
          # ) %>% View()
#
#             findlowest_basedf_joined %>% 
#               inner_join(
#                 findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#               ) %>% 
#               
#             
#           findlowest_basedf_filter %>% 
#             inner_join(
#               findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#             ) %>% 
#             arrange(
#               col_id_new2, ground_year
#             )%>% 
#             # select(-col_toreplaceprev) %>% 
#           #then actually bring the renamed prevs
#           # select(
#           #   -col_id_new
#           # )%>%
#           rename(
#             col_id_new1 = col_id_new
#           ) %>%
#           bind_rows(
#             findlowest_basedf_joined_needreid%>% 
#               select(
#                   -col_toreplaceprev, -col_id_new2copyorig, -minyear_in_id , -maxyear_in_id
#               )   
#             # select(
#             #   -col_id_new_toreplace
#             # ) %>%
#             # rename(
#             #   col_id_new = col_id_new_toreplace
#             # )
#           ) %>%
#           # rename(
#           #   col_id_newprev = col_id_new
#           # ) %>% 
#           rename(
#             # col_id_makesurenone = col_id_new,
#             # 
#             # col_id_new = col_id_new_toreplace
#             col_id_new3 = col_id_new2
#           # )
#         ) %>% 
#           # rename(
#           #   col_id_makesurenone = col_id_new,
#           #   col_id_new = col_id_new_toreplace
#           # ) %>% 
#           arrange(
#             col_id_new3,ground_year
#           ) %>% 
#           distinct()
#           
# 
#   
#     
#   ### comment out above
#       i <- 1
#       acquiredlist <- findlowest_basedf$col_acquired %>% unique()
#       while(i <= length(acquiredlist))
#       {
#         findlowest_basedf_current <- findlowest_basedf %>% 
#           filter(col_acquired == acquiredlist[i])
#         
#           findlowest_basedf_joined <-    findlowest_basedf_filter%>% 
#         group_by(col_id_new ) %>% 
#         mutate(
#           minyear_in_id = min(ground_year) , 
#           maxyear_in_id = max(ground_year)
#         ) %>% 
#         ungroup() %>% 
#         select(
#           col_id_new ,   col_acquired, col_crop, minyear_in_id  , maxyear_in_id
#         ) %>% 
#         rename(
#           col_id_new1 = col_id_new
#         )%>%
#         distinct() %>% 
#         inner_join(
#           findlowest_basedf_filter,# %>%
#             # select(
#             #   -col_acquired_new
#             # ),#  %>%  
#             # filter(
#             #   col_year  <  currentyear
#             # ), #%>% 
#           #      filter(ground_year < currentyear),
#           # select(
#           #   -col_id_new
#           # ),
#           # select(
#           #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
#           # )%>% 
#           by = c(
#             "col_acquired",  "col_crop" 
# 
#           )
#           
#         )%>% 
#         filter(
#           # !is.na(col_acquirer),
#           # ground_year < minyear_in_id
#           col_id_new1 != col_id_new,
#           ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
#         )%>% 
#         # mutate(
#         #   col_acquired = col_acquired_old
#         # )%>% 
#         # select(
#         #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
#         # )%>% 
#         mutate(
#           # col_id_new = col_id_new2, 
#           #this will be the new id name
#           col_id_new2= paste0(col_id_new1, "; ", col_id_new) 
#          )   %>% 
#     mutate(
#       col_id_new2copyorig = col_id_new2
#     )%>% 
#         rename(
#           col_toreplaceprev = col_id_new
#         ) 
# 
#         
#       }
# 
#   findlowest_basedf_joined <-    findlowest_basedf_filter%>% 
#         group_by(col_id_new ) %>% 
#         mutate(
#           minyear_in_id = min(ground_year) , 
#           maxyear_in_id = max(ground_year)
#         ) %>% 
#         ungroup() %>% 
#         select(
#           col_id_new ,   col_acquired, col_crop, minyear_in_id  , maxyear_in_id
#         ) %>% 
#         rename(
#           col_id_new1 = col_id_new
#         )%>%
#         distinct() %>% 
#         inner_join(
#           findlowest_basedf_filter,# %>%
#             # select(
#             #   -col_acquired_new
#             # ),#  %>%  
#             # filter(
#             #   col_year  <  currentyear
#             # ), #%>% 
#           #      filter(ground_year < currentyear),
#           # select(
#           #   -col_id_new
#           # ),
#           # select(
#           #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
#           # )%>% 
#           by = c(
#             "col_acquired",  "col_crop" 
# 
#           )
#           
#         )%>% 
#         filter(
#           # !is.na(col_acquirer),
#           # ground_year < minyear_in_id
#           col_id_new1 != col_id_new,
#           ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
#         )%>% 
#         # mutate(
#         #   col_acquired = col_acquired_old
#         # )%>% 
#         # select(
#         #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
#         # )%>% 
#         mutate(
#           # col_id_new = col_id_new2, 
#           #this will be the new id name
#           col_id_new2= paste0(col_id_new1, "; ", col_id_new) 
#          )   %>% 
#     mutate(
#       col_id_new2copyorig = col_id_new2
#     )%>% 
#         rename(
#           col_toreplaceprev = col_id_new
#         ) 
#         findlowest_basedf_filter %>% 
#     filter(
#       col_id_new == "{27}merge00312]agrotricum; {18wp1}merge00096]agrotricum; {18w1}merge00188]agrotricum"
#         # col_crop == "cotton",
#         # grepl(pattern= "merge00312]agrotricum",x= col_id_new2,perl = TRUE)
#     )%>% 
#     View()
# 
#   
#   findlowest_basedf_joined %>% 
#     filter(
#       col_id_new1 == "{27}merge00312]agrotricum; {18wp1}merge00096]agrotricum; {18w1}merge00188]agrotricum"
#         # col_crop == "cotton",
#         # grepl(pattern= "merge00312]agrotricum",x= col_id_new2,perl = TRUE)
#     )%>% 
#     View()
# 
# # c('
# # $ col_id_new2       <chr> "{6w1}merge00…
# # $ col_acquired_new  <chr> "LIMAGRAIN GE…
# # $ col_crop          <chr> "agrotricum",…
# # $ col_id_new1       <chr> "{6w1}merge00…
# # $ col_acquirer      <chr> "LIMAGRAIN GE…
# # $ col_acquired      <chr> "VILMORIN", "…
# # $ col_year          <dbl> 1975, 1975, 1…
# # $ col_id            <chr> "merge00291]a…
# # $ ground_year       <dbl> 1975, 1976, 1…
# # $ col_toreplaceprev <chr> "merge00291]a…
# # $ old_acquirer      <chr> "1975-LIMAGRA…
# # $ newnametemp       <chr> "1975-LIMAGRA…
# # $ col_acquirer_new  <chr> "LIMAGRAIN GE…
# # ')      
#       if(!(nrow(findlowest_basedf_joined) >=1))
#       {
#         
#         i <- i+1
#         next
#       }
# 
#     
#       if(nrow(findlowest_basedf_joined) >=1)
#       {
#         # break
#         
#         #renames it
#         findlowest_basedf_joined_needreid <- findlowest_basedf_joined%>% 
#           splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "fl1")%>% 
#           mutate(
#             col_id_new2 = coltotrans
#           ) %>% 
#           select(
#             -coltotrans
#           )
#         # whichgetacquired_rename_withpast_needreid_withpresent <- whichgetacquired_rename_withpast_needreid %>% 
#         #   bind_rows(
#         #     whichgetacquired_rename_id
#         #   )
#         # 
#         
#         
#         whichgetacquired_rename_id_newid  <- # findlowest_basedf_filter  %>% 
#           # filter(
#           #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_id_new1),
#           #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_toreplaceprev)
#           #   ) %>% 
#           bind_rows(
#           findlowest_basedf_filter %>% 
#             inner_join(
#               findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#             ) %>% 
#             arrange(
#               col_id_new2, ground_year
#             )%>% 
#             # select(-col_toreplaceprev) %>% 
#           #then actually bring the renamed prevs
#           # select(
#           #   -col_id_new
#           # )%>%
#           rename(
#             col_id_new1 = col_id_new
#           ) %>%
#           bind_rows(
#             findlowest_basedf_joined_needreid%>% 
#               select(
#                   -col_toreplaceprev, -col_id_new2copyorig, -minyear_in_id , -maxyear_in_id
#               )   
#             # select(
#             #   -col_id_new_toreplace
#             # ) %>%
#             # rename(
#             #   col_id_new = col_id_new_toreplace
#             # )
#           ) %>%
#           # rename(
#           #   col_id_newprev = col_id_new
#           # ) %>% 
#           rename(
#             # col_id_makesurenone = col_id_new,
#             # 
#             # col_id_new = col_id_new_toreplace
#             col_id_new3 = col_id_new2
#           # )
#         ) %>% 
#           # rename(
#           #   col_id_makesurenone = col_id_new,
#           #   col_id_new = col_id_new_toreplace
#           # ) %>% 
#           arrange(
#             col_id_new3,ground_year
#           ) %>% 
#           distinct()
#           )
#         
#         whichgetacquired_rename_id_newid %>% 
#           filter(
#             col_crop == "cotton"
#           ) %>% 
#           arrange(
#             col_id_new3, ground_year
#           ) %>% 
#           View()
#            # now rename future ids to that renamed previously
#           
#         
#      whichgetacquired_rename_id_newid_reduce <-whichgetacquired_rename_id_newid   %>% 
#       functionreduce_down_dups(passthrudf =. )
#      
#      listofpass[[i]] <-whichgetacquired_rename_id_newid_reduce
#      i <- i+1
# #      whichgetacquired_rename_id_newid_reduce %>% 
# #     group_by(col_id_new) %>% 
# #     mutate(
# #         totalyear = length(unique(ground_year)) 
# #     ) %>% filter(col_crop == "cotton") %>% 
# #  View()
# #      
# # whichgetacquired_rename_id_newid_reduce %>% 
# #   group_by(col_id_new) %>% 
# #   mutate(
# #     totalyear = length(unique(ground_year)) 
# #   ) %>% 
# #   group_by(
# #     totalyear, col_crop 
# #   ) %>%
# #   summarise(
# #     totyearunique = length(unique(totalyear)) 
# #   )
#         # select(
#         #   -col_id_new.x
#         # ) %>% 
#       }
#   }
#   listofpass %>%
#     bind_rows()
# }

```


#### use reduce2 function
```{r }
sendthroughmergers_LU_reduce2 <- sendthroughmergers_LU_reduce %>%  joinpast_and_present_futureacquired_fromreduce(findlowest_basedf =., origfuncdc = sendthroughmergers_LU)

sendthroughmergers_LU_reduce2 <-  findlowest_basedf_joined_final_reduce

sendthroughmergers_LU_reduce2 %>%
    filter(
        col_crop == "cotton"
    ) %>%
    arrange(
        col_id_new, ground_year
    ) %>% 
  writexl::write_xlsx("X:/msi/work/farmer welfare/seed/R analysis/merger journal/230821/230901_sendthroughlureduce2.xlsx")

sendthroughmergers_LU_reduce2 %>% 
  feather::write_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230910_sendthroumergers_LU_reduce2.feather"
  )

sendthroughmergers_LU_reduce2 <-  
  feather::read_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230903_sendthroumergers_LU_reduce2.feather"
  )
    sendthroughmergers_LU_reduce2 %>% 
      filter(
        col_crop == "canola"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) %>%  View()

```

```{r }
countryLU <- data.table::fread(
  "https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv"
)

```
##  pair patents with merger

### func 1
```{r }

joinpatents_with_mergerfunc <- function(patentpvp_df_func, mergerdf_func,  years_max  =  2023){
  # 
  # sendthroughmergers_LU_reyear <- y%>% 
  # group_by(
  # col_crop, col_acquirer_col_acquired_col_year,old_acquirer_name_new  
  # ) %>% 
  # slice(1) %>% 
  #   # ungroup() %>% 
  #   select(
  #     -ground_year
  #   ) %>% 
  #   mutate(
  #     min_year =  
  #   )
# patentpvp_df_func <- pvppatent_combine_url_filter
# # patentdf_func=soycropquery_unnest_df
# mergerdf_func= sendthroughmergers_LU_reduce2
# pvpdf_func= pvppatent_combine_url_filter
# years_max =   mergerdf_func$ground_year %>% max(., na.rm = TRUE)



patentpvp_df_standard <- patentpvp_df_func %>% 
  # used a different crop lu 
  select(
    -contains("crop_")
  ) %>% 
   mutate(
     patent_years = case_when(
       patent_type == "design" ~ 14, 
       TRUE ~ 20
     ),
     patent_type2 = patent_type_orig, 
     patent_number_edit = patent_number, 
     id = patent_number
   )%>%       
  # standardizenames_crop(zzcroplistrfdf = croplistLU221126_2)
  standardizenames_crop(
    ., 
    zzwhichcol_to_rename =.$crop , 
    zzcroplistrfdf = croplistLU221126_2
    )%>%
   select(
     -crop
   )%>%
   rename(
     crop = crop_shortname
   ) %>%
  # standardizenames_companies()
  # standardizenames_companies(zzluconames_df = lu_conames_out230705_match)
  standardizenames_companies(
    zz=., 
    whichcol_to_rename =.$applicant_upper, 
    zzluconames_df = lu_conames_out230705_match
  )%>%
  rename(
    # name_standard_patent = renamedcol,
    name_standard_patent2= Namestandard
  )%>% 
  mutate(
       universal_id_start = paste0("renameid_",row_number())
  )   %>% 
    select(
      id, name_standard_patent2,applicant_upper, abstract_title, crop, patent_year, crop_type, crop_type2, patent_type,patent_type2, patent_years,#terms,terms_tfidf,
      patent_number_edit, patent_number
    ) %>% 
   mutate(
     name_standard_patent2= replace_na(name_standard_patent2,"name not found" )
       
     ) %>% 
  group_by(
    id, crop
  ) %>% 
  slice(1) %>% 
  ungroup()

# check if any names or crops didnt match with LU standardname 
patentpvp_df_standard_isnaname_standard_patent2 <- patentpvp_df_func %>% 
  filter(
    !patent_number   %in%   c( patentpvp_df_standard$patent_number  ) 
  )
# 
#   patentpvp_df_standard %>%
#   filter(
#     is.na( name_standard_patent2),  !(nchar(name_standard_patent2)>=3)
#   ) 


if(nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2 ){
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
    print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )

}
patentpvp_df_standard_isna_crop <- patentpvp_df_standard %>%
  filter(
    is.na( crop)
  ) 
if(nrow(patentpvp_df_standard_isna_crop)>=2 ){
  print("patentpvp_df_standard_isna_crop)>=2 " )
  print("patentpvp_df_standard_isna_crop)>=2 " )
  print("patentpvp_df_standard_isna_crop)>=2 " )
  print("patentpvp_df_standard_isna_crop)>=2 " )

}


patentpvp_df_standard_isna_firmname <- patentpvp_df_standard %>%
  filter(
   (  is.na( name_standard_patent2)) | ((name_standard_patent2== "name not found")&(!is.na(nchar(applicant_upper)))
  )
  )
if(nrow(patentpvp_df_standard_isna_firmname)>=2 ){
  print("patentpvp_df_standard_isna_firmname)>=2 " )
  print("patentpvp_df_standard_isna_firmname)>=2 " )
  print("patentpvp_df_standard_isna_firmname)>=2 " )
  print("patentpvp_df_standard_isna_firmname)>=2 " )

}

 
  # mergerdf_func_rename <-mergerdf_func

      

       
 allpatents_func_rename_merger <-patentpvp_df_standard  %>% 
     # join_with_conameLUfunc(joinwithdf_patent=., refdf = mergerdf_func_rename_LUconame , mergerdf_df = mergerdf_func_rename)
    left_join(
      mergerdf_func ,# %>% 
        # group_by(
        #   col_id, col_crop
        # ) %>%
        # mutate(
        #   minyear_merge = min(ground_year)
        # ) %>%
      #  ungroup(),
      by = c("crop" = "col_crop", "name_standard_patent2"="col_acquired"  )
    )%>% 
   ungroup() %>%
   mutate(
     patent_merger_id = paste0(id, replace_na( col_id_new, "nomerge"))
   )     
 
#   there would b e NA  for  ground_year  if  didn't  merge
 # if the merger-patent joined df doesnt have ground year that extends to the years max specified, adds on enough rows 
 if((allpatents_func_rename_merger$ground_year %>%   max(.,na.rm=   TRUE))  < years_max)
 {
   allpatents_func_rename_merger_addyear <-allpatents_func_rename_merger %>%
  bind_rows(
    allpatents_func_rename_merger  %>%  
      # filter(!is.na(ground_year))   %>%  
      group_by(
        patent_merger_id
      ) %>%
      slice(which.max(ground_year))  %>%
      ungroup() %>%
      # mutate(
      #   maxyear_in_id = max(ground_year)
      # ) %>% 
      # ungroup() %>% 
      mutate(
        numreps =years_max -  ground_year
      ) %>% 
      group_by(
        patent_merger_id
      ) %>%
      slice(rep(row_number(), numreps)) %>%
      mutate(
        ground_year =  ground_year + row_number()
      )  %>% 
      ungroup()
  )
# allpatents_func_rename_merger_addyear %>% 
#   filter(
#     patent_merger_id        == "007100001{74}merge00310]green; merge00039]green; {71}merge00236]green
# "
#   ) %>% 
#   View()
allpatents_func_rename_merger<-   allpatents_func_rename_merger_addyear%>% 
      select(-numreps)
       
 }
 
 # this filters for the patentxmerger df in which the patent year is less than the ground year and needs additional ground years after patent year  
 allpatents_func_rename_merger_slice  <-  allpatents_func_rename_merger%>% 
   ungroup() %>%  
   group_by(patent_merger_id) %>% 
   arrange(ground_year) %>% 
   slice(1) %>% 
   ungroup() 
 
 # for those that simply need to extend the minimum, simply extend to patent year
 allpatents_func_rename_merger_lessthan <- allpatents_func_rename_merger_slice%>% 
   filter(
    (patent_year <=ground_year)&(!is.na(ground_year))
   )  %>% 
   mutate(
     # rep num is minimum ground year minus patent year  +1
     repnum =  ground_year  - patent_year + 1
   ) %>% 
   group_by(
     patent_merger_id
   ) %>% 
slice(rep(row_number(), repnum)) %>%
   ungroup() %>% 
   group_by(
     patent_merger_id
   ) %>% 
   mutate(
     ground_year = patent_year + row_number() -1 
   ) %>% 
   ungroup() %>% 
   mutate(
     col_acquirer = name_standard_patent2, 
     col_acquired_new = name_standard_patent2, 
     col_acquirer_new = name_standard_patent2, 
     old_acquirer = name_standard_patent2

   )
 
 allpatents_func_rename_merger_nayears <-allpatents_func_rename_merger_slice%>% 
   filter(
    is.na(ground_year)
   )  %>% 
   mutate(
     # rep num is minimum ground year minus patent year  +1
     repnum =  years_max  - patent_year + 1
   ) %>% 
   group_by(
     patent_merger_id
   ) %>% 
slice(rep(row_number(), repnum)) %>%
   ungroup() %>% 
   group_by(
     patent_merger_id
   ) %>% 
   mutate(
     ground_year = patent_year + row_number() -1 
   ) %>% 
   ungroup() %>% 
   mutate(
     col_acquirer = name_standard_patent2, 
     col_acquired_new = name_standard_patent2, 
     col_acquirer_new = name_standard_patent2, 
     old_acquirer = name_standard_patent2, 
     col_id_new = patent_merger_id

   )
 
 # allpatents_func_rename_merger_na_or_lessthan_bindrow <- allpatents_func_rename_merger_lessthan %>% 
 #   bind_rows(
 #     allpatents_func_rename_merger_nayears
 #   ) %>% 
 #   select(
 #     -repnum
 #   )
 # this bind is going to be several parts
 allpatents_func_rename_merger_exp <- 
   #first bind the rows that we need
   allpatents_func_rename_merger_lessthan %>% 
   bind_rows(
     allpatents_func_rename_merger_nayears
   ) %>% 
   select(
     -repnum
   ) %>% 
   bind_rows(
     #   bind those that have proper years and are earlier part of less than 
   allpatents_func_rename_merger %>% 
   anti_join(
     allpatents_func_rename_merger_lessthan, 
     by = c("patent_merger_id", "ground_year")
   ) %>% 
     #make sure to not include those in NA groundyears included above
   anti_join(
    allpatents_func_rename_merger_nayears,
    by = c("patent_merger_id")
   ) 
   
     
   ) %>% 
   arrange(
     patent_merger_id, ground_year
   )
   
#  
# d %>% 
#    group_by(patent_merger_id) %>% 
#   arrange(
#     ground_year
#   ) %>% 
#    mutate(
#      ground_year =
#        case_when(
#          is.na(universalgroundstart) ~ ground_year_min + row_number() -1 ,
#          ((patent_year <universalgroundstart)& ground_year == universalgroundstart)~ ground_year_min + row_number() -1 ,
#          TRUE ~ground_year
# 
#        ),
#       col_acquirer_new =  
#        case_when(
#          is.na(universalgroundstart) ~ name_standard_patent2, 
#          (((patent_year <universalgroundstart))& (ground_year < universalgroundstart))~name_standard_patent2  ,
#          TRUE ~col_acquirer_new
# 
#        )
# 
# 
#    ) %>% 
#   ungroup()
#  
#   # slice(which.max(ground_year))  %>%
#   
#    mutate(
#      universalgroundstart = min(ground_year)
#    ) %>% 
#    ungroup() %>% 
#     filter(
#     ((patent_year <=ground_year)&(universalgroundstart>=1))|(is.na(universalgroundstart))
#   ) %>% 
#    mutate(
#      repnum = 
#        case_when(
#          is.na(universalgroundstart) ~ years_max   - patent_year + 1, 
#          ((patent_year <universalgroundstart)& ground_year == universalgroundstart)~ universalgroundstart - patent_year   + 1,
#          TRUE ~ 1
#          
#            
#        )
#    ) %>% 
#    group_by(
#      patent_merger_id
#    ) %>% 
# slice(rep(row_number(), repnum)) %>%
#    ungroup() %>% 
#    mutate(
#      ground_year_min = 
#        case_when(
#          is.na(universalgroundstart) ~ patent_year, 
#          ((patent_year <universalgroundstart))~patent_year  ,
#          TRUE ~universalgroundstart
# 
#        )
# 
#    ) %>% 
#    group_by(patent_merger_id) %>% 
#   arrange(
#     ground_year
#   ) %>% 
#    mutate(
#      ground_year =
#        case_when(
#          is.na(universalgroundstart) ~ ground_year_min + row_number() -1 ,
#          ((patent_year <universalgroundstart)& ground_year == universalgroundstart)~ ground_year_min + row_number() -1 ,
#          TRUE ~ground_year
# 
#        ),
#       col_acquirer_new =  
#        case_when(
#          is.na(universalgroundstart) ~ name_standard_patent2, 
#          (((patent_year <universalgroundstart))& (ground_year < universalgroundstart))~name_standard_patent2  ,
#          TRUE ~col_acquirer_new
# 
#        )
# 
# 
#    ) %>% 
#   ungroup()
#  
 
 allpatents_func_rename_merger_exp_pastmax <- allpatents_func_rename_merger_exp %>% 
   filter(
     ground_year > years_max
   )
if(nrow(allpatents_func_rename_merger_exp_pastmax)>=2 ){
  print("allpatents_func_rename_merger_exp_pastmax)>=2 " )
  print("allpatents_func_rename_merger_exp_pastmax)>=2 " )
  print("allpatents_func_rename_merger_exp_pastmax)>=2 " )
  print("allpatents_func_rename_merger_exp_pastmax)>=2 " )

}
 
#  allpatents_func_rename_merger_exp %>% 
#    filter(
#       patent_merger_id %in% c(allpatents_func_rename_merger_exp_pastmax$patent_merger_id)
#    ) %>% 
#    arrange(
#      patent_merger_id, ground_year
#    )%>% 
#    View()
#  
# allpatents_func_rename_merger_exp %>%
# #   filter(
# #     patent_merger_id        == "007100001{74}merge00310]green; merge00039]green; {71}merge00236]green
# # "
# #   ) %>%
#   arrange(
#     patent_merger_id, ground_year
#   ) %>%
#   View()


  patentpvp_df_standard_isnaname_standard_patent2 <- patentpvp_df_func %>% 
  filter(
    !patent_number   %in%   c( allpatents_func_rename_merger_exp$patent_number  ) 
  )
if(nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2 ){
  print("patentpvp_df_standard_isnaname_standard_patent2)>=2 " )
  print("patentpvp_df_standard_isnaname_standard_patent2)>=2 " )
  print("patentpvp_df_standard_isnaname_standard_patent2)>=2 " )
  print("patentpvp_df_standard_isnaname_standard_patent2)>=2 " )

}
  
  
  allpatents_func_rename_merger_exp %>% 
  filter(
   patent_number   %in%   c( patentpvp_df_standard_isnaname_standard_patent2$patent_number  ) 
  )  %>%  
    View()
  
   allpatents_func_rename_merger_inNApatentnumber <- allpatents_func_rename_merger %>% 
  filter(
    patent_number   %in%   c( patentpvp_df_standard_isnaname_standard_patent2$patent_number  ) 
  )

allpatents_func_rename_merger_rename <- allpatents_func_rename_merger_exp %>%
  # filter(
  #    ground_year >=patent_year
  #  )%>% 
 
 # allpatents_func_merger_cross%>% 
 #   filter(
 #    ground_year < patent_year
 #   ) %>% 
 #   View()
   # this binds both yrs before (and repeats same entries for previous yrs) and those found after
   #this first filter step reduces to patent 
 #      filter(
 #     patent_year >= ground_year
 #   ) %>%
   
        mutate(
       
       yearcount_since_patent = ground_year - patent_year,
       name_new_offpatent = 
         case_when(
           yearcount_since_patent>=20 & patent_type == "utility" ~ paste0("Offpatent"), 
           yearcount_since_patent>=20 & patent_type == "plant" ~ paste0("Offpatent" ), 
           yearcount_since_patent>=14 & patent_type == "design" ~ paste0("Offpatent"), 
        patent_type == "PVP" & ( ground_year > (patent_years+patent_year)) ~ paste0("Offpatent"), 
           
          yearcount_since_patent>=20 & (is.na(patent_type)) ~ paste0("Offpatent"), 

           TRUE ~ col_acquirer_new
         )# ,
       # name_new_offpatent =
       #   case_when(
       #     name_new_offpatent== "Offpatent" ~ "Offpatent",
       #     ground_year <col_year ~ name_standard_patent2,
       #     ground_year >=col_year ~ name_standard_patent2
       #   )

     ) %>% 

   mutate(
       name_new_offpatent =
         case_when(
           name_new_offpatent== "Offpatent" ~ "Offpatent",
           TRUE ~ col_acquirer_new
          )

   ) 

 patentpvp_df_standard_isnaname_standard_patent2 <- patentpvp_df_func %>% 
  filter(
    !patent_number   %in%   c( allpatents_func_rename_merger_exp$patent_number  ) 
  )

if(nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2 ){
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
    print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )
  print("nrow(patentpvp_df_standard_isnaname_standard_patent2)>=2" )

}
 

# allpatents_func_rename_merger_rename %>% 
#   select(
#     -newnametemp, -universalgroundstart   , -repnum, -ground_year_min,-yearcount_since_patent 
#   )

soycropquery_merger <-allpatents_func_rename_merger_rename%>%
select(
 -yearcount_since_patent
)

# soycropquery_merger %>% 
#   feather::write_feather(
#     "X:/msi/work/farmer welfare/seed/R analysis/230122_soycropquerymerger.feather"
#   )
# soycropquery_merger %>% 
#   arrange(
#     patent_merger_id
#   ) %>% 
#   View()

# rm(allpatents_func_rename_merger)
# rm(allpatents_func_rename_merger_exp)
# rm(allpatents_func_rename_merger_rename)
# rm(mergerdf_func)
# rm(patentpvp_df_func)
# rm(patentpvp_df_standard)
# rm(soycropquery_merger)

soycropquery_merger



}
```

### use func join patents w merger
```{r }
soycropquery_merger <- sendthroughmergers_LU_reduce2 %>% 
joinpatents_with_mergerfunc(patentpvp_df_func = pvppatent_combine_url_filter, mergerdf_func = .)

soycropquery_merger %>% filter(name_standard_patent2 == "NOVARTIS") %>% arrange(patent_merger_id, ground_year) %>% View()

soycropquery_merger %>% 
  feather::write_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230910_soycropquery_merger.feather"
  )

soycropquery_merger <-  
  feather::read_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230910_soycropquery_merger.feather"
  )
pvppatent_combine_url_filter %>% 
  filter(
    !patent_number %in% c(
      soycropquery_merger$patent_number
    )
  )%>% 
  View()
```

#####  join to country
```{r }
soycropquery_mergercountry <- soycropquery_merger%>% appendcountrynamefunc_simple(qq_countrypath ="//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230910c rename Lu seed cos.xlsx" ,qq_colnamefirmname = .$col_acquirer_new, qqattachnamesdf =.)
soycropquery_mergercountry %>% 
  filter(
    is.na(`alpha-2`)
  ) %>% 
  View()
```

#### double check if there were any left out
```{R }
pvppatent_combine_url_filter %>% 
    filter(
        !patent_number %in% c(
            soycropquery_merger$patent_number
        )
    )%>% 
    View()

```

### create a country LU
```{r }
pvppatent_combine_url_filter_namescountryfill <- pvppatent_combine_url_filter  %>%
  # standardizenames_companies()
  # standardizenames_companies(zzluconames_df = lu_conames_out230705_match)
  standardizenames_companies(
    zz=., 
    whichcol_to_rename =.$applicant_upper, 
    zzluconames_df = lu_conames_out230705_match
  ) %>% 
  filter(
    !is.na(Namestandard ), !is.na(assignee_country ), nchar(assignee_country)>=1, assignee_country!= "NA"
  ) %>% 
  mutate(
    assignee_country_standard = gsub(
      "] NA|NA", "", assignee_country
       
      )
  ) %>% 
  group_by(
    Namestandard
  )  %>% 
  mutate(
    total_patent_number = length(unique(patent_number))
  )%>% 
    group_by(
    Namestandard, assignee_country_standard
  )  %>% 
  mutate(
    total_patent_number_country = length(unique(patent_number))
  )%>% 
  ungroup() %>% 

  group_by(
    Namestandard,crop, patent_year, total_patent_number, assignee_country_standard, total_patent_number_country
  ) %>% 
  summarise(
    numpatent_year =length(unique(patent_number ))
  ) %>% 
  ungroup() %>%  
  # mutate(
  #   countryabbrletter   =  gsub("[^A-Za-z]","",  countryabbr), 
  #   countryabbrnum  =  gsub("[^0-9]","",  countryabbr)
  # )   %>%  
  left_join(
    countryLU  %>%  
      select(`alpha-2`,  name),
    by  =  c("assignee_country_standard"=   "alpha-2")
  )  %>%  
  mutate(
    # patent_info = paste0(crop, " ", patent_year," " ,  numpatent_year), 
    country_info =  paste0(assignee_country_standard, " ", crop, " ", patent_year," " ,  numpatent_year),
    countryinfo_short = paste0(assignee_country_standard, " ", total_patent_number_country),  
     countryinfo_long = paste0(name, " ", total_patent_number_country),  
   
  ) %>%   
  group_by(
    Namestandard, total_patent_number 
  ) %>% 
  summarise(
    # patent_info = paste(patent_info %>% unique(), collapse = "; "),
    patent_info = paste(country_info %>% unique(), collapse = "; "), 
    country_info = paste(countryinfo_short %>% unique(), collapse = "; "),
    countryinfo_long= paste(countryinfo_long %>% unique(), collapse = "; ")


  ) %>% 
  ungroup() 
 
  
```

#### Join with soycropquery_merger
```{r }

soycropquery_merger_country <- soycropquery_merger %>% 
  mutate(
    inventor =   name_standard_patent2
  ) %>% 
  gather(
    key  = firmtype,   
    value   =  firmname,
    c("col_acquirer_new","name_standard_patent2"   )
  )   %>%  
  mutate(
    countinventor  =  
      case_when(
        inventor==firmname~ patent_number#,
        # TRUE   ~   0
          ),
    countacquire   =  
       case_when(
        inventor!=firmname~patent_number#,
        # TRUE   ~   patent_number
          )
  )  %>%  
  left_join(
    pvppatent_combine_url_filter_namescountryfill, 
    by = c("firmname" = "Namestandard")
  ) %>% 
  group_by(
    firmname
  ) %>% 
  summarise(
    total_patent_number = length(unique(patent_number)), 
    total_patent_invent = length(unique(countinventor)), 
    total_patent_countacquire = length(unique(countacquire)), 

    patent_info = paste(patent_info %>% unique(), collapse = "; "), 
    country_info = paste(countryinfo_long %>% unique(), collapse = "; ")
  ) %>% 
  ungroup() %>% 
  mutate(
    total_patent_invent =  total_patent_invent     -   1,
    total_patent_countacquire =  total_patent_countacquire     -   1,
  ) %>% 
  splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$patent_info, if_id_col= "no", prefix = "") %>% 
  select(
    -patent_info
  ) %>% 
  rename(
    patent_info = coltotrans
  )%>% 
    splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$country_info, if_id_col= "no", prefix = "") %>% 
  select(
    -country_info
  ) %>% 
  rename(
    country_info = coltotrans
  ) %>% 
  mutate(
    likely_country =str_squish(
      gsub(
      "[^A-Za-z ]","",  country_info
    )
    )
  )   %>%   
  select(
    firmname, likely_country, country_info, everything()
  )

soycropquery_merger_country  %>% 
  writexl::write_xlsx(
    "//jna_nol/asus/msi/work/farmer welfare/seed/company names LU/230904_countrynamesLU.xlsx"
  )
pvppatent_combine_url_filter_names   %>% 
  filter(
    !Namestandard  %in%  c(soycropquery_merger_country$firmname )
  )  %>%  
  View()
```

# Graph alluvial

## helpful funcs

### margin spacer
```{r }
    margin_spacer <- function(x) {
  # where x is the column in your dataset
  left_length <- nchar(levels(factor(x)))[1]
  if (left_length > 8) {
    return((left_length - 8) * 4)
  }
  else
    return(0)
}

addline_format <- function(x,...){
    gsub('\\s','\n',x)
}
```
### addunits func
```{r }
addUnits <- function(n) {
  labels <- ifelse(abs(n) < 1000, n,  # less than thousands
                   ifelse(abs(n) < 1e6, paste0(round(n/1e3), 'k'),  # in thousands
                          ifelse(abs(n) < 1e9, paste0(round(n/1e6), 'M'),  # in millions
                                 ifelse(abs(n) < 1e12, paste0(round(n/1e9), 'B'), # in billions
                                        ifelse(abs(n) < 1e15, paste0(round(n/1e12), 'T'), # in trillions
                                               'too big!'
                                        )))))
  return(labels)
}


```

## func alluvial 1

### func to find max name in year
```{r }
func_find_maxyear_name <- function( findmaxyear_df, findmaxyear_yearcol,findmaxyear_firmnamecol, findmaxyear_firmname_changetocol,findmaxyear_idcol )
{
  
  
  
  findmaxyear_df_col <- findmaxyear_df %>% 
    cbind(
      tibble(
        findmaxyear_year = findmaxyear_yearcol
      ), 
       tibble(
         #col_acquired; or inventor
        findmaxyear_firmname = findmaxyear_firmnamecol
      ),
      tibble(
       #usu col_acquirer_new or name_new_offpatent

        findmaxyear_firmname_changeto = findmaxyear_firmname_changetocol
      ),
       tibble(
        findmaxyear_id = findmaxyear_idcol
      )
    ) 
  
findmaxyear_df_col_slice <-findmaxyear_df_col  %>% 
    group_by(
      findmaxyear_firmname, findmaxyear_id
    ) %>% 
  arrange(
    -findmaxyear_year
  )%>%  
  slice(1) %>% 
    # slice(which.max(findmaxyear_year )) %>% 
  ungroup()

  findmaxyear_df_out <- findmaxyear_df_col %>% 
    left_join(
      findmaxyear_df_col_slice %>% 
        select(
          findmaxyear_firmname, findmaxyear_firmname_changeto,findmaxyear_id 
        ) %>% 
        distinct() %>% 
        rename(
          finalname = findmaxyear_firmname_changeto
        ),
      by = c("findmaxyear_firmname", "findmaxyear_id")
    ) %>% 
    select(
      -contains("findmaxyear_")
    )
  findmaxyear_df_out
}



```

### func to process labels

#### processlabelbytypegeneric func
```{r }

processlabel_bytype_generic <- function(
  passthrudf , 
  passthrudf_yearlistdf,
  which_to_change1 ,
  top_strata_colsplitby ,  
  top_strata ,
  howderived_acq_or_orig ,
  passthru_if_take_tops,
  passthru_name_countunique = "Inventor"
  # sendthru = "bypatent_acq", 
  # col_to_split = alluv_df_by15$patent_type2
  ){
  
 # passthrudf =     alluv_df_by15 %>% 
 #  filter(
 #    col_loopthru == alluv_current_loop
 #  )
 #  

  # passthrudf_yearlistdf = yearlist
  #usually this is crop; and by number
  # which_to_change1 = passthrudf$col_facet
  # passhtrudf_aggregator = passthrudf$col_aggregator
  # which_col_is_id = .$col_id,
  # top_strata_colsplitby   = top_strata_colsplitbysend  
  # top_strata =  top_strata
  # howderived_acq_or_orig = "yes"
  # passthru_if_take_tops = passthru_if_take_topssend
  # top_strata_colsplitby = 12
  # passthrudf_yearlistdf = yearlist
  #     passthrudf =   alluv_df_by15
  # passthrudf_yearlistdf = yearlist
  # which_to_change1 = alluv_df_by15$crop_type
  # top_strata_colsplitby   = 6
  # top_strata =  12
  # howderived_acq_or_orig = "yes"
  # passthru_if_take_tops = 4

#   # 
#   passthrudf =   alluv_df_by15
#   passthrudf_yearlistdf = yearlist
#   which_to_change1 = alluv_df_by15$crop_type
#   top_strata_colsplitby   = 4
#   top_strata =  12
#   howderived_acq_or_orig = "yes"
# passthru_if_take_tops = 4
#   
#   passthrudf =   alluv_df_by15
#   passthrudf_yearlistdf = yearlist
#   which_to_change1 = alluv_df_by15$patent_type2
#   top_strata_colsplitby   = 2
#   top_strata =  12
#   howderived_acq_or_orig = "yes"
# passthru_if_take_tops = 4


      passthrudf_filteryr <-      passthrudf %>%  filter(
        patentyear_by5 %in% passthrudf_yearlistdf
      ) 
    
    ##### first step is to categorize
    passthrudf_by15_lu5yr <- passthrudf %>% 
    #         cbind(
    #   tibble(
    #     col_splitby = which_to_change1
    #   )  
    #   # tibble(
    #   #   col_aggregator = passhtrudf_aggregator
    #   # )
    #   # tibble(
    #   #   col_id = which_col_is_id
    #   # )
    # 
    # )  %>%

      filter(
        # patent_merger_id %in% c(passthrudf_filteryr$patent_merger_id)
     by15 %in% passthrudf_yearlistdf

      ) %>% 
      mutate(
        # make sure that aggregator becomes offpatent if needed
        col_aggregator = 
          case_when(
            col_aggregator == "Offpatent" ~ "Offpatent",
            TRUE ~ col_aggregator
          )
      )%>% 
 
      # group_by(
      #   patent_merger_id,by15
      # ) %>% 
      # filter(
      #   # this makes it so that for by15=2015, if merger happened in 2018, it'll still use 2017 name (bc that's what it was in 2015; actually, should use max to capture any ) 
      #   ground_year == min(ground_year)
      # )%>% 
      # slice(which.max(ground_year )) %>% 
      ungroup() %>% 
      # rename(
      #   name_new_by15 = name_new_offpatent
      # )%>% 
      select(
patent_merger_id, by15,col_id, name_standard_patent2,   name_new_offpatent,      col_facet,col_aggregator, patentyear_by5
      ) %>% 
      distinct() 
    

          # this generates a top 12 by category/splitby
           passthrudf_by15_lu5yr_crop_top12 <- passthrudf_by15_lu5yr%>% 
      group_by(
       col_facet
      ) %>% 
      summarise(
        numpatents_colsplitby =length(unique(col_id))
      ) %>% 
      ungroup() %>% 
      arrange(
        -numpatents_colsplitby
      ) %>% 
      slice(1:top_strata_colsplitby) %>% 
      ungroup()

           # this joins tops; then, if the category is not the top, makes it q; if yes, retains first character of top
           
passthrudf_by15_lu5yr_cat <-   passthrudf_by15_lu5yr%>%
      left_join(
        passthrudf_by15_lu5yr_crop_top12 ,  
        by =  c("col_facet")
      ) %>% 
      mutate(
       name_new_by15_col_splitby_crop  = 
         case_when(
           is.na(numpatents_colsplitby) ~   "q", #paste0("Not top ", top_strata_colsplitby), 
           TRUE ~ substr(col_facet,1,1 ) 
         ),
              name_new_by15_col_splitby_crop_full  = 
         case_when(
           is.na(numpatents_colsplitby) ~   paste0("Not top ", top_strata_colsplitby), 
           TRUE ~  col_facet 
         )

     ) %>% 
  group_by(name_new_by15_col_splitby_crop) %>% 
  arrange(name_new_by15_col_splitby_crop_full) %>% 
  mutate(
    # gets the full name of splitby; makes sure to substite trailing 1 for nothing
    name_new_by15_col_splitby_crop = 
      paste0(  
        name_new_by15_col_splitby_crop,
        cumsum(!duplicated(name_new_by15_col_splitby_crop_full))
      ),  
   name_new_by15_col_splitby_crop =  gsub("1$",  "", name_new_by15_col_splitby_crop )
  )%>% 
    ungroup() %>% 
  # computes 
      mutate(
        howderived =
          case_when( 
            name_new_offpatent!= name_standard_patent2 ~ "Acquired", 
            TRUE ~ "Original"
          ), 
        howderived_1  =howderived , 
        howderived = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop,
            TRUE  ~paste0(substr(howderived_1,1,1),"_", name_new_by15_col_splitby_crop)
            
            ), 
        name_new_by15_col_splitby_crop_full = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop_full,
            TRUE  ~paste0(howderived_1, "_", stringr::str_to_title(name_new_by15_col_splitby_crop_full))
            
            ), 
        name_new_by15_col_splitby_crop = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop,
            TRUE  ~ paste0(substr(howderived_1,1,1),"_", name_new_by15_col_splitby_crop)
            
            ), 

        if_created_thatyear = 
          case_when(
            patentyear_by5 == by15~ "Created that Year", 
            TRUE ~ "Acquired that Year"
          ), 
        patent_type2_if_created_thatyear = paste0(
        name_new_by15_col_splitby_crop,"_", if_created_thatyear
      )


      ) 

passthrudf_by15_lu5yr_catLU <- passthrudf_by15_lu5yr_cat %>% 
  select(
    name_new_by15_col_splitby_crop, name_new_by15_col_splitby_crop_full 
  ) %>% 
mutate(
 name_new_by15_col_splitby_crop  = gsub(".*_","",name_new_by15_col_splitby_crop ), 
 name_new_by15_col_splitby_crop_full  = gsub(".*_","",name_new_by15_col_splitby_crop_full )
  ) %>% 
    distinct()

# passthrudf_by15_lu5yr_catLU %>%
#   writexl::write_xlsx(
#     "X:/msi/work/farmer welfare/seed/R analysis/images/merger/230108_shortname_keylu.xlsx"
#   )
    
### aggregator lu; which names to keep
       passthrudf_by15_lu5yr_totals_top12 <- passthrudf_by15_lu5yr%>% 
      group_by(
        by15, col_aggregator
      ) %>% 
      summarise(
        numpatents =length(unique(col_id))
      ) %>% 
      ungroup() %>% 
     group_by(
        by15 
      ) %>% 
      arrange(
        -numpatents
      ) %>% 
      slice(1:top_strata) %>% 
      ungroup()

    
   passthrudf_by15_lu5yr_strata <- passthrudf_by15_lu5yr_cat  %>% 
     left_join(
       #deciding which co names to keep
       passthrudf_by15_lu5yr_totals_top12, 
       by = c("by15", "col_aggregator")
     ) %>% 
     mutate(
       col_aggregator_by15_strata = 
         case_when(
           is.na(numpatents) ~ paste0("Not top ", top_strata), 
           TRUE ~ col_aggregator
         )
     ) %>% 
     #remove below for confusion; only keeps tops
     select(
       -numpatents
     ) %>% 
      group_by(col_aggregator_by15_strata, by15 ) %>% 
      mutate(
        #total patents in that year by the aggregator
        totalpatents_by15 =  length(unique(col_id)), 
        #total patents in that year by the aggregator
        # so if it's offpatent, will show number aggregators, eg unique firm names in there

        num_unique_aggregator = length(unique(name_standard_patent2))
      ) %>% 
      ungroup()  %>% 
     select(
       -col_aggregator
     ) %>%
     rename(
       col_aggregator = col_aggregator_by15_strata
     )
      #total patents in that year: total by year, total by acq or dev, 
    
        ##### second step is to get totals for each company label by year, filtering out offpatent
   passthrudf_by15_lu5yr_strata_totals <- passthrudf_by15_lu5yr_strata %>% 
      filter(
        col_aggregator != "Offpatent"
      ) %>% 
      
      group_by( by15 ) %>% 
      mutate(
        totalpatents_year =  length(unique(col_id))
      ) %>% 
      ungroup() %>% 
    group_by(
      by15, if_created_thatyear 
    ) %>% 
    mutate(
      #total by acq or dev
      created_or_acq_num =  length(unique(col_id))
    ) %>% 
    ungroup() %>% 
     mutate(
       name_new_by15_col_splitby_crop  = gsub(".*_","",name_new_by15_col_splitby_crop)  
     ) %>% 
     #total by crop
   group_by(
      by15,   name_new_by15_col_splitby_crop 
    ) %>% 
    mutate(
      numcrops_thatyear =  length(unique(col_id))
    ) %>% 
    ungroup()  %>% 
     #total by crop and acq or dev
  group_by(
      by15, col_aggregator,  howderived
    ) %>% 
    mutate(
      numcrops_thatyear_acq_or_dev =  length(unique(col_id))
    ) %>% 
    ungroup()  %>% 

     select(
    patent_merger_id, name_standard_patent2,  by15,col_aggregator, totalpatents_year, if_created_thatyear, name_new_by15_col_splitby_crop, numcrops_thatyear, created_or_acq_num,numcrops_thatyear_acq_or_dev
     ) %>% 
     distinct()

    #label the individual co years 
passthrudf_by15_lu5yr_labelpre <-   passthrudf_by15_lu5yr_strata %>% 
  #only have mdified crop name
  select(
    -contains("name_new_by15_col_splitby_crop")
  ) %>% 
   left_join(
     passthrudf_by15_lu5yr_strata_totals,
     by = c("patent_merger_id", "name_standard_patent2", "by15", "if_created_thatyear",  "col_aggregator")
     #  %>% 
       # select(
       #   name_new_by15,patent_merger_id, by15, name_standard_patent2, patent_type2, 
       #   
       # ), 
     # by = c("name_new_by15", "patent_merger_id", "by15","name_standard_patent2", "patent_type2" )
   ) %>% 
   mutate(
     percent_patents_year_byfirm =
       case_when(
         
         col_aggregator == "Offpatent"~ "0%",
         TRUE ~paste0(round(100*totalpatents_by15/totalpatents_year,0),"%")
       )
   )  %>% 
     group_by(col_aggregator, by15,howderived ) %>% 
         # this is total acq or dev  by crop
         mutate(
           num_howderived_by15 = length(unique(col_id))
         ) %>% 
         ungroup() %>% 
             #this is total acquired or dev

     group_by(col_aggregator, by15,howderived_1 ) %>% 
  #this is total 
         # num 
         mutate(
           num_howderived_by15_1 = length(unique(col_id))
         ) %>% 
         ungroup() %>% 
           # this is howderived divided by total number of  crop patents existing in that year (that aren't  offpatent)
         mutate(
           # percent_patents_thatyear = 
           # percent_acquired_howderived = percent(num_howderived_by15/totalpatents_by15)
          percent_acquired_howderived = 
            # should be by  crop 
            gsub(
              "NA%","",
              paste0(round(100*numcrops_thatyear_acq_or_dev/numcrops_thatyear,0),"%")
            )
            # below is how it was prev;  
            # paste0(round(100*num_howderived_by15/totalpatents_by15,0),"%")
              
          #  )
         ) 
# passthrudf_by15_lu5yr_labelpre %>% 
#   arrange(
#     patent_merger_id, by15
#   ) %>% 
#   View()

passthrudf_by15_lu5yr_label_crop <-passthrudf_by15_lu5yr_labelpre %>% 
      select(
        col_aggregator, by15,howderived, percent_acquired_howderived  
      ) %>% 
      distinct() %>% 
  mutate(
    percent_acquired_howderived = round(
      as.numeric(
      gsub("%",  "", percent_acquired_howderived),0
      )
    ),  
    howderived_only = gsub("_.*", "", howderived),
    howderived_crop = gsub(".*_", "", howderived)

  ) %>% 
  filter(
    !is.na(percent_acquired_howderived), 
    percent_acquired_howderived  >=2#,
    # !(percent_acquired_howderived %in%  c("1%",  "2%"))
  ) %>% 
  mutate(
    howd_percent =  paste0(str_pad(percent_acquired_howderived,4,side =  c("left"),  "0" ) ,"%", howderived_crop )
  ) %>%
  group_by(
    col_aggregator, by15, howderived_only
  ) %>% 
  summarise(
   label_crop_percent = paste(str_remove(unique(rev(sort(howd_percent))), "^0+"),   collapse =  " ")
  ) %>% 
    ungroup() %>% 
  mutate(
    # label_crop_percent = str_remove(label_crop_percent, "^0+"),
    label_crop_percent = paste0(howderived_only,  ": ", label_crop_percent)
  )%>%
  group_by(
    col_aggregator, by15
  ) %>% 
  summarise(
    label_crop_percent = paste(unique(sort(label_crop_percent)), collapse =   "; ")
  )%>% 
    ungroup()
  

passthrudf_by15_lu5yr_label_crop_offpatent <- passthrudf_by15_lu5yr_labelpre %>% 
    filter(
    col_aggregator == "Offpatent"
  ) %>% 
  mutate(
        howderived_only = gsub("_.*", "", howderived),
    howderived_crop = gsub(".*_", "", howderived)

  ) %>% 
      group_by(
        col_aggregator, by15,howderived_crop
      ) %>% 
  mutate(
    offpatentnum_bycrop= length(unique(col_id))
  ) %>% 
  ungroup() %>% 
  group_by(
        col_aggregator, by15
      ) %>% 
  mutate(
    offpatentnum_total = length(unique(col_id))
  ) %>% 
  ungroup() %>% 
  mutate(
    howd_percent =  tolower(paste0(str_pad(round(100*offpatentnum_bycrop/offpatentnum_total,0),4,side =  c("left"),  "0" ) ,"%", howderived_crop ))
  ) %>%
  group_by(
    col_aggregator, by15,offpatentnum_total
  ) %>% 
  summarise(
   label_crop_percent = paste(str_remove(unique(rev(sort(howd_percent))), "^0+"),   collapse =  " ")
  ) %>% 
    ungroup() %>% 
  mutate(
    finallabel = paste0(
                col_aggregator, " composition: ", offpatentnum_total," (",
                label_crop_percent,")"
              )
  ) %>% 
  select(
    col_aggregator,by15, finallabel
  ) %>% 
  distinct()

# %>% 
#   mutate(
#     percent_acquired_howderived = round(
#       as.numeric(
#       gsub("%",  "", percent_acquired_howderived),0
#       )
#     ),  
# 
#   )
  
  
     # View(passthrudf_by15_lu5yr_label_crop %>% arrange(name_new_by15, by15))
lookup <- c(`Original_Patent_num` = "Original", `Acquired_Patent_num` = "Acquired")

passthrudf_by15_lu5yr_label   <- passthrudf_by15_lu5yr_labelpre  %>% 
  filter(col_aggregator != "Offpatent") %>%
      select(
        col_aggregator, by15, num_unique_aggregator,totalpatents_by15,percent_patents_year_byfirm
      ) %>% 
      distinct() %>% 
  left_join(
        passthrudf_by15_lu5yr_labelpre %>% 
          select(
            col_aggregator, num_howderived_by15_1, by15, howderived_1
          ) %>% 
          distinct() %>% 
          spread(
            key = howderived_1, 
            value = num_howderived_by15_1 
          ) %>% 
          rename(
            any_of(lookup)
# 
#             Original_Patent_num = Original,
#             Acquired_Patent_num = Acquired
          ),
        by =  c ("col_aggregator", "by15")
        
      ) %>% 
  left_join(
    passthrudf_by15_lu5yr_label_crop,
        by =  c ("col_aggregator", "by15")
  ) %>% 
  
      mutate(
        label_crop_percent =  label_crop_percent,
        finallabel = 
          case_when(
              col_aggregator == "Offpatent"~ paste0(
                col_aggregator, ": ", totalpatents_by15," (",
                label_crop_percent,")"
              ),
              col_aggregator == paste0("Not top ", top_strata) ~ paste0(
                col_aggregator, ": ", totalpatents_by15, " ", 
               percent_patents_year_byfirm , 
                " #", passthru_name_countunique, ": ", num_unique_aggregator, " Avg: ",
                round(totalpatents_by15/num_unique_aggregator,0) , " (",
                label_crop_percent,")"

              ) ,
              TRUE ~ paste0(
                col_aggregator, ": ", totalpatents_by15,
                " ", percent_patents_year_byfirm  , " (",
                label_crop_percent,")"
              )
          ), 
        finallabel = gsub("; 0%pvp|; 0%pvp", "; ",  finallabel),        
        finallabel = gsub(" 0%pvp", "",  finallabel),
        finallabel = gsub(" 0%p ", "; ",  finallabel), 
        finallabel = gsub("; A:; |O:; ; |O:; ; | ; A:; |O: 0%p; |O: NA 0%p; |A: NA 0%p|())", "", finallabel), 
        finallabel = gsub("O:; ", "O: ", finallabel),        
        finallabel = gsub("; A: 0%p)", ")", finallabel),
        finallabel= 
          # case_when(
          #  substr( finallabel,   ) 
            paste0(
          finallabel, ")"
        # )
          )
      ) %>% 
  select(
    any_of(names( passthrudf_by15_lu5yr_label_crop_offpatent))
  ) %>% 
  # select_at(
  #   c(names(passthrudf_by15_lu5yr_label_crop_offpatent))
  # ) %>% 
  bind_rows(
    passthrudf_by15_lu5yr_label_crop_offpatent
  )
 

passthrudf_by15_lu5yr_labelyear <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 0)

passthrudf_by15_lu5yr_labelyear_top4 <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = passthru_if_take_tops)

passthrudf_by15_lu5yr_labelyear_final <-  passthrudf_by15_lu5yr_labelyear  %>% 
  left_join(
    passthrudf_by15_lu5yr_labelyear_top4 %>% 
      rename(
        top4label  = finalyearlabel
      ),
    by  =  c("by15")
  )  %>%  
  mutate(
    finalyearlabel  =  
      paste0(finalyearlabel,"; ", top4label)
    
  )  %>%
  select(
  by15,  finalyearlabel
  )  %>%  
  distinct()

   # now year labels
  # then get totals of year   
  #make label for each year

passthrudf_by15_spread <- passthrudf_by15_lu5yr_strata  %>% 
     mutate(
       name_new_by15_col_splitby_crop  = gsub(".*_","",tolower(name_new_by15_col_splitby_crop)  )
     )  %>% 
  left_join(
    passthrudf_by15_lu5yr_label %>% 
      select(by15,col_aggregator , finallabel) %>% 
      distinct(), 
    by = c("by15", "col_aggregator")
  ) %>% 
    left_join(
    passthrudf_by15_lu5yr_labelyear_final %>% 
      select(by15,finalyearlabel) %>% 
      distinct(), 
    by = c("by15" )
  ) %>% 
  select(
    patent_merger_id, name_standard_patent2,finallabel, finalyearlabel, howderived,name_new_by15_col_splitby_crop,name_new_by15_col_splitby_crop_full
  ) %>% 
  mutate(
      finalyearlabel = paste0("YR=", finalyearlabel)
  ) %>% 
  # left_join(
  #   passthrudf_by15_lu5yr_catLU  %>% 
  #     mutate(
  #       name_new_by15_col_splitby_crop =   tolower(name_new_by15_col_splitby_crop)
  #     ),
  #   by  = c("name_new_by15_col_splitby_crop" )
  # ) %>%  
  mutate(
  name_new_by15_col_splitby_crop_full =  paste0(
    gsub(
      ".*_","", 
      name_new_by15_col_splitby_crop_full
      
      ), " (",  name_new_by15_col_splitby_crop,")"
  )  
  ) %>%  
  select(
    -name_new_by15_col_splitby_crop , -howderived
  )%>%  
  rename(
    howderived = name_new_by15_col_splitby_crop_full 
  )

# 2 is only with howacq
passthrudf_by15_spread2 <- passthrudf_by15_spread %>% 
    distinct() %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) 
# 3 is  with finalname
passthrudf_by15_spread3 <- passthrudf_by15_spread %>% 
  select(-howderived) %>%
  distinct() %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) %>% 
  mutate(
    howderived = "only_final"
  )
# rm(passthrudf_by15_spread2)
# rm(passthrudf_by15_spread3)
rm(passthru_if_take_tops)
rm(passthrudf_by15_lu5yr)
rm(passthrudf_yearlistdf)
rm(passthrudf_filteryr)
# rm(passthrudf_by15_spread3)
rm(passthrudf_by15_lu5yr_totals_top12)
rm(passthrudf_by15_lu5yr_strata_totals)
rm(passthrudf_by15_lu5yr_strata)
rm(passthrudf_by15_lu5yr_labelyear_top4)
rm(passthrudf_by15_lu5yr_labelyear_final)
rm(passthrudf_by15_lu5yr_labelyear)
rm(passthrudf_by15_lu5yr_labelpre)
rm(passthrudf_by15_lu5yr_label_crop_offpatent)
rm(passthrudf_by15_lu5yr_label_crop)
 rm(passthrudf_by15_lu5yr_label)
rm(passthrudf_by15_lu5yr_crop_top12)
rm(passthrudf_by15_lu5yr_catLU)
rm(passthrudf_by15_lu5yr_cat)
rm(passthrudf_by15_lu5yr)
rm(passthru_if_take_tops)
 rm(passthrudf)
  
   rm(passthrudf_yearlistdf )
  rm(passthru_if_take_tops )
  rm(top_strata_colsplitby )
 
 # rm(passthrudf_by15_spread)
 # rm(passthrudf_by15_spread)
 # rm(passthrudf_by15_spread2)
 # rm(passthrudf_by15_spread3)

 passthrudf_out <- 
 passthrudf_by15_spread2 %>% 
  bind_rows(
    passthrudf_by15_spread3
  )
# passthrudf_out %>%
#   filter(
#     name_standard_patent2 == "STONEVILLE PEDIGREED SEED"
#   ) %>%
#   arrange(
#     patent_merger_id
#   )%>%
#   View()
passthrudf_out
}
```

##### labelyear func generic
```{r }
processlabel_bytype_generic_labelyear <- function( passthru_process_stratadf, passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 4){
  # passthru_process_stratadf = passthrudf_by15_lu5yr_strata
  # passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals
  # if_top4 = 4
  # if_top4=0
  if((if_top4 >=1))
  {
     top4cos_in_year <- passthru_process_stratadf%>% 
            filter(
      col_aggregator != "Offpatent",  
      !grepl( x  =col_aggregator,  pattern= "not top|name not",  ignore.case=TRUE,perl  = TRUE)
      
    ) %>% 

      group_by(
        col_aggregator , by15
      ) %>% 
      summarise(
        numpatents_total_bycoyear = length(unique(col_id))
      ) %>% 
      ungroup() %>% 
      group_by(by15) %>% 
      arrange(
        -numpatents_total_bycoyear
      ) %>%
      slice(1:if_top4) %>% 
      ungroup()
    
    passthru_process_stratadf_filter <- passthru_process_stratadf%>% 
      inner_join(
        top4cos_in_year, 
        by = c("by15", "col_aggregator")
      )
  }
    if(!(if_top4  >=1))
  {
      passthru_process_stratadf_filter <- passthru_process_stratadf
       
    }
   # now year labels
    # then get totals of year   
  passthru_process_stratadf_filter_labelyear_totals <-   passthru_process_stratadf_filter %>% 
  #only have mdified crop name
  select(
    -contains("col_aggregator_col_splitby_crop")
  ) %>% 
   left_join(
     passthru_process_strata_totals ,#%>% 
       # select(
       #   -numcrops_thatyear
       # ), # %>% 
       # select(
       #   col_aggregator,patent_merger_id, by15, name_standard_patent2, patent_type2, 
       #   
       # ), 
     by = c("col_aggregator", "patent_merger_id", "by15","name_standard_patent2", "if_created_thatyear" )
   )  %>% 
     filter(
      col_aggregator != "Offpatent"
    ) %>% 
   mutate(
        #this gets the crop
    howderived_short = gsub(".*_", "", howderived)
  ) 
  
      passthru_process_lu5yr_labelyear_totalLU  <-passthru_process_stratadf_filter_labelyear_totals  %>% 
          mutate(
      total_percent_num_patents_bytype =  
        round(100*numcrops_thatyear/totalpatents_year,0),
        howd_percent_total =  paste0(str_pad(total_percent_num_patents_bytype,4,side =  c("left"),  "0" ) ,"%", howderived_short )

  ) %>% 
    group_by(
          by15, totalpatents_year  
    ) %>% 
    summarise(
      label_total_if_createdthatyear_usethis = 

           paste(
             str_remove(
  
          rev(sort(unique(howd_percent_total ) )  ), 
           "^0+"),
        collapse = " "

        )
       
    ) %>% 
    ungroup()   %>% 
        mutate(
          label_total_if_createdthatyear_usethis = tolower(label_total_if_createdthatyear_usethis)
        )
       
  
     if(!(if_top4  >=1))
  {
       passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals #%>% 
         # mutate(
         #  created_or_acq_num= numcrops_thatyear
         # )
       

       
     }
  
  
  
     if((if_top4  >=1))
  {
        passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals  %>%
    group_by(
      by15,if_created_thatyear
    ) %>% 
    
      mutate(
        #  make this total  or by  top  4
        created_or_acq_num  =  
          # case_when(
          #   !(if_top4  >=1)  ~  created_or_acq_num,
             # (if_top4  >=1)  ~ 
          length(unique(col_id))
          # )
      )  %>% 
    ungroup()   

        
        
     }
  
 passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals %>% 
    # group_by(
    #   howderived_short,by15
    # ) %>%
    # mutate(
    #  numcrops_thatyear = length(unique(col_id))  
    # ) %>% 
    # ungroup()

  # top  row first
    # group_by(
    #   howderived_short, by15
    # ) %>% 
    # #don't  actually need  below
    # mutate(
    #   #global  corn, soy,  by year: originated or 
    #   num_patents_bytype = length(unique(
    #     id
    #   )
    #   )
    # )%>% 
    # ungroup() %>% 
    mutate(
      #this should be D  or P
      total_percent_num_patents_bytype =  
        round(100*created_or_acq_num/totalpatents_year,0)
    )  %>% 
    select(
      by15, patent_merger_id, howderived_short , if_created_thatyear ,col_id, total_percent_num_patents_bytype,totalpatents_year, created_or_acq_num,
      numcrops_thatyear
     
    ) %>% 
    
    #  group_by(
    #   by15
    # ) %>% 
    # mutate(
    #   bytype_by15 = paste0(
    #     totalpatents_year, " ",
    #     paste(
    #     paste0(
    #       rev(sort( unique(total_percent_num_patents_bytype ))),
    #       "%", howderived_short
    #     ), 
    #     collapse = " "
    #   ) 
    #   )
    # )%>% 
    ungroup() %>% 
   
    # then created_or_acq_num is total for  second line
    #   mutate(
    #     if_created_thatyear = 
    #       case_when(
    #         patentyear_by5 == by15~ "Created that Year", 
    #         TRUE ~ "Acquired that Year"
    #       )
    #     
    #   ) %>% 
    # filter(
    #   if_created_thatyear == "Created that Year"
    # ) %>% 
  # then by passed or developed by crop
  group_by(
    by15,   total_percent_num_patents_bytype,totalpatents_year,
    created_or_acq_num, if_created_thatyear, 
    # aka by crop
    howderived_short,
    #this is to get divided by total patents by  crop
    numcrops_thatyear
  ) %>% 
    summarise(
        total_developed_thatyearbytype = length(unique(col_id))
      ) %>% 
      ungroup() %>% 
    mutate(
      per_total_developed_thatyearbytype = 
        case_when(
          !(if_top4  >=1) ~ 
          round(100*total_developed_thatyearbytype/created_or_acq_num,0), 
          (if_top4  >=1) ~ 
          round(100*total_developed_thatyearbytype/numcrops_thatyear,0)

        )
    )#  %>% 
    # gather(
    #   key =  eachrowtype, 
    #   value = value,
    #   num_patents_bytype,  total_developed_thatyearbytype
    # ) %>% 
    # distinct() %>% 
    # mutate(
    #   label_by_if_created_thatyear =  paste0(
    #     total_developed_thatyearbytype,  
    #     "%", howderived_short
    #   )
    # )
  # filter(
  #   per_total_developed_thatyearbytype >=2
  # )
  # 
  # passthru_process_stratadf_filter_labelyear_totals %>%
  #   filter(
  #       by15   == "1980"#, howderived_short == "c"
  #   ) %>% arrange(by15, howderived_short,if_created_thatyear  ) %>%   View()
  # 
  
passthru_process_lu5yr_labelyear <-passthru_process_stratadf_filter_labelyear_totals  %>% 
  mutate(
    howd_percent =  paste0(str_pad(per_total_developed_thatyearbytype,4,side =  c("left"),  "0" ) ,"%", howderived_short ),
        howd_percent_total =  paste0(str_pad(total_percent_num_patents_bytype,4,side =  c("left"),  "0" ) ,"%", howderived_short )

  ) %>% 
    group_by(
          by15, totalpatents_year,created_or_acq_num,if_created_thatyear  
    ) %>% 
    summarise(
      label_by_if_created_thatyear = paste(
         str_remove( #rev(sort(howd_percent)), "^0+")
          rev(sort(unique(howd_percent )   )), 
           "^0+"),
        collapse = " "
      ),
      label_total_if_createdthatyear = 

           paste(
             str_remove(
  
          rev(sort(unique(howd_percent_total ) )  ), 
           "^0+"),
        collapse = " "

        )
       
    ) %>% 
    ungroup()  %>% 
    mutate(
      label_by_if_created_thatyear = tolower(label_by_if_created_thatyear),
      dev_or_pass = 
        case_when(
          #this is  for  totals
          ((if_created_thatyear== "Created that Year")&( !(if_top4  >=1))) ~ 
            paste0(
              "D: ", created_or_acq_num, " (",  label_by_if_created_thatyear, ")"
            ),  
          ((if_created_thatyear!= "Created that Year")&( !(if_top4  >=1)))  ~ 
            paste0(
              "R: ", created_or_acq_num," (", label_by_if_created_thatyear, ")"
              ),
          #this is  for  tops only
          
          ((if_created_thatyear== "Created that Year")&( (if_top4  >=1))) ~ 
            paste0(
              "Top",if_top4,"_", "D: ", created_or_acq_num," ",
              round(100*created_or_acq_num/totalpatents_year ,0 ),"%",   " of total",
              " (",  label_by_if_created_thatyear, ")"
            ),  
          ((if_created_thatyear!= "Created that Year")&( (if_top4  >=1)))  ~ 
            paste0(
              "Top",if_top4,"_", 
              "R: ", created_or_acq_num," ", 
              round(100*created_or_acq_num/totalpatents_year ,0 ),"%",  " of total", 
               " (", label_by_if_created_thatyear, ")"
            )
          
        )
    ) %>% 
  group_by(
    by15,  totalpatents_year
  )  %>%  
  arrange(rev(label_total_if_createdthatyear ))  %>% 
  mutate(
    label_total_if_createdthatyear = tolower(label_total_if_createdthatyear),

    label_total_if_createdthatyear  =
      case_when(
         (row_number()==1)#&(grepl("D:|P:",dev_or_pass , perl = TRUE))  
         ~  label_total_if_createdthatyear,
       row_number()>=2#&(grepl("D:|P:",dev_or_pass , perl = TRUE)) 
       ~ lag(label_total_if_createdthatyear)#, 
       # TRUE ~ 
       
      )
  ) %>%   
    ungroup()   %>%  
  group_by(
    by15,  totalpatents_year, label_total_if_createdthatyear
  ) %>% 
  summarise(
    final_label_year   =  paste(
      sort(unique(dev_or_pass)),
      collapse = "; "
    )
  ) %>% 
  ungroup()%>% 
  left_join(
    passthru_process_lu5yr_labelyear_totalLU , 
    by = c("by15", "totalpatents_year")
  ) %>%
    mutate(
      finalyearlabel  = 
        case_when( 
         !(if_top4  >=1) ~  paste0(
         by15,  ": ",totalpatents_year, " (", label_total_if_createdthatyear_usethis,  "); ",
          final_label_year
        ),   
        (if_top4  >=1) ~ 
          final_label_year
          )
        
    ) %>% 
  select(
    by15,  finalyearlabel
  ) %>%
  distinct()
   
 passthru_process_lu5yr_labelyear   
  
}
```


### actual func
```{r }
 # alluvial::Refugees %>% glimpse()
graphalluvial <-function(alluv_df,  crops_to_use, top_strata , textsize , textout , outwidth, outheight,folderout,savefileas, yearlist, whichcolisID, whichcolisfacet, passthru_if_take_topssend , top_strata_colsplitbysend, order_by_cropLU= NULL, alluv_titleinclude , if_alluv_loop , alluv_label_legend, alluv_whichcolisaggregator ,alluv_legendlabelwrap,
                         shrink_factor , alluv_size ,alluv_transparency, alluv_remove_parentheses_vallabs= "no" ,alluv_remove_parentheses_ylabs = "no", 
                                 alluv_title_expo =  "Ownership of Acquired (A) or Origin (O) count and percent of certificates from ", 
                            alluv_xlabel=  "5-Year Interval: Total PVP or patent count; Developed (D); or Retained (R) during that 5-year interval, with %composition shown", 
                                   alluv_subtitle =   
         "Origin means that the patent or PVP applicant organization is the same name as the extant parent firm name. \nAcquired means that applicant organization was acquired by a parent firm."  

                         ){

  require(lubridate)
  require(alluvial)
  require(ggalluvial)
  require(scales)
  require(tidyverse)
          require(rcartocolor)

# # 
#  alluv_df <-  soycropquery_mergercountry %>%
#    select(
#      -col_id
#    )# %>%
#   ## dynamic vars to test
#  alluv_df %>% 
#    group_by(
#      crop
#    ) %>% 
#    summarise(
#      numpatent = length(unique(patent_number))
#    ) %>% 
#    ungroup() %>% 
#    arrange(-numpatent) %>% 
#    View()
#  
#  whichcolisID = alluv_df$patent_number
# whichcolisfacet= alluv_df$name_standard_patent2
#  order_by_cropLU = soycropquery_merger %>%
#                 group_by(crop) %>%
#                 summarise(
#                   numpatent = length(unique(patent_number))
#                 ) %>%
#                 ungroup()
# alluv_whichcolisaggregator= alluv_df$name_new_offpatent
# if_alluv_loop = alluv_df$crop
# 
# savefileas = "230910_patent_topcluster"
# savefileas = "230916_patentmerger_byinventor"
# savefileas = "230916_patentmerger_byinventor_bycrop"
# 
# yearlist = c(1980:2020)
# # this is the number of color categories to show, eg crop or company
# top_strata_colsplitbysend = 12
# outheight=35*6
# 
#  ## static vars to test
# crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola")
# crops_to_use = c("bean", "stonefruit", "green", "berry", "ornamental", "rice")
# crops_to_use = c("solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")
# # top strata is to keep Top n; call everything else not top n 
# top_strata = 12
# textsize = 6
# textout = 45
# outwidth =60
# outheight=35
# folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger"
# 
# # this is the summary stat for the x axis, for top 5 or top 4 ownership
# passthru_if_take_topssend = 5
#               # show num of top crops
#  # if_alluv_loop = alluv_df$crop
#               if_alluv_loop = 0
# # # 
#  alluv_remove_parentheses_vallabs= "yes"
#  alluv_remove_parentheses_ylabs = "yes"
#  alluv_title_expo =  ""
#  alluv_xlabel=  ""
#  alluv_subtitle =   ""
#  alluv_size = 3
#  alluv_transparency = .4
#  alluv_label_legend = ""
#  alluv_titleinclude = ""
#   shrink_factor = .75
# crops_to_use = c("soybean", "corn", "cotton", "forage", "wheat" )
 # crop_dontuse = c(
 #   (
 #     x %>% 
 #     filter(
 #       !crop %in% c(crops_to_use)
 #     )
 #   )$crop
 #   
 # )
 # top_strata = 12
 # yearlist = c(1980:2022)
 # textsize = 4
 # textout = 40
 #   outwidth = 60
 #   outheight = 35
 #   folderout ="X:/msi/work/farmer welfare/seed/R analysis/images/merger"
 #      folderout ="D:/seed"

   #    folderout ="C:/Users/Jeffrey.Nian/Documents/Comp/seed/images/merger"

         # folderout ="D:/seed/images/merger"

   # savefileas= "221106_alluvium_themes"
   #   savefileas= "230109_alluvium_themes"
   #   savefileas= "230117_alluvium_crop"


   # alluv_df <- soycropquery_merger  
   # top_strata = 10
  # x_filtercrop <- x %>% 
  #   filter(crop %in% crops_to_use)
  # 
  # x_filtercrop_other <- x_filtercrop %>% 
  #   bind_rows(
  #     x %>% 
  #       filter(
  #        !(crop %in% c(crop_dontuse)),
  #         !universal_id_start %in% c(x_filtercrop$universal_id_start)
  #       ) %>% 
  #       mutate(
  #         crop = "Other"
  #       )
  #     
  #   )  
     # so 2018 -> 2015
    # lubridate::year(round_date(as.Date(paste(2018, 12, 31, sep = "-")) , "5 years"))
    alluv_df_by15 <-  alluv_df%>%
      # select(
      #   -col_id
      # ) %>% 
      cbind(
        tibble(
          col_id = whichcolisID
        ), 
        # this is the column that is colored and split out by number, usually crop; can be company
        tibble(
          col_facet = whichcolisfacet
        ), 
        tibble(
          col_loopthru = if_alluv_loop
        ), 
        tibble(
          col_aggregator = alluv_whichcolisaggregator
        )

      )  %>% 
   mutate(
     # ground_year_year=  as.Date(paste(ground_year, 12, 31, sep = "-"))
     ground_year_year=   as.Date(ISOdate(ground_year, 12, 31)),
     patent_year = as.Date(ISOdate(patent_year, 12, 31))
   ) %>% 
   mutate(
     # by15 = parse_date_time(BeginTime, '%d/%m/%y %I:%M %p'),
     by15 = lubridate::year(round_date(ground_year_year, "5 years")), 
     patentyear_by5 = lubridate::year(round_date(patent_year, "5 years"))

     ) %>% 
      select(-ground_year_year) %>% 
      filter(
        crop %in% c(crops_to_use )
      ) %>% 
      group_by(patent_merger_id, by15) %>% 
      arrange(
        -ground_year
      ) %>% 
      slice(1) %>% 
      # slice(which.max(ground_year)) %>% 
      ungroup()
    # alluv_df_by15 %>% 
    #   filter(
    #     crop == "corn", 
    #     name_standard_patent2 == "MONSANTO"
    #   ) %>% 
    #   arrange(
    #     patent_merger_id, ground_year
    #   )%>% 
    #   View()
    # alluv_df_by15_selectcols <- alluv_df_by15%>% 
    #   select(
    #     by15, patentyear_by5, crop, starts_with()
    #   )
# 
#     alluv_df_by15_finalyearlu <-  alluv_df_by15 %>% 
#       group_by(patent_merger_id, name_standard_patent2 ) %>% 
#       filter(
#         patentyear_by5 == max(patentyear_by5)
#       ) %>% 
#       ungroup() %>%  
#       select(
#         patent_merger_id, name_standard_patent2, name_new_offpatent    
#       )
    
 # alluv_df_by15_spread <-  alluv_df_by15 %>% 
 #     processlabel_bytype(
 #  passthrudf =   ., 
 #  passthrudf_yearlistdf = yearlist,
 #  top_strata=12
 #  )
    rm(q)
    rm(list_alluv_ggplots)
q <- 1
alluv_list_loopthru <- alluv_df_by15$col_loopthru %>% unique() %>% sort()
list_alluv_ggplots <- list()

    while(q <= length(alluv_list_loopthru) )
    {
  alluv_current_loop <-    alluv_list_loopthru[q] 
    
  # alluv_df_by15 %>% 
  #   group_by(
  #     
  #   )
    # alluv_df_by15_spread <- passthrudf_out
  alluv_df_by15_spread <-  alluv_df_by15 %>% 
  filter(
    col_loopthru == alluv_current_loop
  ) %>% 
     processlabel_bytype_generic(

    passthrudf =   ., 
  passthrudf_yearlistdf = yearlist,
  # which_to_change1 = .$col_facet,
  # which_col_is_id = .$col_id,
  top_strata_colsplitby   = top_strata_colsplitbysend,
  top_strata =  top_strata,
  howderived_acq_or_orig = "yes",
  passthru_if_take_tops = passthru_if_take_topssend,
  passthru_name_countunique = "Inventor"

  
  )
# 
#   alluv_df_by15_spread <-  alluv_df_by15 %>% 
#     mutate(
#         patent_type2 =
#           case_when( 
#             name_new_offpatent== name_standard_patent2 ~ paste0("original."  , patent_type2) , 
#             TRUE ~ paste0("acquired." , patent_type2)
#           ), 
#     )  %>% 
#      processlabel_bytype_generic(
#   passthrudf =   ., 
#   passthrudf_yearlistdf = yearlist,
#   which_to_change1 = .$patent_type2,
#   top_strata_colsplitby   = 4,  
#   howderived_acq_or_orig = "yes", 
#     top_strata =  12,
#   passthru_if_take_tops = 4
#   )
# 

alluv_df_by15_spread2 <-alluv_df_by15_spread %>% 
  cbind(
     data.frame(
       final_name =   rev(alluv_df_by15_spread)[1]
     )
  )
names(alluv_df_by15_spread2)[ncol(alluv_df_by15_spread2)] <- "final_name"

        alluv_df_by15_topcos_color <- alluv_df_by15_spread2 %>% 
          filter(
            howderived ==  "only_final" 
          ) %>% 
      group_by(final_name) %>% 
      summarise(
        num_ids = length(unique(patent_merger_id))
      ) %>% 
      ungroup() %>% 
      arrange(
        -num_ids
      ) %>% 
      slice(1:top_strata_colsplitbysend)
            
# alluv_df_by15_withfinal <- alluv_df_by15%>% 
#   left_join(
#     alluv_df_by15_lu5yr, 
#     by = c("patent_merger_id","by15", "name_standard_patent2")
#   ) %>% 
#   group_by(
#     name_new_by15, patent_merger_id,by15, name_standard_patent2
#   ) %>% 
#   slice(1) %>% 
#   ungroup()
        require(rcartocolor)

   alluv_df_by15_spread_sum <- alluv_df_by15_spread2 %>% 
     filter(
       howderived != "only_final" 
     ) %>% 
     group_by_at(
       c(
         "final_name",
         "howderived",
         alluv_df_by15_spread %>% 
           select(
             contains("YR")
           ) %>% 
           names()
         )
     ) %>% 
    # group_by(
    #   crop,final_name,`YR1990`,`YR1995`,`YR2000`,`YR2005`,`YR2010`,`YR2015`,`YR2020`
    # ) %>% 
    summarise(
      freq = length(unique(patent_merger_id))
            # freq = length(unique(col_id))

    ) %>% 
     ungroup() %>% 
     mutate(
       rowid = row_number()
     )  
   
 alluv_df_by15_spread_sum_long <-alluv_df_by15_spread_sum  %>%
    gather(
      key = by15,
      value = value,
      contains("YR")
      ) %>% 
  mutate(
    final_name = 
      case_when(
        final_name %in% c(alluv_df_by15_topcos_color$final_name)~ final_name,
        TRUE ~ "Other"
      ) #,
# howderived = as.factor(as.character(howderived))
  )
 
   alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread2 %>% 
          filter(
       howderived == "only_final" 
     ) %>% 
     group_by_at(
       c(
         "final_name",
         alluv_df_by15_spread %>% 
           select(
             contains("YR")
           ) %>% 
           names()
         )
     ) %>% 
    # group_by(
    #   crop,final_name,`YR1990`,`YR1995`,`YR2000`,`YR2005`,`YR2010`,`YR2015`,`YR2020`
    # ) %>% 
    summarise(
      freq = length(unique(patent_merger_id))
    ) %>% 
     ungroup() %>% 
     mutate(
       rowid = row_number()
     )  %>%
    gather(
      key = by15,
      value = value,
      contains("YR")
      ) %>% 
     mutate(
       howderived = "Original to Acquired"#,
       # howderived = as.factor(as.character(howderived))
       ) #%>% 
  # mutate(
  #   final_name = 
  #     case_when(
  #       final_name %in% c(alluv_df_by15_topcos_color$final_name)~ final_name,
  #       TRUE ~ "Other"
  #     )
  # ) 

 
 # %>% 
   # mutate(
   #   howderived = 
   #     case_when(
   #       howderived == "Original_PVP" ~ "Original P"
   #     )
   # )
  # x_prepped_rename_usda <- x_prepped_rename_sum %>%
  #  filter(
  #    grepl("stine",`YR2000`, ignore.case = TRUE)
  #  )%>% arrange(patent_number,ground_year)  #%>% 


  # https://stackoverflow.com/questions/70283357/alluvial-plot-with-2-different-sources-but-a-converging-shared-variable-r

#   maxcolors <- length(unique((alluv_df_by15_topcos_color$final_name))
#     set.seed(111)
# 
#   require(RColorBrewer)
#   require(randomcoloR)
#  # n <- 60
# qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# # pie(rep(1,maxcolors), col=sample(col_vector,maxcolors))  
#  
# getPalette = colorRampPalette(brewer.pal(maxcolors, "Set1"))
# use_thispalette = col_vector[1: maxcolors]
# 
#   safe_colorblind_palette <- use_thispalette

 #   require(randomcoloR)
 # safe_colorblind_palette <- distinctColorPalette(maxcolors)
 #  require(rcartocolor)
#   nColor <- length(unique(x_prepped_rename_sum_cross$final_name))
# use_these_colors = carto_pal(nColor, "multi.pal")
# is_alluvia_form(x_prepped_rename_sum,
#                 weight = "countpatent")
  # curriculum data in alluvia format
# majors_alluvia <- 
#   to_alluvia_form(
#  x_prepped_rename_sum_cross,
#   key = "by15", 
#   value = "countpatent",
#   id = "rowid"
# )
   howderivedlu <- alluv_df_by15_spread_sum_long %>% 
     ungroup() %>% 
     bind_rows(
       alluv_df_by15_spread_sum_finalname 
     ) %>%   
     group_by(
      howderived 
     ) %>% 
     summarise(
       freq = sum(freq, na.rm =TRUE)
     ) %>% 

     ungroup() %>% 
     arrange(
       -freq
     ) %>% 
     mutate(
       crop = tolower(gsub(" \\(.*","", howderived))
     ) 

   
  if(!is.null(order_by_cropLU))
  {
   howderivedlu <- howderivedlu %>% 
     left_join(
       order_by_cropLU, 
       by = ( "crop")
     )  %>% 
         arrange(
           -numpatent
         ) %>% 
     mutate(
       howderived2 = paste0(row_number(),howderived)
     )
  } 
   
   if(is.null(order_by_cropLU))
   {
     howderivedlu <- howderivedlu %>% 
       mutate(
         howderived2 = howderived
       )
   }
   
      
   
   alluv_df_by15_spread_sum_long <-alluv_df_by15_spread_sum_long  %>% 
left_join(
  howderivedlu %>% 
    select(
      howderived, howderived2
    ), 
  by = ("howderived")
)

if( alluv_remove_parentheses_vallabs != "no" )
{
  alluv_df_by15_spread_sum_long <- alluv_df_by15_spread_sum_long %>% 
    mutate(
      value = gsub(" \\(.*","", value)
    )
  alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread_sum_finalname %>% 
    mutate(
      value = gsub(" \\(.*","", value)
    )
}
if( alluv_remove_parentheses_ylabs != "no" )
{
  alluv_df_by15_spread_sum_long <- alluv_df_by15_spread_sum_long %>% 
    mutate(
      by15 = gsub(":.*|YR=","", by15)
    )%>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
  alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread_sum_finalname %>% 
    mutate(
      by15 = gsub(":.*|YR=","", by15)
    )%>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
  
  howderivedlu <- howderivedlu %>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
}

   
     set.seed(123)
  large_palette <-  tibble(
  colors = c(
   
  
      "#B998DD",   "#88CCEE", "#CC6677", "#DDCC77", "#888888", "#44AA99","#EDEF5D", "#999933",  "#FFC6C4", "#70A494", "#B4C8A8",  "#EDBB8A", "#E4C7F1", "#EB4A40","#CE78B3", "#B0F2BC", "#F7FEAE" , "#AA4499"  , "#D1EEEA" 
        
     


)
) 
  
  #add more colors if needed
#   if(length(howderivedlu$howderived2 )>  length(large_palette$colors))
#   {
#     large_palette <- large_palette %>% 
#       bind_rows(
#         tibble(
#           colors = c(
#             # carto_pal(12, "Safe"),
#             carto_pal(7, "Geyser"),
#             carto_pal(7, "ag_Sunset"),
#             carto_pal(7, "ag_GrnYl"),
#             carto_pal(7, "Earth"),
#               carto_pal(7, "Geyser"),
#             carto_pal(7, "TealGrn"),
# 
# 
# 
#           )
#         )
#       )%>%
#       arrange(runif(n()))%>% 
#     filter(
#       colors %in%c(
# 
#         "#88CCEE", "#CC6677", "#DDCC77", "#888888", "#44AA99", "#999933", "#f0c6c3", "#70A494", "#B4C8A8",  "#EDBB8A", "#E4C7F1", "#F8A07E","#CE78B3", "#B0F2BC", "#F7FEAE", "#B998DD", "#AA4499" 
# 
# )
#     ) %>% 
#       distinct()
#   }
  # if(!(length(howderivedlu$howderived2 ) <= 7 )) 
  # {
  #   large_palette <- large_palette %>% 
  #   filter(
  #     colors %in% c(
  #       "#88CCEE", "#CC6677", "#DDCC77", "#888888", "#44AA99", "#999933", "#f0c6c3"
  #     )
  #   )
  # }
  #   if(!(length(howderivedlu$howderived2 ) <= 7 )) 
  # {
  #   large_palette <- large_palette %>% 
  #   filter(
  #     colors %in% c(
  #       "#88CCEE", "#CC6677", "#DDCC77", "#888888", "#44AA99", "#999933", "#f0c6c3"
  #     )
  #   )
  # }

  use_this_palette <- large_palette$colors[1:length(
    howderivedlu$howderived2
    #   c(
    #   alluv_df_by15_spread_sum_long$howderived,
    #    alluv_df_by15_spread_sum_finalname$howderived
    # ) %>% unique()
    )]
  names(use_this_palette) <- levels (
    c(howderivedlu$howderived2
    )
    # c(
    # 
    #   alluv_df_by15_spread_sum_long$howderived,
    #    alluv_df_by15_spread_sum_finalname$howderived
    # ) %>% unique())
  )
   # 
   # if((alluv_df_by15_spread_sum_long$howderived %>% unique() %>% length())>=3)
   # {
     
  # }
#     if(!(alluv_df_by15_spread_sum_long$howderived %>% unique() %>% length())>=3)
#    {
#  use_this_palette <- tibble(
#   colors = c(
#   carto_pal(12, "Safe")[1],
#     # carto_pal(12, "Safe")[12],
# 
#   # carto_pal(12, "Safe")[12]
#   carto_pal(7, "Earth")[5]
# ), 
# labels =
#     c(alluv_df_by15_spread_sum_long$howderived %>% unique(),
# alluv_df_by15_spread_sum_finalname$howderived %>% unique()
# )
# ) 



    # }
outplot <- alluv_df_by15_spread_sum_long %>% 
  ggplot(
    aes(
      x = by15,
      stratum = value,
      alluvium = rowid , 
      y = freq, 
      # color = final_name,
      label = value
      # Third variable on the X-axis
    )
  ) + 
     # geom_stratum() +
      # stat_stratum(
      #   # aes(fill=final_name),
      #   decreasing = FALSE,
      #   aes.bind = "flow",
      #   alpha = .4
      #   ) +
      # stat_alluvium(geom = "text", aes(label = subject),
      #           lode.guidance = "backfront")
      

      #   aes(fill = concentration),
      #   lode_backfront()
      #   ) +
# geom_stratum(
#   alpha = .5
# ) +
  # geom_text(
  #   aes(label = value, fill = final_name), stat = "stratum"
  #   )+
# geom_flow(
#   stat = "alluvium", lode.guidance = "forward", decreasing = FALSE) +
     # stat_flow(
     #    aes(fill = final_name),
     #    # aes(label = after_stat(stratum)),
     #    decreasing = FALSE,
     #    
     #    aes.bind = "flow"
     #  ) +      # geom_alluvium(
      # stat_stratum(
      #           # aes(fill=Cluster),
      #   geom = "text",
      #   aes(label = after_stat(stratum)),
      #   decreasing = FALSE,
      #   size = textsize,
      #   aes.bind = "flow"
      #   ) +
  # stat_alluvium(
  #    stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .3
  # ) +
  # stat_alluvium(
  #  data = alluv_df_by15_spread_sum_long,
  #  aes(
  #           x = by15,
  #     stratum = value,
  #     alluvium = rowid , 
  #     y = freq, 
  #     # color = final_name,
  #     label = value,
  #     fill =  howderived 
  # 
  # 
  #  ),
  #    stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .8
  # ) + 

  #   scale_fill_carto_d(
#   name = "",
#   palette = "Safe"
#   ) + 
# scale_color_carto_d(
#   # name = "Firm",
#   
#   palette = "Safe"
#   ) + 
 # stat_alluvium(
 #   data = alluv_df_by15_spread_sum_finalname,
 #   aes(
 #      x = by15,
 #      stratum = value,
 #      alluvium = rowid ,
 #      y = freq,
 #      # fill = NA  ,
 #            fill = howderived  ,
 # 
 #      # color = final_name,
 #      label = value
 # 
 #   ),
 #     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = 0#, alpha = 0#, fill =  carto_pal(7, "Earth")[5]#  "black"
 #  ) +
 stat_alluvium(
   data = alluv_df_by15_spread_sum_finalname,
   aes(
      x = by15,
      stratum = value,
      alluvium = rowid ,
      y = freq,
      # fill = howacquired  ,
      # color = final_name,
      label = value

   ),
     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .9, #, color =alpha("black", .6),
   # this allows a background of all 
   fill =  carto_pal(7, "Earth")[5]#  "black"
  ) +

  stat_alluvium(
   data = alluv_df_by15_spread_sum_long,
   aes(
            x = by15,
      stratum = value,
      alluvium = rowid , 
      y = freq, 
      # color = final_name,
      label = value,
      fill =  howderived2


   ),
     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE , alpha = .9#, color =alpha("black", .6)
  ) + 
    geom_stratum(
    # aes(
    #   # label = after_stat(value),
    #   # color =   final_name
    #
    # ),
    # width = 1/4,
    na.rm = TRUE,
    decreasing = FALSE,
    alpha =.8,
    size = alluv_size,
    fill = NA,
    color =alpha("black", alluv_transparency)
  ) +
#      geom_label(
#        aes(
#          # label = value
#          label =  value 
#          # label = stat(stratum)
#          # label = after_stat(stratum)
#            ),
#        fill = alpha("white", .3),
#        color = alpha("black", 0),
#        stat = "stratum",
#      # decreasing = FALSE,
#      na.rm = TRUE#,
# # size = textsize,
#        # width = 1/4,
# #        min.size = textsize,
# # reflow = TRUE,
# # grow = TRUE#, 
# # contrast = TRUE
# ) +

     ggfittext::geom_fit_text(
       aes(
         # label = value
         label =  value 
         # label = stat(stratum)
         # label = after_stat(stratum)
           ),
       # fill = alpha("white", .3),
       stat = "stratum",
     decreasing = FALSE,
     na.rm = TRUE,
# size = textsize,
       # width = 1/4,
       min.size = textsize,
reflow = TRUE,
grow = TRUE#, 
# contrast = TRUE
) +

  # scale_fill_manual(values = safe_colorblind_palette) +
  # scale_color_manual(values = safe_colorblind_palette)+
  theme_minimal()+
# scale_fill_manual(
#   name  =  "",
#   # values =  c( )
#     values = use_this_palette$colors,
#     labels=use_this_palette$labels,
#   # limits  =  use_this_palette$colors#,
#   drop = FALSE
# 
#   
# ) +
  # scale_fill_carto_d("Safe") +
#   scale_color_manual(
#   name  =  "Crop",
# 
#     values = use_this_palette#,
#     # labels=use_this_palette$labels#,
#   # drop = FALSE
# 
# 
# ) +
  scale_fill_manual(
  name  =  alluv_label_legend,

    values = use_this_palette,
    labels = scales::label_wrap(alluv_legendlabelwrap)
    # labels=use_this_palette$labels#,
  # drop = FALSE


) +

  # geom_text(stat = "stratum", size = 4) + 
  # theme_void() #+
  # scale_fill_brewer(type = "qual", palette = "Set3") _ 
# geom_alluvium(aes(fill = final_name),
#                 alpha = .75, decreasing = FALSE, width = 1/2) +
#   geom_stratum(aes(stratum = name_new), decreasing = FALSE, width = 1/2) + 
#  ggfittext::geom_fit_text(
#        aes(label = after_stat(name_new)),
#        stat = "stratum", 
#      decreasing = FALSE,
# # size = textsize,
#        # width = 1/4, 
#        min.size = textsize, 
# reflow = TRUE, 
# grow = FALSE
# ) +

      theme(
        # panel.background = element_rect(fill = 'black', colour = 'black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        # text = element_text(size = 14),
        plot.title = element_text(size = textout, face = "bold"),
        plot.subtitle = element_text(size = textout, face = "bold"),
        strip.text = element_text(size = textout),
        # axis.title.x.top = element_text( size = 20 ),
        axis.text.x = element_text( 
          size = textout, 
          angle = 40, 
          hjust = 1
          ),
        plot.margin = margin(l = 0 + margin_spacer( alluv_df_by15_spread_sum_long$by15), t = 80, b = 80),
        # axis.text.y = element_text( size = 20 ),
        axis.title.x=element_text( size = textout ),

        legend.text=element_text(size=textout),
        # legend.title=element_text(size=20),
        # axis.title=element_text(size=20,face="bold"),
        title = element_text(size = textout) ,
        # axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        plot.background = element_rect(color = alpha("black", .6), size = 3),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "top", 
        legend.title = element_text(size=textout),
        legend.direction = "horizontal",
         # legend.title = element_blank(),
        legend.key.size = unit(2, 'cm')
      )  + 
  scale_x_discrete(labels=function(x){gsub("; ", "\n", x)}) + 
  ggtitle(
    paste0(
      gsub("0: ","",
      gsub(
        ": : ", ": ", 
        paste0(
          
          toupper(alluv_current_loop) , ": ", 
          alluv_titleinclude,  ": ", 
          alluv_title_expo, 
          # "Ownership of Acquired (A) or Origin (O) count and percent of certificates from " , 
          # alluv_title_expo =  "Ownership of Acquired (A) or Origin (O) count and percent of certificates from "
          min(yearlist), "-", max(yearlist)
          
        ) 
      )
    )
    )
    ,
    alluv_subtitle
    #  alluv_subtitle =   
    # "Origin means that the patent or PVP applicant organization is the same name as the extant parent firm name. \nAcquired means that applicant organization was acquired by a parent firm."  
    
    
  ) +
  xlab(
   alluv_xlabel
   # alluv_xlabel=  "5-Year Interval: Total PVP or patent count; Developed (D); or Passed on (P) during that 5-year interval, with %composition shown"
           # label= "5-Year Interval: Total PVP or patent count; Developed (D); or Passed on (P) during that 5-year interval, with %composition shown"
          
        )
#       scale_fill_manual(values = safe_colorblind_palette)+ 
  # facet_wrap(~crop, "free")
list_alluv_ggplots[[q]] <- outplot
q <- q+1
    }

heresmylistofplots = cowplot::plot_grid(
        plotlist = list_alluv_ggplots ,
        nrow = length(list_alluv_ggplots),
        ncol = 1,
        # labels = "AUTO",
        # # label_size = 12,
        align = "v"#,
        # rel_heights = c(rep(1, each = sqrt(length(use_these_facetvec))))
       
)

   
    
#  if(!exists(paste0(
#     # "/home/jaina/Documents/work/2021 ML/unsupervised/",
#     foldername)))
# {
#   dir.create(foldername)
#  }

heightdf_use <- ((length(list_alluv_ggplots)*shrink_factor))*outheight


 pdf(
    paste0(folderout,"/", savefileas, ".pdf"),
  width = outwidth,
    height = heightdf_use

    # width = 60,
    # height = 300 #,
    # units = "in", 
    # res = 300
  )
  print(
    heresmylistofplots
  #   ggplot(
  #     data = as.data.frame(x),
  #     aes(
  #       y = num_divided,
  #       axis1 = bankname, 
  #       axis2 = label, 
  #       axis3 = parentlabel
  #     )
  #   ) +
  #     geom_alluvium(
  #       aes(fill = label),
  #       # width = 0, knot.pos = 0, reverse = FALSE
  #     ) +
  #     # guides(fill = FALSE) +
  #     geom_stratum(width = 1/8, reverse = FALSE) +
  #     geom_text(stat = "stratum", aes(label = after_stat(stratum)),
  #               reverse = FALSE) +
  #     scale_x_continuous(breaks = 1:3, labels = c("Lender", "County", "Integrator")) +
  #     # coord_flip() +
  #     ggtitle("Titanic survival by class and sex")
  #   

  
    
  ) 
  
  
  
  dev.off()

    
  
  rm(crops_to_use)
rm(top_strata)
rm(textsize)
rm(textout)
rm(outwidth)
rm(outheight)
rm(folderout)
rm(savefileas)
rm(yearlist)
rm(whichcolisID)
rm(whichcolisfacet)
rm(passthru_if_take_topssend)
              # show num of top crops
              rm(top_strata_colsplitbysend)
              
              rm(alluv_df_by15)
              rm(alluv_df_by15_spread)
              rm(alluv_df_by15_spread_sum)
              rm(alluv_df_by15_spread_sum_finalname)
              rm(alluv_df_by15_spread_sum_long)
              rm(alluv_df_by15_spread2)
              rm(alluv_df_by15_topcos_color)
              rm(alluv_df)
              rm(howderivedlu)
              rm(large_palette)
              rm(outplot)
              rm(order_by_cropLU)
              rm(top_strata_colsplitbysend)
              rm(use_this_palette)
              rm(q)
              rm(shrink_factor)
              rm(lookup)
              rm(heightdf_use)
              rm(alluv_xlabel)
              rm(alluv_whichcolisaggregator)
              rm(alluv_transparency)
              rm(alluv_titleinclude)
              rm(alluv_title_expo)
              rm(alluv_subtitle)
              rm(alluv_size)
                 rm(alluv_remove_parentheses_vallabs)
                 rm(alluv_remove_parentheses_ylabs)
                 rm(alluv_list_loopthru)
                 rm(alluv_legendlabelwrap)
                 rm(alluv_label_legend)
                 rm(alluv_current_loop)
                 rm(which_to_change1)
                 rm(if_alluv_loop)
                 rm(passhtrudf_aggregator)
                 rm(passthrudf_out)
                 rm(passthrudf_by15_spread3)
                 rm(passthrudf_by15_spread2)
                 rm(list_alluv_ggplots)
                 rm(heresmylistofplots)

}
```

 
### use func alluv 

#### test if contains
```{r }
soycropquery_mergercountry %>% 
  filter(
    name_standard_patent2 == "STONEVILLE PEDIGREED SEED"#, 
    # crop == "canola"
      
  ) %>% 
  arrange(
    patent_merger_id, ground_year
  ) %>% 
  View()
crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola")
crops_to_use = c("bean", "stonefruit", "green", "berry", "ornamental", "rice")
crops_to_use = c("solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")


```
#### basic p and pvp; acq or dev



##### by inventor; no facet
###### top crops
###### reminder crop summary
```{r }
 soycropquery_mergercountry %>% 
   group_by(
     crop
   ) %>%
   summarise(
     numpatent = length(unique(patent_number))
   ) %>%
   ungroup() %>%
   arrange(-numpatent) %>%
   View()
```
###### includes legend labels - detail
```{r }
soycropquery_mergercountry %>% 
  filter(
    # crop %in%c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")
        crop  %in%  c("soybean", "corn", "cotton", "wheat", "forage", "canola" )

  ) %>% 
  select(
    -col_id
  )%>% 
  graphalluvial(
    alluv_df = .,
     # crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"),
   crops_to_use  = c("soybean", "corn", "cotton", "wheat", "forage", "canola" ),

    top_strata = 15, 
    textsize = 6, 
    textout = 45,
    outwidth =60,
    outheight=35*2,
    
    folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger",
    # savefileas = "230916_patentmerger_byinventor_detail_topcrop_offpatent",
       savefileas = "230916_patentmerger_byinventor_topcrop_offpatent_detail",

    yearlist = c(1980:2022), 
    whichcolisID = .$patent_number, 
    whichcolisfacet= .$name_standard_patent2, 
    passthru_if_take_topssend = 4,
    # show num of top crops
    top_strata_colsplitbysend = 15, 
    if_alluv_loop = 0, 
    alluv_remove_parentheses_vallabs= "yes",
    alluv_remove_parentheses_ylabs = "no",
    alluv_title_expo =  "",
    alluv_xlabel=  "",
    alluv_subtitle =   "",
    alluv_size = 3,
    alluv_transparency = .4,
    alluv_label_legend = "Inventor",
    alluv_titleinclude = "Patent and PVP Certificate Count by Inventor (Legend) and Parent Firm (Shown in Chart) for crops: soybean, corn, cotton, wheat, forage, canola",
    shrink_factor = .75,
    # alluv_whichcolisaggregator= .$col_acquirer_new,
    alluv_whichcolisaggregator= .$name_new_offpatent,

    alluv_legendlabelwrap = 20
              )

```

###### no legend labels - no detail; many crops
```{r }
soycropquery_mergercountry %>% 
  filter(
    crop %in%c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")
        # crop  %in%  c("soybean", "corn", "cotton", "wheat", "forage", "canola" )

  ) %>% 
  select(
    -col_id
  )%>% 
  graphalluvial(
    alluv_df = .,
     crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"),
   # crops_to_use  = c("soybean", "corn", "cotton", "wheat", "forage", "canola" ),

    top_strata = 15, 
    textsize = 6, 
    textout = 45,
    outwidth =60,
    outheight=35,
    
    folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger",
    # savefileas = "230916_patentmerger_byinventor_allcroprop_offpatent",
    savefileas = "230916_patentmerger_byinventor_manycrop_offpatent",

    yearlist = c(1980:2022), 
    whichcolisID = .$patent_number, 
    whichcolisfacet= .$name_standard_patent2, 
    passthru_if_take_topssend = 4,
    # show num of top crops
    top_strata_colsplitbysend = 15, 
    if_alluv_loop = .$crop,
    alluv_remove_parentheses_vallabs= "yes",
    alluv_remove_parentheses_ylabs = "yes",
    alluv_title_expo =  "",
    alluv_xlabel=  "",
    alluv_subtitle =   "",
    alluv_size = 3,
    alluv_transparency = .4,
    alluv_label_legend = "Inventor",
    alluv_titleinclude = "Patent and PVP Certificate Count by Inventor (Legend) and Parent Firm (Shown in Chart) for many crops",
    shrink_factor = .75,
    # alluv_whichcolisaggregator= .$col_acquirer_new,
    alluv_whichcolisaggregator= .$name_new_offpatent,

    alluv_legendlabelwrap = 20
              )

```


###### includes legend labels - no detail
```{r }
soycropquery_mergercountry %>% 
  filter(
    # crop %in%c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")
        crop  %in%  c("soybean", "corn", "cotton", "wheat", "forage", "canola" )

  ) %>% 
  select(
    -col_id
  )%>% 
  graphalluvial(
    alluv_df = .,
     # crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"),
   crops_to_use  = c("soybean", "corn", "cotton", "wheat", "forage", "canola" ),

    top_strata = 15, 
    textsize = 6, 
    textout = 45,
    outwidth =60,
    outheight=35,
    
    folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger",
    # savefileas = "230916_patentmerger_byinventor_allcroprop_offpatent",
    savefileas = "230916_patentmerger_byinventor_topcrop_notoffpatent",

    yearlist = c(1980:2022), 
    whichcolisID = .$patent_number, 
    whichcolisfacet= .$name_standard_patent2, 
    passthru_if_take_topssend = 4,
    # show num of top crops
    top_strata_colsplitbysend = 15, 
    if_alluv_loop = 0, 
    alluv_remove_parentheses_vallabs= "yes",
    alluv_remove_parentheses_ylabs = "yes",
    alluv_title_expo =  "",
    alluv_xlabel=  "",
    alluv_subtitle =   "",
    alluv_size = 3,
    alluv_transparency = .4,
    alluv_label_legend = "Inventor",
    alluv_titleinclude = "Patent and PVP Certificate Count by Inventor (Legend) and Parent Firm (Shown in Chart) for crops: soybean, corn, cotton, wheat, forage, canola",
    shrink_factor = .75,
    alluv_whichcolisaggregator= .$col_acquirer_new,
    # alluv_whichcolisaggregator= .$name_new_offpatent,

    alluv_legendlabelwrap = 20
              )

```



##### by country  
```{r }
soycropquery_mergercountry %>% 
  filter(
    # crop %in%c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon")
        crop %in%c("soybean", "corn", "cotton", "wheat", "forage", "canola" )

  ) %>% 
  # mutate(
  #   likely_country = 
  #     case_when(
  #       name_new_offpatent == "Offpatent" ~ "Offpatent",
  #       TRUE ~ likely_country
  #     )
  # )
  select(
    -col_id
  )%>% 
  graphalluvial(
    alluv_df = .,
    # crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"),
   crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage", "canola" ),
    top_strata = 12, 
    textsize = 6, 
    textout = 45,
    outwidth =60,
    # outheight=35*2,
     outheight=35,
   
    folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger",
    savefileas = "230916_patentmerger_bycountry_nolabel_topcrop",
       # savefileas = "230916_patentmerger_bycountry_nolabel",

    yearlist = c(1980:2022), 
    whichcolisID = .$patent_number, 
    whichcolisfacet= .$name_standard_patent2, 
    passthru_if_take_topssend = 4,
    # show num of top crops
    top_strata_colsplitbysend = 15, 
    # if_alluv_loop = .$crop, 
       if_alluv_loop = 0, 
    #    alluv_remove_parentheses_vallabs= "no",
    # alluv_remove_parentheses_ylabs = "no",
    alluv_remove_parentheses_vallabs= "yes",
    alluv_remove_parentheses_ylabs = "yes",
    alluv_title_expo =  "",
    alluv_xlabel=  "",
    alluv_subtitle =   "",
    alluv_size = 3,
    alluv_transparency = .4,
    alluv_label_legend = "Inventor",
    alluv_titleinclude = "Patent and PVP Certificate Count by Inventor (Legend) and Country of Parent Firm (Shown in Chart) for crops: soybean, corn, cotton, wheat, forage, canola",
    shrink_factor = .75,
    alluv_whichcolisaggregator= .$likely_country,
    alluv_legendlabelwrap = 20
              )

```
# lineplot innov func

##  cowplot innovation and acq

```{r }
# calcpercent <- function(x){
#   (100*x)
# }
```

## helper funcs
```{r }
sigfig <- function(vec, digits){
  return(gsub("\\.$", "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
}

```

```{r }
bylinecalc_unique_score <- function(x_idcol,y_scorecol){
  
  x_id_df <- tibble(
    id = x_idcol
  ) %>% 
    cbind(
       tibble(
    score = y_scorecol
  ) 
      
    ) %>% 
    distinct()
    # group_by(id, score) %>% 
    # slice(1) %>% 
    # ungroup() 
  # round(sum(x_id_df$score, na.rm=TRUE),0)
   sum(x_id_df$score, na.rm=TRUE) 
  
}

```
### func to find mins

####first smooth
```{r }
# library(SplinesUtils)
# library(broom)
# devtools::install_github("ZheyuanLi/SplinesUtils")
calc_spline_func <- function(q ,spline_col_year, spline_col_value, spline_col_groupby, if_writeout = "no") {
  require(caret)
  require(SplinesUtils)
  require(broom)
  require(mgcv)
  require(gam)
# 
#   q <-  innov_acq_df_sum_relabelfacet_parent_sum %>%
#    mutate(
#      groupallby = paste(facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass, sep = "<" )
#    )
#   spline_col_year = q$by15
#   spline_col_value = q$sumval
#   spline_col_groupby = q$groupallby
  
  z_orig <- q%>% 
    cbind(
      tibble(
         x = spline_col_year 
      )
    )%>% 
    cbind(
      tibble(
         y =spline_col_value
      )
    )%>% 
    cbind(
      tibble(
         splinegroupby =spline_col_groupby
      )
    )%>% 
    group_by(
      splinegroupby
    ) %>% 
    filter(
      length(unique(x)) >=4
    ) %>%
    ungroup()
  
  z_bounds <- z_orig %>% 
    mutate(
      year_year = year(x)
    ) %>% 
    group_by(splinegroupby) %>% 
    mutate(
      yearmax = max(year_year)
    ) %>% 
    filter(
      year_year == min(year_year)
    ) %>% 
    ungroup() %>% 
    group_by(
      splinegroupby, yearmax
    ) %>% 
    slice(1) %>% 
    ungroup() %>% 
    mutate(
      years_to_expand = yearmax - year_year + 1
    ) %>% 
    group_by(
      splinegroupby 
    ) %>% 
    slice(rep(row_number(), years_to_expand)) %>% 
    mutate(
      year_year = year_year + row_number()-1
    ) %>% 
    ungroup() %>% 
    select(
      year_year, splinegroupby
    ) %>% 
    distinct() %>% 
    left_join(
      z_orig %>% 
        mutate(
          year_year = year(x)
        ), 
      by = c("year_year", "splinegroupby")
    ) %>% 
    mutate(
      x = as.Date(ISOdate(year_year, 12, 31))
    ) %>%
    mutate(
      y = replace_na(y, 0)
    ) %>% 
    select(
      x, y, splinegroupby
    ) %>% 
    distinct()
    

  z <- z_bounds %>% 
  
  #   group_by(
  #     GEOID
  #   )
  # filter(
  #   length(unique(year)) >=4
  # ) %>% 
  # ungroup()  %>% 
    # rename(
    #    x = year, 
    #    y = Value
    # ) %>% 
    mutate(
      x = as.numeric(x)
    ) %>% 
    filter(
      !is.na(x+1),
      !is.na(y+1),
      is.finite(x),
      is.finite(y)
    )  
  i <- 1
  vars_loopthru <- z$splinegroupby %>% unique()
  # Sx = seq(
  #   from = z$x  %>% min(),
  #   # from = lubridate::as_date("1984-01-01" ), 
  #   # to = lubridate::as_date("1984-01-01" ) , 
  #   to = z$x  %>% max(),
  #   by = 365
  #   # by = "month"
  # )
  rm(d1_list)
d1_list <- list()
  while(i <= length(vars_loopthru))
  {
    
      current_GEOID <- vars_loopthru[i]

      
  current_df <- z %>% 
    filter(
      splinegroupby == current_GEOID
    ) %>% 
    select(
      x, y
    ) %>% 
    data.frame()
        if(length(unique(current_df$y))<=2)
        {
          i <- i+1
          next
        }

      current_Sx = seq(
    from = current_df$x  %>% min(),
    # from = lubridate::as_date("1984-01-01" ), 
    # to = lubridate::as_date("1984-01-01" ) , 
    to = current_df$x  %>% max(),
    by = 365/12
    # by = "month"
  )
current_Sx_df <- tibble(
 x =  current_Sx
)
  # sp1 <- smooth.spline(current_df  )
  # https://www.statology.org/loess-regression-in-r/
#define k-fold cross validation method
ctrl <- trainControl(method = "cv", number = 5)
grid <- expand.grid(span = seq(0.3, .75, len = 5), degree = 1)

#perform cross-validation using smoothing spans ranginf from 0.5 to 0.9
model <- train(y ~ x, data = current_df, method = "gamLoess", tuneGrid=grid, trControl = ctrl)

  # model <- loess(y ~ x, data = current_df )
  # model <- gam(y ~ x, data = current_df )

 # pred.spline <- predict.gam(model, newdata =current_Sx_df)
pred.spline <- predict(model, current_Sx_df)
    # pred.spline <- augment(model, current_df)
d0 <-  tibble(
   pred.spline = pred.spline
  ) %>% 
  cbind(
    x = current_Sx
  ) %>% 
  rename(
    y = pred.spline
  ) %>% 
# pred.spline %>% 
  mutate(
    currentgroupby = current_GEOID,
    type = "predicted_val", 
    # year = as.Date(paste( lubridate::year(as_date(as.numeric(x))), 12, 31, sep = "-") )
    # changed to below in order to allow more interval for smoothing and peak calc instead of just one yearl; needs to match the inteval above (365)
        year = as_date(as.numeric(x))

  ) %>% 
  group_by(
    year
    ) %>% 
  slice(1) %>% 
  ungroup()#%>% as.Date(paste(2018, 12, 31, sep = "-"))
  # select(
  #  x, y, GEOID, type
  # )
# pred.prime <- predict(sp1, Sx, deriv=1)
# d1 <- data.frame(pred.prime) %>% 
#   mutate(
#     GEOID = current_GEOID, 
#     type = "deriv"
# 
#   ) %>% 
#   select(
#    x, y, GEOID, type
#   )
# d1_mins <- d1 %>% 
#   mutate(
#     meanval = mean(abs(y))/150,
#     type = "mins"
#   ) %>% 
#   filter(
#     abs(y) > meanval
#   ) %>% 
#   select(
#    x, y, GEOID, type
#   )

d1_list[[i]] <- d0 # %>% 
  # bind_rows(
  #   d1_mins,
  #   d0
  # )

i <- i+1
  }



d5 <- d1_list %>% 
  bind_rows()
  rm(q) 
  rm(z)
  rm(spline_col_year) 
  rm(spline_col_value)
  rm(spline_col_groupby )
rm(z_orig)
rm(z_bounds)
  rm(d0)
  rm(d1_list)
  rm(pred.spline)
  rm(model)
  rm(current_Sx)
  rm(current_GEOID)
  rm(current_df)
rm(ctrl)
rm(grid)
rm(model)
rm(i)
rm(current_Sx_df)
d5
# Mins = which(abs(d1$y) < mean(abs(d1$y))/150)
}


broilers_ee_readytoplot_spline <- broilers_ee_readytoplot %>% 
  filter(
    shape_type == "plant"
  ) %>% 
  select(
    year,
    GEOID,
    Value
  ) %>% 
  distinct() %>% 
  # group_by(GEOID) %>% 
  calc_spline_func(.) %>% 
  mutate(
    year = as_date(as.numeric(x))
  ) 

```

#### second find extrema
```{r }

### 

# 
locate_xtrem_loop <- function(x, whichcolisgroupby){
  # require(ggpmisc)
  drv <- function(x, y) c(NA, (diff(y) /diff(x))) 
require(ggpmisc)
peakPosition <- function(x, inclBorders=TRUE) {
  if(inclBorders) {y <- c(min(x), x, min(x))
  } else {y <- c(x[1], x)}
  y <- data.frame(x=sign(diff(y)), i=1:(length(y)-1))
  y <- y[y$x!=0,]
  idx <- diff(y$x)<0
  (y$i[c(idx,F)] + y$i[c(F,idx)] - 1)/2
}


lowPosition <- function(x, inclBorders=TRUE) {
  if(inclBorders) {y <- c(min(x), x, min(x))
  } else {y <- c(x[1], x)}
  y <- data.frame(x=sign(diff(y)), i=1:(length(y)-1))
  y <- y[y$x!=0,]
  idx <- diff(y$x)>0
  (y$i[c(idx,F)] + y$i[c(F,idx)] - 1)/2
}

x_df <- x %>% 
  cbind(
    tibble(
     colgroupby =  whichcolisgroupby
    )
  )

  i <- 1
  vars_loopthru <- whichcolisgroupby %>% unique()
  rm(found_extreme_df)
  found_extreme_df <-list()
  while(i <= length(vars_loopthru))
  {

    current_GEOID <- vars_loopthru[i]
    current_df <- x_df %>%
      filter(
        colgroupby == current_GEOID
      ) %>% 
      mutate(
        index = row_number()
      )
    current_loop_min= current_df$x %>% min()
    current_loop_max = current_df$x %>% max()

    
    found_extreme <- peakPosition(
      current_df$y 
    )
    
    # found_extreme_df[[i]] <- current_df %>% 
    #     filter(
    #       index %in% found_extreme
    #     )

    
    low_extreme <- lowPosition(
      current_df$y
    )
    
      found_extreme_df_pass <- current_df %>% 
      filter(
        index %in% found_extreme
      ) %>% 
      mutate(
        low_or_peak = "peak"
      ) %>% 
      bind_rows(
        current_df %>% 
          filter(
            index %in% low_extreme
          ) %>% 
          mutate(
            low_or_peak = "low"
          )
      )
      
      # last find derivatives
      xtrem_d1 = diff(current_df$y)/diff(current_df$x)
      xtrem_d1 = c(xtrem_d1[1],xtrem_d1)
      xtrem_Derivativedf = tibble(
        d1 = xtrem_d1, 
      ) %>% 
        cbind(
        current_df %>% 
          select(
            x, index
          )

        )
        
         
      
      current_df_extremes_withlast_end <- found_extreme_df_pass %>% 
        # group_by(colgroupby) %>% 
        # here we make sure that pass has endval, if appropriate (filters to preceding value; if that extrem val is "low" and 
        filter(
          x == max(x),  
          x != current_loop_max,
          low_or_peak =="low"
        )
        # ungroup() 
        

    if(nrow( current_df_extremes_withlast_end) >=1)
    {
    found_extreme_df_pass <-   found_extreme_df_pass  %>% 
      bind_rows(
        current_df  %>% 
          filter(
            !is.na(y),
            x == max(x), 
           x != current_loop_max

          ) %>% 
          mutate(
            low_or_peak = "peak"
          )%>% 
        slice(1)%>% 
          # needs to be upward sloping
         left_join(
           xtrem_Derivativedf , 
           by = c("x", "index")
         )%>% 
        #https://stackoverflow.com/questions/53109083/r-function-to-find-derivative-of-every-point-in-time-series
        filter(
          d1 >0
        )  #%>% 
          # group_by(x) %>% 
          # slice(1) %>% 
          # ungroup()
      )
    }
        
          # if the first extreme is low, means that first value is 
       current_df_extremes_withlast_begin <-   found_extreme_df_pass %>% 
        # group_by(colgroupby) %>% 
        filter(
          x == min(x),  
          x != current_loop_min,
          low_or_peak =="low"
        )# %>% 
        #  left_join(
        #    xtrem_Derivativedf, 
        #    by = c("x", "index")
        #  )%>% 
        # filter(
        #   d1 <0
        # )
        
    if(nrow( current_df_extremes_withlast_begin) >=1)
    {
    found_extreme_df_pass <-  found_extreme_df_pass %>% 
      bind_rows(
        current_df  %>% 
          filter(
            x == min(x), 
           x != current_loop_min
          ) %>% 
          # at start need to be downward sloping
          mutate(
            low_or_peak = "peak"
          )%>% 
          slice(1)  %>%  left_join(
           xtrem_Derivativedf,
           by = c("x", "index")
         )%>%
        filter(
          d1 <0
        )
# %>% 
          # ungroup()
      )
    }

found_extreme_df[[i]] <- found_extreme_df_pass
    i <- i+1
  }
found_extreme_df_bindrow <- found_extreme_df %>% 
  bind_rows() %>% 
  filter(!is.na(y)) %>% 
  group_by(
    x, y,low_or_peak 
  ) %>% 
  slice(1) %>% 
  ungroup()
found_extreme_df_bindrow

}

```

###### produce labels emmeans
```{r }
   ### run tukey test and get letters

calc_emmeansfunc <- function(emmeansdf, emmeans_valuecol, emmeans_group_within_col, emmeans_groupcol, emmeans_comparisoncol){
  require(emmeans)
emmeansdf_df <- emmeansdf %>% 
  cbind(
    tibble(
      valuecol = emmeans_valuecol
    )
  ) %>% 
   cbind(
    tibble(
      groupwithinco = emmeans_group_within_col
    )
  ) %>% 
   cbind(
    tibble(
      groupcol = emmeans_groupcol
    )
  )%>% 
   cbind(
    tibble(
      comparisoncol = emmeans_comparisoncol
    )
  )
  PC_gothru <- emmeans_groupcol %>% 
    unique()
    j <- 1

  rm(emmeanslist)
  emmeanslist <- list()
  while(j <=length(PC_gothru) )
  {
    currentpc <- PC_gothru[j]
    currentdf_pc <- emmeansdf_df %>% 
      filter(
        groupcol == currentpc
      )
    
    
    # group within 
    emmcld <- lm(valuecol ~ comparisoncol + groupwithinco, data = currentdf_pc) %>%
  emmeans(~comparisoncol) %>%
  multcomp::cld(Letters = letters, adjust = "sidak")
emmeanslist[[j]] <-  emmcld %>% 
  mutate(
    groupcol = currentpc
  )
j <- j+1
  }
  emmeanslist %>% 
    bind_rows()
  }
# X:\msi\work\farmer welfare\seed
```

#### actual func
```{r }

innov_acq_cowplotfunc <- function(
    # df
    innov_acq, 
    # finalname
    innov_acq_facetcol, 
    # theme or crop
    innov_acq_mainrow,
    # patent merger id or simply id
    innov_acq_idcol, 
    # name of each column, or co name
    innov_acq_facetcol_indiv,
    # if summing by unique id or gamma/quantity
    sum_by_unique_or_quantity, #= NULL, 
    ### this is the number of top parents
    slicetopn_of_namefinal,
    #### this is number of top indivs within parent
        slicetopn_of_nameindiv ,

    linesizedf, #= 3,
    num_sigfigs,
    textout ,#=5,
    textsize, outwidth, outheight,foldername ,naming , 
    if_append_facetlabel_ggtitle,# = "no", 
    num_to_dividefacetheight ,#= 10, 
    ylabdf,# = "Count of unique Patent or PVP IDs", 
    # ylabdf = "Score"
if_calc_max ,#= "yes",
innov_show_all_only ,#= "no", 
if_scale_fixed ,#= "no", 
if_only_developed ,#= "no", 
pointsize,# = .75, 
#=yes ,
linesize ,#= .5, 
show_mergercurve,# = "yes", 
if_calc_diversity, # = "yes"
# facetwrapsize = 60
innov_if_show_labels,
innov_legend_ncol,
innov_crops_to_use,
       # c("soybean", "corn", "cotton", "wheat", "forage", "canola" )
innov_crops_to_use_label
 
    ){
  require(rcartocolor)
  require(lubridate)
  require(ggrepel)
  require(tidyverse)
  require(cowplot)

 # innov_acq_pre <- soycropquery_mergercountry  
   
  # filter(
  #   # col_acquirer_new != "DENGHAI SEED GROUP", 
  #   finalname != "DENGHAI SEED GROUP"
  #   
  # #   crop == "wheat"#,
  # #   # grepl("plant, soybean, variety, may, plants, can, used, seed, example, resistance, one, gene", terms, perl = TRUE, ignore.case = TRUE),
  # )
# innov_acq <- soycropquery_mergercountry %>%
#   filter(
#     crop %in%  
#        c("soybean", "corn", "cotton", "wheat", "forage", "canola" )
#    
#   ) %>% 
#   mutate(
#     crop = "Canola, Corn, Cotton, Forage, Soybean, Wheat", 
#     patent_type = "IP"
#   ) %>% 
 # # filter(
#  #   patent_merger_id %in% c(innov_acq_pre$patent_merger_id)
#  # ) %>% 
#  # functionreduce_down_dups(passthrudf = ., functionreduce_down_colthatisid = #.$patent_number, functionreduce_down_colthatiscrop = .$crop #,functionreduce_down_colthatisacquired = .$name_standard_patent2 )
    
  # func_find_maxyear_name( 
  #   findmaxyear_df =., 
  #   findmaxyear_yearcol = .$ground_year,
  #   findmaxyear_firmnamecol = .$name_standard_patent2,
  #   findmaxyear_firmname_changetocol = .$col_acquirer_new,
  #   findmaxyear_idcol = .$patent_merger_id
  #   )# %>% 
  # filter(
  #   ground_year == patent_year
  # )
# if_remove_text ="yes"
#  innov_acq_facetcol = innov_acq$finalname
#  num_to_dividefacetheight = 10
# # theme or crop
# innov_acq_mainrow = innov_acq$crop
# # patent merger id or simply id
# innov_acq_idcol = innov_acq$patent_number
# # name of each column or co name
# innov_acq_facetcol_indiv =innov_acq$name_standard_patent2
# # if summing by unique id or gamma/quantity
# sum_by_unique_or_quantity = innov_acq$patent_number
# slicetopn_of_nameindiv = 0
# if_scale_fixed = "no"
# slicetopn_of_namefinal=5
# textout =5
# textsize=2
# outwidth = 120
# outheight=70
# num_sigfigs = 2
# foldername ="X:/msi/work/farmer welfare/seed/R analysis/images/topic model/230124_topic_by_crop"
# foldername ="X:/msi/work/farmer welfare/seed/R analysis/images/topic model/230917_topic_by_crop"
# 
# if_append_facetlabel_ggtitle= "no"
# 
# ylabdf = "Score"
# if_calc_max = "yes"
# if_show_all_only = "no"
# if_only_developed = "yes" 
# 
# # these are for only all
# pointsize = 1
# linesize = 2
# textout =35
# textsize = 3
# show_mergercurve = "yes"
# slicetopn_of_nameindiv = 0
# if_calc_diversity = "no"
# naming = "230124_soytopics_only_cropbytopicdiversity"
# naming = "230124_cropbytopicdiversity_omitdenghai"
# naming = "230917_cropbytopicdiversity"
# 
# if_append_facetlabel_ggtitle= "no"
# 
# ylabdf = "Score"
# if_calc_max = "yes"
# if_show_all_only = "no"
# if_only_developed = "yes" 
# 
# # these are for only all
# pointsize = 1*2
# linesize = 2*2
# textout =40 
# textsize = 3*6
# show_mergercurve = "yes"
# slicetopn_of_nameindiv = 0
# if_calc_diversity = "no"
# naming = "230124_soytopics_only_cropbytopicdiversity"
# naming = "230124_cropbytopicdiversity_omitdenghai"
# naming = "230603_soytopics"

    if(is.numeric(sum_by_unique_or_quantity[1]))
    {
      quantity_to_cbind = sum_by_unique_or_quantity
    }
     if(!is.numeric(sum_by_unique_or_quantity[1]))
    {
      quantity_to_cbind = 1
    }

 innov_acq_df <-  innov_acq %>% 
   cbind(
     tibble(
       facetcol = innov_acq_facetcol
     ), 
          tibble(
       facetcol_indiv = innov_acq_facetcol_indiv
     ), 

       tibble(
       mainrow = innov_acq_mainrow
     ), 
       tibble(
       idcol = innov_acq_idcol
     ), 
       tibble(
       quantitycol = quantity_to_cbind
     )
   
   )
 ### if there is one label to use for crops, then lumps all crops and patent type
 if(nchar(innov_crops_to_use_label)>=2)
 {
   innov_acq_df <-  innov_acq_df%>%
     filter(
    crop %in%  innov_crops_to_use 
  ) %>% 
  mutate(
    # crop = "Canola, Corn, Cotton, Forage, Soybean, Wheat", 
    mainrow = innov_crops_to_use_label,
crop = innov_crops_to_use_label,
    patent_type = "IP"
  ) 
 }
innov_acq_df <-  innov_acq_df%>% 

   # filter(
   #   grepl("race, variety, biotype, plant, fly, hessian",  mainrow, perl = TRUE)
   # )%>%
   mutate(
     #likely finalname_colacquired/namepatent
     facetcol_indiv_final = paste0(facetcol,"_",facetcol_indiv) , 
     # as.Date(ISOdate(year, 12, 31)),
     ground_year_year=  as.Date(ISOdate(ground_year, 12, 31)),
     # by15 = parse_date_time(BeginTime, '%d/%m/%y %I:%M %p'),
    #  by15 = lubridate::year(round_date(ground_year_year, "5 years")), 
    # patentyear_by5 = lubridate::year(round_date( as.Date(paste(patent_year, 12, 31, sep = "-")), "5 years")), 
     by15 = ground_year_year,
     
    patentyear_by5 = as.Date(ISOdate(patent_year, 12, 31)),

    # patentyear_by5 = lubridate::as_date(paste(patent_year, 12, 31, sep = "-")),

     dev_or_passed = 
       case_when(
         by15 == patentyear_by5 ~ "Developed", 
         by15 != patentyear_by5 ~ "Passed"
       ), 
    dev_or_passed_firstletter = substr(dev_or_passed, 1,1) ,
     # acquired_or_originated = 
     #    case_when(
     #     name_standard_patent2 != col_acquirer_new ~ "Acquired", 
     #     name_standard_patent2 == col_acquirer_new ~ "Originated"
     #   ), 
    mainrow_x_dev_or_passed = paste0( mainrow, "_", dev_or_passed),
     #concat col_acuired/namestandard and year
     # column_by15 = paste0(  name_standard_patent2, "_", by15)#, # substr(colby15lab, 1,5)
     # column_by15label = paste0( column_by15, "_", by15)
     ) %>% 
   group_by(
     mainrow
   ) %>% 
   mutate(
     #calculates number in topic global across all years; gets used in title
     num_in_mainrow = bylinecalc_unique_score(idcol, quantitycol),
     num_in_mainrowip = length(unique(idcol))
   ) %>% 
   ungroup()%>% 
   mutate(
     total_num_in_universe =  bylinecalc_unique_score(idcol, quantitycol)
     # total_num_in_universe = length(unique(idcol))
   )%>% 
   group_by(
     mainrow, by15
   ) %>% 
   mutate(
     #calculates number in topic/crop/mainrow x year; gets used in calculating percentage
     num_in_mainrow_year = bylinecalc_unique_score(idcol, quantitycol), 
     mainrow_x_facetcol = paste0(mainrow, facetcol), 
     mainrow_x_facetcol_x_facetcol_indiv= paste0(mainrow_x_facetcol,facetcol_indiv )
     
     # num_in_mainrow_year = length(unique(idcol)), 
     # mainrow_x_facetcol = paste0(mainrow, facetcol), 
     #  mainrow_x_facetcol_x_facetcol_indiv= paste0(mainrow_x_facetcol,facetcol_indiv )
     # facetcol_indiv_final_mainrow_x_dev_or_passed = paste0(
     #   facetcol_indiv_final, mainrow_x_dev_or_passed
     # )
   ) %>% 
   group_by(
     by15
   ) %>% 
mutate(
  total_num_in_year = bylinecalc_unique_score(idcol, quantitycol)

# total_num_in_year = length(unique(idcol))
  )%>% 
   ungroup() %>% 
   group_by(mainrow_x_dev_or_passed) %>% 
   mutate(
   total_num_in_mainrow_x_dev_or_passed =bylinecalc_unique_score(idcol, quantitycol)
# 
#      total_num_in_mainrow_x_dev_or_passed = length(unique(idcol))
   )%>% 
   ungroup() %>% 
      group_by(mainrow_x_dev_or_passed, by15) %>% 
   mutate(
     total_num_in_mainrow_x_dev_or_passed_year= bylinecalc_unique_score(idcol, quantitycol)
     
     # total_num_in_mainrow_x_dev_or_passed_year= length(unique(idcol))
   )%>% 
   ungroup() 

 # innov_acq_df %>% 
 #   group_by(dev_or_passed) %>% 
 #   summarise(
 #     counter = length(unique(idcol))
 #   )
 
 currentcrops <- (innov_acq_df 
   # filter(
   #   crop %in% c(
   #     "corn",  "forage","soy", "wheat" 
   #   )
    # )
 )$crop %>% unique() %>% paste(collapse = ", ")
 #  
 # innov_acq_df_labelcol <- innov_acq_df %>% 
 #   group_by(
 #     by15
 #   ) %>% 
 #   filter(
 #     ground_year == min(ground_year)
 #   ) %>% 
 #   group_by(
 #     by15, mainrow, facetcol
 #   )

 
 # of each finalname, group together anything above top 5; call facet indiv "finalname_otherinventor"
 innov_acq_df_sum_top5_parent <-innov_acq_df %>% 
   group_by(
      mainrow,  mainrow_x_facetcol,facetcol
   ) %>% 
   #get totals for each facet in each row
      summarise(
       sumval_total_parents=  bylinecalc_unique_score(idcol, quantitycol)
        # sumval_total_parents = length(unique(idcol))
      ) %>% 
   ungroup() %>% 
       mutate(
      sumval_total_parents  = 
        case_when(
         facetcol == "name not found"  ~ 0,
           TRUE ~ sumval_total_parents
        )
    )%>% 

   # mutate(
   #   percent_parent_in_universe = round(100*(sumval_total_parents/total_num_in_universe),0), 
   #   percent_parent_in_mainrow = round(100*(sumval_total_parents/num_in_mainrow),0)
   # )%>% 
   group_by(
    mainrow
   )%>%
   arrange(
     -sumval_total_parents
   ) %>% 
   mutate(
     rownum_parent = row_number() 
   ) %>% 
      ungroup()  %>%
    mutate(
      label_parent =
        case_when(
          rownum_parent <= slicetopn_of_namefinal ~ paste0(
            paste0( 
              str_pad(rownum_parent, side = "left", pad = "0", width = nchar(max(slicetopn_of_namefinal))),
              facetcol 
              )
          ),
          TRUE ~ paste0( 
              # str_pad(rownum_parent, side = "left", pad = "0", width = nchar(max(rownum_parent))),
              "Other" 
              )
          )
    ) %>% 
   select(
     label_parent, mainrow, mainrow_x_facetcol,facetcol 
     ) %>% 
   distinct()#%>%
   # slice(1:slicetopn_of_namefinal) %>% 
   #    ungroup() 
  # innov_acq_df  %>% 
  #   filter(
  #       grepl("denghai", facetcol , ignore.case = TRUE, perl = TRUE)
  #   ) %>% 
  #   View()

 ## this is identifying top 5 parents per mainrow
  innov_acq_df_sum_top5_parent_per <-innov_acq_df %>% 
    left_join(
      innov_acq_df_sum_top5_parent, by = c("facetcol",
"mainrow", "mainrow_x_facetcol")
    ) %>% 
        group_by(
      label_parent, by15
    ) %>% 
    mutate(
       total_in_new_parentlabel_year=  bylinecalc_unique_score(idcol, quantitycol)
      
      # total_in_new_parentlabel_year = length(unique(idcol)) 
    ) %>% 
    ungroup() %>% 
     group_by(
      label_parent
    ) %>% 
    mutate(
       total_in_new_parentlabel=  bylinecalc_unique_score(idcol, quantitycol)
      
      # total_in_new_parentlabel = length(unique(idcol)) 
    ) %>% 
    ungroup() %>% 

        group_by(
      label_parent, by15, dev_or_passed
    ) %>% 
    mutate(
     total_in_new_parentlabel_year_devpass=  bylinecalc_unique_score(idcol, quantitycol)

      # total_in_new_parentlabel_year_devpass = length(unique(idcol)) 
    ) %>% 
    ungroup() %>% 
     group_by(
      label_parent,  dev_or_passed, mainrow
    ) %>% 
    mutate(
           total_in_new_parentlabel_devpass_mainrow=  bylinecalc_unique_score(idcol, quantitycol)

      # total_in_new_parentlabel_year_devpass_mainrow = length(unique(idcol)) 
    ) %>% 
    ungroup() %>% 
     group_by(
      label_parent, by15, mainrow
    ) %>% 
    mutate(
      total_in_new_parentlabel_year_mainrow=  bylinecalc_unique_score(idcol, quantitycol)

      # total_in_new_parentlabel_year_mainrow = length(unique(idcol)) 
    ) %>% 
    ungroup() %>% 

   mutate(
     
     percent_parent_in_universe = round(100*(total_in_new_parentlabel/total_num_in_universe),0), 
     # parent value in mainrow divided by total num in mainrow
     percent_parent_in_mainrow =
       round(100*(total_in_new_parentlabel_devpass_mainrow/num_in_mainrow),0), 
     percent_parent_in_mainrow_x_d_or_p = round(100*(total_in_new_parentlabel_devpass_mainrow/total_num_in_mainrow_x_dev_or_passed),0), 
     percent_in_mainrow_x_d_or_p_of_parent = round(100*(total_in_new_parentlabel_devpass_mainrow/total_in_new_parentlabel),0)


   )%>% 
     mutate(
      facetcol_finalparent = 
        paste0(
          label_parent#, " ",sigfig( total_in_new_parentlabel, num_sigfigs), " ", percent_parent_in_universe, "%t ",percent_parent_in_mainrow, "%r " , 
    #     percent_parent_in_mainrow_x_d_or_p, "%", dev_or_passed_firstletter, " ", 
    #     percent_in_mainrow_x_d_or_p_of_parent, "%", "pt", dev_or_passed_firstletter

        )
        # case_when(
        #   mainrow_x_facetcol %in% c( innov_acq_df_sum_top5_parent$mainrow_x_facetcol) ~ facetcol, 
        #   TRUE ~ "Other"
        # )
    ) %>% 
    # select( mainrow, facetcol_final, facetcol_indiv,mainrow_x_facetcol_x_facetcol_indiv,idcol, num_in_mainrow  ) %>% 
   group_by(
      mainrow,label_parent,facetcol_indiv #  facetcol_final, facetcol_indiv,mainrow_x_facetcol_x_facetcol_indiv,num_in_mainrow
   ) %>% 
   #get totals for each facet in each row
      mutate(
        sumval_total_parents_perinventor=  bylinecalc_unique_score(idcol, quantitycol)

        # sumval_total_parents_perinventor = length(unique(idcol)), 
      ) %>% 
    # slice(1) %>%
   ungroup() %>% 
  
   group_by(
    mainrow, label_parent
   )%>%
   arrange(
     -sumval_total_parents_perinventor
   ) %>% 
    mutate(
      rownum_parentper =
        cumsum(!duplicated(facetcol_indiv))
        #row_number()
    )%>%
      ungroup()%>%
       mutate(
         finalparent_child = 
            case_when(
             rownum_parentper <= slicetopn_of_nameindiv ~ facetcol_indiv, 
             TRUE ~  "OtherInventor"
               
               ),
         label_parentper_prefixnumber =
           case_when(
             rownum_parentper <= slicetopn_of_nameindiv ~ paste0(
               str_pad(rownum_parentper, width = nchar(slicetopn_of_nameindiv), pad = "0", side = "left"), 
               finalparent_child
             ),
             TRUE ~paste0(
              finalparent_child
             )
           )
       ) %>% 
    # mutate(
    #         facetcol_final_parent = facetcol_final
    # 
    # ) %>% 
    mutate(
      percent_sumval_total_parents_perinventor = 
        round(100*sumval_total_parents_perinventor/num_in_mainrow),
      label_parentper = paste0(
        facetcol_finalparent, "; ",label_parentper_prefixnumber
      )
        # case_when(
        #   rownum_parentper <= slicetopn_of_nameindiv ~ paste0(
        #     facetcol_final, "; ",label_parentper_prefixnumber
        #     # str_pad(rownum_parentper, width = nchar(slicetopn_of_namefinal), pad = "0", side = "left"), 
        #     # facetcol_indiv
        #   ),
        #   TRUE ~paste0(
        #     facetcol_final,"; ",label_parentper_prefixnumber # "OtherInventor"
        #   )
        # )
    )  %>% 
    group_by(
          mainrow, facetcol_finalparent
        ) %>% 
        mutate(
          sumval_parentper_mainrow = bylinecalc_unique_score(idcol, quantitycol)
        ) %>% 
        ungroup()
  
    innov_acq_df_sum_top5_parent_per_label <- 
 innov_acq_df_sum_top5_parent_per %>%
    group_by(
      label_parentper, dev_or_passed, mainrow
    ) %>% 
    mutate(
        num_new_facetindiv=  bylinecalc_unique_score(idcol, quantitycol)
      
      # num_new_facetindiv = length(unique(idcol ))
    ) %>% 
    ungroup() %>% 
       mutate(
     percent_facetindiv_in_universe = round(100*(num_new_facetindiv/total_num_in_universe),0), 
     percent_facetindiv_mainrow = round(100*(num_new_facetindiv/num_in_mainrow),0), 
     percent_facetindiv_mainrow_x_d_or_p = round(100*(num_new_facetindiv/total_num_in_mainrow_x_dev_or_passed),0),
     percent_facetindiv_ofparent = round(100*(num_new_facetindiv/total_in_new_parentlabel),0),
          percent_facetindiv_ofparent_mainrow_x_d_or_p = round(100*(num_new_facetindiv/total_in_new_parentlabel_devpass_mainrow),0)


   )%>% 
    #  group_by(
    #   mainrow
    # ) %>% 
    # arrange(
    #   -sumval_parentper_mainrow
    # ) %>% 
    # ungroup() %>% 
    #  group_by(
    #   mainrow, facetcol_final_parent
    # ) %>% 
    # mutate(
    #   nchar_facetcol_finalmax = nchar(max(cumsum(!duplicated( facetcol_final_parent)))),
    # 
    #   facetcol_final =  paste0(
    #    str_pad( cumsum(!duplicated( facetcol_final_parent)), width = nchar_facetcol_finalmax, side = "left", pad = "0"), 
    #    facetcol_final
    # )
    # ) %>% 
    # ungroup() #%>% 
    mutate(
      facetcol_final = 
        paste0(
          label_parentper#,  " ", sigfig(num_new_facetindiv,num_sigfigs), " ", percent_facetindiv_in_universe, "%t ",percent_facetindiv_mainrow, "%r " , 
         # percent_facetindiv_mainrow_x_d_or_p, "%", dev_or_passed_firstletter, " ", 
         # percent_facetindiv_ofparent, "%pt ", 
         # percent_facetindiv_ofparent_mainrow_x_d_or_p, "%pt", dev_or_passed_firstletter
        )
      )

  
  #  if(innov_if_include_agg == "yes")
  # {
     innov_acq_df_sum_top5_parent_per_agg <- innov_acq_df_sum_top5_parent_per %>%
       # bind_rows(
       #   innov_acq_df_sum_top5_parent_per %>%
       #     mutate(
       #      facetcol_indiv = "Sum", 
       #      facetcol = facetcol_finalparent,
       #     mainrow_x_facetcol = paste0(mainrow,facetcol_finalparent ),
       # 
       #      mainrow_x_facetcol_x_facetcol_indiv = paste0(mainrow_x_facetcol,facetcol_indiv )
       #     )
       # ) %>% 
       mutate(
         facetcol_final  =
            paste0(
               facetcol_finalparent, "; 0_All"
              ), 
         label_parentper= facetcol_final, 
         finalparent_child = "0_All"
       )
   # }
  # innov_acq_df_sum_top5_parent_per_agg %>% 
  #   select(
  #     mainrow_x_facetcol, everything()
  #   ) %>% 
  #   filter(
  #     facetcol_indiv == "Sum"
  #   ) %>% 
  #   View()
  
  
     #   innov_acq_df_sum_top5_parent_per %>% 
     # filter(
     #   grepl(pattern = "race, variety, biot",  mainrow_x_dev_or_passed )
     # ) %>% 
     # group_by(facetcol_final) %>% 
     # slice(1) %>% 
     # ungroup() %>% 
     #     select(facetcol_final) %>% 
     # View()

  
        # case_when(
        #   mainrow_x_facetcol %in% c( innov_acq_df_sum_top5_parent$mainrow_x_facetcol) ~ facetcol, 
        #   TRUE ~ "Other"
        # )
    
    ### double of above 
        # case_when(
        #   mainrow_x_facetcol %in% c( innov_acq_df_sum_top5_parent$mainrow_x_facetcol) ~ facetcol, 
        #   TRUE ~ "Other"
        # )
       

      innov_acq_df_sum <- innov_acq_df_sum_top5_parent_per_label %>% 
        # group_by(
        #   mainrow, facetcol_final_parent
        # ) %>% 
        # mutate(
        #   sumval_parentper_mainrow = bylinecalc_unique_score(idcol, quantitycol)
        # ) %>% 
        # ungroup() %>% 
        
   group_by(
     # finalname, theme or crop, dev or passed, year 
   crop,  facetcol_final,facetcol_finalparent, mainrow_x_dev_or_passed, by15, facetcol,facetcol_indiv, mainrow, mainrow_x_facetcol, mainrow_x_facetcol_x_facetcol_indiv,dev_or_passed_firstletter,patent_type,label_parentper,finalparent_child,label_parent,
     # quantities needed to produce percent
     total_num_in_year, total_num_in_universe, num_in_mainrow_year,num_in_mainrow,num_in_mainrowip,  total_num_in_mainrow_x_dev_or_passed,total_in_new_parentlabel_year, total_in_new_parentlabel_year_devpass, total_num_in_mainrow_x_dev_or_passed_year, 
     sumval_parentper_mainrow
   ) %>% 
reframe(
        sumval =bylinecalc_unique_score(idcol, quantitycol),
        num_ip = length(unique(idcol)),
        # likely label is the value label for point

        likely_label = paste(unique( col_acquirer_new))
      ) %>% 
      ungroup() %>% 
        mutate(
          likely_label = 
            case_when(
              facetcol_indiv == "Sum" ~ "Sum", 
              TRUE ~ likely_label
            )
        )
 #    
  
      
      innov_acq_df_sum_agg <- innov_acq_df_sum_top5_parent_per_agg %>% 
        # group_by(
        #   mainrow, facetcol_final_parent
        # ) %>% 
        # mutate(
        #   sumval_parentper_mainrow = bylinecalc_unique_score(idcol, quantitycol)
        # ) %>% 
        # ungroup() %>% 
        # 
   group_by(
     # finalname, theme or crop, dev or passed, year 
   crop,  facetcol_final,facetcol_finalparent, mainrow_x_dev_or_passed, by15, facetcol,facetcol_indiv, mainrow, mainrow_x_facetcol, mainrow_x_facetcol_x_facetcol_indiv,dev_or_passed_firstletter,patent_type,label_parentper,finalparent_child, label_parent,
     # quantities needed to produce percent
     total_num_in_year, total_num_in_universe, num_in_mainrow_year,num_in_mainrow,num_in_mainrowip,  total_num_in_mainrow_x_dev_or_passed,total_in_new_parentlabel_year, total_in_new_parentlabel_year_devpass, total_num_in_mainrow_x_dev_or_passed_year, 
     sumval_parentper_mainrow
   ) %>% 
reframe(
        sumval =bylinecalc_unique_score(idcol, quantitycol),
        num_ip = length(unique(idcol)),
        # likely label is the value label for point

        likely_label = paste(unique( col_acquirer_new))
      ) %>% 
      ungroup() %>% 
        mutate(
          likely_label = 
            case_when(
              facetcol_indiv == "Sum" ~ "Sum", 
              TRUE ~ likely_label
            )
        )
 #    
 innov_acq_df_sum_and_agg <- innov_acq_df_sum %>% 
   bind_rows(
     # this is equiv as above, but has all of them in one called ;All
     innov_acq_df_sum_agg 
)
 #    
 # if(!is.numeric(sum_by_unique_or_quantity[1]))
 # {
 #    innov_acq_df_sum <- innov_acq_df_sum_top5_parent_per %>% 
 #   group_by(
 #     # finalname, theme or crop, dev or passed, year 
 #     facetcol_final, mainrow_x_dev_or_passed,acquired_or_originated, by15, facetcol,facetcol_indiv, mainrow, mainrow_x_facetcol, mainrow_x_facetcol_x_facetcol_indiv,dev_or_passed_firstletter,patent_type,
 #     # quantities needed to produce percent
 #     total_num_in_year, total_num_in_universe, num_in_mainrow_year,num_in_mainrow, total_num_in_mainrow_x_dev_or_passed,total_in_new_parentlabel_year, total_in_new_parentlabel_year_devpass, total_num_in_mainrow_x_dev_or_passed_year
 #   ) %>% 
 #      summarise(
 #        sumval = length(unique(idcol)),
 #        num_ip = length(unique(idcol)),
 # 
 #        likely_label = paste(unique( col_acquirer_new))
 #      ) %>% 
 #      ungroup()
 # }
 # 
 #  if(is.numeric(sum_by_unique_or_quantity[1]))
 # {
 #    innov_acq_df_theme <- innov_acq_df_sum_top5_parent_per %>% 
 #      cbind(
 #        tibble(
 #          value_to_sum = sum_by_unique_or_quantity
 #        )
 #      )
 #    innov_acq_df_sum <- innov_acq_df_theme %>% 
 #   group_by(
 #     facetcol_final, mainrow_x_dev_or_passed,acquired_or_originated, by15, facetcol,facetcol_indiv, mainrow, mainrow_x_facetcol, mainrow_x_facetcol_x_facetcol_indiv,dev_or_passed_firstletter,patent_type,
 #     # quantities needed to produce percent
 #     total_num_in_year, total_num_in_universe, num_in_mainrow_year,num_in_mainrow, total_num_in_mainrow_x_dev_or_passed,total_in_new_parentlabel_year, total_in_new_parentlabel_year_devpass, total_num_in_mainrow_x_dev_or_passed_year
 #   ) %>% 
 #      summarise(
 #        num_ip = length(unique(idcol)),
 # 
 #        sumval = sum(value_to_sum, na.rm = TRUE),
 #        likely_label = paste(unique( col_acquirer_new))
 #      ) %>% 
 #      ungroup()
 #  }
  
     #%>% 
    # mutate(
    #   percent_num_new_facetindiv_mainrow = 
    #     round( 100*num_new_facetindiv/dd ), 
    #   percent_num_new_facetindiv_mainrow_x_dev = 
    # )
    
   # slice(1:slicetopn_of_namefinal) %>%
   #    ungroup()

  # below is relabeling and summing
  
  innov_acq_df_sum_relabelfacet_parent <- innov_acq_df_sum_and_agg %>% 
       
     mutate(
       patenttype_x_devpass = paste0( 
         gsub("patent", "Patent", patent_type)#,
         # "_", acquired_or_originated 
         ),
      patenttype_x_devpass_id = paste0( 
         patenttype_x_devpass,facetcol_final, facetcol_indiv
         # "_", acquired_or_originated 
         ),
      percent_ip_year =  round(100*sumval/total_num_in_year ), 
      # percent_ip_ofmainrow = round(100*sumval/num_in_mainrow_year ),
      percent_ip_ofmainrow_devpass_year = round(100*sumval/total_num_in_mainrow_x_dev_or_passed_year ), 
      percent_ip_ofparent_devpass_year=  round(100*sumval/total_in_new_parentlabel_year_devpass )
     ) %>% 
    group_by(
      facetcol_final,   mainrow_x_dev_or_passed, facetcol_indiv, by15
    ) %>% 
    mutate(
      likely_label_concat = paste( unique(likely_label), collapse = ", ")
    ) %>% 
    ungroup() %>% 
    mutate(
      valuelabel = paste0(
        lubridate::year(by15), ": ", likely_label_concat,"-", facetcol_indiv, ": ",   round(sumval, 1 ), "sum ", 
        num_ip, "ip ",
        #percent of year
        percent_ip_year,"%y ",
        #percent of theme dev or pass in year
        percent_ip_ofmainrow_devpass_year, "%y",  dev_or_passed_firstletter, " ",
         #percent of parents' dev or pass in year
        percent_ip_ofparent_devpass_year, "%ypt"
      ), 
      valuelabel =  str_squish(
        gsub(
        " 0%[a-zA-Z]+| 0%[a-zA-Z]+;| NaN%[a-zA-Z]+;| NaN%[a-zA-Z]+","", valuelabel
      )
      ),
      facetcol_final = str_squish(
        gsub(
        " 0%[a-zA-Z]+| 0%[a-zA-Z]+;| NaN%[a-zA-Z]+;| NaN%[a-zA-Z]+","", facetcol_final
      )
    )
      )  %>% 
    group_by(
      facetcol_final,   mainrow_x_dev_or_passed
    ) %>%
    mutate(
      # totalrange
      totalrange = abs(max(sumval) - min(sumval)),
      range_y_max = totalrange*.4+max(sumval),
      range_y_max_textstart = totalrange*.2+max(sumval),
      range_y_min = 0 - totalrange*.6,
      range_y_min_textstart= 0 - totalrange*.5

    ) %>%
    ungroup() %>%
    group_by(
     facetcol, facetcol_final,   mainrow_x_dev_or_passed, valuelabel, facetcol_indiv
    ) %>% 
    slice(1) %>% 
    ungroup() %>% 
    # arrange(
    #   dev_or_passed_firstletter, num_in_mainrow
    # ) %>% 
    mutate(
      # nchar_mainrowmax = nchar(max(cumsum(!duplicated( mainrow)))),
      mainrow_x_dev_or_passed = paste0(
        # str_pad( cumsum(!duplicated( mainrow)), width = nchar_mainrowmax, side = "left", pad = "0"), 
        mainrow_x_dev_or_passed, " ", round(num_in_mainrow,0), "s ", num_in_mainrowip, "ip"
      )
    ) %>% 
    ungroup()%>% 
       mutate(
         facetcol_final = paste0(
           mainrow_x_dev_or_passed, "_", 
           facetcol_final
         )
       )
  # innov_acq_df_sum_relabelfacet_parent %>% 
  #   filter(
  #     grepl("denghai", facetcol_final, ignore.case = TRUE, perl = TRUE)
  #   ) %>% 
  #   View()
  
  #     if(if_append_facetlabel_ggtitle != "no")
  # {
  #    innov_acq_df_sum_relabelfacet_parent <- innov_acq_df_sum_relabelfacet_parent %>% 
  #      mutate(
  #        facetcol_final = paste0(
  #          mainrow_x_dev_or_passed, "_", 
  #          facetcol_final
  #        )
  #      )
  # }

  # 
  # innov_acq_df_sum_relabelfacet_parent_notsum <- innov_acq_df_sum_relabelfacet_parent #%>% 
    # mutate(
    #   valuelabel = 
    #     case_when(
    #       grepl(
    #     "; 0_All", facetcol_final, perl = TRUE
    #   ) ~ "", 
    #   TRUE ~valuelabel 
    #     )
    # )
    # filter(
    #   facetcol_indiv != "Sum"
    # )

  # parent_sum calculates the total per pvp or patent in each panel; this gets rep as black line
  innov_acq_df_sum_relabelfacet_parent_sum <- innov_acq_df_sum_relabelfacet_parent %>% 
    # filter(
    #   grepl(
    #     "; 0_All", facetcol_final, perl = TRUE
    #   )
    #   # facetcol_final  =
    #   #       paste0(
    #   #          facetcol_finalparent, "; 0_All"
    # ) %>% 
    group_by(
      by15, facetcol_final,facetcol_finalparent,   mainrow_x_dev_or_passed, patenttype_x_devpass, total_num_in_year, total_num_in_mainrow_x_dev_or_passed_year, total_in_new_parentlabel_year_devpass,dev_or_passed_firstletter
    ) %>% 
    reframe(
      sumval = sum(sumval, na.rm = TRUE),
      num_ip = sum(num_ip, na.rm = TRUE)
    ) %>% 
    ungroup() %>% 
    mutate(
      percent_ip_year =  round(100*sumval/total_num_in_year ), 
      # percent_ip_ofmainrow = round(100*sumval/num_in_mainrow_year ),
      percent_ip_ofmainrow_devpass_year = round(100*sumval/total_num_in_mainrow_x_dev_or_passed_year ), 
      percent_ip_ofparent_devpass_year=  round(100*sumval/total_in_new_parentlabel_year_devpass ),
      valuelabel = paste0(
        lubridate::year(by15)," ",  patenttype_x_devpass,": ", facetcol_final, " Sum: " ,sumval, "s ", 
        num_ip, "ip ",
        #percent of year
        percent_ip_year,"%y ",
        #percent of theme dev or pass in year
        percent_ip_ofmainrow_devpass_year, "%y",  dev_or_passed_firstletter, " ",
        #percent of parents' dev or pass in year
        percent_ip_ofparent_devpass_year, "%ypt"
      )
    )

  
    #   facetcol_# arrange(final, mainrow_x_dev_or_passed
    # )
    if( if_calc_max == "yes")
    {
 innov_acq_df_sum_relabelfacet_parent_sum_spline <- innov_acq_df_sum_relabelfacet_parent_sum %>%     
   mutate(
     groupallby = paste(facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass, sep = "<" )
   ) %>% 
   calc_spline_func(q =. ,spline_col_year = .$by15 , spline_col_value = .$sumval, spline_col_groupby = .$groupallby, if_writeout = "no") 
 
 ### take a look at crossing https://stackoverflow.com/questions/60374355/all-combinations-crossing-by-group 
 
 innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme <- innov_acq_df_sum_relabelfacet_parent_sum_spline %>% 
   mutate(
     x = as.numeric(x)
   ) %>% 
   locate_xtrem_loop(., whichcolisgroupby =.$currentgroupby ) %>% 
   rename(
     by15 = year,
     sumval = y
   ) %>% 
   separate(
     data = ., col = currentgroupby, into = c("facetcol_final", "mainrow_x_dev_or_passed", "patenttype_x_devpass"), sep = "<"
   )
 
  # innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_lines_high <- innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme %>% 
  #  filter(
  #    !is.na(sumval),
  #    low_or_peak == "peak"
  #  ) 
  #  innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_lines_low <- innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme %>% 
  #  filter(
  #    !is.na(sumval),
  #    low_or_peak == "low"
  #  ) 

 innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high <- innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme %>% 
   filter(
     !is.na(sumval),
     low_or_peak == "peak"
   ) %>% 
   group_by(
     facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass
   ) %>%                         
   arrange(
     by15, colgroupby
   ) %>% 
   mutate(
     yearyear = year(by15),
     years_span_withprev = year(by15) - year(lag(by15)),
     yearlow = lag(by15)
    
   ) %>% 
   ungroup() %>% #%>% 
   filter(
     !is.na(years_span_withprev ),
     years_span_withprev >= 3, 
          years_span_withprev <= 30

   )   %>% 
   # the purpose of this is 
   separate(
     data = ., col = facetcol_final, into = c("crop", "dev_or_passed", "facetcol", "all_or_not"), sep = "_", remove = FALSE
   ) #%>% 
     # mutate(
     #   facetcol = str_squish(gsub(";.*", "", facetcol, perl = TRUE))
     # )   
  
  innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high_sep_assignall<-
    innov_acq_df_sum_relabelfacet_parent_sum %>% 
              # first grab correct facetcol final name
    # select(
    #   facetcol_final
    # ) %>% 
   separate(
     data = ., col = facetcol_final, into = c("crop", "dev_or_passed", "facetcol", "all_or_not"), sep = "_", remove = FALSE
   ) %>% 
     filter(
       !is.na(all_or_not)
     ) %>% 
     # mutate(
     #   facetcol = str_squish(gsub(";.*", "", facetcol, perl = TRUE))
     # )  %>%
# innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high_sep %>% 
     select(
     facetcol_final,  facetcol, crop, mainrow_x_dev_or_passed, patenttype_x_devpass
     ) %>% 
     group_by(
     facetcol_final,    facetcol, crop, mainrow_x_dev_or_passed, patenttype_x_devpass
     ) %>% 
     slice(1) %>% 
     ungroup() %>% 
    # first grab correct facetcol final name
    
     left_join(
       innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high %>% 
     # filter(
     #   is.na(all_or_not)
     # ) %>%
       select(
         facetcol, crop, mainrow_x_dev_or_passed, patenttype_x_devpass,by15, low_or_peak:yearlow, x, sumval
       ) %>% 
       distinct(), 
     by = c("facetcol",
"crop", "mainrow_x_dev_or_passed",
"patenttype_x_devpass")
     ) %>% 
    distinct() %>% 
    filter(
      !is.na(by15)
    )
      
 innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high_allrows <-
   # first those that are not "all"
   innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high%>% 
     filter(
       is.na(all_or_not)
     )  %>% 
   select(
    facetcol_final, facetcol, crop, mainrow_x_dev_or_passed, patenttype_x_devpass,by15, low_or_peak:yearlow
   ) %>% 
   mutate(
     all_or_not = "no"
   )%>% 
   #second those that are all reassigned
   bind_rows(
     innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high_sep_assignall %>% 
   select(
    facetcol_final, facetcol, crop, mainrow_x_dev_or_passed, patenttype_x_devpass,by15, low_or_peak:yearlow
   )%>% 
   mutate(
     all_or_not = "total"
   )
   ) %>% 
   distinct()%>% 
   left_join(
     innov_acq_df_sum_relabelfacet_parent %>% 
       select(
         facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass, range_y_max, range_y_min
       ) %>% 
       distinct()
   ) %>% 
   mutate(
     yearmed = 
       as.Date(ISOdate(as.integer((year(yearlow)+year(by15))/2)  , 12, 31)), 
     year_errobars = (range_y_max -range_y_min)*.08
     # y_to_use = 
     #   case_when(
     #     
    ) %>% 
  group_by(
     facetcol_final, mainrow_x_dev_or_passed 
   ) %>% 
   mutate(
     y_to_use = 
       case_when(
         (row_number())%%3 ==1 ~ jitter(range_y_max+2*year_errobars), 
       (row_number())%%3 ==2~ jitter(range_y_max+3*year_errobars), 
           
     TRUE ~ jitter(range_y_max + year_errobars)
   )
   ) %>% 
   ungroup() %>% 
   filter(
     (years_span_withprev >= 10)&(years_span_withprev <=25)
   ) %>% 
   mutate(
     inventor = 
       case_when(
        grepl(";", facetcol_final, perl = TRUE)~ gsub(".*;", "", facetcol_final)
         ), 
     inventor = gsub("%.*", "", inventor ), 
     inventor = str_squish(gsub("(\\d+)|\\.|_", "", str_squish( inventor)))
   ) 

# innov_acq_df_sum_relabelfacet_parent_allspline <- innov_acq_df_sum_relabelfacet_parent %>% 
#    filter(
#      dev_or_passed_firstletter == "D",
#       grepl(
#         "; 0_All", facetcol_final, perl = TRUE
#       )
#       # facetcol_final  =
#       #       paste0(
#       #          facetcol_finalparent, "; 0_All"
#     ) %>% 
#     group_by(
#       by15, facetcol , facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass
#     ) %>% 
#     summarise(
#       sumval = sum(sumval, na.rm = TRUE),
#       num_ip = sum(num_ip, na.rm = TRUE)
#     ) %>% 
#     ungroup() %>%
#   group_by(
#      facetcol , facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass
#     ) %>% 
#   filter(
#     length(unique(by15)) >=4
#   ) %>% 
#   ungroup() %>% 
#   mutate(
#      groupallby = paste(facetcol, facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass, sep = "<" )
#    ) %>% 
#    calc_spline_func(q =. ,spline_col_year = .$by15 , spline_col_value = .$sumval, spline_col_groupby = .$groupallby, if_writeout = "no") 
#  
#  innov_acq_df_sum_relabelfacet_parent_allspline_extreme <- innov_acq_df_sum_relabelfacet_parent_allspline %>% 
#    locate_xtrem_loop(., whichcolisgroupby =.$currentgroupby ) %>% 
#    rename(
#       by15 = year,
#       sumval = y
#    ) %>% 
#    separate(
#      data = ., col = currentgroupby, into = c("facetcol", "facetcol_final", "mainrow_x_dev_or_passed", "patenttype_x_devpass"), sep = "<"
#    ) %>% 
#    filter(
#      low_or_peak == "peak"
#    ) %>% 
#    group_by(
#     facetcol, facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass
#    ) %>% 
#    arrange(
#      by15
#    ) %>% 
#    mutate(
#      years_span_withprev = year(by15) - year(lag(by15))
#    ) %>% 
#    ungroup() #%>% 
#   
#  innov_acq_df_sum_relabelfacet_parent_allspline_extreme_letters <- innov_acq_df_sum_relabelfacet_parent_allspline_extreme %>% 
#    filter(!is.na(years_span_withprev)) %>% 
# calc_emmeansfunc(emmeansdf =., emmeans_valuecol=.$sumval , emmeans_group_within_col = .$mainrow_x_dev_or_passed, emmeans_groupcol = .$patenttype_x_devpass, emmeans_comparisoncol = .$facetcol) 
 
 
    }
  
  
  innov_acq_df_sum_relabelfacet_parent_blanklabel <- innov_acq_df_sum_relabelfacet_parent %>% 
    group_by(facetcol_final,   mainrow_x_dev_or_passed, range_y_max, range_y_min) %>% 
    slice(1) %>% 
    ungroup() %>% 
    mutate(
      blanklabel = ""
    )
    # slice(1) %>% 
    # ungroup() 
  
  set.seed(123)
  innov_acq_df_sum_relabelfacet_parent_labels_only <- innov_acq_df_sum_relabelfacet_parent%>% 
    arrange(runif(n())) %>% # randomize the order

   group_by(
     facetcol_final, mainrow_x_dev_or_passed, patenttype_x_devpass, likely_label
   ) %>% 
   mutate(
     #should be mutually exclusive
     sumval_median = as.numeric(sigfig(median(sumval, na.rm = TRUE),2)), 
     sumval_numpatents = round(median(num_ip, na.rm = TRUE),0)
    
     # num_years = length(unique(by15))
   ) %>% 
   slice(1) %>% 
   ungroup()  %>%
   mutate(
     label_mids = paste0(
       likely_label, " ", sumval_median, "s ", sumval_numpatents, "i"
     )
   )%>% # randomize the order
   ungroup() #%>% 
  #  select(
  # #   col_factor,
  #    by15, sumval, label_mids, facetcol_final, mainrow_x_dev_or_passed
  #  )
     
    # mutate(
    #   facetcol_final = 
    #     case_when(
    #       mainrow_x_facetcol %in% c( innov_acq_df_sum_top5_parent$mainrow_x_facetcol) ~ facetcol, 
    #       TRUE ~ "Other"
    #     ), 
    #   facetcol_indiv_final = 
    #      case_when(
    #       mainrow_x_facetcol_x_facetcol_indiv %in% c( innov_acq_df_sum_top5_parent_per$mainrow_x_facetcol_x_facetcol_indiv) ~ paste0(
    #         facetcol_final, "_", facetcol_indiv
    #       ), 
    #       TRUE ~ paste0( facetcol_final, "_", "OtherInventor")
    #     )
    #   
    #     
    # ) 

  ##### now pull in mergers ##### 
  innov_acq_df_sum_relabelfacet_parent_merger <- sendthroughmergers_LU_reduce2  %>%
  filter(
    col_crop %in%  
      innov_crops_to_use
       # c("soybean", "corn", "cotton", "wheat", "forage", "canola" )
   
  ) %>% 
  mutate(
    crop = innov_crops_to_use_label
    # crop = "Canola, Corn, Cotton, Forage, Soybean, Wheat"
  )%>% 
    filter(
      crop %in% c(innov_acq_df$crop %>% unique() )
    ) %>% 
   func_find_maxyear_name( 
    findmaxyear_df =., 
    findmaxyear_yearcol = .$ground_year,
    findmaxyear_firmnamecol = .$col_acquired,
    findmaxyear_firmname_changetocol = .$col_acquirer_new,
    findmaxyear_idcol = .$col_id_new
    ) %>% 
    # find_finalcofunc_simple(x=., passidcol=.$col_id_new, passacqcol = .$col_acquirer_new) %>% 
    group_by(
      col_acquirer_new, col_acquired, old_acquirer, finalname
    ) %>% 
    filter(
      ground_year == min(ground_year)
    ) %>% 
    ungroup() %>% 
    mutate(
      by15 = as.Date(ISOdate(ground_year, 12, 31)), 
      #as.Date(paste(as.numeric(ground_year), 12, 31, sep = "-")), 
      ### originally was below commented; changed to 
      # mergerlabel = gsub(";.*", "", old_acquirer)
      mergerlabel = paste0(ground_year, "-", col_acquirer_new, "-", col_acquired)

    )
  
  innov_acq_df_sum_relabelfacet_parent_mergerlines <- innov_acq_df_sum_relabelfacet_parent_merger  %>% 
    inner_join(
      innov_acq_df_sum_relabelfacet_parent %>% 
        select(
          facetcol, facetcol_indiv, mainrow_x_dev_or_passed, facetcol_final, range_y_max_textstart
        ) %>% 
        distinct(), 
      by = c("finalname" = "facetcol", "col_acquired" = "facetcol_indiv" )
      ) %>% 
    bind_rows(
      innov_acq_df_sum_relabelfacet_parent_merger  %>% 
    inner_join(
      innov_acq_df_sum_relabelfacet_parent %>% 
        select(
          facetcol, facetcol_indiv, mainrow_x_dev_or_passed, facetcol_final, range_y_max_textstart, crop
        ) %>% 
        distinct(), 
      by = c("finalname" = "facetcol", "col_acquirer_new" = "facetcol_indiv", "crop" = "crop" )
      ) 
    ) %>% 
    group_by(
       facetcol_final, by15, mainrow_x_dev_or_passed,range_y_max_textstart, crop
    ) %>% 
    summarise(
      mergerlabel = paste(unique(mergerlabel), collapse = "; ")
    ) %>% 
    ungroup()
   
  #### quantify # patents that have been passeddown
  # if(show_mergercurve == "yes")
  # {
   innov_merger_join  <-  innov_acq_df_sum_relabelfacet_parent_merger  %>% 
    inner_join(
      innov_acq_df_sum_relabelfacet_parent %>% 
        select(
          facetcol, facetcol_indiv, mainrow_x_dev_or_passed, facetcol_final, range_y_max_textstart, mainrow,
          crop,
          by15, sumval, patent_type, finalparent_child,label_parent
        ) %>% 
        distinct(), 
      by = c("finalname" = "facetcol", "col_acquired" = "facetcol_indiv",
             "crop" = "crop" ,
             "by15")
      ) %>% 
     mutate(
       merger_occurred = paste0( col_acquirer_new, "-", col_acquired )
     )
  innov_merger_joinLU <- innov_merger_join  %>% 
    group_by( by15) %>% 
    mutate(
      total_mergers_year = length(unique(merger_occurred))
    ) %>% 
    ungroup() %>% 
    group_by( by15, mainrow)  %>% 
    mutate(
      total_mergers_year_mainrow = length(unique(merger_occurred))
    ) %>% 
    ungroup() %>% 
    #  group_by( by15, label_parent )  %>% 
    # mutate(
    #   total_mergers_year_grand_parent = length(unique(merger_occurred))
    # ) %>% 
    # ungroup() %>% 
  
    
    group_by(label_parent, finalparent_child,finalname,col_acquired, by15, patent_type, 
             # crop
             crop, 
             mainrow, merger_occurred, 
             total_mergers_year, 
             total_mergers_year_mainrow#,
             # total_mergers_year_grand_parent
             ) %>% 
    summarise(
      sumtotal_mergers = sum(sumval, na.rm = TRUE)
    ) %>% 
    ungroup()
  
    innov_merger_joinLU_parent <- innov_merger_join  %>% 
    group_by( by15,col_acquirer_new , label_parent, finalname) %>% 
    summarise(
      total_mergers_year_col_acquirer_new = length(unique(merger_occurred)), 
      year_parent_merger_occurred = paste(
        unique(merger_occurred), 
        collapse = ", "
      )
    ) %>% 
    ungroup()
  
  # innov_merger_joinLU %>% 
  #   filter(
  #     
  #   )
#     innov_merger_curve_pre%>% 
#     filter(
# grepl("chemchina", facetcol, ignore.case = TRUE, perl = TRUE), 
# crop == "corn"
#     ) %>% 
#       View()
#     
#     innov_merger_curve%>% 
#     filter(
# grepl("chemchina", label_parent, ignore.case = TRUE, perl = TRUE),
# crop_type == "soy",
# grepl("all", facetcol_final, ignore.case = TRUE, perl = TRUE), 
# 
#     ) %>% 
#       View()
  
#    
# this basically joins to itself with gap years filled with 0 
 innov_merger_curveLU_pre <- innov_merger_joinLU %>% 
  select(
    label_parent, finalparent_child,mainrow, crop,by15
  ) %>%
   distinct() %>% 
  mutate(
    by15 = year(by15)
  ) %>% 
  group_by(label_parent, finalparent_child,mainrow, crop ) %>% 
  mutate(
    min_year = min(by15, na.rm = TRUE), 
    max_year = max(by15, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
    group_by(label_parent, finalparent_child,mainrow, crop, min_year, max_year) %>%
  slice(1) %>% 
  mutate(
    numyearrep = max_year-min_year+1
  ) %>% 
  # ungroup() %>% 
   slice(rep(row_number(), numyearrep)) %>% 
  # group_by(
  #   
  # ))
  mutate(
    by15 =as.Date(ISOdate((min_year + row_number()-1), 12, 31)) 
  ) %>% 
  ungroup() %>% 
  select(
    label_parent, finalparent_child,mainrow, crop ,by15
  ) %>%
  anti_join(
    innov_merger_joinLU , by = c("label_parent",
"finalparent_child", "mainrow",
"crop", "by15")#, 
#  by = c("mainrow", "by15", "patent_type", "finalname", "col_acquired", "crop_type")
  ) %>% 
   mutate(
     sumtotal_mergers = 0, 
     # this is just to make the LU not have NA
     patent_type = "IP"
   ) %>% 
    bind_rows(
      innov_merger_joinLU
    ) %>% 
  mutate(
    labelmerger = 
      case_when(
        sumtotal_mergers == 0 ~paste0("0"), 
        TRUE ~ paste0( patent_type, ": ", addUnits(sumtotal_mergers))
      )
  ) 
   
 
 # this gets one sum for all patent types
innov_merger_curve_LUsum <- innov_merger_curveLU_pre%>% 
  
   group_by(
    label_parent, finalparent_child, by15, crop, mainrow, merger_occurred, patent_type
   ) %>% 
   summarise(
     labelmerger_pass_and_dev = paste(labelmerger%>% unique() %>% sort(), collapse = "; " ),
     sumtotal_mergers_pass_and_dev = sum(sumtotal_mergers, na.rm = TRUE)#, 
     # merger_occurred_pass_and_dev = paste(merger_occurred%>% unique() %>% sort(), collapse = "; " )
   ) %>%
   ungroup() %>% 

  mutate(
    labelmerger_pass_and_dev =
      case_when(
        sumtotal_mergers_pass_and_dev >0 ~ 
        paste0(merger_occurred, " (", labelmerger_pass_and_dev ,")"), 
        TRUE ~ paste0("0")
      )
  ) %>% 
   group_by(
    label_parent, finalparent_child, by15, crop, mainrow, patent_type
   ) %>% 
 summarise(
   labelmerger_pass_and_dev = paste(labelmerger_pass_and_dev%>% unique() %>% sort(), collapse = "; " ), 
   sumtotal_mergers_pass_and_dev= sum(sumtotal_mergers_pass_and_dev), 
   list_merger_occurred =  paste(merger_occurred%>% unique() %>% sort(), collapse = "; " )
 ) %>% 
  ungroup() %>% 
  left_join(
    innov_merger_joinLU %>% 
      select(
       # label_parent, 
       mainrow, by15, total_mergers_year, total_mergers_year_mainrow  ,
       patent_type
       # total_mergers_year_grand_parent
      ) %>% 
      distinct(),
    by = c(
     # "label_parent",
           "mainrow", "by15", "patent_type")
  ) %>% 
  mutate(
  labelmerger_pass_and_dev = 
    case_when(
        sumtotal_mergers_pass_and_dev >0 ~ paste0( year(by15), " ",  sumtotal_mergers_pass_and_dev, "t ", ": ",labelmerger_pass_and_dev  )  , 
  TRUE ~paste0( year(by15), ": 0")
  )
  ) %>% 
  mutate(
    # mergers_year_mainrow = coalesce()
    labelmerger_pass_and_dev = paste0 (
      # y means that was the total number of mergers that happened for parent in that year; r means that was total number of mergers for parent in year for that row eg by crop
      labelmerger_pass_and_dev, " (", total_mergers_year, "y ",total_mergers_year_mainrow, "r)" 
    )
    
  )

# innov_merger_curve_mergercount <-  innov_merger_curve_LUsum

innov_merger_curve <-  innov_merger_curve_LUsum %>%   
  left_join(
    innov_merger_join  %>% 
      select(
        label_parent, finalparent_child, crop, mainrow, facetcol_final, mainrow_x_dev_or_passed, range_y_max_textstart, patent_type
      ) %>% 
      distinct()#, 
     # by = c("facetcol", "crop")
  ) %>% 
  group_by(
    facetcol_final,mainrow_x_dev_or_passed , crop
  ) %>% 
  mutate(
    scale_sumtotal_mergers = sumtotal_mergers_pass_and_dev

    # scale_sumtotal_mergers = range01(sumtotal_mergers_pass_and_dev)
  ) %>% 
   ungroup() %>% 
  mutate(
    labelmerger_pass_and_dev = gsub("NAy|NAr|\\(NAy NAr\\)", "",labelmerger_pass_and_dev )
  ) %>% 
  # left_join(
  #   innov_merger_joinLU_parent, 
  #   by = c("by15", "col_acquirer_new")
  # ) %>% 
   mutate(
    ylabel_merger_scale = scale_sumtotal_mergers,
      # case_when(
      #   sumtotal_mergers_pass_and_dev == 0 ~ range_y_max_textstart, 
      #   ((sumtotal_mergers_pass_and_dev > 0) & ((scale_sumtotal_mergers == NaN))) ~  range_y_max_textstart,
      #   ((sumtotal_mergers_pass_and_dev > 0) & ((scale_sumtotal_mergers >0))) ~ (scale_sumtotal_mergers*(range_y_max_textstart) + range_y_max_textstart), 
      #   TRUE ~ range_y_max_textstart
      # ), 
    patent_typecolor = patent_type
  # patent_typecolor = "Merger_IP_acquired"
# patent_typecolor = d
  )

innov_merger_curve_mergercount <-  innov_merger_curve %>% 
  select(
    by15, label_parent, mainrow_x_dev_or_passed, facetcol_final
  ) %>% 
  distinct() %>% 
  left_join(
    innov_merger_joinLU_parent
  ) %>% 
  mutate(
    patent_typecolor = "Mergers_total"

  )
 
   ### this takes parents and then calculates total per dev or pass; this is base which a summary is calculated by mainrow then joined to this base
  # this gets the sum per facet
# innov_merger_curve_pre <- innov_merger_curveLU_pre %>% 
#   left_join(
#     innov_acq_df_sum_relabelfacet_parent, 
#     by = c("")
#     )%>%
#   inner_join(
#     innov_merger_curveLU_pre,
#     by = c("label_parent","finalparent_child" ,
#            "by15",
#            "crop" = "crop_type", "mainrow",
# 
#            "patent_type")
#   ) %>%
#   group_by(
#   facetcol,  facetcol_final, by15, mainrow_x_dev_or_passed,range_y_max_textstart,
#   crop,
#   patent_type, mainrow
#   ) %>%
#   summarise(
#     sumtotal_mergers = sum(sumtotal_mergers, na.rm = TRUE)
#   ) %>%
#   ungroup() %>% 
#   mutate(
#     labelmerger = paste0( patent_type, ": ", addUnits(sumtotal_mergers))
#   )
# 


  
  # innov_merger_sum <- innov_acq_df_sum_relabelfacet_parent_merger  %>% 
  #   inner_join(
  #     innov_acq_df_sum_relabelfacet_parent %>% 
  #       filter(
  #         dev_or_passed_firstletter == "P"
  #       ) %>% 
  #       select(
  #         facetcol, facetcol_indiv, mainrow_x_dev_or_passed, facetcol_final, range_y_max_textstart, crop
  #       ) %>% 
  #       distinct(), 
  #     by = c("finalname" = "facetcol", "col_acquired" = "facetcol_indiv", "crop_type" = "crop" )
  #     )  
  # }
    #%>% 
    # group_by(
    #   mainrow_x_dev_or_passed, facetcol_final
    # ) %>% 
    # mutate(
    #   uniformxmin = min(sumval)
    # )
  # innov_acq_df_sum_relabelfacet_parent %>% 
  #   filter(
  #     
  #     
  #   )
  
  ##### if calculate diversity
  if(if_calc_diversity == "yes")
  {
    innov_combined_diversityjoin <-innov_acq_df_sum_relabelfacet_parent %>%  
      select(
        label_parent, finalparent_child,facetcol,facetcol_indiv, 
             # crop
             crop, 
             mainrow
        )  %>% 
      distinct() %>% 
      inner_join(
        combined_pvp_patent_doc_wheat_unique_topics_id_wcos %>% 
          select(
            finalname, crop, patent_year, name_standard_patent2 ,topictheme, gamma, patent_number , patent_type
          ) %>% 
          distinct(), 
        by = c("crop" = "crop", "facetcol" = "finalname", "facetcol_indiv" = "name_standard_patent2")
      )
  innov_combined_diversitysum <-innov_combined_diversityjoin %>% 
  select(
    label_parent, finalparent_child,mainrow, crop,patent_year, topictheme, gamma, patent_type
  )  %>% 
      group_by(
        label_parent, finalparent_child,mainrow, crop,patent_year, topictheme , patent_type
      ) %>%
  summarise(
   
        topictheme_yearsum = sum(gamma, na.rm = TRUE)
      ) %>%
      ungroup()%>% 
      group_by(
        label_parent, finalparent_child,mainrow, crop, topictheme, patent_type
      ) %>%
      mutate(
       topictheme_max = max(topictheme_yearsum,na.rm = TRUE)
      ) %>%
     ungroup()%>% 
     #  group_by(
     #    label_parent, finalparent_child,mainrow, crop,topictheme
     #  ) %>%
     #  mutate(
     #   topictheme_max = max(topictheme_yearsum)
     #  ) %>%
     # ungroup()%>% 
      # group_by(
      #   label_parent, finalparent_child,mainrow, crop,topictheme, patent_type
      # ) %>%
      # mutate(
      #  topictheme_max_patent = max(topictheme_yearsum)
      # ) %>%
    mutate(
      topictheme_year_divided_max = topictheme_yearsum/topictheme_max
    ) %>% 
    #   mutate(
    #   label_diversity_year = paste0(patent_type, ": ",topictheme_yearsum )
    # )%>% 
    # 
    #   ungroup() %>% 
     group_by(
        label_parent, finalparent_child,mainrow, crop,patent_year, patent_type
      ) %>%
    summarise(
      year_diversityscore_perpatent = sum(topictheme_year_divided_max, na.rm = TRUE)
    ) %>% 
    ungroup() %>% 
    group_by(
        label_parent, finalparent_child,mainrow, crop,patent_type
      ) %>%
    mutate(
      year_diversityscore_perpatent_max = max(year_diversityscore_perpatent, na.rm = TRUE)
    ) %>% 
    ungroup() %>% 
    mutate(
      percent_patenttype_diversityscore = year_diversityscore_perpatent/year_diversityscore_perpatent_max,
        label_diversity_year = paste0( "(", patent_type, " ",round(year_diversityscore_perpatent, 1) , " ", round( (100*percent_patenttype_diversityscore), 0),"%m)"), 
        #below is needed to calc index:  sum of (1+ Sum of scores for PVP) x (1 + scores for patent)
        year_diversityscore_perpatent = percent_patenttype_diversityscore+ 1
      ) %>%
   group_by(
        label_parent, finalparent_child,mainrow, crop, patent_year
      ) %>%
    summarise(
      diversity = prod(year_diversityscore_perpatent, na.rm = TRUE),
      label_diversity_year = paste(unique(label_diversity_year), collapse = "; ")#, 

        # topictheme_diversityscore = topictheme_yearsum/topictheme_max, 
        # topictheme_diversityscore_patent = topictheme_max_patent
      ) %>% 
    ungroup() %>% 
    group_by(
        label_parent, finalparent_child,mainrow, crop
      ) %>%
    mutate(
      max_diversity = max(diversity )
    ) %>% 
    ungroup() %>% 
    mutate(
      percent_max_diversity = diversity/max_diversity,
      label_diversity_year = paste0(
        patent_year, ": ", 
        round(diversity,0), " ",
        round(100*percent_max_diversity, 0), "%m ",
        label_diversity_year
        )
    )

      
 innov_combined_diversity_allyears_blank <- innov_combined_diversityjoin  %>% 
   select(
     label_parent, finalparent_child,mainrow, crop, patent_year
   )%>% 
   distinct() %>% 
    group_by(label_parent, finalparent_child,mainrow, crop) %>%
   filter(
    patent_year == min(patent_year)
   ) %>% 
   slice(1) %>% 
  mutate(

    numyearrep = 2022-patent_year+1
  ) %>% 
  # ungroup() %>% 
   slice(rep(row_number(), numyearrep)) %>% 
  # group_by(
  #   
  # ))
  mutate(
    # by15 =as.Date(ISOdate((patent_year + row_number()-1), 12, 31)) 
    patent_year = patent_year + row_number()-1
  ) %>% 
  ungroup() %>% 
  select(
    label_parent, finalparent_child,mainrow, crop,patent_year
  ) %>% 
   anti_join(
     innov_combined_diversitysum %>% 
       select(
         label_parent, finalparent_child,mainrow, crop,patent_year
       ) %>%
       distinct(),
     by = c("label_parent", "finalparent_child", "mainrow", "crop", "patent_year" = "patent_year")
   ) %>% 
   mutate(
     diversity = 0
   )%>% 
    mutate(
      label_diversity_year = paste0( patent_year, ": ", diversity), 
      diversity_scale = 0
    )
  
    
innov_combined_diversityLU <- innov_combined_diversitysum %>% 
  select( label_parent, finalparent_child,mainrow, crop, label_diversity_year, diversity, patent_year) %>% 
        group_by(
        label_parent, finalparent_child,mainrow, crop
      ) %>%
      mutate(
        diversity_scale = range01(diversity)
      ) %>% 
      ungroup() %>% 
    bind_rows(
    innov_combined_diversity_allyears_blank 
  ) %>% 
      mutate(
        by15 = as.Date(ISOdate(patent_year, 12, 31))#, 
        #  label_diversity = paste0(
        #   ground_year, ": ", addUnits( round(diversity,0)) 
        # )
      ) 

    innov_combined_diversity_rescale <-innov_acq_df_sum_relabelfacet_parent %>%  
      select(
        label_parent, finalparent_child, facetcol_final,
             crop, 
             mainrow, 
        mainrow_x_dev_or_passed, range_y_max
        )  %>% 
      distinct() %>% 
      left_join(
        innov_combined_diversityLU, 
        by = c("label_parent",
"finalparent_child", "crop",
"mainrow")
      ) %>% 
      mutate(
 
    ylabel_diverse_scale = 
      case_when(
        diversity_scale == 0 ~ range_y_max, 
        ((diversity > 0) & ((diversity_scale == NaN))) ~  range_y_max,
        ((diversity > 0) & ((diversity_scale >0))) ~ (diversity_scale*(range_y_max) +  .5*range_y_max), 
        TRUE ~ range_y_max
      ), 
  patent_typecolor = "Topic_Diversity"

  ) %>% 
      filter(!is.na( diversity_scale))
 

  }
  

innov_acq_df_sum_relabelfacet_countco <- innov_acq_df_sum_relabelfacet_parent %>% 
  bind_rows(
    innov_acq_df_sum_relabelfacet_parent %>% 
      filter(
        label_parent != "Other"
      ) %>% 
      mutate(
        rownum = row_number()
      ) %>% 
      group_by(
        rownum 
      ) %>% 
      mutate(
       facetcol_final =  gsub(label_parent, "Other", facetcol_final)

      ) %>% 
      ungroup() %>% 
      
      mutate(
        # facetcol_indiv = likely_label,

        label_parent= "Other", 
      )  %>%    
        filter(
      grepl(
        "; 0_All", facetcol_final, perl = TRUE
      ), 
     grepl(
        "_Developed", mainrow_x_dev_or_passed , perl = TRUE
      
      )
     )%>% 
      group_by(
        mainrow_x_dev_or_passed,facetcol_final, facetcol_indiv, label_parent, by15, patent_type
      ) %>% 
      mutate(
        # sumval  = sum(sumval, na.rm = TRUE)
        #this value is number 
        sumval  = sum(sumval, na.rm = TRUE)
        
      ) %>% 
      ungroup()
  )  %>% 
      group_by(
        mainrow_x_dev_or_passed,facetcol_final, likely_label, label_parent, by15, patent_type
      ) %>% 
      mutate(
        # sumval  = sum(sumval, na.rm = TRUE)
        #this value is number 
        sumval_likelylabel  = sum(sumval, na.rm = TRUE)
        
      ) %>% 
      ungroup()   %>% 

  group_by(
    mainrow_x_dev_or_passed,facetcol_final, facetcol_indiv, label_parent, by15
  ) %>% 
  mutate(
        # sumval  = sum(sumval, na.rm = TRUE)
        sumval_end  = paste(paste0(sumval, patent_type) %>% unique(), collapse = "|")

  ) %>% 
  ungroup() %>% 
  group_by(
    mainrow_x_dev_or_passed,facetcol_final, likely_label, label_parent, by15
  ) %>% 
  mutate(
        # sumval  = sum(sumval, na.rm = TRUE)
        sumval_likelylabel  = paste(paste0(sumval_likelylabel, patent_type) %>% unique(), collapse = "|")

  ) %>% 
  ungroup() %>% 

  group_by(
    # use orig inventor label to show exit
   facetcol_indiv, label_parent
  ) %>% 
  mutate(
    # facetcol_indiv_minyear = min(by15, na.rm = TRUE),
    facetcol_indiv_maxyear = max(by15, na.rm = TRUE)
    
  )  %>% 
  ungroup() %>% 
    group_by(
      #use likely label/parent to show new entry
    label_parent, likely_label
  ) %>%
  mutate(
    facetcol_indiv_minyear = min(by15, na.rm = TRUE),
    # facetcol_indiv_maxyear = max(by15, na.rm = TRUE)
  )  %>%
  ungroup() %>%
  mutate(
    if_new_entrant = 
      case_when(
        facetcol_indiv_minyear == by15 ~ 1, 
        TRUE ~ 0
      ), 
    if_exit = 
      case_when(
        facetcol_indiv_maxyear == by15 ~ 1, 
        TRUE ~ 0
      ), 
    label_activefirm = paste0(likely_label," (" , sumval_likelylabel, ")"), 
      # case_when(
      #   facetcol_indiv_maxyear == by15 ~ 1,
      #   TRUE ~ 0
      # ),
    label_newfirm = 
      case_when(
        if_new_entrant == 1 ~ paste0(likely_label," (" , sumval_likelylabel, ")")
      ), 
    label_exitfirm = 
      case_when(
        if_exit == 1 ~ paste0( facetcol_indiv," (" , sumval, ")")
      )
  )   %>% 
 
  group_by(
    mainrow_x_dev_or_passed,facetcol_final,  by15, label_parent
    )  %>% 
  summarise(
    Num_ReceivedIP = label_activefirm[!is.na(label_activefirm)]%>%    unique() %>% length() , 
  label2_receivedIP=  paste(label_activefirm[!is.na(label_activefirm)]%>%   unique() , collapse=', ' ),  
    Num_Entry =  label_newfirm[!is.na(label_newfirm )]%>%    unique() %>% length() ,    # sum(if_new_entrant, na.rm = TRUE ), 
    label2_newentry = paste(label_newfirm[!is.na(label_newfirm )]%>%   unique() , collapse=', ' ),  

    Num_Exit =  label_exitfirm[!is.na(label_exitfirm) ]   %>%   unique() %>% length() ,  #sum(if_exit, na.rm = TRUE ), 
    label2_exit = paste(label_exitfirm[!is.na(label_exitfirm) ]%>%   unique() , collapse=', ' ),  

  ) %>% 
  ungroup() %>%  
  mutate(
        Num_ReceivedIP = paste0(Num_ReceivedIP, "}",label2_receivedIP ) , 
    Num_Entry =paste0(Num_Entry, "}",label2_newentry ), 

    Num_Exit = paste0(Num_Exit, "}",label2_exit ) 

  ) %>% 
  select( -starts_with("label2_")) %>% 
  gather(
    key = patent_type,
    value = sumval,
    starts_with("Num")
  ) %>% 
  filter(
    !is.na(sumval)
  )%>% 
  separate(
    .,
    col = sumval, 
    into = c("sumval", "valuelabel"), 
    sep = "}"
  )
  # join everything together
  
  innov_combine_selectvarnames <- c("mainrow_x_dev_or_passed","facetcol_final", "measure", "sumval", "patent_type", "valuelabel", "by15", "patent_type_id")
  
 innov_combine_df <- bind_rows(
   # pvp patent sum
   ## /All (black lines)
   innov_acq_df_sum_relabelfacet_parent %>% 
     mutate(
       patent_type = paste0(patent_type ),
       patent_type_id = paste0(patenttype_x_devpass_id), 
       measure = paste0("0IP certificate count" , " - ", facetcol_finalparent)
     )%>% 
     select(all_of(c(innov_combine_selectvarnames))), 
   # pvp patent sum 
   ## by pvp or patent
   innov_acq_df_sum_relabelfacet_parent_sum %>% 
     mutate(
       patent_type = paste0("All", "_", patenttype_x_devpass), 
        patent_type_id = paste0(patent_type), 

       measure = paste0("0IP certificate count" , " - ",facetcol_finalparent)
     ) %>% 
     select(all_of(innov_combine_selectvarnames)), 
   # number of mergers
   ## by total number (black/all)
   # number of IP transferred bc of mergers
   ## by pvp or patent
    innov_merger_curve %>% 
     mutate(
       patent_type = paste0("All_",patent_type), 
       patent_type_id = paste0(patent_type), 
       measure = paste0("2Merger IP acquired" , " - ", label_parent), 
       sumval = ylabel_merger_scale, 
       valuelabel = paste0(sumtotal_mergers_pass_and_dev )
     ) %>% 
     select(all_of(innov_combine_selectvarnames)), 
      # diversity 
   ## by pvp or patent
    # innov_combined_diversity_rescale %>% 
    #  mutate(
    #    patent_type = paste0("All_", patent_type), 
    #    patent_type_id = paste0(patent_type), 
    # 
    #    measure = paste0("3IP Theme Diversity" , " - ", label_parent), 
    #    sumval = diversity_scale, 
    #    valuelabel = paste0(label_diversity_year )
    #  ) %>% 
    #  select(all_of(innov_combine_selectvarnames)), 
         # diversity 
   ## all/black
   #  innov_combined_diversity_rescale %>%
   #   # rename(
   #   #   by15 = patent_year
   #   # )%>%
   # group_by(
   #      label_parent,facetcol_final, finalparent_child,mainrow_x_dev_or_passed, mainrow, crop, patent_year, by15 
   #    ) %>%
   #  summarise(
   #    diversity = mean(diversity_scale, na.rm = TRUE),
   #    label_diversity_year = paste(unique(label_diversity_year), collapse = "; ")
   #    )%>% 
   #   ungroup()%>% 
   #   mutate(
   # 
   #     patent_type = "All", 
   #     patent_type_id = paste0(patent_type), 
   # 
   #     measure = paste0("3IP Theme Diversity" , " - ", label_parent), 
   #     sumval = diversity, 
   #     valuelabel = paste0(label_diversity_year )
   #   ) %>% 
   #   select(all_of(innov_combine_selectvarnames)), 
   innov_acq_df_sum_relabelfacet_countco  %>% 
     mutate(
       patent_type = paste0("All_",patent_type), 
       patent_type_id = paste0(patent_type), 
       measure = paste0("3 Number Firms" , " - ", label_parent), 
       sumval = sumval %>% as.numeric(),  
       valuelabel = paste0(year(by15), ": ",sumval, "; ",  valuelabel), 
       valuelabel = gsub("0; ",  "0", valuelabel)
     ) %>% 
     select(all_of(innov_combine_selectvarnames))



 )
 if(show_mergercurve =="yes")
 {
 innov_combine_df <- innov_combine_df %>% 
   bind_rows(
     innov_merger_curve_mergercount %>% 
     mutate(
       patent_type = "All", 
        patent_type_id = paste0(patent_type), 
       measure = paste0("1Merger count" , " - ", label_parent), 
       sumval = total_mergers_year_col_acquirer_new, 
       valuelabel = paste0(sumval, ": ", year_parent_merger_occurred )
     ) %>% 
     select(all_of(innov_combine_selectvarnames))
   )
 }
     

 innov_combine_df <- innov_combine_df %>% 
      filter(
      grepl(
        "; 0_All", facetcol_final, perl = TRUE
      ), 
     grepl(
        "_Developed", mainrow_x_dev_or_passed , perl = TRUE
      
      )
     )%>% 
     mutate(
       facetcol_final = gsub("; 0_.*", "", facetcol_final)
     ) %>% 
     mutate(
       facetcol_final = gsub(".*p_", "", facetcol_final) , 
       mainrow_x_dev_or_passed  = gsub("_.*", "",mainrow_x_dev_or_passed )
     ) %>% 
   mutate(
     measure_all = gsub(" - .*", "", measure)
   )
 # innov_combine_df_cross <- crossing(
 #   
 #  mainrow_x_dev_or_passed =  innov_combine_df$mainrow_x_dev_or_passed %>% unique(), 
 #  facetcol_final =  innov_combine_df$facetcol_final %>% unique(), 
 #  # measure = innov_combine_df$measure %>% unique(), 
 #  # patent_type  =  innov_combine_df$patent_type %>% unique(), 
 #  by15 =  innov_combine_df$by15 %>% unique(), 
 #  measure_all=  innov_combine_df$measure_all %>% unique()
 # ) %>% 
 #   distinct() %>% 
 #   left_join(
 #     innov_combine_df
 #   ) %>% 
 #   filter(
 #     !is.na(sumval)
 #   ) %>% 
 #   distinct()
 
  innov_acq_mainrow_vec <- innov_combine_df$mainrow_x_dev_or_passed%>% unique() %>% sort()
 
  # 
  # innov_acq_df_sum_relabelfacet_otherlm <- innov_acq_df_sum_relabelfacet_parent %>% 
  #   filter(
  #     grepl("OtherInventor",facetcol_final, perl = TRUE )
  #   )
  # 
#  
   innov_acq_xmin = innov_combine_df$by15 %>% min()
  innov_acq_xmax = innov_combine_df$by15 %>% max()


  
 set.seed(125)
   # mutate(
   #   ordercol = paste0( str_pad(num_in_mainrow,width = nchar(max( num_in_mainrow)), side = "left", pad = "0"),  ) 
   # )
   # innov_acq_df_sum_relabelfacet_parent$mainrow_x_dev_or_passed %>% unique() %>% sort()
 set.seed(123)
 
 my_colorsdf = tibble(
  my_colors = c(
   # carto_pal(7, "Purp")[7],
   "#63589F",
   # carto_pal(7, "Teal")[7],
   "#2A5674",
   # carto_pal(12, "Safe")[5]
   "#332288", 
   # carto_pal(12, "Safe")[11]
   "#6699CC",
   # carto_pal(12, "Safe")[4]
   "#117733",
   # carto_pal(7, "SunsetDark")[7]
  "#7C1D6F",
  # carto_pal(7, "ArmyRose")[1]
   "#798234",
  # carto_pal(7, "Geyser")[7]
  "#CA562C",
   # carto_pal(12, "Safe")[12]
  "#888888",

   "#44AA99",
  "#CE78B3"
  



)
) # randomize the order

 extracolors <- c(
         "#B998DD",   "#88CCEE", "#CC6677", "#DDCC77",  "#44AA99","#EDEF5D", "#999933",  "#FFC6C4", "#70A494", "#B4C8A8",  "#EDBB8A", "#E4C7F1", "#EB4A40","#CE78B3", "#B0F2BC", "#F7FEAE" , "#AA4499"  , "#D1EEEA" ,"#888888"
        
     
 )
 
 require(ggtext)
 
  my_colors_pal_levels <- c(c(innov_combine_df$patent_type %>% unique()) %>% as.factor())
  
    my_colors_pal = my_colorsdf$my_colors[1:length(my_colors_pal_levels)]

  
  names(my_colors_pal) <- levels(my_colors_pal_levels)

  i <- 1
  while(i <= length(innov_acq_mainrow_vec))
 {
   
   
   innov_acq_currentmainrow = innov_acq_mainrow_vec[i]
   innov_acq_df_sum_current <- innov_combine_df   %>% 
     filter(
      mainrow_x_dev_or_passed ==  innov_acq_currentmainrow
     ) %>% 
     mutate(
       facetcol_final = gsub(".*p_", "", facetcol_final)
     )
  
   innov_acq_df_sum_current_cross <- crossing(
     by15 = innov_acq_df_sum_current$by15 %>% unique(),
       mainrow_x_dev_or_passed = innov_acq_df_sum_current$mainrow_x_dev_or_passed %>% unique(),
     facetcol_final = innov_acq_df_sum_current$facetcol_final %>% unique(),
     measure_all = innov_acq_df_sum_current$measure_all %>% unique(),
     measure = innov_acq_df_sum_current$measure %>% unique()#,
     # by15 = innov_acq_df_sum_current$by15 %>% unique(),
   
   ) %>% 
     distinct() %>%  
     left_join(
       innov_acq_df_sum_current
     )
   #dont comment out the below because NA is important to keep consistent num cols
   # %>% 
     # filter(
     #   !is.na( sumval)
     # )
   
   innov_acq_df_sum_current_cross_labels <- innov_acq_df_sum_current_cross %>% 
     group_by(
       measure_all, facetcol_final
     ) %>% 
     mutate(
       rownum = row_number(), 
       maxval = max(sumval, na.rm = TRUE) * 1.5
     ) %>% 
     ungroup() %>% 
     mutate(
       blanklabelval = 
         case_when(
           #take first column and creates new max val of 1.5 * max val
           # grepl("^1", facetcol_final, perl = TRUE) ~ ""
          (grepl("^1", facetcol_final, perl = TRUE)  & rownum ==   1 & maxval >0) ~ maxval
         )
       ) %>% 
     mutate(
       
      
        blanklabelval = 
         # if is new max, then new max; if is still first row num and is NA ie second, third col, then make it zero val; everything else 0
         case_when(
           # grepl("^1", facetcol_final, perl = TRUE) ~ ""
           !(is.na(blanklabelval)) ~ blanklabelval,
           (rownum==   1 & is.na(blanklabelval)) ~ 0
         )
     ) %>%  
     filter(
       !is.na(blanklabelval)
       # grepl("^1", facetcol_final)
     ) %>%
     mutate(
       blanklabel = ""
     )  
   
   rm(j)
   j <- 1
   innov_acq_currentmeasure = innov_combine_df$measure_all  %>% unique()
 rm(listofcowplots)
 listofcowplots <- list()

   while(j <=  length(innov_acq_currentmeasure))
   {
     innov_acq_df_sum_current_measure <- innov_acq_df_sum_current_cross %>% 
       filter(
         measure_all ==  innov_acq_currentmeasure[j]
       )  %>% filter(
      !is.na(sumval)
     )
      
     innov_acq_df_sum_current_cross_current_labels  <- innov_acq_df_sum_current_cross_labels %>% 
       filter(
         measure_all ==  innov_acq_currentmeasure[j]
       )  
     innov_acq_df_sum_current_measure_all <- innov_acq_df_sum_current_measure %>% filter(
       grepl("^All", patent_type_id, perl = TRUE)
     )
     
     
     
     
     if( nrow( innov_acq_df_sum_current_measure)  <=0)
     {
       j<-j+1
       next
     }
      ggplottitle = paste0( str_to_title( innov_acq_currentmeasure[j]))

       facetwrapsize = ((60*16)/( innov_acq_df_sum_current_measure$facetcol_final %>% unique() %>% length()))*(3/textout)*2.5
       
       rm(legend_rows_num)
       legend_cols = floor((((60*16)/( innov_acq_df_sum_current_measure$facetcol_final %>% unique() %>% length()))*(3/textout)))/ (innov_acq_df_sum_current_measure$patent_type %>% unique() %>% length())
       if(legend_cols >=5)
       {
         legend_rows_num = 1
           
       }
       if(legend_cols <=4)
       {
         legend_rows_num = 2
           
       }

      
      innov_acq_gg <- ggplot() 
      if( innov_show_all_only == "no")
      {
        innov_acq_gg <- innov_acq_gg + 
          geom_line(
        data = innov_acq_df_sum_current_measure,
        aes(
          x = by15, 
          y = sumval,

          color = patent_type, 
          group = patent_type_id
          
        ),
        linewidth = .5,
        show.legend = F, 
        alpha = .6
       # alpha = .6
        )+ 
      geom_point(
        data = innov_acq_df_sum_current_measure,
        aes(
          x = by15, 
          y = sumval,

          color = patent_type, 
          group = patent_type_id
          
        ),
        size = pointsize *2 , alpha = .5
      )
      }
   innov_acq_gg <- innov_acq_gg +  
        geom_text(
          data = innov_acq_df_sum_current_cross_current_labels,
        aes(
          x = by15, 
          y = blanklabelval,
          label = blanklabel,
          color = patent_type,
        ),
        size = .75,
        alpha = 0,
        color = alpha('black', 0)#, 

        # size = textsize/2,
         # color = alpha('black', .5), 
        # point.size = NA ,
         # color = alpha('black', .5), 
        # fill = NA
       # min.segment.length = 0, 
       # min.segment.length = Inf

      )+

      # values

       geom_smooth(
        data = innov_acq_df_sum_current_measure_all,
        aes(
          x = by15, 
          y = sumval, 
          # color = patenttype_x_devpass , 
          group = patent_type_id, 
          fill = patent_type

        ), 
        color = alpha('black', 0),
        se = TRUE,
        method = "loess",
        alpha = .2, 
        span = 0.4,

        # span = .1,
        size = .75#, 
        # linetype = "dashed"

      ) + 
      geom_line(
         data = innov_acq_df_sum_current_measure_all,
        aes(
          x = by15, 
          y = sumval,

          color = patent_type, 
          group = patent_type_id
          
        ),
        linewidth = linesize,
        show.legend = T, 
        alpha = .6
       # alpha = .6
        ) + 
           geom_point(
         data = innov_acq_df_sum_current_measure_all,
        aes(
          x = by15, 
          y = sumval,

          color = patent_type, 
          group = patent_type_id
          
        ),
        size = pointsize *2 , 
        show.legend = T, 
        alpha = .6
       # alpha = .6
        ) 


      # ggrepel::geom_text_repel(
      #   data = innov_acq_df_sum_current_measure_all,
      #   aes(
      #     x = by15,
      #     y = sumval,
      #     label = valuelabel,
      #     # color = patenttype_x_devpass #,
      #     # segment.color = patenttype_x_devpass# ,
      #     # group = patenttype_x_devpass
      # 
      #   ),
      #   color = alpha('black',.6),
      #   size = .75,
      #   segment.size = .1#,
      #   # min.segment.length = Inf,
      #   # segment.color =  alpha('black', 0)
      # 
      # ) +
      
      if(innov_if_show_labels == "yes")
      {
         innov_acq_gg <-innov_acq_gg + 
            ggrepel::geom_text_repel(
              data = innov_acq_df_sum_current_measure,
        aes(
          x = by15, 
          y = sumval,
          label = valuelabel,
          color = patent_type,
        ),
        size = .75,
        # size = textsize/2,
         # color = alpha('black', .5), 
        # point.size = NA ,
        segment.size = .1,
        box.padding = 0.3
        # fill = NA
       # min.segment.length = 0, 
       # min.segment.length = Inf

      ) 
}
    innov_acq_gg <-innov_acq_gg + 
      facet_wrap(~facetcol_final , scales = "free",nrow =1 ,  labeller = label_wrap_gen(facetwrapsize )) + 
      # coord_cartesian(clip="off")+
      xlim(innov_acq_xmin ,innov_acq_xmax ) + 
      ggtitle(ggplottitle) +
      theme_minimal() + 
            theme(
        # panel.background = element_rect(fill = 'white', colour = 'grey'),
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(),
        # text = element_text(size = 14),
        # plot.title = element_text(size = textout, face = "bold"),
        # plot.subtitle = element_text(size = textout, face = "bold"),
        strip.text = element_text(size = textout),
        # axis.title.x.top = element_text( size = 20 ),
        axis.text.x = element_text( size = textout ),
        axis.text.y = element_text( size = textout ),

        # axis.text.y = element_text( size = 20 ),
        # axis.title.x=element_text( size = textout ) ,
        axis.title.x= element_blank(),
        axis.title.y= element_blank(),

        legend.text=element_text(size=textout),
        # legend.title=element_text(size=20),
        # axis.title=element_text(size=textout,face="bold"),
        title = element_text(size = textout,face="bold") ,
        # axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
        # axis.title.y=element_blank(),
        # axis.text.y=element_blank(),
        # axis.ticks.y=element_blank(),
        legend.position = c(.1, .9),
                # legend.position = 'top',

        # legend.justification='center',
        legend.direction='horizontal',
        # legend.position =  'top',
        # legend.title = element_blank(),
        legend.key.size = unit(pointsize, 'cm')
      )  
      
    listofcowplots[[j]] <-  innov_acq_gg+
      scale_color_manual(name ="" , values  = my_colors_pal) + 
      scale_fill_manual(name ="" , values  = my_colors_pal)  +
      # guides(
      #   fill="none", 
      #   color = guide_legend(override.aes = list(shape = 22))
      #   ) + 
        guides(
        fill=guide_legend(override.aes = list(
          # shape = 15 ,
          # size = pointsize*6, 
          # alpha =.9, 
          ncol =innov_legend_ncol#,
          # nrow = innov_legend_ncol
          )), 
        color = guide_legend(override.aes = list(
          shape = 15 ,
          size = pointsize*6, 
          alpha =.9, 
          ncol =innov_legend_ncol#,
          # nrow = innov_legend_ncol
          ))
        ) 

      
      j <- j+1
     
   }
   
   require(cowplot)
     functitle <- ggdraw() +
  draw_label(
    paste0(
       # "Topics for ",   
       paste0( 
         str_to_title(
           innov_acq_currentmainrow 
           )
         )

    ),
    #    "#Patents granted each year by company (colored) for patents containing 230 crop names in patent title or abstract;" ,
    # paste0(
    #    "Showing only top ",
    #    slicetopn , " firms;
    #     "
    #  ),
    #
    # paste0(
    #    "
    #     Labeled by Firm: #Patents, %Patents by Firm for crop that year|"),
    #
    # paste0(
    #    "
    #    Total: #Patents, %Patents by Firm for crop since 1970"
    #  )
    # ),
    fontface = 'bold',
    x = 0,
    hjust = 0  ,
      size = textout
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

heresmylistofplots = cowplot::plot_grid(
        plotlist = listofcowplots ,
        nrow = length(listofcowplots),
        ncol = 1,
        # labels = "AUTO",
        # # label_size = 12,
        align = "v"#,
        # rel_heights = c(rep(1, each = sqrt(length(use_these_facetvec))))
       
)

   
    
        if(!dir.exists(foldername))
    {
      dir.create( foldername)
        }
     pdf(
       paste0(foldername,"/", cleantext_text(paste0( naming,substr(innov_acq_mainrow_vec[i],1, 10))), ".pdf"),
       width = 60,
       height = 35  # * ((length(innov_acq_df_sum_relabelfacet_parent$mainrow_x_dev_or_passed %>% unique() ))/num_to_dividefacetheight),
       
       # units = "in", 
       # res = 300
       # compress = TRUE
     )
     print(
       {
         cowplot::plot_grid(
           functitle,
           heresmylistofplots ,
           ncol = 1  ,
           # rel_heights values control vertical title margins
           rel_heights = c(.05, 1)
         )
         
       }
       #         cowplot::plot_grid(
       # heresmylistofplots       
       # )
     )
     dev.off()

   
 
   i <- i+1
 }
 

     
rm(innov_acq_gg)
rm(innov_acq_df_theme)
rm(innov_acq_df)
rm(functitle)
rm(heresmylistofplots)
rm(innov_acq)
rm(innov_acq_df)
rm(innov_acq_df_sum)
rm(innov_acq_df_sum_current)
rm(innov_acq_df_sum_relabelfacet_otherlm)
rm(innov_acq_df_sum_relabelfacet_otherlm_current)
 rm(innov_acq_df_sum_relabelfacet_parent)
 rm(innov_acq_df_sum_relabelfacet_blanklabel)
 rm(innov_acq_df_sum_relabelfacet_blanklabel_current)
 rm(innov_acq_gg)
 rm(listofcowplots)
 rm(innov_acq_df_sum_top5_parent_per)
  rm(innov_acq_df_sum_top5_parent)
   rm(innov_acq_df_sum_relabelfacet_parent_mergerlines)
    rm(innov_acq_df_sum_relabelfacet_parent_mergerlines_current)
     rm(innov_acq_df_sum_relabelfacet_parent_labels_only)
      rm(innov_acq_df_sum_relabelfacet_parent_labels_only_current)
       rm(innov_acq_df_sum_relabelfacet_parent_blanklabel)
       rm(innov_acq_df_sum_relabelfacet_parent_blanklabel_current)
       
       rm(i)
       rm(innov_acq_currentmainrow)
       rm(innov_acq_facetcol)
       rm(innov_acq_facetcol_indiv)
       rm(innov_acq_idcol)
       rm(innov_acq_mainrow)
       rm(innov_acq_mainrow_vec)
       rm(innov_acq_xmax)
       rm(innov_acq_xmin)
       rm(list_of_crops)
       rm(naming)
       rm(num_sigfigs)
       rm(outwidth)
       rm(quantity_to_cbind)
       rm(slicetopn_of_namefinal)
       rm(sum_by_unique_or_quantity)
       rm(textout)
       rm(textsize)
       rm(outheight)
       rm(foldername)
       rm(currentcrops)
       rm(cropsgothru)
       rm(currentcrop)
       rm(if_append_facetlabel_ggtitle)
       rm(num_to_dividefacetheight)
       rm(my_colors_pal)
       rm(my_colorsdf)
       rm(ylabdf)
       rm(if_calc_max)
       rm(if_show_all_only)
       rm(slicetopn_of_nameindiv)
       rm(innov_acq_df_sum_current_isagg)
       rm(innov_acq_df_sum_relabelfacet_parent_mergerlines)
       rm(innov_acq_df_sum_agg)
       rm(innov_acq_df_sum_and_agg)
       rm(innov_acq_df_sum_relabelfacet_parent_notsum)
       rm(innov_acq_df_sum_relabelfacet_parent_sum)
       rm(innov_acq_df_sum_relabelfacet_parent_sum_spline)
       rm(innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme)
       rm(innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high)
       rm(innov_acq_df_sum_relabelfacet_parent_sum_spline_extreme_high_current)
       rm(innov_acq_df_sum_relabelfacet_sum)
       rm(innov_acq_df_sum_top5_parent_per_agg)
       rm(innov_acq_df_sum_top5_parent_per_label)
       rm(innov_pd)
       rm(innov_acq_df_sum_current_cross)
       rm(innov_acq_df_sum_current_cross_labels)
       rm(innov_acq_df_sum_current_cross_measure)
       rm(innov_acq_df_sum_current_cross_measure_all)
       rm(innov_acq)
}

```


### use function

#### use func
```{r }

 soycropquery_mergercountry %>%
  # filter(
  #   patent_merger_id %in% c(innov_acq_pre$patent_merger_id)
  # ) %>% 
  # functionreduce_down_dups(passthrudf = ., functionreduce_down_colthatisid = .$patent_number, functionreduce_down_colthatiscrop = .$crop ,functionreduce_down_colthatisacquired = .$name_standard_patent2 )
    
  func_find_maxyear_name( 
    findmaxyear_df =., 
    findmaxyear_yearcol = .$ground_year,
    findmaxyear_firmnamecol = .$name_standard_patent2,
    findmaxyear_firmname_changetocol = .$col_acquirer_new,
    findmaxyear_idcol = .$patent_merger_id
    ) %>% 
  innov_acq_cowplotfunc(
    # df
    innov_acq = ., 
    # if_remove_text =c("yes"),
    # finalname

 innov_acq_facetcol = .$finalname,
 num_to_dividefacetheight = 10,
# theme or crop
innov_acq_mainrow = .$crop,
# patent merger id or simply id
innov_acq_idcol = .$patent_number,
# name of each column or co name
innov_acq_facetcol_indiv =.$name_standard_patent2,
# if summing by unique id or gamma/quantity
sum_by_unique_or_quantity = .$patent_number,
slicetopn_of_nameindiv = 0,
if_scale_fixed = "no",
slicetopn_of_namefinal=4,
# textout =5,
# textsize=2,
outwidth = 60,
outheight=35,
num_sigfigs = 2,
foldername ="X:/msi/work/farmer welfare/seed/R analysis/images/topic model/230917_topic_by_crop",

ylabdf = "Score",
if_calc_max = "yes",
innov_show_all_only = "yes",
if_only_developed = "yes" ,
# innov_if_show_labels = "yes",
innov_if_show_labels = "no",

# these are for only all
show_mergercurve = c("no"),
naming = "230917_cropbytopicdiversity_pub_nolabel_lessconcencrops_nomerger",

if_append_facetlabel_ggtitle= "no",

# these are for only all
pointsize = 1*2,
linesize = 2*2,
textout =40 ,
textsize = 3*6,
if_calc_diversity = "no",
innov_legend_ncol = 2, 
# innov_crops_to_use =  c("soybean", "corn", "cotton" , "canola" ),
# innov_crops_to_use_label = "Canola, Corn, Cotton, Soybean"

# innov_crops_to_use =  c("soybean", "corn", "cotton" , "canola", "wheat", "forage" ),
# innov_crops_to_use_label = "Canola, Corn, Cotton, Forage, Soybean, Wheat"
# innov_crops_to_use =  c("soybean", "corn", "cotton", "wheat", "forage", "canola", "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"), 
# innov_crops_to_use_label = "Many Crop Types"
innov_crops_to_use =  c("wheat", "forage",  "bean", "stonefruit", "green", "berry", "ornamental", "rice","solanaceae", "tubers", "pome", "cucurbit", "oilseed", "melon"),
innov_crops_to_use_label = "Many Crops Excluding: Soy, Canola, Corn, Cotton"

    )

```

#### helper vars
```{r }
 innov_acq_pre <- soycropquery_mergercountry  
   
  # filter(
  #   # col_acquirer_new != "DENGHAI SEED GROUP", 
  #   finalname != "DENGHAI SEED GROUP"
  #   
  # #   crop == "wheat"#,
  # #   # grepl("plant, soybean, variety, may, plants, can, used, seed, example, resistance, one, gene", terms, perl = TRUE, ignore.case = TRUE),
  # )
innov_acq <- soycropquery_mergercountry %>%
  filter(
    crop %in%  
       c("soybean", "corn", "cotton", "wheat", "forage", "canola" )
   
  ) %>% 
  mutate(
    crop = "Canola, Corn, Cotton, Forage, Soybean, Wheat", 
    patent_type = "IP"
  ) %>% 
  filter(
    patent_merger_id %in% c(innov_acq_pre$patent_merger_id)
  ) %>% 
  # functionreduce_down_dups(passthrudf = ., functionreduce_down_colthatisid = .$patent_number, functionreduce_down_colthatiscrop = .$crop ,functionreduce_down_colthatisacquired = .$name_standard_patent2 )
    
  func_find_maxyear_name( 
    findmaxyear_df =., 
    findmaxyear_yearcol = .$ground_year,
    findmaxyear_firmnamecol = .$name_standard_patent2,
    findmaxyear_firmname_changetocol = .$col_acquirer_new,
    findmaxyear_idcol = .$patent_merger_id
    )# %>% 
  # filter(
  #   ground_year == patent_year
  # )
if_remove_text ="yes"
 innov_acq_facetcol = innov_acq$finalname
 num_to_dividefacetheight = 10
# theme or crop
innov_acq_mainrow = innov_acq$crop
# patent merger id or simply id
innov_acq_idcol = innov_acq$patent_number
# name of each column or co name
innov_acq_facetcol_indiv =innov_acq$name_standard_patent2
# if summing by unique id or gamma/quantity
sum_by_unique_or_quantity = innov_acq$patent_number
slicetopn_of_nameindiv = 0
if_scale_fixed = "no"
slicetopn_of_namefinal=5
textout =5
textsize=2
outwidth = 120
outheight=70
num_sigfigs = 2
foldername ="X:/msi/work/farmer welfare/seed/R analysis/images/topic model/230124_topic_by_crop"
foldername ="X:/msi/work/farmer welfare/seed/R analysis/images/topic model/230917_topic_by_crop"

if_append_facetlabel_ggtitle= "no"

ylabdf = "Score"
if_calc_max = "yes"
if_show_all_only = "no"
if_only_developed = "yes" 

# these are for only all
pointsize = 1
linesize = 2
textout =35
textsize = 3
show_mergercurve = "yes"
slicetopn_of_nameindiv = 0
if_calc_diversity = "no"
naming = "230124_soytopics_only_cropbytopicdiversity"
naming = "230124_cropbytopicdiversity_omitdenghai"
naming = "230917_cropbytopicdiversity"

if_append_facetlabel_ggtitle= "no"

ylabdf = "Score"
if_calc_max = "yes"
if_show_all_only = "no"
if_only_developed = "yes" 

# these are for only all
pointsize = 1*2
linesize = 2*2
textout =40 
textsize = 3*6
show_mergercurve = "yes"
slicetopn_of_nameindiv = 0
if_calc_diversity = "no"

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
