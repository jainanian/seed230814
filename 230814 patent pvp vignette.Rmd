---
title: "230814 patents vig"
output: html_document
date: "2023-08-14"
---
# libraries
```{r  }
require(tidyverse)

```

# get patent data
```{r }
require(patentsview)
```

## test patent function
```{r }

```

### with patents and all endpoints

#### first get patents; as of 23/06/18, pto.gov seems to limit returned data from patents endpoint; need to use all endpoints "patents", "inventors", "assignees", "locations", "cpc_subsections", "uspc_mainclasses", or "nber_subcategories".
 
```{r }

cornfields <-  c("assignee_organization", "appcit_app_number", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type", "citedby_patent_number" ,"citedby_patent_title","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_sequence", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_average_processing_time" ,"patent_processing_time", "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

cornquery <-   (search_pv(
    query =  paste0(
        '{"_and":[
          {"_eq":{"patent_year":"', "2021",'"}},
          {"_or":[
            {"_text_all":{"patent_title":"', "corn", '"}} 
          ]}

          
  ]}'
    ),
    endpoint = "patents" , 
    fields = cornfields, 
    all_pages = TRUE, 
  method = "POST"
))$data$patents %>% unnest()
# Create a field list
```

#### second  get assignee
```{R }

cornquery2 <-   (search_pv(
    query =  paste0(
      
              '{"_eq":{"patent_number":"',10165744,'"}}' 
 
    ),
    endpoint = "assignees" , 
    fields = c("assignee_organization",   "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract",      "cpc_category"  , "cpc_group_title", "cpc_group_id",  "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,     "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$assignees%>% unnest()
```
#### third  get inventor
```{R }

cornquery3 <-   (search_pv(
    query =  paste0(
     
             '{"_eq":{"patent_number":"',10165744,'"}}' 

    ),
    endpoint = "inventors" , 
    fields =c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type",  "cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$inventors%>% unnest( "patents")
```

#### fourth locations
```{R }

cornquery4 <-   (search_pv(
    query =  paste0(
     
             '{"_eq":{"patent_number":"',10165744,'"}}' 

    ),
    endpoint = "cpc_subsections" , 
    fields =  c("assignee_organization", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,   "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ),
    all_pages = TRUE, 
  method = "POST"
))$data$cpc_subsections%>% unnest( "patents")

cornquery4 %>% gather(key = measure, value = value, -patent_number) %>% View()

```

```{r }
cornquery_bind <- bind_rows(
  cornquery,cornquery2, cornquery3, cornquery4
)  %>% gather(key = measure, value = value, -patent_number) %>% distinct() %>% 
  filter(
    !value  %in% c("NANA", NULL, NA ,"NULL", "NA")
  )

```

<!-- #### fifth uspc_mainclasses -->
<!-- ```{R } -->

<!-- cornquery5 <-   (search_pv( -->
<!--     query =  paste0( -->

<!--              '{"_eq":{"patent_number":"',10165744,'"}}'  -->

<!--     ), -->
<!--     endpoint = "nber_subcategories" ,  -->
<!--     # fields =  c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    ), -->
<!--     all_pages = TRUE,  -->
<!--   method = "POST" -->
<!-- ))$data$nber_subcategories%>% unnest( "patents") -->
<!-- ``` -->

## start loops
```{r}



dates <- tibble( 
  startdate = 
    seq(as.Date('1970-01-01'), as.Date('2022-01-01'), by = 'years') ) %>% 
  mutate(
    enddate = lead(startdate)
  ) %>% 
  filter(
    !is.na(enddate)
  )


```

```{r }
actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  str_squish(stripWhitespace(actual_punc_rem(tolower(x))))
}

```

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)

# https://docs.ropensci.org/patentsview/articles/writing-queries.html


veglist <- jsonlite::fromJSON(
  "https://raw.githubusercontent.com/dariusk/corpora/master/data/foods/vegetables.json"
)[[2]]

fruitlist <-  jsonlite::fromJSON(
  "https://raw.githubusercontent.com/amitbet/fruits/master/fruit.json"
)[[2]]

selectnasscroplist <- readxl::read_excel(
  "//jna_nol/asus/msi/work/farmer welfare/nass/220619 select nass vars.xlsx"
)

croplist <- bind_rows(
  tibble(
    crop = veglist
  ),
  tibble(
    crop = fruitlist
  ), 
  tibble(
    crop = selectnasscroplist$shortname
  )
) %>% 
  distinct()

```


### callpatents function 6/17 
```{r }
func_callpatentviewr_2 <- function(currentcrop = croplist, numlist = c(1970:2022), savefolder, numworker = 90, savefileoutfunc) {
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
require(future.callr)
plan(callr)
  require(patentsview)
  plan("callr", workers =numworker)

actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  str_squish(tm::stripWhitespace(actual_punc_rem(tolower(x))))
}

numworker = 90
currentcrop = "corn"
currentcrop = c(croplist$crop , "soybean", "soy", "dicamba", "glyphosat", "glufosinate", "soybean cyst nematode", "soy")
numlist = c(1970:2022)


plan("callr", workers =numworker)


fieldsinterest_patents = c("assignee_organization", "appcit_app_number", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type", "citedby_patent_number" ,"citedby_patent_title","cpc_category"  , "cpc_group_title", "cpc_group_id","cpc_sequence", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_average_processing_time" ,"patent_processing_time", "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_cpc_subsections = c("assignee_organization", "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type","cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,   "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_cpc_subsections_detail = c("cpc_subgroups", "assignees" , "inventors" ,"applications" ,  "nbers", "gov_interests", "lawyers", "examiners")

fieldsinterest_inventors= c("assignee_organization",  "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract", "assignee_state_fips","assignee_county_fips", "assignee_country","assignee_city", "assignee_latitude", "assignee_longitude" ,    "assignee_total_num_patents" ,"assignee_type",  "cpc_category"  , "cpc_group_title", "cpc_group_id", "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,  "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )

fieldsinterest_inventors_detail = c("assignees" ,"applications" , "cpcs", "nbers", "gov_interests", "lawyers", "examiners")


 fieldsinterest_assignees = c("assignee_organization",   "patent_number", "app_number", "patent_title", "patent_type","patent_date", "patent_abstract",      "cpc_category"  , "cpc_group_title", "cpc_group_id",  "cpc_subgroup_id"   , "cpc_subgroup_title",   "cpc_subsection_title"  , "cpc_total_num_patents", "cpc_total_num_assignees", "examiner_id", "govint_org_name", "nber_category_id"  , "nber_category_title", "nber_subcategory_id","nber_subcategory_title", "nber_total_num_assignees",   "nber_total_num_patents" ,     "patent_num_cited_by_us_patents", "patent_num_combined_citations" , "patent_num_us_application_citations","patent_num_us_patent_citations" , "lawyer_id",  "inventor_id", "examiner_id"    )
fieldsinterest_assignees_detail = c("inventors" ,"applications" , "cpcs", "nbers", "gov_interests", "lawyers", "examiners")

 
savefolder = "R analysis/output patents/230618_output"
savefileoutfunc = "230619_saveall"
fieldsinterest_vec <-   c("cpc_subsections", "inventors", "assignees")
fieldsinterest_list <- list(
 fieldsinterest_cpc_subsections, fieldsinterest_inventors,  fieldsinterest_assignees
)  
 fieldsinterest_list_detail <- list(
   fieldsinterest_cpc_subsections_detail, 
   fieldsinterest_inventors_detail, 
   fieldsinterest_assignees_detail
 )

if(!exists(savefolder))
{
  dir.create(savefolder)
}

    process_file_patents <- function( currentk, fieldsinterest_send_safe = fieldsinterest_patents, endpointtype= "patents", saveoutfolder, saveoutfile) {
      
  #     currentk =  (called_df_patent %>%
  # filter(K == 2021))$current_query_title %>% paste(collapse = "")
  #     endpointtype = "patents"
  #    fieldsinterest_send_safe = fieldsinterest_patents
      
  saveoutfile_string = paste0(
    saveoutfile, "_", 
    as.numeric(gsub("\\D", "", currentk)), "_",
    cleantext_text(
      gsub(
  ".*patent_title|.*patent_abstract", "" , currentk
  )
    )
     
  )
  
      
searchedpv_df <-patentsview::search_pv(
        query = currentk ,
        endpoint = endpointtype, 
        fields = fieldsinterest_send_safe, 
        all_pages = TRUE, 
        method = "POST"
      )
# Sys.sleep(.2)

if(endpointtype== "patents")
{
  outputdf <- searchedpv_df$data$patents 
}
# if(endpointtype== "assignees")
# {
#   outputdf <- searchedpv_df$data$assignees%>% unnest("patents" ) 
# }
# if(endpointtype== "inventors")
# {
#   outputdf <- searchedpv_df$data$inventors%>% unnest( "patents")
# }
# if(endpointtype=="cpc_subsections" )
# {
#   outputdf <- searchedpv_df$data$cpc_subsections%>% unnest( "patents")
# }
 write_rds(
   outputdf,
   paste0(
  saveoutfolder, "/", endpointtype,saveoutfile_string,  ".Rds"
  )
 )


outputdf
# searchedpv_df
}
safer_process_file_patent  <- possibly(process_file_patents, otherwise = NULL)
  


    process_file_patentsnum_LU <- function( currentk, fieldsinterest_send_safe = fieldsinterest_patents, endpointtype= "patents", saveoutfolder, saveoutfile) {
      
    #   currentk =  (called_df_patent_title_ul_distinctnum %>% 
    # mutate(
    #     patentnumquery = #"3931757"
    #   paste0('{"_eq":{"patent_number":"', "3931757",'"}}' )
    # ) )$patentnumquery[1]
    #   endpointtype = "assignees"
    #  fieldsinterest_send_safe = current_fieldinterest_list
      
  saveoutfile_string = paste0(
    cleantext_text(gsub(".*number","",  currentk))
     
  )
  
      
searchedpv_df <-patentsview::search_pv(
        query = currentk ,
        endpoint = endpointtype, 
        fields = fieldsinterest_send_safe, 
        all_pages = TRUE, 
        method = "POST"
      )
# Sys.sleep(.2)

if(endpointtype== "assignees")
{
  outputdf <- searchedpv_df$data$assignees%>% unnest("patents" ) 
}
if(endpointtype== "inventors")
{
  outputdf <- searchedpv_df$data$inventors%>% unnest( "patents")
}
if(endpointtype=="cpc_subsections" )
{
  outputdf <- searchedpv_df$data$cpc_subsections%>% unnest( "patents")
}
 write_rds(
   outputdf,
   paste0(
  saveoutfolder , "/", endpointtype[1],saveoutfile_string,  ".Rds"
  )
 )


outputdf
# searchedpv_df
}

 
safer_process_file_patentsnum_LU <- possibly(process_file_patentsnum_LU, otherwise = NULL)
  
  
#   listreturn <- list()
# books_sparse <- p %>%
#   count(docnum, word) %>%
#   cast_sparse(docnum, word, n)
currentcrop <- croplist$crop
rm(j)
rm(patentsgloballist)
patentsgloballist <- list()
j <- 1
while(j <= length(currentcrop))
{
  patentfunc_cropcurrent <- currentcrop[j]
  
  
called_df_foldercrop <- paste0(
  savefolder, "/", patentfunc_cropcurrent
)
if(!exists(called_df_foldercrop))
{
  dir.create(called_df_foldercrop)
}

  
  called_df_patent <-  crossing(
  K = numlist %>% unique(), 
  patentcall_croplist = patentfunc_cropcurrent
) %>% 
  mutate(
    current_query_title = 
      paste0(
        '{"_and":[
          {"_eq":{"patent_year":"',K,'"}},
          {"_text_all":{"patent_title":"', patentfunc_cropcurrent, '"}}
  ]}'
      ), 
  
  current_query_abstract = 
    paste0(
      '{"_and":[
          {"_eq":{"patent_year":"',K,'"}},
          {"_text_all":{"patent_abstract":"', patentfunc_cropcurrent, '"}}
  ]}'
    )
  ) 

called_df_patent_title <- called_df_patent %>% 
  # filter(K%in% c(2020, 1990,2010)) %>%
    # filter(K == 2010) %>%

   mutate(

    calledpatents_df = (furrr::future_map(
      current_query_title,
      ~safer_process_file_patent(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = fieldsinterest_patents,
         endpointtype= "patents",
         saveoutfolder = called_df_foldercrop,
         saveoutfile ="title"

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )
called_df_patent_abstract <- called_df_patent %>% 
  # filter(K%in% c(2020, 1990,2010)) %>%
    # filter(K == 2010) %>%

   mutate(

    calledpatents_df = (future_map(
      current_query_abstract,
      ~safer_process_file_patent(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = fieldsinterest_patents,
         endpointtype= "patents",
         saveoutfolder = called_df_foldercrop,
         saveoutfile ="abstract"

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )

# called_df_patent_title%>%
#   filter(
#     !is.null(calledpatents_df), !calledpatents_df %in% c(NULL,FALSE)
#   ) %>% View()
# 
#   unnest(
#     cols = "calledpatents_df"
#   ) %>% View()
# 
# called_df_patent_abstract%>%
#   unnest(
#     cols = "calledpatents_df"
#   ) %>% View()
called_df_patent_title_ul <-  called_df_patent_title %>% 
  bind_rows(
    called_df_patent_abstract
  ) %>%
  filter(
    !is.null(calledpatents_df), !calledpatents_df %in% c(NULL,FALSE)
  )  %>% 
  unnest(
    cols = "calledpatents_df"
  )  %>% 
  distinct()
  
if(!nrow(called_df_patent_title_ul)>=1)
{
  j <- j+1
  next
}

called_df_patent_title_ul_distinctnum <- called_df_patent_title_ul %>% 
  select(patent_number) %>% 
  distinct()

rm(i)
i <- 1
rm(current_called_list)
current_called_list <- list()
while(i <= length( fieldsinterest_vec))
{
  current_fieldinterest_list <- fieldsinterest_list[[i]]
  current_fieldsinterest_vec <- fieldsinterest_vec[i]
  current_fieldsinterest_listdetail <- fieldsinterest_list_detail[[i]]
  
  current_foldersaveas <- paste0(
    called_df_foldercrop, "/", current_fieldsinterest_vec
  )
  if(!exists(current_foldersaveas))
{
  dir.create(current_foldersaveas)
}

  current_called_dfinterest <- called_df_patent_title_ul_distinctnum %>% 
    mutate(
  patentnumquery = paste0('{"_eq":{"patent_number":"',patent_number,'"}}' )
) %>% 
     mutate(

    calledpatents_df = (furrr::future_map(
      patentnumquery,
     ~safer_process_file_patentsnum_LU(
        # ~ process_file_patentsnum_LU(
    # ~ process_file_patents(
         currentk = ., 
          fieldsinterest_send_safe = current_fieldinterest_list,
         endpointtype= current_fieldsinterest_vec,
         saveoutfolder = current_foldersaveas,
         saveoutfile =current_fieldsinterest_vec

         # saveoutfile = paste0("_title_(", ., "_",patentfunc_cropcurrent,")" )
       )
      
    )
  ) 
  )
  
  current_called_dfinterest_unnest <- current_called_dfinterest%>%
    tibble() %>% 
    select(-patentnumquery) %>%  
    rename(
      patentnumquery = patent_number
    )%>%  
    filter(
      !is.null(calledpatents_df)
    ) %>% 
    unnest(calledpatents_df )
  if(!nrow(current_called_dfinterest_unnest)>=1)
{
  i <- i+1
  next
}

q<- 1
rm(current_called_dfinterest_unnestlist)
current_called_dfinterest_unnestlist <- list()
while(q <= length(current_fieldsinterest_listdetail ))
{
  if(q ==1)
  {
    current_called_dfinterest_unnestlist[[q]] <- current_called_dfinterest_unnest  %>% 
    # distinct()%>% 
    unnest(
      c(current_fieldsinterest_listdetail[q])
    )
  }
  
    if(q >1)
  {
      current_called_dfinterest_unnestlist[[q]] <- current_called_dfinterest_unnestlist[[q-1]]  %>% 
    # distinct()%>% 
    unnest(
      c(current_fieldsinterest_listdetail[q])
    )

    }
  q <- q+1
  
}
current_called_dfinterest_unnestlist_bindrow <-  current_called_dfinterest_unnestlist[[q-1]] %>% 
  distinct()


  current_called_list[[i]] <- current_called_dfinterest_unnestlist_bindrow  
i <- i+1
    
}

called_df_patent_title_ul_names <-tibble(
  coltype=  sapply(called_df_patent_title_ul , class) , 
  colname = called_df_patent_title_ul %>% names()
)%>% filter(coltype == "list")
current_called_list_bindrow_pre <-  current_called_list %>% 
    bind_rows()
rm(q)
rm(current_called_list_unnestlist)
# currentcalled is ul unnested properly
current_called_list_unnestlist<- list()
q <- 1

while(q <= nrow(called_df_patent_title_ul_names ))
{
current_called_df_patent_title_ul_names <- called_df_patent_title_ul_names$colname[q]
   if(q ==1)
  {
    current_called_list_unnestlist[[q]] <- called_df_patent_title_ul  %>% 
    # distinct()%>% 
    unnest(
      c(current_called_df_patent_title_ul_names)
    )
  }
  
    if(q >1)
  {
      current_called_list_unnestlist[[q]] <- current_called_list_unnestlist[[q-1]]  %>% 
    # distinct()%>% 
    unnest(
      c(current_called_df_patent_title_ul_names)
    )

    }
  q <- q+1
}
if( nrow(called_df_patent_title_ul_names )==0 )
{
  current_called_list_bindrow <- called_df_patent_title_ul %>% 
    bind_rows(
      current_called_list_bindrow_pre
    )
}
if( !nrow(called_df_patent_title_ul_names )==0 )
{
  current_called_list_bindrow <- current_called_list_unnestlist[[q-1]] %>% 
    bind_rows(
      current_called_list_bindrow_pre
    )
}
# current_called_list_bindrow <-  current_called_list %>% 
#     bind_rows()%>% 
#   bind_rows(
#     called_df_patent_title_ul %>% 
#       unnest(c("inventors"))%>% 
#       unnest(c("assignees"))%>% 
#       unnest(c("applications"))%>% 
#       unnest(c("application_citations"))%>% 
#       unnest(c("citedby_patents"))%>% 
#       unnest(c("cpcs"))%>% 
#       unnest(c("nbers"))%>% 
#       unnest(c("gov_interests"))%>% 
#       unnest(c("lawyers"))%>% 
#       unnest(c("examiners")) 
#   )

if(!"appcit_app_number" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      appcit_app_number = NA
    )
}
if(!"citedby_patent_number" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      citedby_patent_number = NA
    )
}
if(!"citedby_patent_title" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      citedby_patent_title = NA
    )
}
if(!"cpc_sequence" %in%  c(current_called_list_bindrow %>% names()) )
{
  current_called_list_bindrow <- current_called_list_bindrow %>% 
    mutate(
      cpc_sequence = NA
    )
}

current_called_list_bindrow_sum <- current_called_list_bindrow %>% 
  mutate(
    crop= patentfunc_cropcurrent, 
    patent_year =  lubridate::year(ymd(patent_date))
  ) %>% 
  # select(
  #   -K, -current_query, -patent_average_processing_time, -patent_processing_time
  # ) %>% 
  # rename(
  #   patent_year = year#, 
  #   # patent_decade = decade,
  #   # assignee_organization_namestandard = Namestandard
  # ) %>% 
  group_by(crop, patent_number, patent_abstract, patent_date, patent_title, patent_type, patent_year, assignee_organization
)  %>% 
  summarise(
        app_number = paste(unique(app_number), collapse = "] ") , 
    app_id = paste(unique(app_id), collapse = "] ") ,
    appcit_app_number   = paste(unique(appcit_app_number  ), collapse = "] ") ,

    assignee_state_fips = paste(unique(assignee_state_fips), collapse = "] "), 
    assignee_county_fips = paste(unique(assignee_county_fips), collapse = "] "),
    assignee_country = paste(unique(assignee_country), collapse = "] "), 
    assignee_longitude = paste(unique(assignee_longitude), collapse = "] "), 
    assignee_latitude = paste(unique(assignee_latitude), collapse = "] "), 
    assignee_city = paste(unique(assignee_city), collapse = "] "), 
    assignee_total_num_patents = paste(unique(assignee_total_num_patents), collapse = "] "), 
        citedby_patent_number  = paste(unique(citedby_patent_number ), collapse = "] ") ,
         citedby_patent_title  = paste(unique( citedby_patent_title ), collapse = "] ") ,

     cpc_category = paste(unique(cpc_category), collapse = "] "), 
    cpc_subsection_title = paste(unique(cpc_subsection_title), collapse = "] "), 

    cpc_group_title = paste(unique(cpc_group_title), collapse = "] "), 
    cpc_group_id = paste(unique(cpc_group_id), collapse = "] "), 
    cpc_sequence = paste(unique(cpc_sequence), collapse = "] "), 
    cpc_subgroup_id = paste(unique(cpc_subgroup_id), collapse = "] "), 
     cpc_subgroup_title = paste(unique( cpc_subgroup_title), collapse = "] "), 
    cpc_subsection_title = paste(unique(cpc_subsection_title), collapse = "] "), 

    cpc_total_num_assignees = paste(unique(cpc_total_num_assignees), collapse = "] "), 
    cpc_total_num_patents = paste(unique(cpc_total_num_patents), collapse = "] "), 
    cpc_subgroup_title = paste(unique(cpc_subgroup_title), collapse = "] "), 
    examiner_id = paste(unique(examiner_id), collapse = "] ") , 
    lawyer_id = paste(unique(lawyer_id), collapse = "] ") , 
    nber_category_id = paste(unique(nber_category_id), collapse = "] ") , 
    nber_category_title = paste(unique(nber_category_title), collapse = "] ") , 
    nber_subcategory_id
    = paste(unique(nber_subcategory_id), collapse = "] ") , 
    nber_subcategory_title = paste(unique(nber_subcategory_title), collapse = "] ") ,
    nber_total_num_assignees = paste(unique(nber_total_num_assignees, collapse = "] ")) , 
    nber_total_num_patents = paste(unique(nber_total_num_patents), collapse = "] ") 
    



  ) %>% 
  ungroup()
# 
# current_called_list_bindrow_sum_REMOVE <- current_called_list_bindrow_sum %>%
#   gather(
#     key = measure,
#     value = value,
#     -patent_number
#   ) %>%
#   group_by(
#     patent_number, measure
#   )  %>%
#   summarise(
#     numunique = length(unique(value))
#   ) %>%
#   ungroup() %>%
#   group_by(
#     measure
#   ) %>%
#   summarise(
#     avgunique = sum(numunique, na.rm = TRUE)
#   ) %>%
#   ungroup() %>%
#   arrange(
#     -avgunique
#   )
# (current_called_list_bindrow_sum_REMOVE %>% 
#   filter(
#     avgunique == 6742
#   ))$measure %>% unique() %>% paste(collapse = ", ")
 current_called_list_bindrow_sum %>% 
data.table::fwrite(

   paste0(savefolder,"/",  savefileoutfunc,patentfunc_cropcurrent, ".csv"
)
)

 # write_rds(
 #   called_df_patent_title_ul, 
 #   file=paste0(
 #  savefolder, "/", "allpatents",  ".Rds"
 #  )
 # )
patentsgloballist[[j]] <- current_called_list_bindrow_sum
  j <- j+1
}
patentsgloballist_bindrows <- patentsgloballist %>%   bind_rows()
patentsgloballist_bindrows%>% 
  write_rds(
    .,
   file=paste0(
  savefolder, "/", "allpatents",  ".Rds"
  )
 )
  patentsgloballist_bindrows
}

```


### use callpatents function
```{r }

```

### make sure that abstract title say crop and 

## isolate patents of interest
```{r }
soycropquery_unnest_230619 <- func_callpatentviewr_2(currentcrop = croplist, numlist = c(1970:2022), savefolder =paste0(getwd(), "/output patents/230618_output") , numworker = 90, savefileoutfunc ="230619_saveall" ) 

soycropquery_unnest_230619 <- patentsgloballist_bindrows
soycropquery_unnest_230619 <- read_rds(
  paste0(getwd(), "/output patents/230618_output/230619_saveall.rds") 
  
)
```

## download patents
```{R }
downloadpatentspdffunc <- function(dlpatents_df, dlpatents_outputfolder,   dlpatentsnumworker = 90  ){
  
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
  require(pdftools)
  options(future.globals.maxSize= 891289600)
require(tesseract)
  # cropdf = narrowtoread
  #  typecomp =c("msi", "asus")
  # writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent"
  # usedpidf = 200
#   callr(
# expr,
# envir = parent.frame(),
# substitute = TRUE,
# globals = TRUE,
# label = NULL,
# workers = availableCores(),
# ...
# )
require(future.callr)
  
  # cl <- makePSOCKcluster(detectCores() - 2)

plan("callr", workers =dlpatentsnumworker)

actual_punc_rem <- function(x) {
  gsub('[[:punct:] ]+',' ',x)
  
  # removePunctuation(x,ucp = TRUE)
  
}


cleantext_text <- function(x){
  str_squish(tm::stripWhitespace(actual_punc_rem(tolower(x))))
}

numworker = 90

if(!exists(dlpatents_outputfolder ))
{
dir.create(
  dlpatents_outputfolder
)
}
  
    saferprocess_file <- function( currentk ,safe_dlpatents_df=dlpatents_df, writefolderoutdf) {

dlpatents_df_filter <- safe_dlpatents_df[currentk,] %>% 
  mutate( 
     outputname = paste0(
    crop_shortname, "_", patent_type_orig, "_", patent_decade, "_samplerownum",  crop_decade_patenttype_rownum,"_",
    
    patent_number, ".pdf"
  )    
  )

savefilename = dlpatents_df_filter$outputname[1]
      # searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
      #    currentk,  dpi =  usedpidf_df
      # )
 
      
      download.file(
        dlpatents_df_filter$url[1], 
        paste0(
         writefolderoutdf ,"/", savefilename
        ), 
        mode = "wb"
      )
 # https://apps.ams.usda.gov/CMS//AdobeImages/008300115.pdf
      # download.file(
      #   "https://apps.ams.usda.gov/CMS//AdobeImages/008300115.pdf", 
      #   paste0(
      #     "R analysis/download patents pvps/230720 sample 10","/230720testdl.pdf"
      #   ), 
      #   mode = "wb"
      # )


    }
    
    safer_calc_dist <- possibly(
  saferprocess_file, 
  otherwise = 
    NA
)
    alreadycompletedf_func <- tibble(
      filelist = list.files(
        path = paste0(
          dlpatents_outputfolder
        ),

        pattern = "pdf",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".pdf|.*_","", filelist ), 
        fullname_file = paste0(dlpatents_outputfolder,"/", filelist) 
      ) #%>% 
      # filter(
      #   filesize >=filesizemax
      # )
    set.seed(123)
    
    # cropdf  <-  pvp_url %>%  head(1)
  
    # dfsamp <- feather::read_feather("X:/msi/work/farmer welfare/seed/PVP/writepvp/201900258.feather")
    
    readthese_func <- dlpatents_df %>% 
      filter(
        !patent_number %in% c(alreadycompletedf_func$alreadydone)
      )  

out<-   readthese_func %>%
     mutate(
       k = row_number() 
     ) %>% 
     # head(1) %>% 
  mutate(
    topic_model = future_map(
    k, ~safer_calc_dist( 
      ., 
       writefolderoutdf = dlpatents_outputfolder 
     
    )#,  
      # seed    =  TRUE)
  ) 
  )

# set.seed(dlpatents_setseed)
 

}
```

### convert to doc
```{r }

convert_to_doc_output <- function( current_text, output_folder, outputname = "example_toc.docx"){
  require(htm2txt)
  require("officer")
  rm(i)
  i <- 1
    outputparams <- c(
    
    # "commentId",
    "organization",
    "NAME",
    "citystate",
    # "firstName", 
    # "lastName", 
    # "city", 
    # "stateProvinceRegion", 
    "receiveDate", 
    "linkfinal", 
    "citation",
    "comment", 
    "contents"
    
  )
    current_text <- current_text %>% 
      # filter(
      #   docketId == "AMS-FTPP-21-0044"
      #   # grepl("AMS-FTPP-21-0044",commentId, perl = TRUE )
      # ) %>% 
      mutate(
        NAME = paste0(
              firstName,  " ",  lastName

        ), 
        citystate = paste0(
                        city,  ", ",  stateProvinceRegion

 
        ), 
        orgname = coalesce(
          organization, NAME
        ), 
        citation = paste0(
          toupper(lastName), ", ", 
          toupper(firstName), ", ", 
          toupper(organization), ", ", 
          "Comments on Proposed Rule: Transparency in Poultry Grower Contracting and Tournaments, (Aug. 2022), ", "https://www.regulations.gov/comment/",  commentId, "."
          
        ), 
        citation = gsub("ANONYMOUS, ANONYMOUS, ", "ANONYMOUS, ", citation), 

        citation = gsub("NA, NA, |^NA, | NA, ", " ", citation), 
        citation = str_squish(citation)
      ) %>% 
      group_by(
        commentId,
            organization,
    NAME,
    orgname,
    citystate,
    # firstName, 
    # lastName, 
    # city, 
    # stateProvinceRegion, 
    receiveDate,
        citation

      ) %>% 
      summarise(
            linkfinal = paste( unique(linkfinal), collapse = "; "), 
                        comment = paste( unique(comment), collapse = "; "), 

                        contents = paste( unique(contents), collapse = "; ")
 
      ) %>% 
      ungroup()
          outputdoc <- read_docx()    |>
            body_add_toc()


  # list_of_docs <- list()
  while(i  <= nrow(current_text))
  {
    current_text_row <- current_text[i, ] %>% 
      mutate(
          contents = gsub(
      "Error in file", "", 
      htm2txt(contents)
    )
  ) %>% 
  mutate(
   across(everything(), ~gsub("NA, NA|^NA$", "", .x ))
  )

    
    current_comment_id <- current_text_row$commentId[1]
    # rm(outputdoc)
          
      outputdoc <- outputdoc    |>
             body_add_break() |>

  body_add_par(current_comment_id, style = "heading 1") 

    rm(j)
    j <- 1
    while(j <= length(outputparams))
    {
      if( j ==1)
      {
        orgname_current <-current_text_row$orgname[1]
        
              outputdoc <- outputdoc    |>
  body_add_par(orgname_current, style = "heading 2") 

      }
      
      outputparams_current <- outputparams[j]
      current_text_row_select <- current_text_row %>% 
        select(
           outputparams[j]
        )
      
colnames(current_text_row_select) <- "currentfield"
outputparams_current_text <- current_text_row_select$currentfield[1] %>% 
      htm2txt()%>% 
  gsub("NA, NA|^NA$", "", . )
  
  #     if(outputparams_current == "linkfinal")
  #     {
  #       linktext =              
  #         fpar(
  #                hyperlink_ftext(
  #                  text = htm2txt(outputparams_current_text),
  #                  # pos  = "after",
  #                  href = htm2txt(outputparams_current_text)
  #                )
  # 
  # 
  #              )
  # 
  #       
  #          outputdoc <-    outputdoc|>
  # 
  #      body_add_fpar(
  #        fpar(
  #  ftext(
  #        paste0(
  #          toupper(
  #            gsub(
  #              "contents", "attachment_text", 
  #              
  #              gsub(
  #                "linkfinal", "attachmentlink", 
  #                outputparams_current
  #              )
  #            ) 
  #          ), ": "
  #        ) , 
  #    prop = shortcuts$fp_bold(font.size = 14)
  #    ) 
  #  )#, 
  #     #   style = "Normal"
  #      ) |>
  #        # style = "Normal"
  #            body_add_fpar(
  #            #  fpar(
  #                linktext
  #                # hyperlink_ftext(
  #                #   text = outputparams_current_text, 
  #                #   # pos  = "after",
  #                #   href = outputparams_current_text
  #                # )
  #                
  #                
  #         #     )
  #            )
  #          
  # 
  #     }
  #   
  # if(outputparams_current != "linkfinal" )
  #     {
   outputdoc <-    outputdoc|>
       body_add_fpar(
         fpar(
   ftext(
         paste0(
           toupper(
             gsub(
               "contents", "attachment_text", 
               
               gsub(
                 "linkfinal", "attachmentlink", 
                 outputparams_current
               )
             ) 
           ), ": "
         ) , 
     prop = shortcuts$fp_bold(font.size = 14)
     ) 
   )#, 
      #   style = "Normal"
       ) %>% 
     body_add(
       outputparams_current_text#, style = "Normal"
     )
   
              
# 
#   }
    j <- j+1
     }
    
i <- i+1
  }
  print(outputdoc, target = paste0( output_folder, outputname) )
current_text %>% 
  mutate(
    contents = substr(contents, 1, 32766), 
    comment = htm2txt(comment), 
    contents = gsub(
      "Error in file", "", 
      htm2txt(contents)
    )
  ) %>% 
  mutate(
   across(everything(), ~gsub("NA, NA|^NA$", "", .x ))
  )%>% 
  writexl::write_xlsx(
    paste0( output_folder, gsub("docx","xlsx", outputname) 
  )
  )
  
  
}
comments_detail_df_pdf_seedretail %>% 
        filter(
        docketId == "AMS-FTPP-21-0044"
        # grepl("AMS-FTPP-21-0044",commentId, perl = TRUE )
      ) %>%
  # head() %>%

convert_to_doc_output(
  current_text =., 
  output_folder = "X:/msi/work/RFI/psa/regulations-public-comments/",
  outputname = "Rule_1_comments_and_attachments_14_citation.docx"
)

```

## standardize cropname func
```{r }
standardizenames_crop <- function(zz, whichcol_to_rename, croplistLUdf = croplistLU221126){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     croplistLUdf %>% 
       rename(
         Name = `Common Name`
       ) %>% 
       mutate(
         Name = str_squish(tolower(Name)), 
         shortname = str_squish(tolower(shortname)) 
       )%>% 
       group_by(
         Name,shortname
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     shortname = str_squish(tolower(shortname))
   ) %>% 
   rename(
     crop_shortname = shortname,
     crop_type = type,
     crop_type2 = type2
   )
 zz_df
}
```

```{r }
croplistLU221126 <- readxl::read_excel(
  "221123cropnameLU.xlsx"
) %>% 
  select(
    `Common Name`, shortname, type,type2
  ) %>% 
  distinct()

croplistLU221126 <- croplistLU221126 %>% 
  bind_rows(
     croplistLU221126 %>% 
       mutate(
         `Common Name` = shortname
       ) %>% 
       distinct()
      
  
  )

```

```{r }
patent_url  <- soycropquery_unnest_df  %>%  
  mutate(
    url = paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    )
  )%>%       
  select(
    patent_number, url
  )  %>% 
  distinct()
    alreadycompletedf_patent <- tibble(
      filelist = list.files(
       path = "X:/msi/work/farmer welfare/seed/Patents/writepatent",
        pattern = "feather",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".feather","", filelist )
      )
    set.seed(123)
    set.seed(123)
    
     
    narrowtoread_patent <- patent_url %>%
      mutate(
        registernum = patent_number
        #   gsub(
        #   ".*AdobeImages/|.pdf", "", url
        # )
      ) %>%
      filter(
        !registernum %in% c(alreadycompletedf_patent$alreadydone)#,
        # !is.na(patent_year)
      )  %>%
      group_by(
        registernum
      ) %>% 
      slice(1) %>% 
      ungroup() %>% 
      select(
        registernum, url
      )%>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    rownum = row_number(),
    assign = case_when(
      rownum <= (nrow(.)/2)~ "msi",
      TRUE ~ "asus"
    )
  )
```

### furrr function
```{r }
func_callpatentviewr_dl <- function(cropdf, typecomp = "msi", writefolderout = "X:/msi/work/farmer welfare/seed/PVP/writepvp", usedpidf = 200, numworker = 100, filesizemax = 20000) {
require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
  require(pdftools)
  options(future.globals.maxSize= 891289600)
require(tesseract)
  # cropdf = narrowtoread
  #  typecomp =c("msi", "asus")
  # writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent"
  # usedpidf = 200
#   callr(
# expr,
# envir = parent.frame(),
# substitute = TRUE,
# globals = TRUE,
# label = NULL,
# workers = availableCores(),
# ...
# )
require(future.callr)
  
  # cl <- makePSOCKcluster(detectCores() - 2)

plan("callr", workers =numworker)
  # require(patentsview)
  

    saferprocess_file <- function( currentk , writefolderoutdf, usedpidf_df) {
      # currentk ="https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/6127608"
      
# searchedpv_df <- suppressMessages(textreadr::read_pdf(
#          currentk,ocr = TRUE, trim = TRUE, dpi = usedpidf
#       )
# )
      
      searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
         currentk,  dpi =  usedpidf_df
      )
)

#             searchedpv_df <- suppressMessages(pdftools::pdf_ocr_text(
#           "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/10004195",  dpi =  usedpidf  
#       )
# )

# if( length(searchedpv_df)>=1)
# {
#   
# }
nameout <- gsub(
  ".*AdobeImages/|.pdf|.*downloadPdf/", "", currentk
)
tibble(
  text   =  searchedpv_df,
  patent_number = nameout
) %>% 
  group_by(
    patent_number
  ) %>% 
  summarise(
    text = paste(text,   collapse = " ")
  )  %>% 
  ungroup() %>%  
   feather::write_feather(
     paste0(
       # "X:/msi/work/farmer welfare/seed/Patents/writepatent/",
       writefolderout,"/",
       nameout,".feather"
     )
     
   )
# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/",
#        nameout,".feather"
#      )
# )

# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/200100164.feather"
#      )
# )

 # searchedpv_df
 # Sys.sleep(.1)
gc()
#   
    }
    
    safer_calc_dist <- possibly(
  saferprocess_file, 
  otherwise = 
    NA
)
    alreadycompletedf_func <- tibble(
      filelist = list.files(
        path = paste0(
          writefolderout
        ),

        pattern = "feather",
        full.names = FALSE

      )
    ) %>%
      mutate(
        alreadydone = gsub(".feather","", filelist ), 
        fullname_file = paste0(writefolderout,"/", filelist),
   filesize =      file.size( fullname_file  )
      ) %>% 
      filter(
        filesize >=filesizemax
      )
    set.seed(123)
    
    # cropdf  <-  pvp_url %>%  head(1)
  
    # dfsamp <- feather::read_feather("X:/msi/work/farmer welfare/seed/PVP/writepvp/201900258.feather")
    
    readthese_func <- cropdf %>% 
      filter(
        !registernum %in% c(alreadycompletedf_func$alreadydone)
      ) %>%
      filter(
         assign %in% c(typecomp ) 
      )
    
  #   narrowtoread <- cropdf %>%
  #     mutate(
  #       registernum = gsub(
  #         ".*AdobeImages/|.pdf", "", url
  #       )
  #     ) %>% 
  #     filter(
  #       !registernum %in% c(alreadycompletedf$alreadydone)
  #     ) #  %>% 
  # #   arrange(runif(n())) %>% # randomize the order
  # # mutate(
  # #   rownum = row_number(), 
  # #   assign = case_when(
  # #     rownum <= (nrow(.)/2)~ "msi", 
  # #     TRUE ~ "asus"
  # #   )
  # # )%>% 
  # # filter(
  # #  assign = typecomp
  # # )
  # 
  #   
    # sampledf   <- feather::read_feather("X:/msi/work/farmer welfare/seed/Patents/writepatent/10004195.feather")
    
   readthese_func %>%
     # head(1) %>% 
  mutate(
    topic_model = future_map(
    url, ~safer_calc_dist( 
      ., 
      writefolderoutdf = writefolderout, 
      usedpidf_df = usedpidf
     
    )#,  
      # seed    =  TRUE)
  ) 
  )
   
   # safer_calc_dist( 
   #    "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/10004195", 
   #    writefolderoutdf = writefolderout, 
   #    usedpidf_df = usedpidf
   #   
   #  )
    # cropdf_read
      
}
func_callpatentviewr_dl(cropdf = narrowtoread_patent,  typecomp = c("msi", "asus"), writefolderout = "X:/msi/work/farmer welfare/seed/Patents/writepatent", usedpidf = 200, numworker = 90 , filesizemax = 10000)
# func_callpatentviewr(cropdf = narrowtoread, c("msi", "asus") )
# func_callpatentviewr(cropdf = narrowtoread, c("msi", "asus") )

# searchedpv_df <- feather::read_feather(
#    paste0(
#        "X:/msi/work/farmer welfare/seed/PVP/writepvp/201800341.feather"
#      )
# )

```

# read in patent text
```{r }
patentpvp_text <-  tibble(
   
   filename = list.files(
        "X:/msi/work/farmer welfare/seed/Patents/writepatent",
        pattern = "feather",
        full.names = TRUE

      ) 
   )%>%
    mutate(
      dfcall = 
      purrr::map(filename, ~possibly(~feather::read_feather(.x),otherwise=NA)(.x)) 
    ) #%>% 

  patentpvp_text_unnest <- patentpvp_text %>% 
    unnest() %>%
      mutate(
        registernum = gsub(
          ".*AdobeImages/|.pdf|.*/|.feather", "", filename
        )#,
        # patent_number = case_when(
        #   patent_type == "PVP" & substr(1,2,registernum)=="00" ~ 
        # )
      ) %>% 
    group_by(
      registernum, filename
    ) %>% 
    summarise(
      text = paste(text, collapse = ". ")
    ) %>% 
    ungroup()

```


# combine patents with pvp

## helper functions
```{r }

## standardize cropname func
 
standardizenames_crop <- function(zz, whichcol_to_rename){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     croplistLU221126 %>% 
       rename(
         Name = `Common Name`
       ) %>% 
       mutate(
         Name = str_squish(tolower(Name)), 
         shortname = str_squish(tolower(shortname)) 
       )%>% 
       group_by(
         Name,shortname
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     shortname = str_squish(tolower(shortname))
   ) %>% 
   rename(
     crop_shortname = shortname,
     crop_type = type,
     crop_type2 = type2
   )
 zz_df
}
```

## combine
```{r }
pvp_230705 <- readxl::read_excel(
  "PVP/230614 PVPOApplicationStatus.xlsx"
) %>% 
  filter(
    !is.na(`Years Protected`)
  ) %>% 
  mutate(
    numstr = nchar(`Application #`),
    url = case_when(
      numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",`Application #`, ".pdf"), 
       numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",`Application #`, ".pdf")
      
      
    )
  ) %>% 
      mutate(
        crop = `Common Name`,
        patent_year =  as.integer(gsub(".*/", "", `Issued Date`)),
        # this step alters patent number to simply 
       patent_number = gsub(
          ".*AdobeImages/|.pdf", "", url
        ),
    abstract_title = paste0(
            
      `Variety Name`, ". ", `Experimental Name`, ". ", `Common Name` 
    )
  ) %>%  
      select(
        patent_number,  abstract_title, crop , patent_year, Applicant
      )%>%  
    distinct() %>% 
      mutate(
    patent_type = "PVP",
    patent_type_orig = "PVP"
  ) %>%

  standardizenames_crop(
    ., 
    whichcol_to_rename =.$crop 
    )%>%
   # select(
   #   -crop
   # )%>%
   # rename(
   #   # crop_spec = crop,
   #   crop = crop_type
   # )%>% 
    distinct() 

patent_pvp_combine_230705long <- soycropquery_unnest_df %>% 
  rename(
    Applicant = assignee_organization
  ) %>% 
  select(
    -gamma, -terms, -terms_tfidf, -topic, -rownum, -discard_byaoh
   # any_of(names(pvp_230705 ))
  )  %>%

  standardizenames_crop(
    ., 
    whichcol_to_rename =.$crop 
    )%>%
   # select(
   #   -crop
   # )%>%
   # rename(
   #   # crop_spec = crop,
   #   crop = crop_type
   # )%>% 
    distinct()%>% 
  
  mutate(rownum = row_number()) %>% 
  group_by(rownum)%>% 
  filter(
    grepl(crop_shortname , abstract_title, perl = TRUE, ignore.case =TRUE )
  ) %>% 
  ungroup() %>% 
 
  mutate(
    url = paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    ), 
    patent_type_orig = "patent"
  ) %>% 
  bind_rows(
    pvp_230705 %>% 
  mutate(
    numstr = nchar(patent_number),
    url = case_when(
      numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",patent_number, ".pdf"), 
       numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",patent_number, ".pdf")
      
      
    )
  ) %>% 
    select(
      -numstr
    )
  )%>% 
  group_by(
    patent_number, crop, Applicant
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(
    patent_decade =  lubridate::year(lubridate::round_date( as.Date(ISOdate(patent_year, 12, 31)), "10 years"))
  )
```

#### write out

```{R }

trunccatestr2 <- function(x){
  substr(x, 1,32766)
  
}

removenafunc <- function(x){
  # substr(x, 1,32766)
 str_squish(gsub("] NA|^NA$|. NA. |^NA]" ,"", x))
}

set.seed(123)
patent_pvp_combine_230705sample <- patent_pvp_combine_230705long %>%
  filter(
    crop_shortname  %in% c(
      "corn" , "soybean" , "lettuce", "potato"
    )
  ) %>% 
  group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    sample_prioritynum = row_number()
  ) %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type,  patent_decade, patent_number, url, Applicant,  abstract_title, everything()
  ) %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  ) %>% 
    ungroup() %>% 

  mutate_if(
    is.character, removenafunc
  ) %>% 
  cbind(
    tibble(
      start_claim_description_text ="", 
      stop_Claim_description_text = ""
    )
  )%>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, start_claim_description_text, stop_Claim_description_text, everything()
  )

writexl::write_xlsx(
   list(
     "sample_crops" = patent_pvp_combine_230705sample,
     "sheet2Name" = patent_pvp_combine_230705long %>% 
       inner_join(
         patent_pvp_combine_230705sample %>% 
           select(
             sample_prioritynum, crop_shortname,patent_type, patent_decade, patent_number, url
           )
       )  %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  )%>%
       bind_rows(
         patent_pvp_combine_230705long %>% 
           anti_join(
         patent_pvp_combine_230705sample %>% 
           select(
             crop_shortname,patent_type, patent_decade, patent_number, url
           ) 
       )
       ) %>% 
       
  mutate_if(
    is.character, trunccatestr2
  ) %>% 
   mutate_if(
    is.character, removenafunc
  )   %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, everything()
    ) %>% 
   rename(
   crop_origname =  crop 
   )
 ),
     "PVP/230705_patent_pvpcombine_sample_potato.xlsx"
  
)

set.seed(123)

patent_pvp_combine_230705long %>% 
  mutate_if(
    is.character, trunccatestr2
  ) %>% 
  
  writexl::write_xlsx(
    "PVP/230705_patent_pvpcombine.xlsx"
  )
patent_pvp_combine_230705 <- readxl::read_excel(
    "PVP/230705_patent_pvpcombine.xlsx"
  ) %>%  
  select(
    any_of(pvp_230705 %>% names())
  )
 

```

# Predict variety 

## test keras tensorflow
```{r }
# https://smltar.com/dldnn.html#kickstarter
kickstarter <-  read_csv(
  "https://github.com/EmilHvitfeldt/smltar/raw/master/data/kickstarter.csv.gz"
) 

pvppatent_combine <- readxl::read_excel(
    "PVP/230705_patent_pvpcombine.xlsx", 
      guess_max = 40000
  ) 

pvppatent_filter <- pvppatent_combine%>% 
  # f(
  #   patent_type_orig 
  # )
  filter(
    patent_type != "PVP" ,
    nchar(cpc_group_id ) >=3
  ) %>% 
  # mutate(
  #   nchar_cpc = nchar(cpc_group_id )
  # ) 
  left_join(
    patentpvp_text_unnest, 
    by = c("patent_number" = "registernum")
  ) %>% 
  mutate(
    blurb = paste0(abstract_title, ". ", text  ),
    created_at = as.Date(ISOdate(patent_year, 12, 31)) ,
    state = 
      case_when(
        
        grepl(
          "A01H6", cpc_subgroup_id, ignore.case = TRUE,
          perl = TRUE
        ) ~  1,
        TRUE ~ 0
      ) 
  ) %>% 
  select(
    blurb, 
    state, 
    created_at, 
    patent_number
  )

pvppatent_all <-pvppatent_combine%>% 
  # f(
  #   patent_type_orig 
  # )
  filter(
        patent_type != "PVP" ,
   !patent_number %in% c(pvppatent_filter$patent_number)
  ) %>% 
  # mutate(
  #   nchar_cpc = nchar(cpc_group_id )
  # ) 
  left_join(
    patentpvp_text_unnest, 
    by = c("patent_number" = "registernum")
  ) %>% 
  mutate(
    blurb = paste0(abstract_title, ". ", text  ),
    created_at = as.Date(ISOdate(patent_year, 12, 31)) ,
    state = 
      case_when(
        
        grepl(
          "A01H6", cpc_subgroup_id, ignore.case = TRUE,
          perl = TRUE
        ) ~  1,
        TRUE ~ 0
      ) 
  ) %>% 
  select(
    blurb, 
    state, 
    created_at, 
    patent_number
  )
```

```{r }
kickstarter <- pvppatent_filter# %>% 
  # select(
  #   -patent_number
  # )
kickstarter_full  <- pvppatent_all# %>% 
  # select(
  #   -patent_number
  # )
```

```{r }
  # rename(
  # blurb = abstract_title
  # )

library(tidymodels)
set.seed(1234)
kickstarter_split <- kickstarter %>%
  filter(nchar(blurb) >= 15) %>%
  initial_split()

kickstarter_train_patentnum <- training(kickstarter_split)
kickstarter_test_patentnum <- testing(kickstarter_split)

kickstarter_train <- kickstarter_train_patentnum %>% 
  select(-patent_number)
kickstarter_test <- kickstarter_test_patentnum%>% 
  select(-patent_number)

```

### dnn
```{r }
library(textrecipes)

max_words <- 2e4
max_length <- 30

# max_words <- 2e4
# max_length <- 30

kick_rec <- recipe(~ blurb  , data = kickstarter_train) %>%
  # update_role(patent_number, new_role = "id")  %>%
  step_tokenize(blurb) %>%
  step_tokenfilter(blurb, max_tokens = max_words) %>%
  step_sequence_onehot(blurb, sequence_length = max_length)
# kick_rec
kick_prep <-  prep(kick_rec)
kick_train <- bake(kick_prep, new_data = NULL, composition = "matrix")
kick_matrix <- bake(kick_prep, new_data = NULL, composition = "matrix")

# kick_full <- 
```


```{r }
require(tidymodels)
set.seed(234)
kick_val <- validation_split(kickstarter_train, strata = state)

kick_analysis <- bake(kick_prep, new_data = analysis(kick_val$splits[[1]]),
                      composition = "matrix")
kick_assess <- bake(kick_prep, new_data = assessment(kick_val$splits[[1]]),
                    composition = "matrix")
```

```{r }

state_analysis <- analysis(kick_val$splits[[1]]) %>% pull(state)
state_assess <- assessment(kick_val$splits[[1]]) %>% pull(state)
```

```{r }
require(keras)

final_mod <- keras_model_sequential() %>%
  layer_embedding(input_dim = max_words + 1, output_dim = 16,
                  input_length = max_length) %>%
  layer_conv_1d(filter = 32, kernel_size = 7,
                strides = 1, activation = "relu") %>%
  layer_global_max_pooling_1d() %>%
  layer_dense(units = 64, activation = "relu") %>%
  layer_dense(units = 1, activation = "sigmoid")
final_mod %>%
  compile(
    optimizer = "adam",
    loss = "binary_crossentropy",
    metrics = c("accuracy")
  )

final_history <- final_mod %>%
  fit(
    kick_matrix,
    kickstarter_train$state,
    epochs = 10,
    validation_split = 0.1,
    batch_size = 512,
    verbose = FALSE
  )
```

```{r }
library(dplyr)

keras_predict <- function(model, baked_data, response) {
  predictions <- predict(model, baked_data)[, 1]
  tibble(
    .pred_1 = predictions,
    .pred_class = if_else(.pred_1 < 0.5, 0, 1),
    state = response
  ) %>%
    mutate(across(c(state, .pred_class),            ## create factors
                  ~ factor(.x, levels = c(1, 0))))  ## with matching levels
}

# val_res <- keras_predict(simple_cnn_model, kick_assess, state_assess)
# val_res

```


```{r }
kick_matrix_test <- bake(kick_prep, new_data = kickstarter_test,
                         composition = "matrix")
final_res <- keras_predict(final_mod, kick_matrix_test, kickstarter_test$state)
final_res %>% metrics(state, .pred_class, .pred_1)

final_res %>%
  conf_mat(state, .pred_class) %>%
  autoplot(type = "heatmap")
```
```{r }
kickstarter_full_nchar15 <- kickstarter_full %>%
  filter(nchar(blurb) >= 15) %>% 
  select(
    -patent_number
  )

kick_matrix_full <- bake(kick_prep, new_data = kickstarter_full_nchar15,
                         composition = "matrix")
final_res_full  <- keras_predict(final_mod,kick_matrix_full, kickstarter_full_nchar15$state)
# final_res %>% metrics(state, .pred_class, .pred_1)

# final_res_full %>%
#   conf_mat(state, .pred_class) %>%
#   autoplot(type = "heatmap")

final_matchings <- final_res_full %>% 
  cbind(
    kickstarter_full %>% 
      select(patent_number) 
  ) %>% 
  mutate(
    # keras_predict = 
    #   
    #   paste0(
    #     "predict", 
    #     gsub(
    #       "0", "_not_variety.cultivar.related", 
    #       gsub(
    #       "1", "_yes_variety.cultivar.related",   .pred_class
    #       )
    #         
    #       )
    #     
    #   ), 
    ifcpc_A01H6_known = "unknown", 
    valueuse_ifcpc_A01H6 = as.numeric(as.character(.pred_class)), 
    keras_predict = "predicted"
  ) %>% 
  mutate(
    state = as.numeric(as.character(state))#, 
    # valueuse_ifcpc_A01H6 
  )%>% 
  bind_rows(
    kickstarter_train_patentnum %>% 
      mutate(
        keras_predict = "train", 
        valueuse_ifcpc_A01H6 =state, 
        ifcpc_A01H6_known = "known" 
      ) %>% 
      select(-state) %>% 
      
      bind_rows(
        kickstarter_test_patentnum %>% 
          cbind(
            final_res %>% 
              select(
                .pred_class, .pred_1
              )
          ) %>% 
      mutate(
        keras_predict = "test", 
        valueuse_ifcpc_A01H6 =state, 
        ifcpc_A01H6_known = "known" , 
        .pred_class = .pred_class 
      )
      )%>% 
      mutate(
       ifcpc_A01H6_known = "known"
      )
  ) %>% 
  select(
        keras_predict, 
        valueuse_ifcpc_A01H6 , 
        ifcpc_A01H6_known , 
        .pred_1, 
        .pred_class,
        patent_number
  )
final_matchings %>% 
  writexl::write_xlsx(
    "R analysis/230720 deeplearn if cultivar/230720_finalmatchings.xlsx"
  )
```

## write out xlsx and sample

```{r }
pvppatent_combine_url <- pvppatent_combine %>% 
 
  mutate(
        numstr = nchar(patent_number),
        patent_type_orig = 
          case_when(
        patent_type == "PVP" ~ "PVP", 
        TRUE ~ "Patent"
          ),
    url =
      case_when(
        patent_type == "PVP" & numstr == 9 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/",patent_number, ".pdf"), 
         patent_type == "PVP" & numstr == 7 ~ paste0("https://apps.ams.usda.gov/CMS//AdobeImages/","00",patent_number, ".pdf"), 
        TRUE ~ 
        paste0(
      # "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      "https://image-ppubs.uspto.gov/dirsearch-public/print/downloadPdf/", 
      patent_number
      
    ) 
      ), 
   patent_decade = lubridate::year(lubridate::round_date( as.Date(ISOdate(patent_year, 12, 31)), "10 years"))
  ) %>% 

    select(
      -numstr
    ) %>% 
  left_join(
    final_matchings, 
    by = c("patent_number")
  ) 
   
```

#### sample

##### runif
```{r }
set.seed(123)
pvppatent_combine_url_runif <- pvppatent_combine_url %>%
  filter(
    crop_shortname  %in% c(
      "corn" , "soybean" , "lettuce", "potato"
    )
  ) %>% 
  group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
    arrange(runif(n())) %>% # randomize the order
  mutate(
    sample_prioritynum = row_number()
  ) %>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type,  patent_decade, patent_number, url, Applicant,  abstract_title, `keras_predict`:`.pred_class`, everything()
  ) %>% 
  arrange(
 patent_type, crop_shortname , patent_decade,sample_prioritynum
  ) %>% 
    ungroup() %>% 

  mutate_if(
    is.character, removenafunc
  ) %>% 
    mutate_if(
    is.character, trunccatestr2
  ) %>% 

  # cbind(
  #   tibble(
  #     start_claim_description_text ="", 
  #     stop_Claim_description_text = ""
  #   )
  # )%>% 
  select(
   sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, everything()
  )


```

##### sample 5
```{r }
pvppatent_combine_url_sample5 <- pvppatent_combine_url_runif %>% 
  filter(
    (valueuse_ifcpc_A01H6 == 1)|(patent_type_orig == "PVP")
  ) %>% 
    group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
  slice(1:20) %>%
  ungroup()  %>%
      group_by(
    crop_shortname, patent_decade, patent_type_orig
  ) %>% 
mutate(
  crop_decade_patenttype_rownum = str_pad( row_number(), width = 4, "left", "0")
) %>%
  ungroup() %>%
  cbind(
    tibble(
      start_claim_description_text ="",
      stop_Claim_description_text = ""
    )
    ) %>%
  select(
   crop_decade_patenttype_rownum, sample_prioritynum, crop_shortname,patent_type_orig,patent_type, patent_decade, patent_number, url, start_claim_description_text,stop_Claim_description_text,  everything()
  )

```

```{r }
writexl::write_xlsx(
   list(
     "sample_crops" = pvppatent_combine_url_sample5,
     "sheet2Name" = pvppatent_combine_url_runif ),
     "230720_patent_pvpcombine_sample.xlsx"
  

)

```

```{r }

downloadpatentspdffunc(dlpatents_df = pvppatent_combine_url_sample5, dlpatents_outputfolder = "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/download patents pvps/230720 sample 10" , dlpatentsnumworker = 90)
```


# merger inclusion

## read merger data
```{r }
mergerdata220918 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
) %>% 
  mutate(
    acquired_clean =toupper(cleantext_text(Firm_acquired) ) , 
    acquirer_clean = toupper(cleantext_text(Firm_acquirer) )
  )

```

## create merger list

```{r }
lu_conames220917 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220915 rename Lu seed cos.xlsx", sheet = "final LU Seeds w table - acquis"
) %>% 
  mutate(
    Name = toupper(cleantext_text(Name) ) , 
    Namestandard = toupper(cleantext_text(Namestandard) )
  ) %>% 
  distinct()
lu_conames_out230705_match <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/230706 rename Lu seed cos.xlsx", 
  range = cell_cols("A:D")
) %>% 
  filter(nchar(Applicant)>=2) %>% 
  mutate(
    Applicant = toupper(cleantext_text(Applicant) ) , 
    Namestandard = toupper(cleantext_text(Namestandard) )
  ) %>% 
  distinct()

```

```{r }


lu_conames_out230705  <- patent_pvp_combine_230705 %>% 
  select(
    Applicant,patent_type, patent_number, patent_year, crop
  ) %>% 
  mutate(
    Applicant = toupper(cleantext_text(Applicant) ) 
  ) %>% 
  group_by(
    Applicant
  ) %>% 
  mutate(
    total_patent_number = length(unique(patent_number))
  )%>% 
  group_by(
    Applicant,crop, patent_year, total_patent_number
  ) %>% 
  summarise(
    numpatent_year =length(unique(patent_number ))
  ) %>% 
  ungroup() %>%  
  mutate(
    patent_info = paste0(crop, " ", patent_year," " ,  numpatent_year)
  ) %>% 
  group_by(
    Applicant, total_patent_number
  ) %>% 
  summarise(
    patent_info = paste(patent_info %>% unique(), collapse = "; ")
  ) %>% 
  ungroup()  %>% 
  bind_rows(
    mergerdata220918 %>% 
      select(
        contains("_clean" )
      )  %>% 
      gather(
       key =  key, 
       value = Applicant, 
       contains("_clean" )
      ) %>% 
      select(
        Applicant
      )
  ) %>% 
  group_by(
    Applicant
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  # 
  # group_by(
  #   Applicant
  # ) %>% 
  # summarise(
  #   numpatent = length(unique(patent_number ))
  # ) %>% 
  # ungroup() %>% 
  left_join(
    lu_conames_out230705_match ,
    by = c("Applicant" = "Applicant")
      
  ) %>% 
  arrange(
    Applicant
  ) %>% 
  distinct()
  # lu_conames_out230705 %>% 
  #   select(
  #     Applicant, Namestandard, everything()
  #   )%>% 
  #   writexl::write_xlsx(
  #      "X:/msi/work/farmer welfare/seed/230706 rename Lu seed cos.xlsx"
  # 
  #        )
  
    lu_conames_out230705 %>% 
    select(
      Applicant, Namestandard, everything()
    )%>% 
    writexl::write_xlsx(
       "X:/msi/work/farmer welfare/seed/230707 rename Lu seed cos.xlsx"
    )

  
  
  
```

```{r }
require(readxl)
  lu_conames_out230705_match <- readxl::read_excel(
     "X:/msi/work/farmer welfare/seed/230707 rename Lu seed cos.xlsx", 
      range = cell_cols("A:D")
  ) %>% 
  filter(nchar(Applicant)>=2)
 
  lu_conames_out230705_match <- lu_conames_out230705_match   %>% 
  bind_rows(
    # this helps put the namestandard as a lookup
    lu_conames_out230705_match %>% 
      select(
        Namestandard
      ) %>% 
      mutate(
        Applicant = Namestandard
      )
      
  ) %>% 
    select(
      Applicant, Namestandard
    )%>% 
  distinct()
  


```

## standardize firm name func
```{r }
standardizenames_companies <- function(zz, whichcol_to_rename, luconames_df = lu_conames_out230705_match){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     luconames_df%>% 
       mutate(
         Name = str_squish(tolower(Applicant))
       )%>% 
       group_by(
         Applicant
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     Namestandard = str_squish(toupper(Namestandard))
   )
 zz_df
}

```

### import merger data
```{r }

mergerdata220918 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
)%>% 
  mutate(
    acquired_clean =toupper(cleantext_text(Firm_acquired) ) , 
    acquirer_clean = toupper(cleantext_text(Firm_acquirer) )
  )%>% 
  mutate(
    idcol = paste0("merge", str_pad(string =row_number(), width = 5, pad = "0"))
  )
```

```{r }



mergerdata220918_names <- mergerdata220918 %>% 
  standardizenames_companies(., whichcol_to_rename =.$acquirer_clean  )%>%
  rename(
    # namestandard_acquirer_lower = renamedcol,
    namestandard_acquirer= Namestandard
  ) %>% 
  standardizenames_companies(., whichcol_to_rename = .$acquired_clean  )%>%
  rename(
    # namestandard_acquired_lower = renamedcol,
    namestandard_acquired= Namestandard
  ) %>% 
  filter(
    # grepl(Column2,"yes", ignore.case = TRUE),
    # !is.na(Column2)
    tolower(Column2)=="yes"
  ) 

mergerdata220918_names  %>% 
  filter(
   (is.na(namestandard_acquirer) )|(is.na(namestandard_acquired) )
  ) %>% 
  select(
    contains("standard_"), everything()
  )%>% 
  View()

```



## standardize cropname func
```{r }
standardizenames_crop <- function(zz, whichcol_to_rename){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     croplistLU221126 %>% 
       rename(
         Name = `Common Name`
       ) %>% 
       mutate(
         Name = str_squish(tolower(Name)), 
         shortname = str_squish(tolower(shortname)) 
       )%>% 
       group_by(
         Name,shortname
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     shortname = str_squish(tolower(shortname))
   ) %>% 
   rename(
     crop_shortname = shortname,
     crop_type = type,
     crop_type2 = type2
   )
 zz_df
}
```

## standardize name func
```{r }
standardizenames_companies <- function(zz, whichcol_to_rename){
 zz_df <- zz %>% 
  cbind(
    tibble(
      renamedcol = whichcol_to_rename
    )
  ) %>% 
   mutate(
     renamedcol = str_squish(tolower(renamedcol))
   )%>% 
   left_join(
     lu_conames220917%>% 
       mutate(
         Name = str_squish(tolower(Name))
       )%>% 
       group_by(
         Name
       ) %>% 
       slice(1)%>% 
       ungroup() ,
     by = c(
       "renamedcol" = "Name"
     )
   ) %>%   
   select(
     -renamedcol
   ) %>% 
   # mutate(
   #   Namestandard = 
   #     case_when(
   #       !is.na(Namestandard) ~ Namestandard ,
   #       TRUE ~ "name not found"
   #     )
   # ) %>% 
   mutate(
     # renamedcol = str_squish(toupper(Namestandard)),
     Namestandard = str_squish(toupper(Namestandard))
   )
 zz_df
}

```

## any names not captured
```{r }
extracted <- soycropquery_unnest_df_likelyplants_themed %>% 
  filter(
   !assignee_organization %in% c(
     lu_conames220917$Name
   )
  ) %>% 
  select(
    assignee_organization, everything()
  ) %>% 
  group_by(
    assignee_organization
  ) %>% 
  slice(1) %>% 
  ungroup()

```

## rename patent data
```{r }
## not needed bc renamed in soycropquery_unnest_df_likelyplants_themed <- 
# soycropquery_unnest_df_likelyplants_themed_rename <- soycropquery_unnest_df_likelyplants_themed %>% 
#   select(
#     assignee_organization, everything()
#   ) %>% 
#   mutate(
#     assignee_organization = replace_na(assignee_organization, "blank")
#   )%>% 
#   standardizenames_companies(., whichcol_to_rename =.$assignee_organization  )

```


## correct merger data
### import merger data
```{r }

mergerdata220918 <- readxl::read_excel(
  "X:/msi/work/farmer welfare/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
)

mergerdata220918 <- readxl::read_excel(
  "C:/Users/Jeffrey.Nian/Documents/Comp/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
)
mergerdata220918 <- readxl::read_excel(
  "D:/seed/220914 seed acquisitions.xlsx", 
  sheet = "Sheet1"
  
)

mergerdata220918 <- mergerdata220918 %>% 
  mutate(
    idcol = paste0("merge", str_pad(string =row_number(), width = 5, pad = "0"))
  )

mergerdata220918_names <- mergerdata220918 %>% 
  standardizenames_companies(., whichcol_to_rename =.$Firm_acquirer  )%>%
  rename(
    # namestandard_acquirer_lower = renamedcol,
    namestandard_acquirer= Namestandard
  ) %>% 
  standardizenames_companies(., whichcol_to_rename = .$Firm_acquired  )%>%
  rename(
    # namestandard_acquired_lower = renamedcol,
    namestandard_acquired= Namestandard
  ) %>% 
  filter(
    # grepl(Column2,"yes", ignore.case = TRUE),
    # !is.na(Column2)
    tolower(Column2)=="yes"
  ) 

  # left_join(
  #   lu_conames220917 %>% 
  #     group_by(
  #       Name
  #     ) %>% 
  #     slice(1)%>% 
  #     ungroup(), 
  #   by = c("Firm_acquirer" = "Name")
  # ) %>% 
  # rename(
  #   Firm_acquirer_standard = Namestandard
  # )%>% 
  # left_join(
  #   lu_conames220917%>% 
  #     group_by(
  #       Name
  #     ) %>% 
  #     slice(1)%>% 
  #     ungroup(), 
  #   by = c("Firm_acquired" = "Name")
  # )  %>% 
  # rename(
  #   Firm_acquired_standard = Namestandard
  # )
```

### find if there were any acquirerers that got acwuirte
```{r }
mergerdata220918_gotmerged <- mergerdata220918_names  %>% 
  filter(
    !is.na(Column2)
  ) %>% 
  group_by(
    namestandard_acquirer_lower, namestandard_acquired_lower 
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(
    namestandard_acquired_lower %in% mergerdata220918_names$namestandard_acquirer_lower
  ) #%>% 
  # mutate(
  #   
  # )
  # group_by(
  #   
  # )
mergerdata220918_twoname_peryear <- mergerdata220918_names %>% 
  filter(
    !is.na(Column2)
  ) %>% 
  group_by(
    namestandard_acquirer_lower, namestandard_acquired_lower
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  group_by(
    namestandard_acquired_lower, Year
  ) %>% 
  mutate(
    times_occurring = n()
  ) %>% 
  filter(
    times_occurring >=2
  )

```

## func to find lU 

### func expand numrows in id
```{r }
func_expand_duprows_in_id <- function(x_expand_df, whichcolisid, prefix){
 # x_expand_df <- whichgetacquired_rename_withpast_direct 
 # whichcolisid<- x_expand_df$col_id_new2
 # prefix<- "dup"
 x_expand_df_expo_pre <- x_expand_df %>% 
   cbind(
     tibble(
       col_whichcolisid =whichcolisid
     )
   ) %>% 
   group_by(col_whichcolisid, ground_year) %>% 
   mutate(
     howmany = length(unique(col_acquirer_new))
   ) %>% 
   ungroup() %>% 
   group_by(
     col_whichcolisid
   ) %>% 
   mutate(
     max_number = max(howmany)
   ) %>% 
   ungroup()
 # x_expand_df_expo_pre %>% 
 #   filter(col_crop =="blueberry") %>% 
 #   arrange(
 #     col_id_new2, ground_year
 #   ) %>% 
 #   View()
 x_expand_df_expoed <- x_expand_df_expo_pre %>% 
   filter(howmany  <max_number ) %>% 
   slice(rep(row_number(), max_number))
  
  x_expand_df_expoed_reid <- x_expand_df_expo_pre %>% 
    bind_rows(
      x_expand_df_expoed  
    ) %>% 
    group_by(
      col_whichcolisid, ground_year
    ) %>% 
    arrange(
      col_acquirer_new
    ) %>% 
    mutate(
      col_whichcolisid_new = 
        case_when(
          max_number >=2 ~  paste0(col_whichcolisid ,prefix, row_number() ), 
          TRUE ~ paste0(col_whichcolisid)
        )
       
    ) %>% 
    ungroup() %>% 
    select(
      col_whichcolisid_new, everything(),-howmany, -max_number #,
      # c("col_whichcolisid_new", names(x_expand_df))
    )
    x_expand_df_expoed_reid

  
}

```

### func split row by semicolon
```{r }
splitrowbysemicolon <- function(x_splitrowdf, df_with_names_splitrowdf, whichcoltotrans, if_id_col= "no", currentit = 0, prefix = ""){
 outputthisdf <- x_splitrowdf %>% 
    mutate(
      temprowid = row_number()
             
           ) %>% 
    cbind(
      tibble(
      coltotrans=  whichcoltotrans
      )
    ) %>% 
           group_by(
             temprowid
             # col_crop, col_id, ground_year, newnametemp
           ) %>% 
           mutate(
             coltotransnew =  paste(sort(unique(coltotrans ),decreasing = TRUE) , collapse = "; ")
             
           ) %>%
           ungroup() %>% 
           separate_rows(coltotransnew, sep = "; ") %>%
           group_by_at(
             c("temprowid",  names(df_with_names_splitrowdf) )
           ) %>%
           summarise(coltotrans = paste(sort(unique(coltotransnew),decreasing = TRUE), collapse = "; "))%>%
           ungroup() %>% 
           select(
             -temprowid 
           )
  
  if(   if_id_col == "yes") 
 {
    outputthisdf <- outputthisdf%>% 
      # group_by(
      #   coltotrans, ground_year, col_acquirer_new, col_acquired
      # ) %>% 
      # slice(1) %>% 
      # ungroup() %>% 
      # group_by(
      #   coltotrans, ground_year
      # )%>% 
      # arrange(
      #   col_acquirer_new
      # ) %>% 
      mutate(
        coltotrans = paste0("{", currentit,prefix,  "}",  coltotrans)

        # coltotrans = paste0("{", currentit,"-", row_number(), "}",  coltotrans)
      ) %>% 
      ungroup()
  } 
 outputthisdf
}

```

## do it by year func
```{r }
# go up in years; if there was change that year, then change temp df and go up. Change name permanently. 
list_of_sendthrus <- list()
list_of_sendthrus <- sendthroughmergers_LUlist

findparentcompanyfunc_LU <- function(x,acquirercol, acquiredbycol,cropcol,  yearcol,idcol, df_patents,filenamergename = "221119try", minyear = 1970, maxyear = 2022, folderoutname =  "221119_merge" , sendcroplist = croplistLU221126  ){
 
  x = mergerdata220918_names
  acquirercol = mergerdata220918_names$namestandard_acquirer
  acquiredbycol = mergerdata220918_names$namestandard_acquired
  cropcol = mergerdata220918_names$Crop
  yearcol = mergerdata220918_names$Year
  idcol = mergerdata220918_names$idcol
  filenamergename = "221119try"
  folderoutname = "221119_merge"
  minyear = 1970
  maxyear = 2022
  df_patents = soycropquery_unnest_df_likelyplants_themed_short  %>%
    mutate(
      acquired_all_rowid = row_number()
    )
  # tickerflag = 0
      sendcroplist = croplistLU221126
  x_df <- x %>% 
    cbind(
      tibble(
        col_acquirer = acquirercol
      ),
      tibble(
        col_acquired = acquiredbycol
      ), 
      tibble(
        col_year = yearcol
      ), 
      tibble(
        col_crop = cropcol
      ),
      tibble(
        col_id = idcol
      )
    )%>% 
    
  group_by(
    col_acquirer, col_acquired , col_year, col_id, col_crop
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(
    Column2== "Yes",
    col_acquirer !=col_acquired 
  )# %>% 
    # group_by(
    #   col_acquired , col_year, col_id, col_crop
    # ) %>% 
    # mutate(
    #   col_id = paste0
    # )
  
  x_df2 <- x_df %>% 
    select(
      col_acquirer, col_acquired , col_year, col_crop,col_id
  )
    
  

  

  # lucrossing <- crossing(
  #   year_ground = minyear:maxyear,
  #   firmname = c(acquirercol,acquiredbycol )%>% unique(),
  #   crop =  c(
  #     df_patents$crop%>% unique(),
  #     (x_df %>% filter(!is.na(col_crop)))$col_crop %>% unique()
  # 
  #   )
  # )%>%
  #   distinct()
  
   
  
  currentyearmergers_cross_allyears_pre <- crossing(
    col_crop =c(
      sendcroplist$shortname %>% unique(), 
      (x_df %>% 
         filter(!is.na(col_crop)))$col_crop
    ) %>% unique()
  )%>% 
    mutate(
      joincol = "join"
    ) %>% 
    left_join(
      x_df2 %>% 
        filter(
          is.na(col_crop) 
        ) %>% 
        select(
          col_acquirer, col_acquired ,col_year, col_id
        ) %>% 
        distinct() %>% 
        mutate(
          joincol = "join"
        ),
      by = c("joincol")
    ) %>% 
    bind_rows(
      x_df2 %>% 
        filter(
          !is.na(col_crop) 
        ) %>% 
        select(
          col_acquirer, col_acquired , col_crop,col_year, col_id
        )
    ) %>% 
    select(
      -joincol
    ) %>% 
    group_by(
      col_acquirer, col_acquired , col_crop ,col_year, col_id
    ) %>% 
    slice(1) %>% 
    ungroup()%>% 
    mutate(
      col_id = paste0(col_id, "]", col_crop)
    ) 
  
currentyearmergers_cross_allyears<-   currentyearmergers_cross_allyears_pre%>% 
    group_by(
      col_acquirer, col_acquired , col_crop ,col_year, col_id
      )%>%
    mutate(
      repnum = 2022 - min(col_year) +1
    ) %>% 
     slice(rep(row_number(), repnum)) %>% 
  mutate(
    # rownum = row_number(),
    ground_year = row_number()-1 + col_year
  ) %>% 
  ungroup() %>% 
  select(
    -repnum
  ) 


#### examine
# soycropquery_merger_stone <- currentyearmergers_cross_allyears %>% 
#   filter(
#     grepl("advanta", col_acquired,ignore.case = TRUE, perl = TRUE)
#   ) %>%  
#       arrange(
#        col_crop,ground_year 
#      )  

     #%>% 
    # filter(
    #   grepl("stonevill", col_acquired, ignore.case=TRUE)
    # )
  
  
  # lucrossingtemp <- lucrossing
i <-1
maxyear = 2022

yearsgothru = c(minyear:maxyear) %>% unique() %>% sort()
# tickerflag = 0
# sendthroughmergers_LU <- feather::read_feather(
#   "X:/msi/work/farmer welfare/seed/R analysis/merger/221105_merged_2001.feather"
# )
# i <-
rm(list_of_sendthrus)
list_of_sendthrus <- list()
  while(i <= length(yearsgothru))
  {
    currentyear = yearsgothru[i]
    # #remove this
    # currentyear <- 1987
    # i <- which(yearsgothru == currentyear)
    
    #
    if(i ==1)
    {
      list_of_sendthrus[[i]] <- currentyearmergers_cross_allyears %>% 
        mutate(
          #need to change name of acquirer 
          col_acquirer_new = col_acquirer, 
          col_acquired_new = col_acquired,
          col_id_new = col_id
        ) %>% 
        # group_by(
        #   col_crop, col_acquirer
        # ) %>% 
        mutate(
          old_acquirer = 
            paste0(
              col_year,"-", col_acquirer,"-",col_acquired
            ),
          newnametemp = old_acquirer
          
          
          # paste0(min(col_year), "-",col_acquirer )
        ) %>% 
        ungroup() 
      list_of_sendthrus[[i]] <- list_of_sendthrus[[i]] %>% 
        distinct() #%>% 
      # mutate(
      #   rowid_original = row_number()
      # )
      
      # sendthroughmergers_LU_current <- sendthroughmergers_LU %>% 
      #   filter(col_year == currentyear)
    }
    # if(i >1)
    # {
    #   sendthroughmergers_LU_current <- sendthroughmergers_LU %>% 
    #     filter(col_year == currentyear)
    # }
    # list_of_sendthrus[[i]]  <-  list_of_sendthrus[[i]]   %>% 
    # mutate(
    #   currentrowid = row_number()
    # )
    sendthroughmergers_LU_current <- list_of_sendthrus[[i]] %>% 
      filter(col_year == currentyear, ground_year == currentyear) # %>% 
    # mutate(
    #   currentrowid = row_number()
    # )
    
    # sendthroughmergers_LU_current %>% 
    #   filter(
    #     col_crop == "blueberry", 
    #     col_acquired == "STONEVILLE PEDIGREED SEED"
    #   )
    #     list_of_sendthrus[[i]] %>% 
    #   filter(
    #     col_crop == "blueberry", 
    #     col_acquired == "STONEVILLE PEDIGREED SEED"
    #   ) %>% 
    #       View()

    
    if(nrow(sendthroughmergers_LU_current)<1)
    {
      rm(sendthroughmergers_LU_current)
      list_of_sendthrus[[i+1]] <- list_of_sendthrus[[i]]
      i <-i+1
      next
    }
# 
#     if(currentyear == 2018)
#     {
#       break
#     }

    # if(!nrow(sendthroughmergers_LU_current)<1)
    # {
    #   break    }
    # # if(nrow(sendthroughmergers_LU_current)>=1)
    # {
    #   # i <-i+1
    #   break
    # }
    # 
    # currentyearmergers <- x_df2 %>%
    #     filter(col_year == currentyear)
    
    # 
    # currentyearmergers_cross <- sendthroughmergers_LU_current %>% 
    #   filter(
    #     col_year == 
    #   )
    #   currentyearmergers_cross <- crossing(
    #     col_crop = lucrossing$crop %>% unique()
    #   )%>% 
    #     mutate(
    #       joincol = "join"
    #     ) %>% 
    #     left_join(
    #       #first create a frame with all crops and mergers that year
    #       sendthroughmergers_LU_current %>% 
    #         filter(
    #           is.na(col_crop) 
    #         ) %>% 
    #         select(
    #           name_new, col_acquired 
    #         ) %>% 
    #         mutate(
    #           joincol = "join"
    #         ),
    #       by = c("joincol")
    #     ) %>% 
    #     #bind it to those where we have specific crop
    #     bind_rows(
    #       sendthroughmergers_LU_current %>% 
    #         filter(
    #           !is.na(col_crop) 
                                                                                                                                                                                                                                    #         ) %>% 
    #         select(
    #           name_new, col_acquired , col_crop 
    #         )
    #     ) %>% 
    #     select(
    #       -joincol
    #     ) %>% 
    #     mutate(
    #       col_year = currentyear
    #     ) %>% 
    #     group_by(
    #       name_new, col_acquired , col_crop ,col_year
    #     ) %>% 
    #     slice(1) %>% 
    #     ungroup()
    
    
    # sendthroughmergers_LUnew <-  sendthroughmergers_LU %>% 
    #  filter(col_year > currentyear) %>% 
    #   filter(
    #     col_acquirer %in% c(sendthroughmergers_LU_current$col_acquired)
    #   )
    # 
    # sendthroughmergers_LUnew %>% filter(grepl("cal", col_acquirer, ignore.case=TRUE)) %>% View()
    
    # change those upstream     
    sendthroughmergers_LU_current_edit_pre <- sendthroughmergers_LU_current %>% 
      mutate(
        newnametemp = 
          case_when(
            col_acquirer_new == col_acquirer ~   paste0(
              col_year,"-", col_acquirer,"-",col_acquired
            ), 
            TRUE ~ paste0(
              col_year,"-", col_acquirer_new,"-",col_acquirer,"-",col_acquired
            )
          )  ,
        old_acquirer = newnametemp
      ) 
    
    
      ###   needs   to  be a checker THAT CHECKS IF THose within that year are acquired in that year. If yes, then changes over; if there are those that get acquired later, then retains those and makes duplicate 
  
  check_if_sameyear_acquired<-sendthroughmergers_LU_current_edit_pre  %>% 
    inner_join(
      sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        ) %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop","col_acquirer_new" )
    ) 
    check_if_sameyear_acquirer <-sendthroughmergers_LU_current_edit_pre %>% 
    inner_join(
      sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquirer_new
        ) %>% 
        rename(
          col_acquired  =col_acquirer_new
        ) %>% 
        distinct(),
      by = c("col_crop", "col_acquired" )
    ) %>% 
      anti_join(
        sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        )  %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop", "col_acquirer_new" )
      )

  if(nrow(check_if_sameyear_acquired) >= 1)
  {
    sendthroughmergers_LU_current_edit_replaceacquired <- 
      check_if_sameyear_acquired %>% 
      rename(
        col_acquirer_new1 = col_acquirer_new
      ) %>% 
      inner_join(
        check_if_sameyear_acquirer %>% 
          rename(
             newnametemp2 =  newnametemp
          ) %>% 
          select(
            col_acquirer_new, col_acquired, col_crop,  newnametemp2
          ) %>% 
          distinct(), 
        by = c("col_acquirer_new1" = "col_acquired", "col_crop")
      ) %>% 
      mutate(
         newnametemp =  paste0 ( newnametemp,"; " , newnametemp2)
      ) %>% 
      select(
        -newnametemp2, -col_acquirer_new1
      ) 
      
    
    sendthroughmergers_LU_current_edit_withfuture <- sendthroughmergers_LU_current_edit_pre%>% 
      filter(
        !col_id_new %in% c(sendthroughmergers_LU_current_edit_replaceacquired$col_id_new)
      ) %>% 
      
      bind_rows(
       sendthroughmergers_LU_current_edit_replaceacquired, 
        
        check_if_sameyear_acquired%>% 
          inner_join(
            x_df2 %>% 
              filter(col_year >currentyear) %>% 
              select( 
                col_crop, col_acquired
              ) %>% 
              rename(
                col_acquirer_new = col_acquired
              ) %>% 
              distinct(),
            by = c("col_crop", "col_acquirer_new"  )
          )
      ) %>% 
      anti_join(
        sendthroughmergers_LU_current_edit_pre %>% 
        select(
          col_crop, col_acquired
        )  %>% 
        rename(
          col_acquirer_new = col_acquired
        )%>% 
        distinct(),
      by = c("col_crop", "col_acquirer_new" )
      )
    
    
    sendthroughmergers_LU_current_edit_withfuture_dup <- sendthroughmergers_LU_current_edit_withfuture%>% 
      group_by(
        col_id_new, ground_year
      ) %>%
      mutate(
        count = length(unique(col_acquirer_new))
      ) %>%
      filter(
        count >=2
      ) 
    
# if(nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1  )
# {
#   
#   
#   print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
#    print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
#   print("nrow(sendthroughmergers_LU_current_edit_withfuture_dup)>=1 ")
# #    sendthroughmergers_LU_current_edit_withfuture_expodup <-sendthroughmergers_LU_current_edit_withfuture    %>% 
# #         func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>% 
# #         ungroup() %>% 
# #         select(
# #           -col_id_new
# #         ) %>% 
# #         rename(
# #           col_id_new = col_whichcolisid_new
# #         ) 
# # sendthroughmergers_LU_current_edit_withfuture_expodup %>% 
# #   filter(
# #     grepl("merge00488]", col_id_new, perl = TRUE), 
# #     col_crop == "blueberry"
# #   )  %>% 
# #   arrange(
# #     col_id_new, ground_year
# #   ) %>% 
# #   View()
# # break 
# }
    sendthroughmergers_LU_current_edit_withfuture_reid <- sendthroughmergers_LU_current_edit_withfuture%>% 
      filter(!col_id_new %in% c(sendthroughmergers_LU_current_edit_withfuture_dup$col_id_new)) %>% 
      bind_rows(
        # this next step will 
        sendthroughmergers_LU_current_edit_withfuture %>% 
          filter(
            col_id_new %in% c(sendthroughmergers_LU_current_edit_withfuture_dup$col_id_new)
          ) %>% 
          group_by(col_id_new) %>% 
          arrange(col_acquirer_new) %>% 
          mutate(col_id_new = paste0(col_id_new, row_number())) %>% 
          ungroup()
        
        
      )

    sendthroughmergers_LU_current_edit <- sendthroughmergers_LU_current_edit_withfuture_reid  %>% 
        distinct()    
    
    

  # sendthroughmergers_LUnew_pre_names_newid_final_acquired <-  sendthroughmergers_LUnew_pre_names_newid_final %>% 
  #     filter(
  #       
  #       # grepl(
  #       #   paste(unique(check_if_sameyear_acquirer$col_id_new), collapse = "|"), 
  #       #   col_id_new, 
  #       #   perl = TRUE, ignore.case = TRUE
  #       # ), 
  #       ground_year >= currentyear
  #     ) 
  #   
  }
    if(!(nrow(check_if_sameyear_acquired) >= 1))
    {
      sendthroughmergers_LU_current_edit <- sendthroughmergers_LU_current_edit_pre %>% 
        distinct()
    }

    sendthroughmergers_LU_current_edit %>%
      filter(
        col_crop == "blueberry"
      ) %>%
      arrange(
        col_id_new, ground_year
      )%>%
      View()
    # more like which get transferred
    # whichgetacquired <-  list_of_sendthrus[[i]] %>% 
    #       filter(ground_year >= currentyear) %>% 
    #      inner_join(
    #        list_of_sendthrus[[i]]  %>%
    #          filter(
    #            col_year >= currentyear
    #          ) %>% 
    #          select(
    #            col_acquired_new, col_crop, col_acquirer_new 
    #          ) %>% 
    #          distinct(),
    #          # rename(
    #          #   col_acquirer_shouldnotbe = col_acquirer, 
    #          #   name_new_shouldnotbe = name_new
    #          # ),
    #        by = c("col_acquired" = "col_acquired_new", "col_crop" )
    #      )   %>% 
    #       mutate(
    #         newnametemp.x = paste0(
    #           newnametemp, "; ", newnametemp.x
    #           
    #         )
    #       ) %>% 
    #       select(
    #         -newnametemp
    #       ) %>% 
    #       rename(
    #        newnametemp = newnametemp.x, 
    #        old_acquirer = old_acquirer.x
    #       ) %>% 
    #       select(
    #         starts_with("col_"), ground_year, name_new, newnametemp, old_acquirer
    #       
    #       ) %>% 
    #       distinct()
    # sendthroughmergers_LUnew_pre <-  list_of_sendthrus[[i]] %>% 
    #   filter(ground_year >= currentyear) %>% 
    #      rename(
    #        col_id_new1 = col_id_new
    #      ) %>% 
    #   filter(
    #     grepl("mycogen", col_acquirer_new, ignore.case = TRUE, perl = TRUE)
    #   )
    # 
    sendthroughmergers_LUnew_pre_onlyid <-  list_of_sendthrus[[i]] %>% 
      filter(ground_year >= currentyear) %>% 
      rename(
        col_id_new1 = col_id_new
      ) %>% 
      # select(
      #   -col_id_new
      # ) %>%
      # mutate(
      #   old_acquired = col_acquired
      # ) %>% 
      inner_join(
        sendthroughmergers_LU_current_edit %>% 
          select(
            # -col_year,-col_acquirer, -ground_year , -col_id
            col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
            col_id_new
          ),
        # rename(
        #   name_new = col_acquirer
        # ), 
        by = c(
          "col_crop", "col_acquirer_new" = "col_acquired"
        )
      )
    # save.image("X:/msi/work/farmer welfare/seed/journal/221231 save both before merger and after troubleshoot.RData")
  sendthroughmergers_LUnew_pre <-    list_of_sendthrus[[i]] %>% 
      filter(ground_year >= currentyear) %>% 
      rename(
        col_id_new1 = col_id_new
      ) %>% 
    filter(col_id_new1 %in% c(sendthroughmergers_LUnew_pre_onlyid$col_id_new1))%>%
    left_join(
        sendthroughmergers_LU_current_edit %>% 
          select(
            # -col_year,-col_acquirer, -ground_year , -col_id
            col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
            col_id_new
          ),
        # rename(
        #   name_new = col_acquirer
        # ), 
        by = c(
          "col_crop", "col_acquirer_new" = "col_acquired"
        )
      ) %>% 
    mutate(
      col_acquirer_new.y = coalesce(col_acquirer_new.y, col_acquirer_new)
    ) %>% 
    group_by(
     col_id_new1 
    ) %>% 
    arrange(
      ground_year
    ) %>% 
    tidyr::fill(
      newnametemp.y, col_id_new
    ) %>% 
    tidyr::fill(
      col_id_new,  .direction = "up"
    ) %>% 
    ungroup() %>% 
      mutate(
        # newnametemp.y = coalesce( newnametemp.y, )
        newnametemp = 
          case_when(
            !is.na(newnametemp.y)~
          paste0( 
            newnametemp.y, 
            "; ", 
            newnametemp.x
            #gets the first year
            # substr(old_acquirer.x,1,4),
            # "-",
            #then gets current new acquirer
            # col_acquirer_new.y,
            # "-", 
            # col_acquirer_new,
            # gsub(".*-", "-",old_acquirer.x ), 
            #  "; ", newnametemp.y 
          ), 
          TRUE ~ newnametemp.x
          ),
        #col_id_new is from current year mergers
        #col_id_new1 is original from future merger
        #col_id_new2 is new 
        col_id_new2 = paste0(
          col_id_new1  , 
          "; ", col_id_new
        )
        
        # TRUE ~ newnametemp.y
        #,
        # col_id = col_id.x
      )  %>% 
      # select(
      #   -col_id_new1
      # ) %>% 
      select(
        -col_acquirer_new,-col_id_new
      )%>% 
      rename(
        # needs_to_change = col_acquirer_new, 
        col_acquirer_new = col_acquirer_new.y
      )    %>% 
      select(
        -newnametemp.x, -newnametemp.y, 
        -contains("old_acquirer"),
        -contains(".x"),  -contains(".y")
      ) %>%
      distinct() %>% 
      mutate(
        old_acquirer = paste0(
          newnametemp
          # paste0(
          #   col_year,"-", name_new.y,"-",col_acquirer,"-",col_acquired
          # ),
          # "; ", newnametemp
        )
      )
  sendthroughmergers_LUnew_pre%>%
      filter(
        col_crop == "blueberry"
      ) %>%
      arrange(
        col_id_new1, ground_year
      )%>%
      View()
  ### Below is how it was previously; changed to above with left join, coalesce, and fill bc below step with inner join was omitting future acquisitions
    # sendthroughmergers_LUnew_pre <-  list_of_sendthrus[[i]] %>% 
    #   filter(ground_year >= currentyear) %>% 
    #   rename(
    #     col_id_new1 = col_id_new
    #   ) %>% 
    #   # select(
    #   #   -col_id_new
    #   # ) %>%
    #   # mutate(
    #   #   old_acquired = col_acquired
    #   # ) %>% 
    #   left_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp,
    #         col_id_new
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquirer_new" = "col_acquired"
    #     )
    #   )%>% 
    #   mutate(
    #     # newnametemp.y = coalesce( newnametemp.y, )
    #     newnametemp = 
    #       # case_when(
    #       #   !is.na(newnametemp.x)~ 
    #       paste0( 
    #         newnametemp.y, 
    #         "; ", 
    #         newnametemp.x
    #         #gets the first year
    #         # substr(old_acquirer.x,1,4),
    #         # "-",
    #         #then gets current new acquirer
    #         # col_acquirer_new.y,
    #         # "-", 
    #         # col_acquirer_new,
    #         # gsub(".*-", "-",old_acquirer.x ), 
    #         #  "; ", newnametemp.y 
    #       ),
    #     #col_id_new is from current year mergers
    #     #col_id_new1 is original from future merger
    #     #col_id_new2 is new 
    #     col_id_new2 = paste0(
    #       col_id_new1  , 
    #       "; ", col_id_new
    #     )
    #     
    #     # TRUE ~ newnametemp.y
    #     #,
    #     # col_id = col_id.x
    #   )  %>% 
    #   # select(
    #   #   -col_id_new1
    #   # ) %>% 
    #   select(
    #     -col_acquirer_new,-col_id_new
    #   )%>% 
    #   rename(
    #     # needs_to_change = col_acquirer_new, 
    #     col_acquirer_new = col_acquirer_new.y
    #   )    %>% 
    #   select(
    #     -newnametemp.x, -newnametemp.y, 
    #     -contains("old_acquirer"),
    #     -contains(".x"),  -contains(".y")
    #   ) %>%
    #   distinct()
    # 
    #   extract_df <-   sendthroughmergers_LUnew_pre %>%
    #     filter(
    #       col_crop == "blueberry", 
    #       col_acquired == "CARGILL"
    #     ) %>%
    # arrange(col_id_new2, ground_year)
  

  #   
  # extract_df<-  sendthroughmergers_LUnew_pre %>%
  #     filter(
  #       col_crop == "blueberry"
  #     ) %>% 
  #     arrange(
  #       col_id_new2, ground_year
  #     )%>%  
  #     View()
        # #     
  #              sendthroughmergers_LUnew_pre %>%
  #         group_by(
  #           col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new2
  #         ) %>%
  #         arrange(
  #           col_crop
  #         ) %>%
  #         slice(1) %>%
  #         ungroup() %>%
  #                     filter(
  #       grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #       col_id_new2, ground_year
  #     ) %>%
  #         View()
  # 
  #              
  #  extract_df<-  list_of_sendthrus[[i]]  %>%
  #     group_by(
  #         col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
  #     ) %>%
  #     arrange(
  #         col_crop
  #     ) %>%
  #     slice(1) %>%
  #     ungroup() %>%
  #     filter(
  #         grepl("SUNSEEDS", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #         col_id_new, ground_year
  #     )
  # extract_df %>%
  #     filter(
  #         !grepl("Hoechst", col_acquirer_new, perl = TRUE , ignore.case = TRUE)
  #     )%>%
  #     View()
  # 
  #  extract_df_agrevo <-  list_of_sendthrus[[i]]  %>%
  #     group_by(
  #         col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
  #     ) %>%
  #     arrange(
  #         col_crop
  #     ) %>%
  #     slice(1) %>%
  #     ungroup() %>%
  #     filter(
  #         grepl("agrevo", col_acquired, perl = TRUE , ignore.case = TRUE)
  #     ) %>%
  # 
  #     arrange(
  #         col_id_new, ground_year
  #     )  
  
    # 
    #          sendthroughmergers_LUnew_pre %>%
    #            group_by(
    #              col_crop, col_acquired, col_acquirer_new
    #            ) %>%
    #            mutate(
    #              num = length(unique(col_id_new))
    #            ) %>%
    #            ungroup() %>%
    #            filter(
    #              num >=2
    #            )%>%
    #            View()
    # extract_df_pre <-   list_of_sendthrus[[i]] %>%
    # filter(
    #     col_acquired == "STONEVILLE PEDIGREED SEED",
    #     col_crop == "blueberry"
    # ) %>%
    # arrange(col_id_new, ground_year)
    # 
    # extract_df <- extract_df_pre %>% 
    #   filter(col_id_new %in% c(extract_df_pre$col_id_new))
      
    # sendthroughmergers_LUnew_notchangename_onlyid <-  list_of_sendthrus[[i]] %>% 
    #   # filter(
    #   #   !rowid_original %in% c(sendthroughmergers_LU_current_edit$rowid_original)
    #   # ) %>% 
    #   # # need to keep below 
    #   # filter(ground_year >= currentyear)  %>%
    #   # # mutate(
    #   # #   old_acquired = col_acquired
    #   # # ) %>% 
    #   anti_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquirer_new" = "col_acquired"
    #     )
    #   )  %>% 
    #   anti_join(
    #     sendthroughmergers_LU_current_edit %>% 
    #       select(
    #         # -col_year,-col_acquirer, -ground_year , -col_id
    #         col_crop,  col_acquired, col_acquirer_new, old_acquirer, newnametemp
    #       ),
    #     # rename(
    #     #   name_new = col_acquirer
    #     # ), 
    #     by = c(
    #       "col_crop", "col_acquired" = "col_acquired"
    #     )
    #   ) 
    # sendthroughmergers_LUnew_notchangename <- list_of_sendthrus[[i]] %>%  
    #   filter(
    #     (col_id_new %in% c(sendthroughmergers_LUnew_notchangename_onlyid$col_id_new))
    #   )
    # 
  sendthroughmergers_LUnew_pre_unique <- sendthroughmergers_LUnew_pre %>% 
    group_by(col_id_new2, newnametemp) %>% 
    slice(1) %>% 
    ungroup()# %>% 
    # mutate(
    #   col_id_new2old = col_id_new2, 
    #   newnametempold = newnametemp
    # )
      
    sendthroughmergers_LUnew_pre_tobind <-  sendthroughmergers_LUnew_pre_unique  %>% 
      splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "") %>%
      mutate(
        col_id_new2replace = coltotrans
      ) %>%
      select(
        -coltotrans
      )
    # 
    
    sendthroughmergers_LUnew_pre_names_unique <-sendthroughmergers_LUnew_pre_tobind %>% 
      splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$old_acquirer, if_id_col= "no")%>% 
      mutate(
        old_acquirer2replace = coltotrans
      ) %>% 
      select(
        -coltotrans
      )
    
    sendthroughmergers_LUnew_pre_names <- sendthroughmergers_LUnew_pre %>% 
      left_join(
        sendthroughmergers_LUnew_pre_names_unique %>% 
          select(
            col_id_new2replace, old_acquirer2replace, old_acquirer, col_id_new2
          ) %>% 
          distinct()   ,
        by = c("col_id_new2", "old_acquirer")
      ) %>% 
      select(-col_id_new2, -old_acquirer) %>% 
      rename(
        old_acquirer = old_acquirer2replace, 
        col_id_new2 = col_id_new2replace
      )
    
    # sendthroughmergers_LUnew_pre_names%>%
    # filter(
    #     col_crop == "blueberry"
    # ) %>%
    # arrange(
    #     col_id_new1, ground_year
    # )%>%
    # View()


    # 
    # sendthroughmergers_LUnew_pre_names <-sendthroughmergers_LUnew_pre_tobind %>% 
    #   mutate(
    #     old_acquirer = paste0(
    #       newnametemp
    #       # paste0(
    #       #   col_year,"-", name_new.y,"-",col_acquirer,"-",col_acquired
    #       # ),
    #       # "; ", newnametemp
    #     ),
    #     temprowid = row_number()
    #     
    #   ) %>% 
    #   group_by(
    #     temprowid
    #     # col_crop, col_id, ground_year, newnametemp
    #   ) %>% 
    #   mutate(
    #     old_acquirernew =  paste(sort(unique(old_acquirer ),decreasing = TRUE) , collapse = "; ")
    #     
    #   ) %>%
    #   ungroup() %>% 
    #   separate_rows(old_acquirernew, sep = "; ") %>%
    #   group_by_at(
    #     c("temprowid",  names(sendthroughmergers_LUnew_pre_tobind) )
    #   ) %>%
    #   summarise(old_acquirer = paste(sort(unique(old_acquirernew),decreasing = TRUE), collapse = "; "))%>%
    #   ungroup() %>% 
    #   select(
    #     -temprowid 
    #   )# %>%
    if(!(nrow(sendthroughmergers_LUnew_pre) >=1 ))
    {
      # rm(sendthroughmergers_LU_current_edit)
      # rm(sendthroughmergers_LUnew_pre)
      # list_of_sendthrus[[i+1]] <- list_of_sendthrus[[i]]
      # 
      #  i <-i+1
      #  next
      #doesn't really matter what is sent in so long (nrow is 0 so just send in empty frame)
      sendthroughmergers_LUnew_pre_names_newid_final <-  sendthroughmergers_LUnew_pre_names %>% 
        select(
         -contains("col_id_new2"), -contains("col_id_new1")
        ) %>% 
        distinct()
      
    sendthroughmergers_LUnew_notchangename1 <- list_of_sendthrus[[i]]
  
      
    }
    if(nrow(sendthroughmergers_LUnew_pre) >=1 )
    {
      # this step will join with previous instances by prev id. 
      sendthroughmergers_LUnew_pre_names_newid_finalpre <- sendthroughmergers_LUnew_pre_names  %>%
        #should this be 1 bc 1 is from list_of_sendthru[[i]]
        # should only be minyear; if maxyear, then will erroneously revert 
        group_by(col_id_new1) %>%
        mutate(
          minyear_in_id = min(ground_year)#,
          # maxyear_in_id = max(ground_year)
        ) %>%
        ungroup() %>%
        select(
          col_id_new2, col_id_new1 ,minyear_in_id#, maxyear_in_id
        ) %>%
        distinct() %>%
        inner_join(
          list_of_sendthrus[[i]], # %>%
            # filter(
            #   ground_year < currentyear
            # ),
          by = c("col_id_new1" =  "col_id_new")
        ) %>%
        filter(
          # this will pull those up to
          ground_year < minyear_in_id
        #  (ground_year <minyear_in_id)|(ground_year >maxyear_in_id)
        ) %>%
        select(
          -minyear_in_id#, -maxyear_in_id
        )

      sendthroughmergers_LUnew_pre_names_newid_final <-sendthroughmergers_LUnew_pre_names_newid_finalpre %>% 
        bind_rows(
          sendthroughmergers_LUnew_pre_names# %>% 
            # filter(
            #   !col_id_new2 %in% c(sendthroughmergers_LUnew_pre_names_newid_finalpre$col_id_new2)
            # )
        ) %>% 
        # select(
        #   
        # )
        # select(
        #   -col_id_new
        # ) %>% 
        rename(
          col_toreplaceprev = col_id_new1,
          col_id_new =  col_id_new2
        )  %>% 
        arrange(
          col_id_new, ground_year
        ) %>% 
        select(
         -contains("col_id_new2")
        ) %>% 
        distinct()
  
  extract_df_dup <-   sendthroughmergers_LUnew_pre_names_newid_final %>%
        filter(
          col_crop == "blueberry" 
        ) %>%
    arrange(col_id_new, ground_year) %>% 
    group_by(
      col_id_new, ground_year
    ) %>% 
    mutate(
      num = length(unique(col_acquirer_new))
    ) %>% 
    ungroup() %>% 
    filter(num>=2)
  
  if(nrow(extract_df_dup)>=2)
  {
    print("nrow sendthroughfinal is >=2")
        print("nrow sendthroughfinal is >=2")
    print("nrow sendthroughfinal is >=2")
    print("nrow sendthroughfinal is >=2")
    
 sendthroughmergers_LUnew_pre_names_newid_final_expodup <-sendthroughmergers_LUnew_pre_names_newid_final    %>% 
        func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>%
        ungroup() %>%
        select(
          -col_id_new
        ) %>%
        rename(
          col_id_new = col_whichcolisid_new
        )
 break
  }
  
  #
  #   extract_df <-   sendthroughmergers_LUnew_pre_names_newid_final %>%
  #       filter(
  #        # col_acquired == "STONEVILLE PEDIGREED SEED",
  #         col_crop == "blueberry"
  #       ) %>%
  #   arrange(col_id_new, ground_year)

  
        sendthroughmergers_LUnew_notchangename1 <- list_of_sendthrus[[i]] %>%  
          #first do top
      filter(
        !(col_id_new %in% c(sendthroughmergers_LUnew_pre$col_id_new1)) #,
        #these should be the same
        # !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_newid_final$col_toreplaceprev))
  
      )  
  # sendthroughmergers_LUnew_notchangename1%>%
  #   list_of_sendthrus[[i]] %>%   
  #       filter(
  #         col_crop == "blueberry" ,
  #         col_acquired == "STONEVILLE PEDIGREED SEED"
  #       ) %>%
  #   arrange(col_id_new, ground_year)%>% View()
        
  # recover if there are ends needed            
  # sendthroughmergers_LUnew_pre_names_newid_final_past <- sendthroughmergers_LUnew_pre_names_newid_final%>% 
  #     group_by(col_id_new) %>% 
  #       mutate(
  #         minyear_in_id = min(ground_year),
  #         maxyear_in_id = max(ground_year) 
  #       ) %>% 
  #       ungroup() %>% 
  #       select(
  #         col_id_new,col_toreplaceprev, col_acquired, minyear_in_id, maxyear_in_id
  #       ) %>% 
  #       distinct() %>% 
  #       inner_join(
  #         list_of_sendthrus[[i]], # %>%  
  #           # filter(
  #           #   ground_year < currentyear
  #           # ), 
  #         by = c("col_acquired" )
  #       ) %>% 
  #       filter(
  #         # this will pull those up to 
  #         (ground_year <minyear_in_id)|(ground_year >maxyear_in_id)
  #       ) %>% 
  #       select(
  #         -minyear_in_id, -maxyear_in_id
  #       )  
  
  
  
  # extract_df <- list_of_sendthrus[[i]] %>% 
  #   group_by(
  #     col_id_new, ground_year
  #   ) %>% 
  #   mutate(
  #     dup = n()
  #   ) %>% 
  #   filter(
  #     dup >=2
  #   ) 
      # 
      # sendthroughmergers_LUnew_pre_names_newid_final %>%
      #   filter(
      #     grepl("brownfie", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
      # #
      #     sendthroughmergers_LUnew_pre_names_newid_final %>%
      #       group_by(
      #         col_acquired, col_acquired_new, col_acquirer_new, ground_year
      #       ) %>% 
      #       arrange(
      #         col_crop
      #       ) %>% 
      #       slice(1) %>% 
      #       ungroup() %>% 
      #   arrange(
      #     col_id_new, ground_year
      #   ) %>% 
      #       View()
      #     
      # # #     
      #          list_of_sendthrus[[i]]  %>%
      # 
      #     # group_by(
      #     #   col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
      #     # ) %>%
      #     # arrange(
      #     #   col_crop
      #     # ) %>%
      #     # slice(1) %>%
      #     ungroup() %>%
      #                 filter(
      #   grepl("agrevo", col_acquired, perl = TRUE , ignore.case = TRUE),
      #   col_crop == "garlic"
      # )   %>%
      #            arrange(
      #              col_id_new, ground_year
      #            ) %>%
      #            View()
      # 
      # arrange(
      #   col_id_new, ground_year
      # ) %>%
      #     View()
  
  
        
        #         list_of_sendthrus[[i]] %>%
        #     group_by(
        #       col_acquired, col_acquired_new, col_acquirer_new, ground_year
        #     ) %>%
        #     arrange(
        #       col_crop
        #     ) %>%
        #     slice(1) %>%
        #     ungroup() %>%
        #                 filter(
        #   grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
        # ) %>%
        # 
        # arrange(
        #   col_id_new, ground_year
        # ) %>%
        #     View()
      # 
      #   filter(
      #     grepl("brownfie", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
      # 
      # 
      #     list_of_sendthrus[[i]] %>%
      #   filter(
      #     grepl("calgene", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
  
      #     sendthroughmergers_LUnew_pre_names_newid_final %>%
      #   filter(
      #     grepl("stonevil", col_acquired, perl = TRUE , ignore.case = TRUE)
      #   ) %>%
      #   View()
  
    }
    
   
    # this joins previous instances to new id current, in case the original acquired had past merger history, eg calgene acquired by Mons in 1996 acquired stoneville in 1987 so this would only extend calgene back to the first year it appears (this is an optional step, because we dont actually know when company formed, just merger year)
    # sendthroughmergers_LUnew_pre_names_prev
    ### start of prev lu ##########
  #     sendthroughmergers_LUnew_pre_names_prev <-
  #       sendthroughmergers_LUnew_pre_names%>%
  #       group_by(col_id_new) %>%
  #       mutate(
  #         minyear_in_id = min(ground_year)
  #       ) %>%
  #       ungroup() %>%
  #       select(
  #         col_id_new, col_acquired, col_crop, minyear_in_id
  #       ) %>%
  #       mutate(
  #         col_acquired_old = col_acquired,
  #         col_id_new_old = col_id_new
  #       ) %>%
  #       # rename(
  #       #   col_id_new_old = col_id_new
  #       # )%>%
  #       distinct() %>%
  #       left_join(
  #         list_of_sendthrus[[i]] %>%
  #           # filter(ground_year < currentyear)   %>%
  #           rename(
  #             col_id_new_replace  =  col_id_new
  #           ),
  #         # select(
  #         #   -col_id_new
  #         # ),
  #         # select(
  #         #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
  #         # )%>%
  #         #is it acquired old or acquired_new? acquired_old bc only want to trace the path
  #         by = c("col_acquired_old" = "col_acquirer_new", "col_crop")
  # 
  #       )%>%
  #       filter(
  #         !is.na(col_acquirer),
  #         ground_year < minyear_in_id
  #       )%>%
  #       select(
  #         -minyear_in_id
  #       )%>%
  #       mutate(
  #         #this will be the new id name; remember col_id_new is still in use and will be used to pull in those in future
  #         col_id_new_toreplace= paste0(col_id_new_old, ";", col_id_new_replace)
  #       )%>%
  #       select(
  #         # should be remaining: col_id_new (old to act as LU) and col_id_new_toreplace
  #         -col_acquired_old,  -contains(".y"), -col_id_new_old, -col_id_new_replace
  #       )
  #     if(nrow(sendthroughmergers_LUnew_pre_names_prev) >=1)
  #     {
  #       break
  #       sendthroughmergers_LUnew_pre_names_prev_needreid <- sendthroughmergers_LUnew_pre_names_prev%>%
  #         splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new_toreplace)%>%
  #         mutate(
  #           col_id_new_toreplace = coltotrans
  #         ) %>%
  #         select(
  #           -coltotrans
  #         )
  # 
  # 
  #       sendthroughmergers_LUnew_pre_names_id_newid  <-  sendthroughmergers_LUnew_pre_names    %>%
  #         select(
  #           -col_id_new_toreplace
  #         )%>%
  #         # now rename future ids to that renamed previously
  #         inner_join(
  #           sendthroughmergers_LUnew_pre_names_prev_needreid %>%
  #             select(
  #               col_id_new_toreplace, col_id_new
  #             ) %>%
  #             distinct(),
  #           by = c("col_id_new")
  #         ) %>%
  #         #then actually bring the renamed prevs
  #         # select(
  #         #   -col_id_new
  #         # )%>%
  #         # rename(
  #         #   col_id_new = col_id_new_toreplace
  #         # ) %>%
  #         bind_rows(
  #           sendthroughmergers_LUnew_pre_names_prev_needreid# %>%
  #           # select(
  #           #   -col_id_new_toreplace
  #           # ) %>%
  #           # rename(
  #           #   col_id_new = col_id_new_toreplace
  #           # )
  #         ) %>%
  #         # select(-col_id_new) %>%
  #         rename(
  #           col_id_makesurenone = col_id_new,
  #           col_id_new = col_id_new_toreplace
  #         ) %>%
  #         # rename(
  #         #   col_id_makesurenone = col_id_new,
  #         #   col_id_new = col_id_new_toreplace
  #         # ) %>%
  #         arrange(
  #           col_id_new,ground_year
  #         )
  # 
  #       sendthroughmergers_LUnew_pre_names_newid_final <- sendthroughmergers_LUnew_pre_names_id_newid    %>%
  #         select(
  #           -col_id_makesurenone
  #         ) %>%
  #         # select(
  #         #   -col_id_new.x
  #         # ) %>%
  #         bind_rows(
  #           sendthroughmergers_LUnew_pre_names %>%
  #             filter(
  #               !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_id_newid$col_id_makesurenone))
  #             )
  #         )
  # 
  # 
  #       #
  #       #     sendthroughmergers_LUnew_pre_names_prevnewid  <-  sendthroughmergers_LUnew_pre_names_prev    %>%
  #       #       inner_join(
  #       #         sendthroughmergers_LUnew_pre_names_prev_needreid %>%
  #       #         select(
  #       #           col_id_new_toreplace, col_id_new
  #       #         ) %>%
  #       #           distinct(),
  #       #         by = c("col_id_new")
  #       #       ) %>%
  #       #       # select(
  #       #       #   -col_id_new
  #       #       # )%>%
  #       #       # rename(
  #       #       #   col_id_new = col_id_new_toreplace
  #       #       # ) %>%
  #       #       bind_rows(
  #       #         sendthroughmergers_LUnew_pre_names_prev_needreid# %>%
  #       #           # select(
  #       #           #   -col_id_new_toreplace
  #       #           # ) %>%
  #       #           # rename(
  #       #           #   col_id_new = col_id_new_toreplace
  #       #           # )
  #       #       ) %>%
  #       #       rename(
  #       #         col_id_makesurenone = col_id_new,
  #       #         col_id_new = col_id_new_toreplace
  #       #       )
  #       #
  #       #     sendthroughmergers_LUnew_pre_names_reid <-  sendthroughmergers_LUnew_pre_names_prevnewid    %>%
  #       # select(
  #       #   -col_id_makesurenone
  #       # ) %>%
  #       # # select(
  #       # #   -col_id_new.x
  #       # # ) %>%
  #       # bind_rows(
  #       #    sendthroughmergers_LUnew_pre_names %>%
  #       #     filter(
  #       #       !(col_id_new %in% c(sendthroughmergers_LUnew_pre_names_prevnewid$col_id_makesurenone))
  #       #     )
  #       # )
  #       #
  # 
  # 
  #       # select(
  #       #   -col_id_new.x
  #       # ) %>%
  #     }
  # 
  # 
  #     if(!nrow(sendthroughmergers_LUnew_pre_names_prev) >=1)
  #     {
  # 
  #       sendthroughmergers_LUnew_pre_names_newid_final <- sendthroughmergers_LUnew_pre_names
  #     }
  # }
  
    ### end prev lu ##########
    #  
    # list_of_sendthrus[[i]]  %>%
    #    filter(
    #      grepl("nunza", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #       grepl("nunhem",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #    )%>%
    #    View()
    
    # sendthroughmergers_LUnew_notchangename %>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #      grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    # sendthroughmergers_LUnew_pre_names_reid%>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquirer,   perl = TRUE, ignore.case=TRUE),
    #      grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    #  sendthroughmergers_LUnew_pre_names_reid%>% 
    #   filter(
    #     grepl("LIMAGRAIN", col_acquired,   perl = TRUE, ignore.case=TRUE)#,
    #      # grepl("VILMORIN",col_acquired,  perl = TRUE, ignore.case=TRUE)
    #   )%>% 
    #   View()
    
    
    whichgetacquired <-  list_of_sendthrus[[i]] %>% 
      filter(
        ground_year >= currentyear, 
        col_year >  currentyear
        
      ) %>%
      rename(
        col_id_new1 = col_id_new
      ) %>% 
      # left_join(
      #   sendthroughmergers_LU_current_edit %>% 
      #     select(
      #       col_acquired, col_acquirer_new, col_id_new
      #     ) %>% 
      #     distinct() %>% 
      #     rename(
      #       sendthrough_colacquired = col_acquired, 
      #       sendthrough_colacquirer = col_acquirer_new,
      #       sendthrough_col_id_new = col_id_new
      #     ), 
      #   by = c("col_acquirer_new" = "sendthrough_colacquired")
      # ) %>% 
      # mutate(
      #   col_acquirer_new = coalesce(sendthrough_colacquirer, col_acquirer_new ), 
      #   col_id_new = coalesce
      # )
    #this step will retain 
    # mutate(
    #   old_acquired = col_acquired
    # ) %>% 
    #inner join is approp here bc these remain constant throughout
    inner_join(
      sendthroughmergers_LU_current_edit %>% 
        select(
          # -col_year,-col_acquirer, -ground_year , -col_id
          col_crop, col_acquired, col_id_new, newnametemp,  col_acquirer_new, old_acquirer, newnametemp, col_id_new#, col_year
        ) %>%
        # rename(
        #   col_year_sendthrough_current_edit = col_year 
        # ) %>% 
        distinct(),
      # rename(
      #   name_new = col_acquirer
      # ), 
      by = c(
        "col_crop", "col_acquired" = "col_acquired"
      )
    )   %>%
      mutate(
        newnametemp = 
          # case_when(
          #   !is.na(newnametemp.x)~ 
          paste0( 
            newnametemp.y, 
            "; ", 
            newnametemp.x
            #gets the first year
            # substr(old_acquirer.x,1,4),
            # "-",
            #then gets current new acquirer
            # col_acquirer_new.y,
            # "-", 
            # col_acquirer_new,
            # gsub(".*-", "-",old_acquirer.x ), 
            #  "; ", newnametemp.y 
          ),
        col_acquired_new = col_acquirer_new.y,
        col_acquirer_new  = col_acquirer_new.x,
        # col_acquirer_new  = 
        #   case_when(
        #     col_year_sendthrough_current_edit == col_year ~ col_acquirer_new.y,
        #     TRUE ~ col_acquirer_new.x,
        #   ),
        #just call them the same 
        #col_id_new is from current year mergers
        #col_id_new1 is original from future merger
        #col_id_new2 is new 
        
        col_id_new2 = paste0(col_id_new1, "; ", col_id_new)#,
        # col_id_oldprev = col_id_new1,
        # TRUE ~ newnametemp.y
        #,
        # col_id = col_id.x
      )  %>% 
      # rename(
      #    col_toreplaceprev = col_id_new1
      # ) %>% 
      # select(
      #   -col_id_new1
      # ) %>% 
      
      # TRUE ~ newnametemp.y
      #,
      # col_id = col_id.x
      filter(
        col_acquirer_new != col_acquirer_new.y   
      ) %>% 
      mutate(
        old_acquirer = newnametemp
      )%>% 
      select(
        -contains(".x"), -contains(".y")#, -contains("col_year_sendthrough_current_edit")
        # -col_acquirer_new.x, -col_acquirer_new.y, -old_acquirer.x, -old_acquirer.y, 
      ) 
    
    
    
    if(nrow(whichgetacquired ) >=1)
    {
      
      #first rename and reid if the col_acquirer_new changes
     whichgetacquired_changeacquirername_idonly <-  whichgetacquired %>% 
      inner_join(
        sendthroughmergers_LU_current_edit %>%
          select(
            col_acquired, col_acquirer_new, col_id_new, col_crop, newnametemp,old_acquirer
          ) %>%
          distinct() %>%
          rename(
            sendthrough_colacquired = col_acquired,
            sendthrough_colacquirer = col_acquirer_new,
            sendthrough_col_id_new = col_id_new, 
            sendthrough_col_newnametemp = newnametemp,
            sendthrough_col_old_acquirer = old_acquirer
          ),
        #if 
        by = c("col_acquirer_new" = "sendthrough_colacquired", "col_crop")
      ) %>%
        mutate(
          col_id_new3 = paste0(sendthrough_col_id_new, "; ", col_id_new2),
          old_acquirer = paste0(sendthrough_col_old_acquirer, "; ", old_acquirer),
          newnametemp = paste0(sendthrough_col_newnametemp, "; ", newnametemp),

          col_acquirer_new = sendthrough_colacquirer, 
          

        )%>% 
       select(
         -contains("sendthrough_col")
       )
     
     whichgetacquired_changeacquirername <-  whichgetacquired %>% 
      left_join(
        sendthroughmergers_LU_current_edit %>%
          select(
            col_acquired, col_acquirer_new, col_id_new, col_crop, newnametemp,old_acquirer
          ) %>%
          distinct() %>%
          rename(
            sendthrough_colacquired = col_acquired,
            sendthrough_colacquirer = col_acquirer_new,
            sendthrough_col_id_new = col_id_new, 
            sendthrough_col_newnametemp = newnametemp,
            sendthrough_col_old_acquirer = old_acquirer
          ),
        #if 
        by = c("col_acquirer_new" = "sendthrough_colacquired", "col_crop")
      ) %>%
        mutate(
          col_id_new3 = paste0(sendthrough_col_id_new, "; ", col_id_new2),
          old_acquirer = paste0(sendthrough_col_old_acquirer, "; ", old_acquirer),
          newnametemp = paste0(sendthrough_col_newnametemp, "; ", newnametemp),

          col_acquirer_new = sendthrough_colacquirer, 
          

        )%>% 
       filter(
         col_id_new2 %in% c(whichgetacquired_changeacquirername_idonly$col_id_new2)
       )%>% 
       select(
         -contains("sendthrough_col")
       )
     
     if(nrow(whichgetacquired_changeacquirername)!=nrow(whichgetacquired_changeacquirername_idonly))
     {
       #because this has the potential to break/cut up things
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")
       print("nrow with past3 != nrow with past")

       break
     }
     
     whichgetacquired_withrename <- whichgetacquired %>% 
       filter(
         !(col_id_new2 %in% c(whichgetacquired_changeacquirername$col_id_new2))
       ) %>% 
       bind_rows(
         whichgetacquired_changeacquirername %>% 
           select(-col_id_new2) %>% 
           rename(
             col_id_new2 = col_id_new3
           )
         #potentially bind those that don't get a rename in future run
       )
      

      # then reid it 
      whichgetacquired_rename_id <- whichgetacquired_withrename %>% 
        splitrowbysemicolon(
          x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "w1")%>% 
        mutate(
          col_id_new2 = coltotrans#,
          # col_id_new = col_id_new_toreplace
        ) %>% 
        select(
          -coltotrans
        ) %>% 
        splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$old_acquirer, if_id_col= "no")%>% 
        mutate(
          old_acquirer = coltotrans
        ) %>% 
        select(
          -coltotrans
        )
      extract_df <-   whichgetacquired_rename_id%>%
    filter(
        col_crop == "blueberry", col_acquired == "STONEVILLE PEDIGREED SEED" 
    ) %>%
    arrange(col_id_new2, ground_year) 

      
      #    
      # whichgetacquired_rename_id <- whichgetacquired %>% 
      #  mutate(
      #    temprowid = row_number()
      #  ) %>% 
      #  group_by(
      #    temprowid
      #    # col_crop, col_id, ground_year, newnametemp
      #  ) %>% 
      #  mutate(
      #          col_id_newnew =  paste(sort(unique(col_id_new ),decreasing = TRUE) , collapse = "; ")
      #          
      #        ) %>%
      #        ungroup() %>% 
      #        separate_rows(col_id_newnew, sep = "; ") %>%
      #        group_by_at(
      #          c("temprowid",  names(whichgetacquired) )
      #        ) %>%
      #        summarise(col_id_new = paste(sort(unique(col_id_newnew),decreasing = TRUE), collapse = "; "))%>%
      #        ungroup() %>% 
      #        select(
      #          -temprowid
      #        )      
      
      
      # whichgetacquired_rename <- whichgetacquired_rename_id %>% 
      #   mutate(
      #     temprowid = row_number()
      #   ) %>% 
      #   group_by(
      #     temprowid
      #     # col_crop, col_id, ground_year, newnametemp
      #   ) %>% 
      #   mutate(
      #           old_acquirernew =  paste(sort(unique(old_acquirer ),decreasing = TRUE) , collapse = "; ")
      #           
      #         ) %>%
      #         ungroup() %>% 
      #         separate_rows(old_acquirernew, sep = "; ") %>%
      #         group_by_at(
      #           c("temprowid",  names(sendthroughmergers_LUnew_pre_tobind) )
      #         ) %>%
      #         summarise(old_acquirer = paste(sort(unique(old_acquirernew),decreasing = TRUE), collapse = "; "))%>%
      #         ungroup() %>% 
      #         select(
      #           -temprowid
      #         )
      
      whichgetacquired_rename_withpast_direct_pre <-  whichgetacquired_rename_id %>%
        rename(
          col_id_fromsendthrough = col_id_new 
        ) %>% 
        # select(
        #   -col_id_new
        # ) %>% 
        group_by(col_id_new2)  %>% 
        mutate(
          minyear_in_id = min(ground_year) #, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        rename(
          col_id_new = col_id_new1
        ) %>% 
        select(
      col_id_new,minyear_in_id, col_id_new2 #  , maxyear_in_id
        ) %>% 
        # rename(
        #   col_acquired_old = col_acquired
        # )%>% 
        distinct() %>% 
        inner_join(
          list_of_sendthrus[[i]],# %>% 
            # rename(
            #   col_toreplaceprev = col_id_new
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c("col_id_new")
          
        )%>% 
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id
       
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        # group_by(
        #   col_id_new2, 
        # )
        select(
         -minyear_in_id# , -maxyear_in_id
        ) 
      
      whichgetacquired_rename_withpast_direct <- whichgetacquired_rename_withpast_direct_pre%>% 
        rename(
          col_toreplaceprev = col_id_new
        ) %>% 
        # select(-col_id_new) %>% 
        bind_rows(
          whichgetacquired_rename_id %>% 
            select(
              -col_id_new#,  -col_id_new2
            ) %>%
            rename(
              col_toreplaceprev = col_id_new1
            ) %>%
            filter(
              col_id_new2 %in% c(whichgetacquired_rename_withpast_direct_pre$col_id_new2 )
            )
        ) %>% 
        # select(
        #   -col_id_new
        # ) %>% 
        rename(
          # col_toreplaceprev = col_id_new1,
          col_id_new = col_id_new2
        )  %>% 
        mutate(
          # keep this to be used in next
          col_id_new2 = col_id_new
        )  %>% 
        splitrowbysemicolon(
          x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new, if_id_col= "yes", currentit = i, prefix = "w1d")%>% 
        select(
          -col_id_new
        )%>%
         mutate(
          col_id_new  = coltotrans#,
          # col_id_new = col_id_new_toreplace
        ) %>% 
        select(
          -coltotrans
        ) 
 
      
      whichgetacquired_rename_withpast_direct_reid <- whichgetacquired_rename_withpast_direct %>% 
        func_expand_duprows_in_id(., whichcolisid = .$col_id_new2, prefix = "dup") %>% 
        ungroup() %>% 
        select(
          -col_id_new2
        ) %>% 
        rename(
          col_id_new2 = col_whichcolisid_new
        ) 
        
      # if(nrow(whichgetacquired_rename_withpast_direct) >=1)
      # {
      #   break
      # }
       extract_df <-    whichgetacquired_rename_withpast_direct %>%
        arrange( col_id_new2 , ground_year)%>%
        filter(col_crop == "canola")  

      
 extract_df <-    whichgetacquired_rename_withpast_direct_reid %>%
        arrange( col_id_new2 , ground_year)%>%
        filter(col_crop == "canola")  %>% 
 filter(
   grepl("dup", col_id_new2)
 )
  # whichgetacquired_rename_withpast_direct %>%
  #   arrange( col_id_new , ground_year)  %>%
  #   filter(col_crop == "blueberry") %>% select(col_id_new, ground_year, everything()) %>%  View()

      
    # whichgetacquired_rename_withpast_direct_norepeat <- whichgetacquired_rename_withpast_direct %>% 
    #           group_by(
    #             col_id_new, ground_year
    #           ) %>% 
    #           mutate(counter = n()) %>% 
    #           filter(counter >=2 )%>% 
    #     arrange( col_id_new , ground_year)%>%
    #     filter(col_crop == "blueberry")
    #   
    #   whichgetacquired_rename_withpast_direct %>%
    #     filter(col_crop == "blueberry") %>%
    #     group_by(col_id_new) %>% 
    #     mutate(nelements = length(unique(c( ground_year)))) %>% 
    #     ungroup() %>% 
    #     filter(nelements == 26)%>% 
    #     arrange( col_id_new , ground_year) %>% 
    #   
    #     View()
    #   
    #     whichgetacquired_rename_withpast_direct %>%
    #     filter(col_crop == "blueberry") %>%
    #     group_by(col_id_new) %>% 
    #     mutate(nelements = length(unique(c( ground_year)))) %>% 
    #     ungroup() %>% 
    #       group_by(nelements) %>% 
    #       summarise(
    #         countn = n()
    #       )
    #     arrange( col_id_new , ground_year) %>% 
    #   
    #     View()
    
        # rename(
        #   col_id_new = coltotrans#,
        #   # col_id_new = col_id_new_toreplace
        # ) #%>% 
        # bind_rows(
        #   whichgetacquired_rename_withpast_direct
        # )
        
   whichgetacquired_rename_withpast_onlyid <-  whichgetacquired_rename_id %>% 
        group_by(col_id_new2) %>% 
        mutate(
          minyear_in_id = min(ground_year)#, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>% 
        rename(
          col_acquired_old = col_acquired
        )%>% 
        distinct() %>% 
        inner_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%  
            # filter(
            #   col_year  <  currentyear
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )
          
        )%>% 
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id
       
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )
 
   
         whichgetacquired_rename_withpast3 <-  whichgetacquired_rename_id %>% 
        group_by(col_id_new2) %>% 
        mutate(
          minyear_in_id = min(ground_year)#, 
          # maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>% 
        rename(
          col_acquired_old = col_acquired
        )%>% 
        distinct() %>% 
        left_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%  
            # filter(
            #   col_year  <  currentyear
            # ), #%>% 
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>% 
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )
          
        )%>% 
        filter(
          ground_year < minyear_in_id,
          col_id_new2 %in% c(whichgetacquired_rename_withpast_onlyid$col_id_new2)
          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        mutate(
          col_acquired = col_acquired_old
        )%>% 
        select(
          -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
        )%>% 
        mutate(
          # col_id_new = col_id_new2, 
          #this will be the new id name
          col_id_new1 = col_id_new2,
          col_id_new2= paste0(col_id_new2, "; ", col_id_new),
          col_acquirer_new = col_acquired_new
        )   %>% 
        rename(
          col_toreplaceprev = col_id_new
        ) 

      # 
      # only includes past; and renames past IDs
         ### below is how it was previously 01/01/2023; switched over to getting id's first and rest and filling in, instead of just names (bc will omit those without names)
      whichgetacquired_rename_withpast <-  whichgetacquired_rename_id %>%
        group_by(col_id_new2) %>%
        mutate(
          minyear_in_id = min(ground_year)#,
          # maxyear_in_id = max(ground_year)
        ) %>%
        ungroup() %>%
        select(
          col_id_new2, col_acquired_new, col_acquired, col_crop, col_id_new1,minyear_in_id #, maxyear_in_id
        ) %>%
        rename(
          col_acquired_old = col_acquired
        )%>%
        distinct() %>%
       left_join(
          list_of_sendthrus[[i]] %>%
            select(
              -col_acquired_new
            ),#  %>%
            # filter(
            #   col_year  <  currentyear
            # ), #%>%
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>%
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )

        )%>%
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id

          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>%
        mutate(
          col_acquired = col_acquired_old
        )%>%
        select(
          -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
        )%>%
        mutate(
          # col_id_new = col_id_new2,
          #this will be the new id name
          col_id_new1 = col_id_new2,
          col_id_new2= paste0(col_id_new2, "; ", col_id_new),
          col_acquirer_new = col_acquired_new
        )   %>%
        rename(
          col_toreplaceprev = col_id_new
        )
      
      if(nrow(whichgetacquired_rename_withpast3)!=nrow(whichgetacquired_rename_withpast)){
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        break
      }
      # c('
# $ col_id_new2       <chr> "{6w1}merge00…
# $ col_acquired_new  <chr> "LIMAGRAIN GE…
# $ col_crop          <chr> "agrotricum",…
# $ col_id_new1       <chr> "{6w1}merge00…
# $ col_acquirer      <chr> "LIMAGRAIN GE…
# $ col_acquired      <chr> "VILMORIN", "…
# $ col_year          <dbl> 1975, 1975, 1…
# $ col_id            <chr> "merge00291]a…
# $ ground_year       <dbl> 1975, 1976, 1…
# $ col_toreplaceprev <chr> "merge00291]a…
# $ old_acquirer      <chr> "1975-LIMAGRA…
# $ newnametemp       <chr> "1975-LIMAGRA…
# $ col_acquirer_new  <chr> "LIMAGRAIN GE…
# ')      

    
      if(nrow(whichgetacquired_rename_withpast) >=1)
      {
        # break
        
        #renames it
        whichgetacquired_rename_withpast_needreid <- whichgetacquired_rename_withpast%>% 
          splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "wp1")%>% 
          mutate(
            col_id_new2 = coltotrans
          ) %>% 
          select(
            -coltotrans
          )
        # whichgetacquired_rename_withpast_needreid_withpresent <- whichgetacquired_rename_withpast_needreid %>% 
        #   bind_rows(
        #     whichgetacquired_rename_id
        #   )
        # 
        
        
        whichgetacquired_rename_id_newid  <-  whichgetacquired_rename_id    %>% 
          select(
            -col_id_new1, -col_id_new
          )%>% 
          rename(
            col_id_new1 = col_id_new2
          )%>% 
          # now rename future ids to that renamed previously
          inner_join(
            whichgetacquired_rename_withpast_needreid %>% 
              select(
                col_id_new2, col_id_new1, col_toreplaceprev  
              ) %>% 
              distinct(),
            by = c("col_id_new1" = "col_id_new1")
          ) %>% 
          #then actually bring the renamed prevs
          # select(
          #   -col_id_new
          # )%>%
          # rename(
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          bind_rows(
            whichgetacquired_rename_withpast_needreid# %>%
            # select(
            #   -col_id_new_toreplace
            # ) %>%
            # rename(
            #   col_id_new = col_id_new_toreplace
            # )
          ) %>%
          # select(-col_id_new) %>% 
          rename(
            # col_id_makesurenone = col_id_new,
            # 
            # col_id_new = col_id_new_toreplace
            col_id_new = col_id_new2
          ) %>% 
          # rename(
          #   col_id_makesurenone = col_id_new,
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          arrange(
            col_id_new,ground_year
          )
        
        whichgetacquired_rename_id_newid_final <- whichgetacquired_rename_id_newid%>% 
          select(
            -col_id_new1
          ) %>% 
          bind_rows(
            whichgetacquired_rename_id %>%
              filter(
                !(col_id_new2 %in% c(whichgetacquired_rename_id_newid$col_id_new1)),
                !(col_id_new2 %in% c(whichgetacquired_rename_withpast_direct$col_id_new2))
                
              ) %>%
              select(  -col_id_new) %>%
                rename(
                  col_id_new = col_id_new2,
                  col_toreplaceprev = col_id_new1
                ),
            whichgetacquired_rename_withpast_direct %>% 
              select(-col_id_new2)  
                
                
                # %>% 
              # group_by(
              #   col_id_new, ground_year
              # ) %>% 
              # slice(1) %>% 
              # ungroup()
          ) %>% 
          distinct()
        
        
      extract_df <-  whichgetacquired_rename_id_newid_final %>%
          filter(
            col_crop == "blueberry"
          ) %>%
          arrange(
            col_id_new, ground_year
          ) 
        # select(
        #   -col_id_new.x
        # ) %>% 
      }
      
      
      if(!nrow(whichgetacquired_rename_withpast) >=1)
      {        
        whichgetacquired_rename_id_newid_final <- bind_rows(
            whichgetacquired_rename_id %>%
              filter(
                !(col_id_new2 %in% c(whichgetacquired_rename_withpast_direct$col_id_new2))
                
              ) %>%
              select(  -col_id_new) %>%
                rename(
                  col_id_new = col_id_new2,
                  col_toreplaceprev = col_id_new1
                ),
            whichgetacquired_rename_withpast_direct  %>% 
              select(-col_id_new2)  #%>% 
              # group_by(
              #   col_id_new, ground_year
              # ) %>% 
              # slice(1) %>% 
              # ungroup()
          ) %>% 
          distinct()
          # whichgetacquired_rename_id%>% 
          #     select(-col_id_new, -col_id_new1) %>% 
          #       rename(
          #         col_id_new = col_id_new2
          #       ) 
          
       }
      
      #  list_of_sendthrus[[i]]  %>%
      # group_by(
      #     col_acquired, col_acquired_new, col_acquirer_new, ground_year, col_id_new
      # ) %>%
      # arrange(
      #     col_crop
      # ) %>%
      # slice(1) %>%
      # ungroup() %>%
      # filter(
      #     grepl("stonevill", col_acquired, perl = TRUE , ignore.case = TRUE)
      # ) %>%
      # 
      # arrange(
      #     col_id_new, ground_year
      # ) %>%
      # View()
  
      
      sendthroughmergers_LUnew_notchangename2 <- sendthroughmergers_LUnew_notchangename1 %>% 
        filter(
          # want to keep the below and only remove those that have been changed at top and bottom
          # !col_id_new %in% c(whichgetacquired_rename_id_newid_final$col_toreplaceprev),
          !col_id_new %in% c(whichgetacquired_rename_id$col_id_new1),
          !col_id_new %in% c(whichgetacquired_rename_withpast_direct$col_toreplaceprev)
        )
  
      
      
      sendthisoutdf <- bind_rows(
        
        sendthroughmergers_LUnew_pre_names_newid_final %>% 
          select(
            -contains("col_toreplaceprev")
          ), 
        whichgetacquired_rename_id_newid_final %>% 
          select(
             -contains("col_toreplaceprev")
          ) , 
        sendthroughmergers_LUnew_notchangename2
      ) %>% 
        select(
          -contains("col_id_new1"), -contains("col_id_new2"), -contains("col_id_new_toreplace"), -contains("col_toreplaceprev")
        )
      
    }
    
    if(!(nrow(whichgetacquired)>=1))
    {
      sendthisoutdf <- bind_rows(
        
        sendthroughmergers_LUnew_pre_names_newid_final %>% 
          select(
            -contains("col_toreplaceprev")
          ), 
        sendthroughmergers_LUnew_notchangename1
      )%>% 
      select(
         -contains("col_id_new1"), -contains("col_id_new2"), -contains("col_id_new_toreplace"), -contains("col_toreplaceprev")
      )
           
      
      
    }
    
    
    # list_of_sendthrus[[i+1]] %>%
    #   feather::write_feather(
    #     paste0(
    #       "X:/msi/work/farmer welfare/seed/R analysis/221215_merge/",
    #       currentyear, ".feather"
    #     )
    # 
    #   )
    sendthisoutdf_dup <- sendthisoutdf %>% 
      group_by(
        col_id_new, ground_year
      ) %>% 
      mutate(
        dup = n()
      ) %>% 
      filter(dup >=2) %>% 
      ungroup() #%>% 
    
    # extract_df <- sendthisoutdf %>% 
    #   filter(
    #     col_crop == "blueberry"
    #   ) %>% 
    #   arrange(
    #     col_id_new, ground_year
    #   ) %>% 
    #   filter(
    #     grepl("_", col_id_new, perl = TRUE)
    #   )
 extract_df <- sendthisoutdf_dup %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 
    
    # if(nrow(sendthisoutdf_dup)>=1)
    # {
    #         print("dup! heads up")
    # 
    #   break
    # }
    
    sendthisoutdf_dup_reid <- sendthisoutdf_dup %>% 
      group_by(
        col_id_new, ground_year
      ) %>% 
      arrange(
        col_acquirer_new
      ) %>% 
      mutate(
        col_id_new2 = paste0(  row_number(),"_", col_id_new)
      ) %>% 
      ungroup()
     extract_df <- sendthisoutdf_dup_reid %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 

    sendthisoutdf_w_dup <- sendthisoutdf %>% 
      filter(
        !col_id_new %in% c(sendthisoutdf_dup_reid$col_id_new)
      ) %>% 
      bind_rows(
        sendthisoutdf_dup_reid %>% 
          select(
            -col_id_new, -contains("dup")
          ) %>% 
          rename(
            col_id_new = col_id_new2
          )
      )
    
    # sendthisoutdf_w_dup<- list_of_sendthrus[[49]]
    sendthisoutdf_w_dup_removesame <- sendthisoutdf_w_dup %>% 
      functionreduce_down_dups(passthrudf =. )
    
         extract_df <- sendthisoutdf_w_dup_removesame %>% 
      filter(
        col_crop == "blueberry"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 

    # sendthisoutdf_w_dup_final <- 
    
      # sendthisoutdf_w_dup_removesame %>%
      # feather::write_feather(
      #   paste0(
      #     "X:/msi/work/farmer welfare/seed/R analysis/221215_merge/",
      #     currentyear, ".feather"
      #   )
      # 
      # )

    
    list_of_sendthrus[[i+1]] <- sendthisoutdf_w_dup_removesame
    i <- i+1
    
    rm(extract_df)
    rm(whichgetacquired)
    rm(sendthroughmergers_LU_current_edit)
    rm(sendthroughmergers_LUnew_pre)
    rm(sendthroughmergers_LUnew)
    rm(sendthroughmergers_LUnew_pre_names)
    rm(sendthroughmergers_LUnew_pre_tobind)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LU_bind_withprev)
    rm(sendthroughmergers_LU_bind)
    rm(sendthroughmergers_LU_current)
    # rm(sendthroughmergers_LU_current_edit)
    rm(sendthroughmergers_LUnew)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LUnew_pre)
    rm(sendthroughmergers_LUnew_pre_names)
    rm(sendthroughmergers_LUnew_pre_names_newid_final)
    rm(sendthroughmergers_LUnew_pre_names_prev)
    rm(sendthroughmergers_LUnew_notchangename_id)
    rm(sendthroughmergers_LUnew_notchangename)
    
    rm(sendthroughmergers_LUnew_pre_names_newid_finalpre)
    rm(whichgetacquired_rename_withpast)
    rm(sendthroughmergers_LUnew_pre_names_newid_final)
    rm(whichgetacquired_rename_id_newid_final)
    rm(sendthroughmergers_LUnew_notchangename)
    rm(whichgetacquired)
    rm(whichgetacquired_rename_id)
    rm(whichgetacquired_rename_id_newid)
    rm(whichgetacquired_rename_withpast)
    rm(whichgetacquired_rename_withpast_needreid)
    rm(sendthroughmergers_LUnew_notchangename2)
      rm(sendthroughmergers_LUnew_notchangename1)
      rm(sendthroughmergers_LUnew_notchangename)
    rm(sendthroughmergers_LUnew_notchangename_onlyid)
    
   rm(check_if_sameyear_acquirer)
    rm(check_if_sameyear_acquired)
    rm(sendthisoutdf_w_dup)
    rm(sendthisoutdf)
    rm(sendthisoutdf_dup_reid)
    rm(sendthisoutdf_dup)
    rm(whichgetacquired_rename_withpast_direct)
    rm(whichgetacquired_rename_withpast_direct_pre)
    rm(sendthroughmergers_LU_current)
    rm(sendthroughmergers_LU_current_edit_pre)
    rm(sendthisoutdf_w_dup_removesame)
    rm(sendthroughmergers_LU_current_edit_replaceacquired)
    rm(sendthroughmergers_LU_current_edit_withfuture)
    rm(sendthroughmergers_LU_current_edit_withfuture_dup)
    rm(sendthroughmergers_LU_current_edit_withfuture_reid)
    rm(whichgetacquired_changeacquirername)
    rm(whichgetacquired_withrename)
    rm(sendthroughmergers_LUnew_pre)
        rm(sendthroughmergers_LUnew_pre_onlyid)
                rm(sendthroughmergers_LUnew_pre_unique)
                rm(sendthroughmergers_LUnew_pre_names_unique)
rm(whichgetacquired_rename_withpast_onlyid)
rm(whichgetacquired_changeacquirername_idonly)
rm(whichgetacquired_rename_withpast3)
rm(whichgetacquired_rename_withpast_direct_reid)
    # sendthroughmergers_LU_bind %>% 
    #   filter(
    #     grepl("tick", col_id,perl = TRUE, ignore.case = TRUE)
    #     )%>% 
    #       View()
    
    
    # sendthroughmergers_LU%>%
    #   feather::write_feather(
    #     paste0(
    #        "X:/msi/work/farmer welfare/seed/R analysis/", folderoutname,"/221105_merged_",filenamergename,currentyear,".feather"
    #     )
    
    #  )
    gc()
    # i <- i+1
  }
# sendthroughmergers_LU %>% 
#   feather::w
# 
list_of_sendthrus
# sendthroughmergers_LU <-list_of_sendthrus[[i]]
}


```

#### check for errors
```{r }
sendthroughmergers_LU <-list_of_sendthrus[[i]]
sendthroughmergers_LU %>% 
  filter(
    col_crop == "blueberry"
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

sendthroughmergers_LU %>% 
  filter(
    grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
    col_crop == "blueberry"
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

sendthroughmergers_LU %>% 
  filter(
    col_crop == "corn"
  ) %>%
  group_by(col_id_new) %>% 
  mutate(
    rangeyear = length(unique(ground_year)),
    supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))
     
  ) %>% 
  ungroup() %>% 
  filter(
    supposed_rangeyear!=rangeyear
  ) %>% 
  arrange(col_id_new, ground_year) %>% 
  View()
sendthroughmergers_LU %>% 
  filter(
    grepl("NA;", old_acquirer, perl =TRUE)
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()



```

#### check with sendthru
```{r }

# findyearwhenchange <- function(zz){
#   jj <-1
#   while(jj <= )
#   
# } 

list_of_sendthrus[[31]] %>% 
  filter(
    col_crop == "blueberry"
  ) %>%
  group_by(col_id_new) %>%
  mutate(
    rangeyear = length(unique(ground_year)),
    supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))

  ) %>%
  ungroup() %>%
  filter(
    supposed_rangeyear!=rangeyear
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

```

### function to reduce down
```{r }

functionreduce_down_dups <- function(passthrudf ){
  # passthrudf <- sendthisoutdf_w_dup
  passthrudf_wide <- passthrudf%>% 
    select(col_id_new,col_crop, col_acquired, col_acquirer_new, ground_year) %>% 
    mutate(
      ground_year = paste0("YR_", ground_year)
    ) %>% 
    spread(
      key = ground_year, 
      value = col_acquirer_new
    ) 
  
  passthrudf_wide_colnames <-   passthrudf_wide %>% 
      select(contains("YR_")) %>% 
    names()
  
  passthrudf_wide_reduce <- passthrudf_wide %>% 
    replace(is.na(.), "none")%>% 
    group_by_at(c("col_acquired", "col_crop", passthrudf_wide_colnames)) %>% 
    slice(1) %>% 
    ungroup() 
  
  passthru_df_reduce <- passthrudf %>% 
    filter(
      col_id_new %in% c(passthrudf_wide_reduce$col_id_new)
    )
    
  # passthru_df_reduce <- passthrudf %>% 
  #   filter(
  #     !(col_id_new %in% c(passthrudf_wide_reduce$col_id_new))
  #   )
  # 
  # passthrudf_wide_reduce <- passthrudf_wide %>% 
  #   replace(is.na(.), "none")%>% 
  #   group_by_at(c("col_acquired", "col_crop", passthrudf_wide_colnames)) %>% 
  #   mutate(counter = n()) %>%
  #   ungroup() %>% 
  #   filter(
  #     counter >=2
  #   )
  
  passthru_df_reduce
}
```

### use do it by year func
```{r }
sendthroughmergers_LUlist <- list()
sendthroughmergers_LUlist <- mergerdata220918_names %>% 
  findparentcompanyfunc_LU(x = .,acquirercol =.$namestandard_acquirer, acquiredbycol = .$namestandard_acquired,cropcol = .$Crop,  yearcol = .$Year,idcol = .$idcol, df_patents,filenamergename = "221119try", minyear = 1970, maxyear = 2022, folderoutname =  "221119_merge"   )

sendthroughmergers_LU <- sendthroughmergers_LUlist[[length(sendthroughmergers_LUlist)]]
#
sendthroughmergers_LU %>% 
    filter(
        col_crop == "canola" , 
        col_acquired == "STONEVILLE PEDIGREED SEED"
    ) %>% 
    arrange(
        col_id_new, ground_year
    ) %>% View()


sendthroughmergers_LU_reduce <- sendthroughmergers_LU %>% 
  group_by(
    col_id_new
  ) %>% 
  mutate(
    maxyear = max(ground_year)
  ) %>% 
  ungroup() %>%
  filter(
    maxyear==2022
  ) %>% 
  ungroup() %>% 
  group_by(
    col_acquired
  ) %>% 
  mutate(
    minacq = min(ground_year)
  )  %>% 
  ungroup() %>% 
  group_by(
    col_id_new, col_acquired
  ) %>% 
  mutate(
    minacq_per_id = min(ground_year)
  ) %>% 
  ungroup() %>% 
  filter(
     minacq_per_id==minacq
  ) %>% 
  ungroup() 

sendthroughmergers_LU_reduce %>% 
    filter(
        col_crop == "canola" , 
        col_acquired == "STONEVILLE PEDIGREED SEED"
    ) %>% 
    arrange(
        col_id_new, ground_year
    ) %>% View()

# sendthroughmergers_LU <- mergerdata220918_names %>% 
#   findparentcompanyfunc_LU(x = .,acquirercol =.$namestandard_acquirer, acquiredbycol = .$namestandard_acquired,cropcol = .$Crop,  yearcol = .$Year,idcol = .$idcol, df_patents,filenamergename = "221119try", minyear = 1970, maxyear = 2022, folderoutname =  "221119_merge"   )
  # x = mergerdata220918_names
  # acquirercol = mergerdata220918_names$namestandard_acquirer
  # acquiredbycol = mergerdata220918_names$namestandard_acquired
  # yearcol = mergerdata220918_names$Year
  # idcol = mergerdata220918_names$idcol
  # cropcol = mergerdata220918_names$Crop

```



### search function by company
```{r }
findids_with_textfunc <- function(findids_df, textstringdf, textstringcrop = "canola"){
  
       findids_with_textfunc_df <- findids_df %>% 
      filter(
        col_crop == textstringcrop
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 
findids_with_textfunc_ids <- findids_with_textfunc_df %>% 
  filter(grepl(textstringdf, col_acquirer_new, ignore.case = TRUE, perl = TRUE)) %>% 
  select(col_id_new) %>% 
  distinct()
findids_with_textfunc_df %>% 
  filter(
    col_id_new %in% c(findids_with_textfunc_ids$col_id_new)
  ) %>% 
  View()

  
}
```

### first reduce down function

```{r }

grab_whichgetacq_func <- function( df_to_get ){
  
  df_to_get_red <- df_to_get%>% 
       group_by(col_id_new) %>% 
  mutate(
    rangeyear = length(unique(ground_year)),
    supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))
     
  ) %>% 
  ungroup() %>% 
  filter(
    supposed_rangeyear==rangeyear
  )  %>% 
    select(
      -supposed_rangeyear, -rangeyear
    )
  require(parallel)
  require(furrr)
  require(tidyverse)
  require(tidytext)
require(callr)
  
#   callr(
# expr,
# envir = parent.frame(),
# substitute = TRUE,
# globals = TRUE,
# label = NULL,
# workers = availableCores(),
# ...
# )
require(future.callr)
  # cl <- makePSOCKcluster(detectCores() - 2)

plan(callr(workers = 8))
  require(patentsview)
  

    saferprocess_file <- function( currentk) {
      # currentk ="https://apps.ams.usda.gov/CMS//AdobeImages/200200259.pdf"
      
searchedpv_df <- suppressMessages(textreadr::read_pdf(
         currentk,ocr = TRUE, trim = TRUE
      )
)
nameout <- gsub(
  ".*AdobeImages/|.pdf", "", currentk
)

  searchedpv_df %>% 
   feather::write_feather(
     paste0(
       "X:/msi/work/farmer welfare/seed/PVP/writepvp/",
       nameout,".feather"
     )
     
   )
  
    }
  i <- 1 
  yearsgothru = d
}

```

```{r }
within_getacq_func <- function(x, df_tograb){
  
      whichgetacquired_rename_withpast <-  df_tograb %>%
        slice(x) %>% 
        group_by(col_id_new) %>%
        mutate(
          minyear_in_id = min(ground_year)#,
          # maxyear_in_id = max(ground_year)
        ) %>%
        ungroup() %>%
        select(
          col_id_new, col_acquired_new, col_acquired, col_crop, minyear_in_id #, maxyear_in_id
        ) %>%
        rename(
          col_acquired_old = col_acquired
        )%>%
        distinct() %>%
       left_join(
         df_tograb %>%
            select(
              -col_acquired_new
            ),#  %>%
            # filter(
            #   col_year  <  currentyear
            # ), #%>%
          #      filter(ground_year < currentyear),
          # select(
          #   -col_id_new
          # ),
          # select(
          #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
          # )%>%
          by = c(
            "col_acquired_new" = "col_acquirer_new", "col_crop",
            # "col_acquired_old" = "col_acquired_new"
             "col_acquired_old" = "col_acquired"

          )

        )%>%
        filter(
          !is.na(col_acquirer),
          ground_year < minyear_in_id

          # ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>%
        mutate(
          col_acquired = col_acquired_old
        )%>%
        select(
          -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
        )%>%
        mutate(
          # col_id_new = col_id_new2,
          #this will be the new id name
          col_id_new1 = col_id_new2,
          col_id_new2= paste0(col_id_new2, "; ", col_id_new),
          col_acquirer_new = col_acquired_new
        )   %>%
        rename(
          col_toreplaceprev = col_id_new
        )
      
      if(nrow(whichgetacquired_rename_withpast3)!=nrow(whichgetacquired_rename_withpast)){
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        print("nrow whichgetacquired_rename_withpast3 != whichgetacquired_rename_withpast")
        
        break
      }
      # c('
# $ col_id_new2       <chr> "{6w1}merge00…
# $ col_acquired_new  <chr> "LIMAGRAIN GE…
# $ col_crop          <chr> "agrotricum",…
# $ col_id_new1       <chr> "{6w1}merge00…
# $ col_acquirer      <chr> "LIMAGRAIN GE…
# $ col_acquired      <chr> "VILMORIN", "…
# $ col_year          <dbl> 1975, 1975, 1…
# $ col_id            <chr> "merge00291]a…
# $ ground_year       <dbl> 1975, 1976, 1…
# $ col_toreplaceprev <chr> "merge00291]a…
# $ old_acquirer      <chr> "1975-LIMAGRA…
# $ newnametemp       <chr> "1975-LIMAGRA…
# $ col_acquirer_new  <chr> "LIMAGRAIN GE…
# ')      

    
      if(nrow(whichgetacquired_rename_withpast) >=1)
      {
        # break
        
        #renames it
        whichgetacquired_rename_withpast_needreid <- whichgetacquired_rename_withpast%>% 
          splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "wp1")%>% 
          mutate(
            col_id_new2 = coltotrans
          ) %>% 
          select(
            -coltotrans
          )
        # whichgetacquired_rename_withpast_needreid_withpresent <- whichgetacquired_rename_withpast_needreid %>% 
        #   bind_rows(
        #     whichgetacquired_rename_id
        #   )
        # 
        
        
        whichgetacquired_rename_id_newid  <-  whichgetacquired_rename_id    %>% 
          select(
            -col_id_new1, -col_id_new
          )%>% 
          rename(
            col_id_new1 = col_id_new2
          )%>% 
          # now rename future ids to that renamed previously
          inner_join(
            whichgetacquired_rename_withpast_needreid %>% 
              select(
                col_id_new2, col_id_new1, col_toreplaceprev  
              ) %>% 
              distinct(),
            by = c("col_id_new1" = "col_id_new1")
          ) %>% 
          #then actually bring the renamed prevs
          # select(
          #   -col_id_new
          # )%>%
          # rename(
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          bind_rows(
            whichgetacquired_rename_withpast_needreid# %>%
            # select(
            #   -col_id_new_toreplace
            # ) %>%
            # rename(
            #   col_id_new = col_id_new_toreplace
            # )
          ) %>%
          # select(-col_id_new) %>% 
          rename(
            # col_id_makesurenone = col_id_new,
            # 
            # col_id_new = col_id_new_toreplace
            col_id_new = col_id_new2
          ) %>% 
          # rename(
          #   col_id_makesurenone = col_id_new,
          #   col_id_new = col_id_new_toreplace
          # ) %>% 
          arrange(
            col_id_new,ground_year
          )
        
        whichgetacquired_rename_id_newid_final <- whichgetacquired_rename_id_newid%>% 
          select(
            -col_id_new1
          ) %>% 
          bind_rows(
            whichgetacquired_rename_id %>%
              filter(
                !(col_id_new2 %in% c(whichgetacquired_rename_id_newid$col_id_new1)),
                !(col_id_new2 %in% c(whichgetacquired_rename_withpast_direct$col_id_new2))
                
              ) %>%
              select(  -col_id_new) %>%
                rename(
                  col_id_new = col_id_new2,
                  col_toreplaceprev = col_id_new1
                ),
            whichgetacquired_rename_withpast_direct %>% 
              select(-col_id_new2)  
                
                
                # %>% 
              # group_by(
              #   col_id_new, ground_year
              # ) %>% 
              # slice(1) %>% 
              # ungroup()
          ) %>% 
          distinct()
      }
  
}
```

```{r }

findgcd_merger <- function(findlowest_basedf){
  
  
      findlowest_basedf_2 <- findlowest_basedf%>% 
        mutate(
          id_acq = paste0( ground_year , "-", col_acquirer_new)
        ) %>% 
        group_by(
          col_id_new,col_acquired, col_crop 
        ) %>% 
        summarise(
          countid = length(unique(id_acq)),

         id_acq= paste(sort( unique(id_acq)), collapse = ";") 
        ) %>% 
        ungroup() #%>% 
      
            findlowest_basedf_2LU <-# findlowest_basedf 
            sendthroughmergers_LU%>% 
        mutate(
          id_acq = paste0( ground_year , "-", col_acquirer_new)
        ) %>% 
        group_by(
          col_id_new,col_acquired, col_crop 
        ) %>% 
        mutate(
          countid = length(unique(id_acq)),

         id_acq= paste(sort( unique(id_acq)), collapse = ";") 
        ) %>% 
        ungroup() #%>% 

      
        # mutate(
        #   id_acq= paste0(col_crop, "; ", id_acq)
        # )
     findlowest_basedf_3 <- findlowest_basedf_2 %>% 
       group_by(
         id_acq,col_acquired
       ) %>% 
       slice(1) %>% 
       ungroup() 
      
  i <-1
  # numacquired <- findlowest_basedf$col_acquired %>% unique()
  rm(listofpass)
  listofpass <- list()
  while(i <= nrow(findlowest_basedf_3))
  {
   # if(i==1){
   #   listofpass[[i]] <- findlowest_basedf_3
   # } 
    findlowest_basedf_2_current <- findlowest_basedf_3  %>% 
       filter(
       grepl(
         findlowest_basedf_3$id_acq[i], id_acq, perl = TRUE
       )
      )
    findlowest_basedf_2_current_reduce <- findlowest_basedf_2_current %>%
      slice(which.max(countid))
    listofpass[[i]] <- findlowest_basedf_2_current %>% 
      mutate(
        which_id_col_has_most = findlowest_basedf_2_current_reduce$col_id_new[1]
      ) %>% 
      distinct()
      # bind_rows(
      #   findlowest_basedf_2_current_reduce
      # )
    # findlowest_basedf_3 <- findlowest_basedf_3 %>% 
    #   filter(
    #     !col_id_new %in% c(findlowest_basedf_2_current$col_id_new)
    #   )
    
    i <- i+1
    gc()
     
  }
  rm(i)
  
  listofpass_bindrows <- listofpass %>% 
    bind_rows() %>% 
    distinct()

  findlowest_basedf_2LU_withbase <-    findlowest_basedf_2LU %>% 
    left_join(
        listofpass_bindrows %>% 
           select(id_acq, which_id_col_has_most, col_acquired ) %>% 
           distinct() %>% 
          rename(col_id_new_distill =which_id_col_has_most ),
           by = c("id_acq", "col_acquired")
    ) %>% 
    distinct()

       
  listofpass_bindrows %>% 
    feather::write_feather(
      "X:/msi/work/farmer welfare/seed/R analysis/221230_narrow_ids_to_maxlength.feather"
    )
  findlowest_basedf_2LU_withbase
}

### use it 
```

#### use reduce1 
```{r }

  
sendthroughmergers_LU_reduce <- sendthroughmergers_LU %>% 
  findgcd_merger(.)   %>% 
  distinct()

```

### reduce2: join past and future acquired 
```{r }

joinpast_and_present_futureacquired_fromreduce <- function(findlowest_basedf){
  #### 
  findlowest_basedf <-sendthroughmergers_LU_reduce
  
  findlowest_basedf_joined <- findlowest_basedf %>% 
        filter(
      col_id_new != col_id_new_distill 
    ) %>% 

        group_by(col_id_new ) %>% 
        mutate(
          minyear_in_id = min(ground_year) , 
          maxyear_in_id = max(ground_year)
        ) %>% 
        ungroup() %>% 
        select(
          col_id_new ,col_crop,   col_acquired, minyear_in_id  , maxyear_in_id, col_id_new_distill
        ) %>% 
        rename(
          col_id_new1 = col_id_new
        )%>%
        distinct() %>% 
    inner_join(
          findlowest_basedf %>% 
            select(
            col_id_new,  col_acquirer, col_acquired, col_year, col_id, ground_year, col_acquired_new, col_acquirer_new, newnametemp, old_acquirer, id_acq, countid
              # -col_id_new_distill
            ),# %>%
          by = c(
           "col_id_new_distill" = "col_id_new", "col_acquired"

          )
          
        )%>% 
        filter(
          # !is.na(col_acquirer),
          # ground_year < minyear_in_id
          ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
        )%>% 
        # mutate(
        #   col_acquired = col_acquired_old
        # )%>% 
        # select(
        #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
    # )%>% 
    mutate(
      # col_id_new = col_id_new2, 
      #this will be the new id name
      col_id_new2= paste0(col_id_new1, "; ", col_id_new_distill) 
    ) %>% 
    select(
      -minyear_in_id , -maxyear_in_id
    )%>% 
    distinct() 

  findlowest_basedf_joined_needreid <- findlowest_basedf_joined%>% 
    splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = 0, prefix = "fl1")%>% 
    mutate(
      col_id_new2 = coltotrans
    ) %>% 
    select(
      -coltotrans
    )
   # findlowest_basedf_joined_notin_atall  <-findlowest_basedf %>% 
   #          filter(
   #            col_id_new != col_id_new_distill
   #          )
   # 
          findlowest_basedf_joined_final  <-
          # filter(
          #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_id_new1),
          #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_toreplaceprev)
          #   ) %>% 
          bind_rows(
            #this should be the max existing
            findlowest_basedf %>% 
              inner_join(
                findlowest_basedf_joined_needreid %>% 
                select(
                  col_id_new2, col_id_new1     
                ) %>% 
                distinct(),
              by = c("col_id_new" = "col_id_new1")
              )%>% 
              rename(
                col_id_new1 = col_id_new
              )%>% 
              # select(
              #   -id_acq, -countid
              # ) %>% 
              # should be col_acq max add on
            bind_rows(
              findlowest_basedf_joined_needreid 
            ) %>% 
              rename(
                col_id_new = col_id_new2
              ) #%>%
            # select(
            #   -col_id_new_distill 
            # )
          )
          
   findlowest_basedf_joined_final2 <- findlowest_basedf_joined_final       %>% 
            bind_rows(
              findlowest_basedf %>% 
            # filter(
            #   col_id_new != col_id_new_distill
            # ) %>% 
            anti_join(
              findlowest_basedf_joined_final %>%
                select(col_id_new1) %>%
                distinct(),
              by = c("col_id_new" = "col_id_new1")
            ) 
            ) %>% 
            select(
              -col_id_new_distill
            )%>% 
     distinct() 
   
 findlowest_basedf_joined_final2_maxyear <-findlowest_basedf_joined_final2  %>% 
  group_by(
    col_id_new
  ) %>% 
  mutate(
    maxyear = max(ground_year)
  ) %>% 
  ungroup() %>%
  filter(
    maxyear==2022
  ) %>% 
  ungroup() 
   
   findlowest_basedf_joined_final2_maxyear       %>% 
     filter(
       !col_id_new %in% c(findlowest_basedf_joined_final2$col_id_new)
     ) %>% View()
   
 findlowest_basedf_joined_final2_minyear <-findlowest_basedf_joined_final2_maxyear  %>% 
  group_by(
    col_acquired
  ) %>% 
  mutate(
    minacq = min(ground_year)
  )  %>% 
  ungroup() %>% 
  group_by(
    col_id_new, col_acquired
  ) %>% 
  mutate(
    minacq_per_id = min(ground_year)
  ) %>% 
  ungroup() %>% 
  filter(
     minacq_per_id==minacq
  ) %>% 
  ungroup() 
 
    
   findlowest_basedf_joined_final2_maxyear       %>% 
     filter(
       !col_id_new %in% c(findlowest_basedf_joined_final2_minyear$col_id_new)
     ) %>% View()

 
findlowest_basedf_joined_final2_minyear_rangeyear <- findlowest_basedf_joined_final2_maxyear%>% 
       group_by(col_id_new) %>% 
  mutate(
    rangeyear = length(unique(ground_year)),
    supposed_rangeyear =  length(c( min(ground_year):max(ground_year)))
     
  ) %>% 
  ungroup() %>% 
  filter(
    supposed_rangeyear==rangeyear
  ) 

   findlowest_basedf_joined_final2_minyear       %>% 
     filter(
       !col_id_new %in% c(findlowest_basedf_joined_final2_minyear_rangeyear$col_id_new)
     ) %>% View()

    
            # findlowest_basedf_joined_final2   %>% 
            #   # group_by()
            #   slice( c(72041, 72050) ) %>% View()
         
        
     findlowest_basedf_joined_final_reduce <-findlowest_basedf_joined_final2_minyear_rangeyear   %>% 
      # select(
      #   -col_id_new_distill
      # ) %>% 
      distinct()%>% 
        # func_expand_duprows_in_id(., whichcolisid = .$col_id_new, prefix = "ds") %>%
        # ungroup() %>%
        # select(
        #   -col_id_new
        # ) %>%
        # rename(
        #   col_id_new = col_whichcolisid_new
        # )%>% 

      functionreduce_down_dups(passthrudf =. ) %>% 
       select(
         names(sendthroughmergers_LU)
       )

     
     findlowest_basedf_joined_final_reduce
     
}
## commented out below
             findlowest_basedf_joined_final_reduce %>%
          filter(
            col_crop == "canola"
          ) %>%
          arrange(
            col_id_new, ground_year
          ) %>% View()
# 
        rm(findlowest_basedf)
        rm(findlowest_basedf_joined)
        rm(findlowest_basedf_joined_final)
        rm(findlowest_basedf_joined_final_reduce)
        rm(findlowest_basedf_joined_final2)
        rm(findlowest_basedf_joined_final2_maxyear)
        rm(findlowest_basedf_joined_final2_minyear)
        rm(findlowest_basedf_joined_final2_minyear_rangeyear)
        rm(findlowest_basedf_joined_needreid)
#             findlowest_basedf_joined %>% 
#               inner_join(
#                 findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#               ) %>% 
#               
#             
#           findlowest_basedf_filter %>% 
#             inner_join(
#               findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#             ) %>% 
#             arrange(
#               col_id_new2, ground_year
#             )%>% 
#             # select(-col_toreplaceprev) %>% 
#           #then actually bring the renamed prevs
#           # select(
#           #   -col_id_new
#           # )%>%
#           rename(
#             col_id_new1 = col_id_new
#           ) %>%
#           bind_rows(
#             findlowest_basedf_joined_needreid%>% 
#               select(
#                   -col_toreplaceprev, -col_id_new2copyorig, -minyear_in_id , -maxyear_in_id
#               )   
#             # select(
#             #   -col_id_new_toreplace
#             # ) %>%
#             # rename(
#             #   col_id_new = col_id_new_toreplace
#             # )
#           ) %>%
#           # rename(
#           #   col_id_newprev = col_id_new
#           # ) %>% 
#           rename(
#             # col_id_makesurenone = col_id_new,
#             # 
#             # col_id_new = col_id_new_toreplace
#             col_id_new3 = col_id_new2
#           # )
#         ) %>% 
#           # rename(
#           #   col_id_makesurenone = col_id_new,
#           #   col_id_new = col_id_new_toreplace
#           # ) %>% 
#           arrange(
#             col_id_new3,ground_year
#           ) %>% 
#           distinct()
#           
# 
#   
#     
#   ### comment out above
#       i <- 1
#       acquiredlist <- findlowest_basedf$col_acquired %>% unique()
#       while(i <= length(acquiredlist))
#       {
#         findlowest_basedf_current <- findlowest_basedf %>% 
#           filter(col_acquired == acquiredlist[i])
#         
#           findlowest_basedf_joined <-    findlowest_basedf_filter%>% 
#         group_by(col_id_new ) %>% 
#         mutate(
#           minyear_in_id = min(ground_year) , 
#           maxyear_in_id = max(ground_year)
#         ) %>% 
#         ungroup() %>% 
#         select(
#           col_id_new ,   col_acquired, col_crop, minyear_in_id  , maxyear_in_id
#         ) %>% 
#         rename(
#           col_id_new1 = col_id_new
#         )%>%
#         distinct() %>% 
#         inner_join(
#           findlowest_basedf_filter,# %>%
#             # select(
#             #   -col_acquired_new
#             # ),#  %>%  
#             # filter(
#             #   col_year  <  currentyear
#             # ), #%>% 
#           #      filter(ground_year < currentyear),
#           # select(
#           #   -col_id_new
#           # ),
#           # select(
#           #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
#           # )%>% 
#           by = c(
#             "col_acquired",  "col_crop" 
# 
#           )
#           
#         )%>% 
#         filter(
#           # !is.na(col_acquirer),
#           # ground_year < minyear_in_id
#           col_id_new1 != col_id_new,
#           ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
#         )%>% 
#         # mutate(
#         #   col_acquired = col_acquired_old
#         # )%>% 
#         # select(
#         #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
#         # )%>% 
#         mutate(
#           # col_id_new = col_id_new2, 
#           #this will be the new id name
#           col_id_new2= paste0(col_id_new1, "; ", col_id_new) 
#          )   %>% 
#     mutate(
#       col_id_new2copyorig = col_id_new2
#     )%>% 
#         rename(
#           col_toreplaceprev = col_id_new
#         ) 
# 
#         
#       }
# 
#   findlowest_basedf_joined <-    findlowest_basedf_filter%>% 
#         group_by(col_id_new ) %>% 
#         mutate(
#           minyear_in_id = min(ground_year) , 
#           maxyear_in_id = max(ground_year)
#         ) %>% 
#         ungroup() %>% 
#         select(
#           col_id_new ,   col_acquired, col_crop, minyear_in_id  , maxyear_in_id
#         ) %>% 
#         rename(
#           col_id_new1 = col_id_new
#         )%>%
#         distinct() %>% 
#         inner_join(
#           findlowest_basedf_filter,# %>%
#             # select(
#             #   -col_acquired_new
#             # ),#  %>%  
#             # filter(
#             #   col_year  <  currentyear
#             # ), #%>% 
#           #      filter(ground_year < currentyear),
#           # select(
#           #   -col_id_new
#           # ),
#           # select(
#           #   col_crop, col_acquired,col_acquirer, ground_year, name_new, col_year,newnametemp, old_acquirer
#           # )%>% 
#           by = c(
#             "col_acquired",  "col_crop" 
# 
#           )
#           
#         )%>% 
#         filter(
#           # !is.na(col_acquirer),
#           # ground_year < minyear_in_id
#           col_id_new1 != col_id_new,
#           ((ground_year < minyear_in_id)|(ground_year >maxyear_in_id))
#         )%>% 
#         # mutate(
#         #   col_acquired = col_acquired_old
#         # )%>% 
#         # select(
#         #   -col_acquired_old,  -contains(".y"), -contains(".x"),-minyear_in_id
#         # )%>% 
#         mutate(
#           # col_id_new = col_id_new2, 
#           #this will be the new id name
#           col_id_new2= paste0(col_id_new1, "; ", col_id_new) 
#          )   %>% 
#     mutate(
#       col_id_new2copyorig = col_id_new2
#     )%>% 
#         rename(
#           col_toreplaceprev = col_id_new
#         ) 
#         findlowest_basedf_filter %>% 
#     filter(
#       col_id_new == "{27}merge00312]agrotricum; {18wp1}merge00096]agrotricum; {18w1}merge00188]agrotricum"
#         # col_crop == "cotton",
#         # grepl(pattern= "merge00312]agrotricum",x= col_id_new2,perl = TRUE)
#     )%>% 
#     View()
# 
#   
#   findlowest_basedf_joined %>% 
#     filter(
#       col_id_new1 == "{27}merge00312]agrotricum; {18wp1}merge00096]agrotricum; {18w1}merge00188]agrotricum"
#         # col_crop == "cotton",
#         # grepl(pattern= "merge00312]agrotricum",x= col_id_new2,perl = TRUE)
#     )%>% 
#     View()
# 
# # c('
# # $ col_id_new2       <chr> "{6w1}merge00…
# # $ col_acquired_new  <chr> "LIMAGRAIN GE…
# # $ col_crop          <chr> "agrotricum",…
# # $ col_id_new1       <chr> "{6w1}merge00…
# # $ col_acquirer      <chr> "LIMAGRAIN GE…
# # $ col_acquired      <chr> "VILMORIN", "…
# # $ col_year          <dbl> 1975, 1975, 1…
# # $ col_id            <chr> "merge00291]a…
# # $ ground_year       <dbl> 1975, 1976, 1…
# # $ col_toreplaceprev <chr> "merge00291]a…
# # $ old_acquirer      <chr> "1975-LIMAGRA…
# # $ newnametemp       <chr> "1975-LIMAGRA…
# # $ col_acquirer_new  <chr> "LIMAGRAIN GE…
# # ')      
#       if(!(nrow(findlowest_basedf_joined) >=1))
#       {
#         
#         i <- i+1
#         next
#       }
# 
#     
#       if(nrow(findlowest_basedf_joined) >=1)
#       {
#         # break
#         
#         #renames it
#         findlowest_basedf_joined_needreid <- findlowest_basedf_joined%>% 
#           splitrowbysemicolon(x_splitrowdf = ., df_with_names_splitrowdf = ., whichcoltotrans = .$col_id_new2, if_id_col= "yes", currentit = i, prefix = "fl1")%>% 
#           mutate(
#             col_id_new2 = coltotrans
#           ) %>% 
#           select(
#             -coltotrans
#           )
#         # whichgetacquired_rename_withpast_needreid_withpresent <- whichgetacquired_rename_withpast_needreid %>% 
#         #   bind_rows(
#         #     whichgetacquired_rename_id
#         #   )
#         # 
#         
#         
#         whichgetacquired_rename_id_newid  <- # findlowest_basedf_filter  %>% 
#           # filter(
#           #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_id_new1),
#           #   !col_id_new %in% c(findlowest_basedf_joined_needreid$col_toreplaceprev)
#           #   ) %>% 
#           bind_rows(
#           findlowest_basedf_filter %>% 
#             inner_join(
#               findlowest_basedf_joined_needreid %>% 
#                 select(
#                   col_id_new2, col_id_new1     
#                 ) %>% 
#                 distinct(),
#               by = c("col_id_new" = "col_id_new1")
#             ) %>% 
#             arrange(
#               col_id_new2, ground_year
#             )%>% 
#             # select(-col_toreplaceprev) %>% 
#           #then actually bring the renamed prevs
#           # select(
#           #   -col_id_new
#           # )%>%
#           rename(
#             col_id_new1 = col_id_new
#           ) %>%
#           bind_rows(
#             findlowest_basedf_joined_needreid%>% 
#               select(
#                   -col_toreplaceprev, -col_id_new2copyorig, -minyear_in_id , -maxyear_in_id
#               )   
#             # select(
#             #   -col_id_new_toreplace
#             # ) %>%
#             # rename(
#             #   col_id_new = col_id_new_toreplace
#             # )
#           ) %>%
#           # rename(
#           #   col_id_newprev = col_id_new
#           # ) %>% 
#           rename(
#             # col_id_makesurenone = col_id_new,
#             # 
#             # col_id_new = col_id_new_toreplace
#             col_id_new3 = col_id_new2
#           # )
#         ) %>% 
#           # rename(
#           #   col_id_makesurenone = col_id_new,
#           #   col_id_new = col_id_new_toreplace
#           # ) %>% 
#           arrange(
#             col_id_new3,ground_year
#           ) %>% 
#           distinct()
#           )
#         
#         whichgetacquired_rename_id_newid %>% 
#           filter(
#             col_crop == "cotton"
#           ) %>% 
#           arrange(
#             col_id_new3, ground_year
#           ) %>% 
#           View()
#            # now rename future ids to that renamed previously
#           
#         
#      whichgetacquired_rename_id_newid_reduce <-whichgetacquired_rename_id_newid   %>% 
#       functionreduce_down_dups(passthrudf =. )
#      
#      listofpass[[i]] <-whichgetacquired_rename_id_newid_reduce
#      i <- i+1
# #      whichgetacquired_rename_id_newid_reduce %>% 
# #     group_by(col_id_new) %>% 
# #     mutate(
# #         totalyear = length(unique(ground_year)) 
# #     ) %>% filter(col_crop == "cotton") %>% 
# #  View()
# #      
# # whichgetacquired_rename_id_newid_reduce %>% 
# #   group_by(col_id_new) %>% 
# #   mutate(
# #     totalyear = length(unique(ground_year)) 
# #   ) %>% 
# #   group_by(
# #     totalyear, col_crop 
# #   ) %>%
# #   summarise(
# #     totyearunique = length(unique(totalyear)) 
# #   )
#         # select(
#         #   -col_id_new.x
#         # ) %>% 
#       }
#   }
#   listofpass %>%
#     bind_rows()
# }

```


###### use reduce2 function
```{r }
sendthroughmergers_LU_reduce2 <- sendthroughmergers_LU_reduce %>%  joinpast_and_present_futureacquired_fromreduce(findlowest_basedf =.)

sendthroughmergers_LU_reduce2 %>% 
  feather::write_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230122_sendthroumergers_LU_reduce2.feather"
  )

sendthroughmergers_LU_reduce2 <-  
  feather::read_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230122_sendthroumergers_LU_reduce2.feather"
  )

```

## retrieve lu
```{r }


  sendthroughmergers_LU <-  list_of_sendthrus[[i]]  

# 1998 Rhobio
# 2000 mycogern channel becomes NA 
# 2018 monsanto bayer becomes NA

# mycogen 
# sementes supposed to merge in 1999 under agrevo
     extract_df <- sendthroughmergers_LU_reduce2 %>% 
      filter(
        col_crop == "canola"
      ) %>% 
      arrange(
        col_id_new, ground_year
      ) 
mycogen_df_ids <- mycogen_df %>% 
  filter(grepl("mycogen", col_acquirer_new, ignore.case = TRUE, perl = TRUE)) %>% 
  select(col_id_new) %>% 
  distinct()
extract_df %>% 
  filter(
    col_id_new %in% c(mycogen_df_ids$col_id_new)
  ) %>% 
  View()
sendthroughmergers_LU %>% 
findids_with_textfunc(findids_df =., textstringdf = "mycogen", textstringcrop = "canola")
# sendthroughmergers_LU <- feather::read_feather(
#   "X:/msi/work/farmer welfare/seed/R analysis/merger/221105_merged_2022.feather"
# )
soycropquery_merger_stone <-  sendthroughmergers_LU%>% 
  filter(
    grepl("advant", col_acquired,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 
 soycropquery_merger_stone <-  sendthroughmergers_LU%>% 
  filter(
    grepl("dunhuang", col_acquirer,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 
 

# soycropquery_merger_stone <- sendthroughmergers_LU %>% 
#   filter(
#     grepl("seminis", col_acquired,ignore.case = TRUE, perl = TRUE)
#   )%>% arrange( col_acquired ,ground_year) 
soycropquery_merger_stone <-  list_of_sendthrus[[i]] %>% 
  filter(
    grepl("advant", col_acquired,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 
soycropquery_merger_stone <- sendthroughmergers_LU %>% 
  # filter(
  #   grepl("advant", col_acquired,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  filter(
    grepl("ticker", col_id,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 

  soycropquery_merger_stone <-  sendthroughmergers_LU %>% 
  filter(
    grepl("stonevil", col_acquired,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 

    soycropquery_merger_stone <-  sendthroughmergers_LU %>% 
  filter(
    grepl("merge00424]caraway", col_id,ignore.case = TRUE, perl = TRUE)
  )%>% arrange( col_crop, ground_year) 

  
```

<!-- ###### use last step func  -->
<!-- ```{r } -->
<!-- sendthroughmergers_LU_final <- sendthroughmergers_LU %>% joinpast_and_present_futureacquired(findlowest_basedf =.) -->

<!-- ``` -->

##  pair patents with merger

### func 1
```{r }

joinpatents_with_mergerfunc <- function(patentdf_func, mergerdf_func, pvpdf_func, writefilefolder, writefileas){
  # 
  # sendthroughmergers_LU_reyear <- y%>% 
  # group_by(
  # col_crop, col_acquirer_col_acquired_col_year,old_acquirer_name_new  
  # ) %>% 
  # slice(1) %>% 
  #   # ungroup() %>% 
  #   select(
  #     -ground_year
  #   ) %>% 
  #   mutate(
  #     min_year =  
  #   )

patentdf_func=soycropquery_unnest_df   
mergerdf_func= sendthroughmergers_LU_reduce2
pvpdf_func= pvp_url
  


# gets merged
 patentdf_func_rename <- patentdf_func%>% 
   mutate(
     assignee_organization= case_when(
        !is.na(assignee_organization) ~ assignee_organization ,
         TRUE ~ "name not found"
     )
     )%>%       
  standardizenames_crop(
    ., 
    whichcol_to_rename =.$crop 
    )%>%
   select(
     -crop
   )%>%
   rename(
     crop = crop_shortname
   )%>%
  standardizenames_companies(., whichcol_to_rename =.$assignee_organization  )%>%
  rename(
    # name_standard_patent = renamedcol,
    name_standard_patent2= Namestandard
  ) %>% 
    ungroup() %>% 
      mutate(
     name_standard_patent2= case_when(
        !is.na(name_standard_patent2) ~ name_standard_patent2 ,
         TRUE ~ "name not found"
     )        

   )  %>% 
   mutate(
     id = paste0(patent_year, "; ", patent_number,";",app_number,";" , crop, "; ",abstract_title  )
      
    

   )  %>% 
   group_by(
     id
   ) %>% 
   slice(1)  %>% 
   ungroup() %>% 
   select(
     -terms,-topic, -terms_tfidf
   )  #%>% 
     # left_join(
     #   patent_themes, 
     #   by  = c("id" =  "patent_number")
     # )
 

   pvpdf_func_rename <-pvpdf_func%>% 
    filter(
      !is.na(`Issued Date` )
    ) %>%
    mutate(
      year = as.integer(gsub(".*/", "", `Issued Date`)), 
    patent_number_edit = `Application #`, 
         patent_number = `Application #`


    ) %>% 
    standardizenames_crop(
    ., 
    whichcol_to_rename =.$`Common Name` 
    )%>%
   select(
     -`Common Name`
   )%>%
   rename(
     crop = crop_shortname,
     patent_year = year
   )%>%
    standardizenames_companies(., whichcol_to_rename =.$Applicant  )%>%
    select(
     -Applicant  
   )%>%
  rename(
    name_standard_patent2 = Namestandard 
  ) %>% 
      mutate(
     name_standard_patent2= case_when(
        !is.na(name_standard_patent2) ~ name_standard_patent2 ,
         TRUE ~ "name not found"
     ), 
     patent_number_edit = 
       case_when(
         nchar( `Application #`) == 7 ~ paste0("00", `Application #`), 
          nchar( `Application #`) == 9 ~ paste0(`Application #`), 
        
       )

   )  %>% 

    mutate(
      abstract_title = paste0(
       "Varietyname: ", `Variety Name`, ". ", "Experimentalname: ", `Experimental Name`, ". "
      ),
      id = paste0(patent_year, "; ", patent_number , crop, "; ",abstract_title  ) 
    ) %>% 
     mutate(
       patent_number = as.character(patent_number)
     ) %>% 
     # left_join(
     #   patent_themes, 
     #   by  = c("patent_number" =  "patent_number")
     # ) %>% 
    mutate(
      patent_type = "PVP",
      patent_type2 = "PVP",
      patent_years = `Years Protected`#,
      # terms = abstract_title
    ) %>% 
    select(
      id, name_standard_patent2, abstract_title, crop, patent_year, crop_type, crop_type2, patent_type,patent_type2, patent_years,#terms,terms_tfidf,
      patent_number_edit, patent_number
    )

 
  mergerdf_func_rename <-mergerdf_func%>% 
   # mutate(
   #   col_acquirer= case_when(
   #      !is.na(col_acquirer) ~ col_acquirer ,
   #       TRUE ~ "name not found"
   #   )  ,
   #  col_acquired= case_when(
   #      !is.na(col_acquired) ~ col_acquired ,
   #       TRUE ~ "name not found"
   #   ),
   # name_new= case_when(
   #      !is.na(name_new) ~ name_new ,
   #       # mutate(
   #   col_acquirer= case_when(
   #      !is.na(col_acquirer) ~ col_acquirer ,
   #     # mutate(
   #   col_acquirer= case_when(
   #      !i
    standardizenames_crop(
    ., 
    whichcol_to_rename =.$col_crop 
    )%>%
   select(
     -col_crop,-crop_type,-crop_type2
   )%>%
   rename(
     col_crop = crop_shortname
   ) #%>%

  mergerdf_func_rename %>% 
  filter(
    grepl("shamroc|keygene", ignore.case = TRUE, perl = TRUE, x = col_acquired),
    col_crop == "blueberry"
  ) %>%
  arrange(col_id_new, ground_year) %>% 
  View()

  # 
  # mergerdf_func_rename_LUconame <- mergerdf_func_rename %>% 
  #   select(col_id_new,col_crop, col_acquired, col_acquired_new, col_acquirer, col_acquirer_new) %>% gather(
  #     key = coltype,
  #     value = companyname,
  #     col_acquired:col_acquirer_new
  #   ) %>% 
  #   select(col_id_new,companyname,col_crop ) %>% 
  #   distinct() 
  #   
  # join_with_conameLUfunc <- function(joinwithdf_patent, refdf, mergerdf_df){
  #   joinoutputdf_id <- joinwithdf_patent %>% 
  #     left_join(
  #       refdf, 
  #       by = c("name_standard_patent2" = "companyname", "crop" = "col_crop"  )
  #     ) %>% 
  #     left_join(
  #       mergerdf_df, 
  #       by = c("col_id_new")
  #     )
  #   
  #  join_with_conameLUfunc
  #   
  #   
  # }
  
   # ndardizenames_companies(., whichcol_to_rename =.$col_acquirer  )%>%
  # standardizenames_companies(., whichcol_to_rename =.$col_acquired  )%>%
  #  select(
  #    -col_acquired  
  #  )%>%
  # rename(
  #   col_acquired = Namestandard 
  # ) %>% 
  # standardizenames_companies(., whichcol_to_rename =.$name_new  )%>%
  #  select(
  #    -name_new
  #  )%>%
  # rename(
  #   name_new = Namestandard 
  # ) %>% 
  #   ungroup() 
   
     
  #    mergerdf_func_seminis <- mergerdf_func     %>%
  # filter(
  #   grepl("nunhem", col_acquired ,ignore.case = TRUE, perl = TRUE), 
  #   col_crop == "onion"
  # ) %>%
  #   arrange(col_id ,ground_year) #%>%
  # 
  #    mergerdf_func_seminis <- mergerdf_func     %>%
  # filter(
  #   grepl("advant", col_acquired ,ignore.case = TRUE, perl = TRUE) , 
  #   col_crop == "onion"
  # ) %>%
  #   arrange(col_id ,ground_year) #%>%
  # 
  #    allpatents_func_rename_merger_seminis <- mergerdf_func     %>%
  # filter(
  #   col_id == "merge93]agrotricumticker6"
  # )
  # 
  # mergerdf_func_seminis <- mergerdf_func    %>%
  # filter(
  #   # col_acquired == "ADVANTA"
  #   grepl("advant", old_acquirer,ignore.case = TRUE, perl = TRUE)
  # ) %>%
  #   arrange(col_id, col_crop,col_acquired ,ground_year) #%>%
#)
   # ndardizenames_companies(., whichcol_to_rename =.$col_acquirer  )%>%

 allpatents_func_rename <- patentdf_func_rename %>% 
   mutate(
     patent_years = case_when(
       patent_type == "design" ~ 14, 
       TRUE ~ 20
     ),
     patent_type2 = "Patent", 
     patent_number_edit = patent_number
   ) %>% 
   select_at(
      names(pvpdf_func_rename)
   ) %>% 
   bind_rows(
     pvpdf_func_rename
   ) %>% 
  mutate(
       universal_id_start = paste0("renameid_",row_number())
  )   
allpatents_func_rename %>% 
   feather::write_feather(
      ., path = paste0(
        "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/", "230113_patents", 
        # writefilefolder, writefileas
        ".feather"
      )
    )
    

  allpatents_func_rename <-
   feather::read_feather(
        paste0(
        "//jna_nol/asus/msi/work/farmer welfare/seed/R analysis/", "230113_patents", 
        # writefilefolder, writefileas
        ".feather"
      )
    )
    


  #    allpatents_func_rename_merger_seminis <- allpatents_func_rename     %>%
  # filter(
  #   grepl("advant", name_standard_patent2 ,ignore.case = TRUE, perl = TRUE)
  # )
     

  #   mutate(
  #     old_acquirer = paste0(name_new, "}", old_acquirer)
  #   ) %>% 
  #   select(
  #     col_crop,col_year, ground_year, col_acquired,old_acquirer, col_id
  #   ) %>% 
  #   distinct() %>% 
  #   spread(
  #     key =  ground_year , 
  #     value  = old_acquirer
  #   )

  
   # x_merger_seminis <- y_rename    %>%
  # filter(
  #   grepl("asgrow", col_acquired,ignore.case = TRUE, perl = TRUE)
  # )
  #    x_merger_seminis <- y_rename    %>%
  # filter(
  #   grepl("vilmorin", col_acquired,ignore.case = TRUE, perl = TRUE)
  # )
   

  #     x_merger_seminis <- y_rename    %>%
  # filter(
  #   grepl( "pioneer", col_acquired,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #       
  #       filter(col_year == max(col_year))
  # 
  #   x_merger_seminis <- x_rename    %>%
  #    filter(
  #      grepl("asgrow", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  #    )
  #  #cross licensed dow and asgrow->monsanto
  #         x_merger_seminis <- x_rename    %>%
  # filter(
  #   grepl("5945583",  patent_number,ignore.case = TRUE, perl = TRUE)
  # )

  # this gets the name of each at the max patent year
   # allpatents_func_rename_lastyr_patent <- allpatents_func_rename %>%
   #   group_by(
   #     name_standard_patent2, crop
   #   ) %>% 
   #   summarise(
   #     year_patent_max  = max(patent_year, na.rm = TRUE )
   #   ) %>% 
   #   ungroup() %>% 
   #   # rename(
   #   #   year_patent_max = patent_year
   #   # ) %>% 
   #   select(
   #     name_standard_patent2, crop, year_patent_max
   #   )
   
      
  #   x_merger_seminis <- x_rename_lastyr_patent    %>%
  # filter(
  #   grepl("seminis", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  # )

    # y_rename_lastyr_merger<- mergerdf_func_rename %>% 
    #    mutate(
    #      yr_max = as.numeric(substr(old_acquirer,1,4))
    #    ) %>% 
    #    group_by(
    #      col_acquired,col_crop
    #    )%>% 
    #    summarise(
    #      year_merge_max  = max(col_year, na.rm = TRUE )
    #    )%>% 
    #   # rename(
    #   #   year_merge_max = yr_max
    #   # ) %>% 
    #   select(
    #     col_acquired, col_crop, year_merge_max
    #   ) 
  #      x_merger_seminis <- y_rename_lastyr_merger    %>%
  # filter(
  #   grepl("vilmorin",  col_acquired,ignore.case = TRUE, perl = TRUE)
  # )

  # allpatents_func_rename_merger
  #      renameid_10015
  #  allpatents_func_rename_merger    %>%
  # filter(
  #   # col_acquired == "ADVANTA"
  #   grepl("renameid_10015", universal_id_start,ignore.case = TRUE, perl = TRUE)
  # ) %>%
  #   arrange(col_id_new, ground_year)  %>% View()
# allpatents_func_rename  %>% group_by(
#   patent_type2,  crop, terms
# ) %>% 
#   summarise(
#     counter = length(unique(id))
#   ) -> allpatents_summary
       
 allpatents_func_rename_merger <-allpatents_func_rename  %>% 
     # join_with_conameLUfunc(joinwithdf_patent=., refdf = mergerdf_func_rename_LUconame , mergerdf_df = mergerdf_func_rename)
    left_join(
      mergerdf_func_rename,# %>% 
        # group_by(
        #   col_id, col_crop
        # ) %>%
        # mutate(
        #   minyear_merge = min(ground_year)
        # ) %>%
      #  ungroup(),
      by = c("crop" = "col_crop", "name_standard_patent2"="col_acquired"  )
    )%>% 
   ungroup() %>%
   mutate(
     patent_merger_id = paste0(id, replace_na( col_id_new, "nomerge"))
   ) #%>% 
   # group_by(patent_merger_id, ground_year) %>% 
   # mutate(
   #   numentries = n()
   # ) %>% 
   # filter(
   #   numentries >=2
   # )
 # allpatents_func_rename_merger %>% 
 #   filter(
 #     is.na(ground_year)
 #   ) %>% glimpse()
 
allpatents_func_rename_merger_exp <-allpatents_func_rename_merger %>%
  group_by(patent_merger_id) %>% 
   mutate(
     universalgroundstart = min(ground_year)
   ) %>% 
   ungroup() %>% 
    filter(
    ((patent_year <=ground_year)&(universalgroundstart>=1))|(is.na(universalgroundstart))
  ) %>% 
   mutate(
     repnum = 
       case_when(
         is.na(universalgroundstart) ~ 2022 - patent_year + 1, 
         ((patent_year <universalgroundstart)& ground_year == universalgroundstart)~ universalgroundstart - patent_year   + 1,
         TRUE ~ 1
         
           
       )
   ) %>% 
   group_by(
     patent_merger_id
   ) %>% 
slice(rep(row_number(), repnum)) %>%
   ungroup() %>% 
   mutate(
     ground_year_min = 
       case_when(
         is.na(universalgroundstart) ~ patent_year, 
         ((patent_year <universalgroundstart))~patent_year  ,
         TRUE ~universalgroundstart

       )

   ) %>% 
   group_by(patent_merger_id) %>% 
  arrange(
    ground_year
  ) %>% 
   mutate(
     ground_year =
       case_when(
         is.na(universalgroundstart) ~ ground_year_min + row_number() -1 ,
         ((patent_year <universalgroundstart)& ground_year == universalgroundstart)~ ground_year_min + row_number() -1 ,
         TRUE ~ground_year

       ),
      col_acquirer_new =  
       case_when(
         is.na(universalgroundstart) ~ name_standard_patent2, 
         (((patent_year <universalgroundstart))& (ground_year < universalgroundstart))~name_standard_patent2  ,
         TRUE ~col_acquirer_new

       )


   ) %>% 
  ungroup()
 
 
allpatents_func_rename_merger_rename <- allpatents_func_rename_merger_exp %>%
  filter(
     ground_year >=patent_year
   )%>% 
 
 # allpatents_func_merger_cross%>% 
 #   filter(
 #    ground_year < patent_year
 #   ) %>% 
 #   View()
   # this binds both yrs before (and repeats same entries for previous yrs) and those found after
   #this first filter step reduces to patent 
 #      filter(
 #     patent_year >= ground_year
 #   ) %>%
   
        mutate(
       
       yearcount_since_patent = ground_year - patent_year,
       name_new_offpatent = 
         case_when(
           yearcount_since_patent>=20 & patent_type == "utility" ~ paste0("Offpatent"), 
           yearcount_since_patent>=20 & patent_type == "plant" ~ paste0("Offpatent" ), 
           yearcount_since_patent>=14 & patent_type == "design" ~ paste0("Offpatent"), 
        patent_type == "PVP" & ( ground_year > (patent_years+patent_year)) ~ paste0("Offpatent"), 
           
          yearcount_since_patent>=20 & (is.na(patent_type)) ~ paste0("Offpatent"), 

           TRUE ~ col_acquirer_new
         )# ,
       # name_new_offpatent =
       #   case_when(
       #     name_new_offpatent== "Offpatent" ~ "Offpatent",
       #     ground_year <col_year ~ name_standard_patent2,
       #     ground_year >=col_year ~ name_standard_patent2
       #   )

     ) %>% 

   mutate(
       name_new_offpatent =
         case_when(
           name_new_offpatent== "Offpatent" ~ "Offpatent",
           TRUE ~ col_acquirer_new
          )

   ) 
# allpatents_func_rename_merger_rename %>% 
#   select(
#     -newnametemp, -universalgroundstart   , -repnum, -ground_year_min,-yearcount_since_patent 
#   )

soycropquery_merger <-allpatents_func_rename_merger_rename%>%
select(
  -newnametemp, -universalgroundstart   , -repnum, -ground_year_min,-yearcount_since_patent
)

soycropquery_merger %>% 
  feather::write_feather(
    "X:/msi/work/farmer welfare/seed/R analysis/230122_soycropquerymerger.feather"
  )
soycropquery_merger
# allpatents_func_rename_merger_rename_red <- allpatents_func_rename_merger_rename %>%
#   mutate(
#     col_crop = crop,
#     col_id_new = patent_merger_id,
#     col_acquired = name_standard_patent2
#   ) %>%
# functionreduce_down_dups(passthrudf =.)
# left_join(
#   x_rename_lastyr_patent,
#   by = c("name_new_offpatent" = "name_standard_patent2", "crop")
# )%>%
# left_join(
#   y_rename_lastyr_merger,
#   by = c("name_new_offpatent" = "col_acquired", "crop" = "col_crop")
# )%>%
# 
#  
 
   # filter(
   #   patent_year >=minyear_merge
   #   
   # ) %>%
   #    filter(
   #   
   #   patent_year <= ground_year
   # ) %>%
  #  left_join(
  #    mergerdata220918_names %>% 
  #      filter(!is.na(Year), Column2 == "Yes") %>% 
  #      # select(
  #      #   
  #      # ) %>% 
  #        group_by(
  #   namestandard_acquirer, namestandard_acquired 
  # ) %>% 
  #   summarise(
  #     minyear = min(Year, na.rm = TRUE)
  #   ) %>% 
  #   ungroup(),
  # by = c("name_standard_patent2" = "namestandard_acquired", "col_acquirer" = "namestandard_acquirer")
  # 
  #  ) %>% 
   #this steps takes it back to the year before it merged; now I need to repopulate what it was earlier with the name of it before merger, ie patent name
   # filter(
   #   patent_year >=minyear
   # )  %>%
  # filter(
  #   grepl("advant", old_acquirer ,ignore.case = TRUE, perl = TRUE)
  # )%>% 
   # filter(
   #   patent_year >= ground_year
   # ) %>% 
 # select(
 #  patent_year,
 #  # minyear, minyear_merge,
 #  ground_year,
 #   # year_merge_max_larger,
 #   name_standard_patent2, col_acquirer_new,crop, 
 #   # year_patent_max,year_merge_max,
 #   old_acquirer,col_year, id, everything()
 #   ) %>% 
 #   arrange(
 #   id , col_id_new, ground_year#,
 #  # ground_year
 #   ) %>% 
 #   mutate(
 #     mergecrossid = row_number()
 #   ) 


}
```

#### how it was originally

```{r }

{
    merger_seminis <- allpatents_func_rename_merger     %>%
    filter(
        # col_id == "merge88",
        # crop == "soybean"
      grepl("5536901;08286473", id, perl = TRUE)
    ) %>% 
       select(
         col_id, ground_year, 
   # year_merge_max_larger,
   name_standard_patent2, name_new,
   # year_patent_max,year_merge_max,
   old_acquirer,col_year, id, everything()
   ) %>% 
      arrange(
        col_id
      )
    
  #       allpatents_func_merger_cross_seminis <- allpatents_func_merger_cross     %>%
  # filter(
  #   # grepl("advant", old_acquirer ,ignore.case = TRUE, perl = TRUE),
  #   # crop == "corn"
  #   grepl(
  #     "5536901;08286473", id
  #   )
  # )%>%
  #    select(
  #  patent_year, crop, ground_year,minyear_merge,
  #  # year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,
  #  # year_patent_max,year_merge_max,
  #  old_acquirer,col_year, id, everything()
  #  ) %>%
  #    arrange(
  #      id,ground_year, patent_year
  #    )
  # 
  #   
  #   x_merger_seminis <- x_merger    %>%
  # filter(
  #   grepl("5084082",  patent_number,ignore.case = TRUE, perl = TRUE)
  # )%>% 
  #    select(
  # yearcount_since_patent,  patent_year,  ground_year,name_standard_patent2, name_new,name_new_offpatent,old_acquirer,id,col_year,  everything()
  #  )

  #   x_merger_seminis <- x_rename    %>%
  # filter(
  #   grepl("asgrow", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  # )
  #   x_merger_seminis <- x_rename    %>%
  # filter(
  #   grepl("seminis", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  # )
  #   x_merger_seminis <- x_rename    %>%
  # filter(
  #   grepl("6433258|6448480|6835874|6765131",  patent_number,ignore.case = TRUE, perl = TRUE)
  # )
  # 
    # originated with asgrow and dow
  #      x_merger_seminis <- x_merger    %>%
  # filter(
  #   grepl("5945583",  patent_number,ignore.case = TRUE, perl = TRUE)
  # )



 
    # need to take earliest; then  change to f 
  allpatents_func_merger_precross <- allpatents_func_rename_merger %>%
   # this binds both yrs before (and repeats same entries for previous yrs) and those found after
   #this first filter step reduces to patent 
      filter(
     patent_year < ground_year
   ) %>%
    #This needs to be patent_year < (not inclusive of) ground year because everything beforehand until the year of the patent is the name of it beforehand.
   # filter(
   #   
   #   ground_year < patent_year
   # ) %>%
    #the below key step will change name to original patentapplicant name before the first year start of its merger
    mutate(
      name_new = name_standard_patent2
    )  %>% 

   group_by(
crop, id, patent_year,name_standard_patent2,col_id 
   ) %>% 
   filter(
     ground_year == min(ground_year)
   ) %>%
  mutate(
      repnum = ground_year - patent_year +1
    )  %>% 
 select(
   patent_year, ground_year, id, repnum,
   # year_merge_max_larger,
   name_standard_patent2, name_new,
   # year_patent_max,year_merge_max,
   old_acquirer,col_year,crop, everything()
   ) %>%
     arrange(
       id,ground_year, patent_year
     ) %>%
slice(rep(row_number(), repnum)) %>%
  mutate(
    # rownum = row_number(),
    ground_year = patent_year + row_number()-1#,
    # name_new = name_standard_patent2
  )  %>%

   ungroup()  %>% 
 select(
   patent_year, ground_year, id, repnum,
   # year_merge_max_larger,
   name_standard_patent2, name_new,
   # year_patent_max,year_merge_max,
   old_acquirer,col_year,crop, everything()
   ) %>%
     arrange(
       id,ground_year
     ) 
    
       # this binds both yrs before (and repeats same entries for previous yrs) and those found after; the last filter step eliminates years before the patent (but still keeps new name if changed)

 allpatents_func_merger_cross <- allpatents_func_merger_precross  %>%
   bind_rows(
     allpatents_func_rename_merger %>% 
       filter(
         !mergecrossid %in% allpatents_func_merger_precross$mergecrossid, 
         !(patent_year ==ground_year)
       )
   ) %>% 
   filter(
     ground_year >=patent_year
   )%>% 
 
 # allpatents_func_merger_cross%>% 
 #   filter(
 #    ground_year < patent_year
 #   ) %>% 
 #   View()
   # this binds both yrs before (and repeats same entries for previous yrs) and those found after
   #this first filter step reduces to patent 
 #      filter(
 #     patent_year >= ground_year
 #   ) %>%
   
        mutate(
       
       yearcount_since_patent = ground_year - patent_year,
       name_new_offpatent = 
         case_when(
           yearcount_since_patent>=20 & patent_type == "utility" ~ paste0("Offpatent"), 
           yearcount_since_patent>=20 & patent_type == "plant" ~ paste0("Offpatent" ), 
           yearcount_since_patent>=14 & patent_type == "design" ~ paste0("Offpatent"), 
        patent_type == "PVP" & ( ground_year > (patent_years+patent_year)) ~ paste0("Offpatent"), 
           
          yearcount_since_patent>=20 & (is.na(patent_type)) ~ paste0("Offpatent"), 

           TRUE ~ name_standard_patent2
         )# ,
       # name_new_offpatent =
       #   case_when(
       #     name_new_offpatent== "Offpatent" ~ "Offpatent",
       #     ground_year <col_year ~ name_standard_patent2,
       #     ground_year >=col_year ~ name_standard_patent2
       #   )

     ) %>% 

   mutate(
       name_new_offpatent =
         case_when(
           name_new_offpatent== "Offpatent" ~ "Offpatent",
           TRUE ~ name_new
          )

   )%>% 
   # left_join(
   #   x_rename_lastyr_patent,
   #   by = c("name_new_offpatent" = "name_standard_patent2", "crop")
   # )%>% 
   # left_join(
   #   y_rename_lastyr_merger,
   #   by = c("name_new_offpatent" = "col_acquired", "crop" = "col_crop")
   # )%>% 
     arrange(
       id,ground_year
     )%>% 
     select(
       
    patent_year,  ground_year,name_standard_patent2, name_new,name_new_offpatent,old_acquirer,id,col_year,
  #  year_patent_max,year_merge_max, 
    everything()#,
 # -repnum
   ) %>%
   # mutate(
   #   year_merge_max = replace_na(year_merge_max, 2050), 
   #   year_merge_max_gsub = 
   #     as.numeric(
   #       gsub(
   #         "-.*","", old_acquirer
   #       )
   #     ),
   #   year_merge_max_larger = 
   #     case_when(
   #       year_merge_max > year_merge_max_gsub ~ year_merge_max,
   #       year_merge_max <= year_merge_max_gsub ~ year_merge_max_gsub
   #     )
   # ) %>%
   # filter(
   #   
   #   patent_year <= ground_year
   #   
   #   # year_merge_max>ground_year 
   #   # !((year_merge_max<=ground_year )&(!is.na(year_merge_max)))
   # )  %>% 
   # group_by(
   #    id, col_year, ground_year, crop, name_standard_patent2, col_id
   # ) %>% 
   # this step eliminates dual identities per year if >2x merger happened in that year (else will have two paths for mergers in diff yrs); and places the patent into that which it will likely become instead of retaining it elsewhere
   # arrange(
   #   -year_merge_max_larger
   # ) %>% 
 #  slice(1) %>%
   ungroup()%>% 
       filter(
         ground_year <= 2022
       )
    
  merger_cross_seminis <- allpatents_func_merger_cross     %>%
  filter(
    # grepl("advant", old_acquirer ,ignore.case = TRUE, perl = TRUE),
    # crop == "corn"
    grepl(
      "5536901;08286473", id, perl = TRUE
    )
        #     grepl(
        #     "6849790;09811048", id
        # )

  )%>%
    select(
        col_id,repnum, ground_year, 
        # year_merge_max_larger,
        name_standard_patent2, name_new,
        # year_patent_max,year_merge_max,
        old_acquirer,col_year, id, everything()
    ) %>% 
     arrange(
       col_id
     )
  merger_cross_seminis <- allpatents_func_merger_cross     %>%
  filter(
    # grepl("advant", old_acquirer ,ignore.case = TRUE, perl = TRUE),
    # crop == "corn"
    grepl(
      "10440909;15679863;canola", id, perl = TRUE
    )#, 
    # grepl(
    #   "merge19]canolaticker4]canola", col_id, perl = TRUE
    # )
        #     grepl(
        #     "6849790;09811048", id
        # )

  )%>%
    select(
        col_id,repnum, ground_year, 
        # year_merge_max_larger,
        name_standard_patent2, name_new,
        # year_patent_max,year_merge_max,
        old_acquirer,col_year, id, everything()
    ) %>% 
     arrange(
       col_id
     )
  #    allpatents_func_rename_merger_seminis <- allpatents_func_rename     %>%
  # filter(
  #   grepl("advant", name_standard_patent2 ,ignore.case = TRUE, perl = TRUE)
  # )%>%
  #    select(
  #  patent_year,  ground_year,
  #  # year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,
  #  # year_patent_max,year_merge_max,
  #  old_acquirer,col_year, id, everything()
  #  ) %>%
  #    arrange(
  #      id,ground_year, patent_year
  #    )

  #   x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("5084082",  patent_number,ignore.case = TRUE, perl = TRUE)
  # )%>% 
  #    select(
  #  patent_year,  ground_year,
  #  year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) %>%
  #    arrange(
  #      id,ground_year, patent_year
  #    )

 # test for presence of ################
 
  #   x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("asgrow", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,
  #  year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) %>% 
  #    arrange(
  #      id,ground_year, patent_year
  #    )
  # 
  #  x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("shamrock", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,
  #  # year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) %>% 
  #    arrange(
  #      id,ground_year, patent_year
  #    )
  #  x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("6433258|6448480|6835874|6765131", patent_number,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,
  #  year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  )  
  # 
  #  #mycogen agrigenetics dow inspect
  #  x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("4381624", id,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,
  #  year_merge_max_larger,
  #  name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  )  
  # 
  #  x_merger_seminis <- x_merger_cross    %>%
  #    group_by(
  #      id
  #    ) %>% 
  #    mutate(
  #      max_colyrs = length(unique(col_year))
  #    ) %>% 
  # filter(
  #    max_colyrs >=3
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) %>% 
  #    arrange(
  #      id,ground_year
  #    )
  #  
  #  # soybean shared bt asgrow/monsanto/bayer and corteva?
  #    x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("5945583", id,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) 
  # 
  #    #dupont bought pioneer in 1997 and 1999 so need to make more for that one
  #      x_merger_seminis <- x_merger_cross    %>%
  # filter(
  #   grepl("5602317", id,ignore.case = TRUE, perl = TRUE)
  # ) %>% 
  #    select(
  #  patent_year,  ground_year,name_standard_patent2, name_new,name_new_offpatent,year_patent_max,year_merge_max,old_acquirer,col_year, id, everything()
  #  ) %>% 
  #    arrange(
  #      id,ground_year, patent_year
  #    )
   
   # test for presence of ################ end #####
     # before flattening, check if we have any ids with different numbers of new names per year
       
       ### need below
 # x_merger_cross_diffyears <-      x_merger_cross%>% 
 #         group_by(
 #           id, col_year, ground_year, crop, name_standard_patent2
 #         ) %>% 
 #         mutate(
 #           num_new = paste0( length(unique(name_new_offpatent)))
 #         ) %>% 
 #         ungroup() %>% 
 #         group_by(
 #           id, crop, name_standard_patent2
 #         ) %>% 
 #         summarise(
 #           num_new_acrossyears = length(unique(num_new)), 
 #           yearnew = paste(unique(num_new)%>% sort(), collapse = ", ")
 #         )%>% 
 #         filter(
 #           num_new_acrossyears >=2
 #         )
     # now flatten and consolidate same flows; and assign new id for new
     allpatents_func_merger_cross_wide <- allpatents_func_merger_cross%>% 
       filter(
         ground_year <= 2022
       ) %>% 
       # slice(c(6771:6773)) %>% 
       select(
           id, col_id,ground_year, crop, name_standard_patent2, name_new_offpatent
       ) %>%
       distinct() %>% 
    slice(c(416137, 416142, 416144, 416145, 416148))
    # slice(1000:2000) %>% 
       spread(
         key = ground_year,
         value = name_new_offpatent
       ) %>% 
         arrange(
           id
         ) %>% 
         group_by_(
          c(
            "id", "crop", "name_standard_patent2",
            allpatents_func_merger_cross$ground_year %>% unique()
          ) 
         ) %>% 
         slice(1) %>% 
         ungroup() %>% 
         group_by(
           id, crop, name_standard_patent2
         ) %>% 
         mutate(
           id2 = paste0(id,"_idmerge}",row_number())
         )%>% 
         ungroup()
       
  allpatents_merger_cross_reid <- allpatents_func_merger_cross %>% 
    inner_join(
      allpatents_func_merger_cross_wide %>% 
        # rename(
        #   id2 = id
        # ) %>% 
        select(
         id, id2,  crop, name_standard_patent2
        ), 
      by = c(
       "id", "crop", "name_standard_patent2"
      )
    ) %>% 
    select(
      -id
    ) %>% 
    rename(
      id = id2
    )
         
   x_nonmerger <- x_rename %>% 
     filter(
       !universal_id_start %in% c(x_merger_cross$universal_id_start)
     ) 
  
   # now take those not ids in and stretch them out from patent year to 2022 
  x_nonmerger_cross <- x_nonmerger %>% 
    mutate(
      repnum = 2022 - patent_year +1
    ) %>% 
    group_by(
     id,   crop, name_standard_patent2
      )%>%
    slice(1) %>%
    mutate(
      id2 =  paste0(id,"_idnomerge}",row_number()),
      repnum = 2022 - min(patent_year) +1
    ) %>%
     slice(rep(row_number(), repnum)) %>%
  mutate(
    # rownum = row_number(),
    ground_year = row_number()-1 + patent_year
  ) %>%
  ungroup() %>%
  select(
    -repnum
  )  %>% 
  group_by(
     id2,   crop, name_standard_patent2,ground_year
      )%>%
    slice(1) %>%
    ungroup()%>% 
    select(
      -id
    ) %>% 
    rename(
      id = id2
    ) %>% 
     mutate(
      
       yearcount_since_patent = ground_year - patent_year,
       name_new_offpatent = 
         case_when(
           yearcount_since_patent>=20 & patent_type == "utility" ~ paste0("Offpatent"), 
           yearcount_since_patent>=20 & patent_type == "plant" ~ paste0("Offpatent" ), 
           yearcount_since_patent>=14 & patent_type == "design" ~ paste0("Offpatent"), 
          yearcount_since_patent>=20  ~ paste0("Offpatent"), 

           TRUE ~ name_standard_patent2
         )# ,
       # name_new_offpatent =
       #   case_when(
       #     name_new_offpatent== "Offpatent" ~ "Offpatent",
       #     ground_year <col_year ~ name_standard_patent2,
       #     ground_year >=col_year ~ name_standard_patent2
       #   )

     )

  x_nonmerger_cross_wide <- x_nonmerger_cross%>% 
    select(
      id, ground_year, crop, name_standard_patent2, name_new_offpatent
    ) %>%
    distinct() %>% 
    spread(
      key = ground_year,
      value = name_new_offpatent
    ) %>% 
    arrange(
      id
    ) %>% 
    group_by_(
      c(
        "id", "crop", "name_standard_patent2",
        x_nonmerger_cross$ground_year %>% unique()
      ) 
    ) %>% 
    slice(1) %>% 
    ungroup() %>% 
    group_by(
      id, crop, name_standard_patent2
    ) %>% 
    mutate(
      id2 = paste0(gsub("_idnomerge}.*","", id),"_idnomerge}",row_number() )
    )%>% 
    ungroup()
  
 x_merger_seminis <- x_nonmerger_cross_wide    %>%
  filter(
    grepl("usda", name_standard_patent2,ignore.case = TRUE, perl = TRUE)
  ) 
    
       
  x_nonmerger_cross_reid <- x_nonmerger_cross %>% 
    inner_join(
      x_nonmerger_cross_wide %>% 
        # rename(
        #   id2 = id
        # ) %>% 
        select(
         id, id2,  crop, name_standard_patent2
        ), 
      by = c(
       "id", "crop", "name_standard_patent2"
      )
    ) %>% 
    select(
      -id
    ) %>% 
    rename(
      id = id2
    )
  
  x_merger_bind <-     x_merger_cross_reid %>% 
    select(
       c(
        names(x_nonmerger_cross_reid), 
        "name_new", "old_acquirer"
      )
    ) %>% 
    bind_rows(
      x_nonmerger_cross_reid
    )
  
 x_merger_bind
  # x_merger_cross_numforks_perid <- x_merger_cross%>% 
 #   group_by(
 #     id
 #   ) %>% 
 #   d
   # this will find the number of splits per application
   # i <- 1
   # years_cyclethrough <- x_merger_cross$ground_year %>% unique() %>% sort()
   # 
   # i <- which(years_cyclethrough == 1995)
   # rm(list_previous_mergerids)
   # list_previous_mergerids <- list()
   # rm(listcurrent_mergerids)
   # listcurrent_mergerids <- list()

#    while(i <= length(years_cyclethrough))
#    {
#      current_year <-years_cyclethrough[i]
#      x_merger_current_df <- x_merger_cross %>% 
#        filter(
#          ground_year == current_year
#        )
#     x_merger_current_df_renamepatentid <-x_merger_current_df %>% 
#        mutate(
#          current_co_oldacquirer = paste0(
#            assignee_organization_namestandard,"_",
#            old_acquirer
#          )
#        ) %>% 
#        group_by(
#          id
#        ) %>% 
#        mutate(
#          num_splits = length(unique(current_co_oldacquirer))
#          # new_id = 
#          #   paste0(
#          #     id,"_",
#          #     cumsum(!duplicated(current_co_oldacquirer))
#          #   ) 
#          # 
#        ) %>% 
#        ungroup()
#      if(i ==1 )
#      {
# 
#         list_previous_mergerids[[i]] <-x_merger_current_df_renamepatentid 
#      }
#           
#      if(i >=1 )
#      {
#        list_previous_mergerids[[i]] <- list_previous_mergerids[[i-1]]  x_merger_current_df_renamepatentid
#      }
#      
# 
#      i <-i+1
#    }
#    
# x_merger_seminis <- x_merger_cross    %>%
#   filter(
#     grepl("PP22533", patent_number,ignore.case = TRUE, perl = TRUE)
#   ) %>%
#   select(
#   ground_year,patent_year, repnum, name_standard_patent2, name_new, old_acquirer, everything()
#   )%>%
#   arrange(patent_year, patent_number,ground_year)
# 
#      x_finalstate <- x_merger %>% 
#     group_by(
#        name_standard_patent2,id
#     ) %>% 
#    filter(
#      ground_year == max(ground_year)
#    )%>% 
#      # slice(which.max(ground_year )) %>% 
#    ungroup() %>% 
#    rename(
#      final_name = name_new_offpatent
#    )%>% 
#    select(
#      name_standard_patent2,final_name, id
#    ) %>% 
#    distinct()
#      
# x_everypathtakenLU <- x_merger%>% 
#   mutate(
#     originator = 
#         case_when(
#           !is.na(old_acquirer) ~ paste0( 
#             gsub(".*; ","", old_acquirer)
#           ),
#           is.na(old_acquirer) ~ paste0( 
#              name_standard_patent2
#           )
#           
#         )
#   ) %>% 
#   select(
#     name_standard_patent2,id,originator
#   ) %>% 
#   distinct() %>% 
#      left_join(
#        x_finalstate, 
#        by = c("name_standard_patent2", "id")
#      ) %>% 
#     select(
#     name_standard_patent2,id,originator,final_name
#   ) %>% 
#   distinct() %>% 
#   mutate(
#     originator2 = paste0(originator,"_", final_name)
#   ) %>% 
#   group_by(
#     name_standard_patent2,id 
#   ) %>% 
#   mutate(
#     id_2 = paste0(id,"_",  cumsum(!duplicated(originator2)) )
#   ) %>% 
#   ungroup()
# 
#    
#    x_merger_edit <- x_merger %>% 
#      left_join(
#        x_finalstate, 
#        by = c("name_standard_patent2", "id")
#      ) %>% 
#      
#     mutate(
#       originator = 
#         case_when(
#           !is.na(old_acquirer) ~ paste0( 
#             gsub(".*; ","", old_acquirer)
#           ),
#           is.na(old_acquirer) ~ paste0( 
#              name_standard_patent2
#           ),
#           
#         ), 
#       yearcount_since_patent = ground_year - patent_year,
#       name_new = 
#         case_when(
#           yearcount_since_patent>=20 & patent_type == "utility" ~ paste0("Offpatent"), 
#           yearcount_since_patent>=20 & patent_type == "plant" ~ paste0("Offpatent" ), 
#  yearcount_since_patent>=14 & patent_type == "design" ~ paste0("Offpatent"), 
#  TRUE ~ name_new
#         )
#         
#     ) %>% 
#     arrange(
#       assignee_organization
#     )%>%
#     group_by(
#       id, crop  
#     ) %>% 
#     arrange(
#       originator
#     )%>%
#   mutate(id =paste0(  cumsum(!duplicated(originator)),"_", id)) %>% 
#     ungroup()
#  
# 
#  # 
# 
#  
# # x_merger_seminis <- x_merger_cross    %>%
# #   filter(
# #     grepl("hornbec", assignee_organization,ignore.case = TRUE, perl = TRUE)
# #   ) %>%
# #   select(
# #   ground_year,patent_year, repnum, name_standard_patent2, name_new, old_acquirer, everything()
# #   )%>%
# #   arrange(patent_year, patent_number,ground_year)
# 
#  x_nonmerger <- x_rename %>% 
#     anti_join(
#       y, 
#       by = c("crop" = "col_crop", "name_standard_patent2"="col_acquired"  )
#     ) 
#  
#   x_nonmerger_cross <- x_nonmerger %>% 
#     mutate(
#       repnum = 2022 - min(patent_year) +1
#     ) %>% 
#     group_by(
#      patent_number,  crop ,patent_year, topic, name_standard_patent2  
#       )%>%
#     slice(1) %>%
#     mutate(
#       repnum = 2022 - min(patent_year) +1
#     ) %>%
#      slice(rep(row_number(), repnum)) %>%
#   mutate(
#     # rownum = row_number(),
#     ground_year = row_number()-1 + patent_year
#   ) %>%
#   ungroup() %>%
#   select(
#     -repnum
#   )  
#   x_merger_cross %>% 
#     bind_rows(
#       x_nonmerger_cross
#     )
  
  #   left_join(
  #     y, 
  #     by = c("crop" = "col_crop", "name_standard_patent2"="col_acquired", "ground_year"  )
  #   )
    
  
}

```


### use pair function 1
```{r }
soycropquery_merger <-
soycropquery_unnest_df %>% 
  joinpatents_with_mergerfunc(x=., y= sendthroughmergers_LU ) #%>% 
  # select(
  # ground_year,patent_year,  name_standard_patent2, name_new, old_acquirer, everything()
  # )  %>% 
  #   mutate(
  #     name_standard_patent2= replace_na(name_standard_patent2, "no assignee name" ),
  #     name_new = 
  #       case_when(
  #         name_standard_patent2 == "no assignee name" ~ name_standard_patent2,
  #         is.na(name_new) ~  name_standard_patent2, 
  #         TRUE ~ name_new
  #       )
  #   ) %>% 
  # filter(
  #   patent_year <=ground_year
  # )
soycropquery_merger_stone <- soycropquery_merger %>% 
  filter(
    grepl("advanta", assignee_organization,ignore.case = TRUE, perl = TRUE)
  ) %>%  
     select(
   patent_year,  ground_year,
    
   name_standard_patent2, name_new,name_new_offpatent,old_acquirer,id, everything()
   ) %>%
     arrange(
       id,ground_year, patent_year
     )

#namenewoffpatent is the new name
```

#### how it was originally

```{r }
findparentcompanyfunc <- function(x,acquirercol, acquiredbycol,cropcol,  yearcol,idcol, df_patents ){
  
  x = mergerdata220918_names
  acquirercol = mergerdata220918_names$namestandard_acquirer_lower
  acquiredbycol = mergerdata220918_names$namestandard_acquired_lower
  cropcol = mergerdata220918_names$Crop
  yearcol = mergerdata220918_names$Year
  idcol = mergerdata220918_names$idcol
  df_patents = soycropquery_unnest_df_likelyplants_themed %>% 
    mutate(
      acquired_all_rowid = row_number()
    )
    
  x_df <- x %>% 
    cbind(
      tibble(
        col_acquirer = acquirercol
      ),
      tibble(
        col_acquiredby = acquiredbycol
      ), 
      tibble(
        col_year = yearcol
      ), 
      tibble(
        col_crop = cropcol
      )
    )%>% 
  group_by(
    col_acquirer, col_acquiredby, col_year
  ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(
    Column2 == "Yes"
  )
  
  

  # biggest_acquirers_LU <- x_df %>% 
  #   group_by(
  #     col_acquirer
  #   ) %>% 
  #   summarise(
  #     number_acquisitions = n()
  #   )%>% 
  #   ungroup() 
  # 
  # acquired_many_to_one_LU <- x_df  %>%
  #   group_by(
  #     col_acquirer
  #   ) %>%
  #   mutate(
  #     number_acquisitions = n()
  #   ) %>%
  #   ungroup() %>%
  #   group_by(
  #     col_acquiredby, col_year
  #   ) %>%
  #   arrange(
  #     -number_acquisitions
  #   ) %>% 
  #   slice(1) %>% 
  #   ungroup()

    # left_join(
    #   biggest_acquirers_LU
    # )

  lucrossing <- crossing(
    year_ground = c(min(na.omit(c(x_df$col_year))):max(na.omit(c(df_patents$year)))), 
    firmname = c(acquirercol,acquiredbycol )%>% unique()
  ) %>% 
    distinct() %>% 
  inner_join(
    x_df %>% 
      select(
        col_acquirer, col_acquiredby, col_year, col_crop, idcol
      ), 
    by = c("firmname" ="col_acquiredby" )
  )   %>% 
    #filter out if year is greater than merger year
    filter(
      year_ground >= col_year
    ) %>%
    group_by(
      col_acquirer
    )%>% 
    mutate(
      num_acquisitions = length(unique(idcol))
    )%>% 
    ungroup()%>% 
    group_by(
     firmname, col_crop, year_ground, col_year
    ) %>% 
    arrange(
      -num_acquisitions
    )%>% 
    slice(1) %>% 
    ungroup() %>% 
    group_by(
      firmname
    ) %>% 
    arrange(
      col_year, firmname
    ) %>% 
    ungroup()
   
lucrossing_monsanto <- lucrossing%>%
  filter(
    grepl("dekalb",firmname, ignore.case = TRUE, perl =TRUE )
  )

lucrossing_monsanto <- lucrossing%>%
    filter(
        grepl("monsan",col_acquirer, ignore.case = TRUE, perl =TRUE )
    )

lucrossing_get_otherorder <- function(d){
  whichgotacquired <- lucrossing %>% 
    filter(
      col_acquirer %in% c(
        lucrossing$firmname
      ),
      year_ground >= col_year
    )
  
  whichgotacquired_spread_nocrop <- whichgotacquired %>% 
    # filter(
    #   is.na(col_crop)
    # ) %>%
    select(
      year_ground,firmname, col_acquirer, col_year, col_crop
    ) %>% 
    group_by(
      year_ground,firmname, col_acquirer,col_crop
    ) %>% 
    summarise(
      col_year = mean(min(col_year, na.rm = TRUE), na.rm = TRUE)
    ) %>% 
    ungroup() %>% 
    # group_by(
    #   firmname, col_acquirer 
    # ) %>% 
    # mutate(
    #   count = n()
    # )
    spread(
      key = col_acquirer, 
      value =  col_year
    )
  
  names_to_loopthru <- whichgotacquired_spread_nocrop$firmname %>% unique() %>% sort()
  #loop through all of acquirers that got acquired
  j<- 1
  #j <-262
  storelistoffinalacq = list()

  while(j <= length(names_to_loopthru))
  {
    currentname_loopthru = names_to_loopthru[j]
    currentname_acquired <- whichgotacquired_spread_nocrop%>% 
      filter(firmname ==currentname_loopthru ) %>%
      gather(
        key = col_acquirer,
        value = col_year,
        -firmname, -col_crop,-year_ground
      ) %>% 
     filter(
       !is.na(col_year)
     ) %>% 
      mutate(
        type_acquisition = 
          case_when(
           year_ground == col_year ~  paste0("named")
          ), 
       acquirer =  case_when(
           year_ground == col_year ~  paste0(col_acquirer)
          ),
      fill_acquirer = acquirer,
      fill_type = type_acquisition
       
      )%>% 
      arrange(
        year_ground
      )%>% 
      tidyr::fill(
        fill_acquirer, .direction ="down"
      )%>% 
      tidyr::fill(
        fill_type, .direction ="down"
      ) %>% 
      mutate(
        helpersort = case_when(
          (is.na(acquirer)) ~ "ZZZZZZ_M",
          # (is.na(acquirer))&() ~ "ZZZZZZ_0",

          TRUE ~ "ZZZZZZ_0"
        )
      ) %>% 
      group_by(
        year_ground
      ) %>% 
      arrange(helpersort) %>% 
      slice(1) %>% 
      ungroup()  
    
    
   currentname_acquired_withacquired <- 
        whichgotacquired_spread_nocrop%>% 
     # inner_join(
     #   currentname_acquired %>%
     #     select(
     #       year_ground, col_acquirer
     #     ),
     #   by  = c("year_ground","firmname" = "col_acquirer" )
     # )%>%
          filter(
            firmname %in% currentname_acquired$col_acquirer
          )%>%
      gather(
        key = col_acquirer,
        value = col_year,
        -firmname, -col_crop,-year_ground
      )%>% 
     filter(
       !is.na(col_year)
     )%>% 
     # left_join(
     #   currentname_acquired %>% 
     #     select(
     #       year_ground, 
     #     )
     # )
      mutate(
        type_acquisition = 
          case_when(
           year_ground == col_year ~  paste0("acquisition_of_named")
          ), 
       acquirer =  case_when(
           year_ground == col_year ~  paste0(col_acquirer)
          ),
      fill_acquirer = acquirer,
      fill_type = type_acquisition
      )%>% 
      arrange(
        year_ground
      )%>% 
      tidyr::fill(
        fill_acquirer, .direction ="down"
      )%>% 
      tidyr::fill(
        fill_type, .direction ="down"
      ) %>% 
      mutate(
        helpersort = case_when(
          is.na(acquirer) ~ "ZZZZZZ_Z",
          TRUE ~ "ZZZZZZ_A"
        )
      ) %>% 
      group_by(
        year_ground
      ) %>% 
      arrange(helpersort) %>% 
      slice(1) %>% 
      ungroup()  
currentname_acquired_withacquired <- currentname_acquired %>%  
      bind_rows( 
        currentname_acquired_withacquired
        )  %>% 
      arrange(
        year_ground
      )%>% 
  mutate(
    lagacquisit = lag()
  ) %>% 
      group_by(
        year_ground
      ) %>% 
      arrange(helpersort,year_ground) %>% 
      slice(1) %>% 
      ungroup()
      
   
   g%>% 
     mutate(
       
       is_year_acquisition = case_when(
         year_ground == col_year ~ , 
         TRUE ~ ""
       )
     )
      
    # for each primary acquirer (1d) get the second order set of acquirers (2d)
    # if the 2d acquirer gets acquired later on, add that to the list; remove any ? 
    years_within_jloopthru <- current_df_whichgotacquired$year_ground %>% unique() %>% sort()
  q <- 1 
  while(q <= length(years_within_jloopthru))
  {
    current_yearloop <- years_within_jloopthru[q]
    
    current_whichgotacquired <- whichgotacquired %>%
      filter(
        year_co
      )
    
    current_df_whichgotacquired_year <- current_df_whichgotacquired %>% 
      filter(
        year_ground == current_yearloop
      ) %>% 
  dplyr::rename_with(~ paste0("source_", .))%>% 
      inner_join(
        whichgotacquired, 
        by = c("source_col_acquirer" = "firmname", "source_year_ground" = "year_ground" )
      ) %>% 
      select(
        source_firmname, source_col_acquirer
      ) 
    current_df_acquirername = current_df_whichgotacquired_year$col_acquirer[1]
    
    current_df_lucrossingacquirer = whichgotacquired %>% 
      filter(
        
      )
    
  }
      
  }
  
  j <- 1 
  have_acquiredloop <- "yes"
  rm(storelistoffinalacq)
  storelistoffinalacq = list()
  current_whichgotacquired = whichgotacquired
  while(have_acquiredloop =="yes")
  {
    d_secondorder <- current_whichgotacquired %>% 
    inner_join(
      lucrossing %>% 
        filter(
          col_acquirer %in% c(
            lucrossing$firmname
          )
        ) %>% 
        select(
          col_acquirer, firmname, col_year,year_ground
        ) %>% 
        rename(
         new.col_acquirer = col_acquirer , 
        new.col_year = col_year
          
        ),
       # setNames(paste0('new.', names(.))),
      by = c("col_acquirer" = "firmname", "year_ground")
        
    ) %>% 
    select(
      -col_acquirer, -col_year
    )  %>% 
      rename(
        col_acquirer=new.col_acquirer , 
        col_year = new.col_year
      ) %>% 
      mutate(
        temp_rowid =row_number()
      ) %>% 
      left_join(
        lucrossing %>% 
          select(
            
          )
      )
    storelistoffinalacq[[j]] <- d_secondorder %>% 
      filter(
        year_ground < col_year
      ) 
   current_whichgotacquired <-d_secondorder %>%  
     anti_join(
       storelistoffinalacq[[j]] %>% 
         select(
           temp_rowid
         ), 
       by = c("temp_rowid")
     )
      filter(
        year_ground >= col_year
      )
    storelistoffinalacq[[j]] <- d_secondorder
    current_whichgotacquired <- d_secondorder %>%
      filter(
        col_acquirer %in% c(
          lucrossing$firmname
        ),
        year_ground >= col_year
      )
    if( nrow(current_whichgotacquired) <=1)
    {
      have_acquiredloop = "no"
    }
    j<-j+1
    
  }
  
  
 
  
}

# first need to rep df patents from year patent onwards
df_patents_crossed = df_patents %>% 
  mutate(
    repeatntimes =  max(na.omit(c(df_patents$year))) - year + 1, 
    # repeatntimes = replace()
  )%>% 
  group_by(
    acquired_all_rowid
  )%>%
  slice(rep(1:n(), first(repeatntimes))) %>% 
  mutate(
    year_ground = year+( row_number() -1)
  )%>% 
  ungroup()

df_patents_crossed$patent_number %>% unique() %>% length()

df_patents_acquired_crop_iscrop <-  df_patents_crossed %>%
    inner_join(
      lucrossing %>%
        filter(
          !is.na(col_crop)
        )  ,
      by = c("renamedcol" = "firmname","crop" = "col_crop", "year_ground")
    )

df_patents_acquired_crop <-  df_patents_crossed %>%
    left_join(
      lucrossing %>%
        filter(
          !is.na(col_crop)
        )  ,
      by = c("renamedcol" = "firmname","crop" = "col_crop", "year_ground")
    ) %>% 
  filter(
    acquired_all_rowid %in% (
      df_patents_acquired_crop_iscrop%>% 
        filter(
          !is.na(idcol)
        )
    )$acquired_all_rowid
  )


df_patents_acquired_crop_monsanto <- df_patents_acquired_crop%>%
    filter(
        grepl("syngen",col_acquirer, ignore.case = TRUE, perl =TRUE ),
        grepl("monsan",renamedcol, ignore.case = TRUE, perl =TRUE ),

        # acquired_all_rowid == 4
    )

df_patents$patent_number %>% unique() %>% length()
df_patents_acquired_all <-  df_patents_crossed %>% 
  filter(
    !acquired_all_rowid %in% c(
      df_patents_acquired_crop$acquired_all_rowid
    )
  ) %>% 
  # anti_join(
  #   df_patents_acquired_crop %>%
  #     select(
  #       renamedcol, crop
  #     ),
  #   by = c("renamedcol", "crop")
  # ) %>% 
  left_join(
    lucrossing %>%
      filter(
        !idcol %in% c(df_patents_acquired_crop$idcol),
      
        is.na(col_crop)
      ),
    by = c("renamedcol" = "firmname", "year_ground")
    
  ) %>% 
  # left_join(
  #     lucrossing ,
  #       # filter(
  #       #   is.na(col_crop)
  #       # ), 
  #     by = c("renamedcol" = "firmname")
  #   ) %>% 
  # filter(
  #   !is.na(col_acquirer)
  # ) %>% 
  bind_rows(
    df_patents_acquired_crop
  ) %>%
  #   group_by(
  #     Namestandard
  #   ) %>% 
  #   arrange(
  #     -col_year
  #   ) %>% 
  # ungroup()  %>% 
  filter(
    #FIRST FILTER OUT IF YEAR IS AFTER PATENT YEAR
    year_ground >= year #, 
   #SECOND FILTER OUT IF YEAR IS AFTER PATENT YEAR (repeat of above; just in case)
  # year_ground >= col_year
  ) %>% 
    mutate(
    patent_endyear = case_when(
      patent_type == "utility" ~ year + 20,
       patent_type == "plant" ~ year + 17,
        patent_type == "design" ~ year + 15,
      TRUE ~ year + 20
    
    ),
    belongsto = 
     case_when(
       year_ground >=col_year ~col_acquirer,
       TRUE ~ Namestandard
     ),
   belongsto_if_offpatent =  case_when(
     year_ground > patent_endyear ~ "Off patent", 
     TRUE ~ belongsto
   )  
    # crop_join = case_when(
    #   renamedcol %in% c(
    #     (
    #       lucrossing %>% 
    #       filter(
    #         !is.na(col_crop)
    #       )
    #     )$firmname
    #     
    #   )
    # )
  ) %>% 
  select(
    year_ground,Namestandard, belongsto,belongsto_if_offpatent,col_year, year, crop, patent_title, patent_abstract, everything()
  )
df_patents_acquired_all_monsanto <- df_patents_acquired_all%>%
    # filter(
    #     grepl("syng",renamedcol, ignore.case = TRUE, perl =TRUE )
    # )
    filter(
     acquired_all_rowid == 4
    )

df_patents_acquired_all_monsanto <- df_patents_acquired_all%>%
    filter(
        grepl("syng",renamedcol, ignore.case = TRUE, perl =TRUE )
    ) %>% 
  arrange(
    acquired_all_rowid
  )
df_patents_acquired_all_monsanto <- df_patents_acquired_all%>%
    filter(
        # crop == "sunflower", 
         grepl("delta",Namestandard, ignore.case = TRUE, perl =TRUE ),
         # grepl("syng",belongsto, ignore.case = TRUE, perl =TRUE ), 
# acquired_all_rowid %in% c(
#   df_patents_acquired_crop$acquired_all_rowid
# )
    ) %>% 
  arrange(
    acquired_all_rowid
  )


    # filter(
    #  acquired_all_rowid == 4
    # )


df_patents_acquired_all$patent_number %>% unique() %>% length()


df_patents_acquired_all_repeat <- df_patents_acquired_all %>% 
  group_by(acquired_all_rowid) %>% 
  arrange(year_ground) %>% 
  slice(1) %>%
  ungroup() %>% 
  rename(
    minground = year_ground
  )%>% 
  mutate(
    repeatntimes = minground - year
  )%>% 
  group_by(
    acquired_all_rowid
  )%>%
  slice(rep(1:n(), first(repeatntimes))) %>% 
  mutate(
    year_ground = year+( row_number() -1)
  )%>% 
  ungroup()
  select(
    -repeatntimes,-minground
  )

df_patents_acquired_all_final <- df_patents_acquired_all%>% 
  bind_rows(
    df_patents_acquired_all_repeat
  ) %>% 
  mutate(
   belongsto = 
     case_when(
       year_ground >=col_year ~col_acquirer,
       TRUE ~ Namestandard
     ),
   belongsto_if_offpatent =  case_when(
     year_ground > patent_endyear ~ "Off patent", 
     TRUE ~ belongsto
   )  
   
  )  

df_patents_acquired_all_monsanto <- df_patents_acquired_all%>%
    filter(
        grepl("dekalb",renamedcol, ignore.case = TRUE, perl =TRUE )
    )


df_patents_acquired_all
}
```

# graph summary


## lineplot dominance

### function
```{r }

linegraph_dominanceoveral_func <- function(x, output_folder, 
      file_name,  widthdf = 128, heightdf = 72, namecol=NULL, showtopn_or_other = 12, slicetopnlabel = 6,slicetopn =6, if_faceted = "no", faceted_col = NULL, sizefont = 20, showminfacet = 10, sizefontlabel= 5, sizefontlabel_title = 8, pointsize = 2, use_cowplot = "no", skip_eachcrop = "yes") {

  x <- x  %>%
     cbind(
       tibble(
         namedcolumn = namecol
       )
     ) 
  if(if_faceted != "no")
  {
    x <- x %>% 
      cbind(
        tibble(
          facetcol = faceted_col
        )
      )

  }
   if(if_faceted == "no")
  {
    x <- x %>% 
      mutate(
        facetcol = "onefacet"
      )
    
  }
 x <- x%>% 
      mutate(
        allpatentnum = length(unique(patent_number))
      )%>% 
   group_by(
     facetcol
   )%>% 
   mutate(
     num_patents = length(unique(patent_number)), 
     # percent_allpatents = percent(num_patents/allpatentnum)
   ) %>% 
   ungroup() %>% 
   mutate(
     facetcol = paste0(
       facetcol, 
       " (",addUnits(num_patents)  , " patents)"
       )
   )
  
   x_df_summary <- x %>%
     filter(
       !is.na(namedcolumn)
     ) %>% 
  group_by(
    namedcolumn, facetcol
  ) %>% 
  summarise(
    total_patents = length(unique(patent_number))
  ) %>% 
  arrange(
    -total_patents
  ) %>% 
     # this is the command to coerce to "other"
  slice(1:showtopn_or_other) %>% 
     ungroup() 
   
  #  x_df_summary_label <- x %>%
  #    # mutate(
  #    #   namedcolumn = replace_na
  #    # )
  #    filter(
  #      !is.na(namedcolumn)
  #    ) %>%
  # group_by(
  #   namedcolumn
  # ) %>% 
  # summarise(
  #   total_patents = length(unique(patent_number))
  # ) %>% 
  # ungroup() %>% 
  # arrange(
  #   -total_patents
  # ) %>% 
  # slice(1:showtopn)

  
x_df <-  x%>%
  left_join(
    x_df_summary, 
    by = c("namedcolumn", "facetcol")
  ) %>% 
  mutate(
    namedcolumn = 
      case_when(
        # namedcolumn %in% x_df_summary$namedcolumn ~ namedcolumn, 
        !is.na(total_patents) ~ namedcolumn, 
        TRUE ~ "Other"
      ) 
  ) %>% 
  # filter(
  #   namedcolumn != "Other"
  # ) %>% 
  group_by(
    year, facetcol
  )%>% 
  mutate(
    numpatent_year = length(unique(patent_number))
  ) %>% 
  group_by(
     namedcolumn, year, facetcol,numpatent_year
  )%>%
  summarise(
    amtparent_type = length(unique(patent_number))
  ) %>% 
  ungroup() %>% 
  mutate(
    percent_patents =paste0(
       round(amtparent_type/numpatent_year,2)*100, "%"
    )
  ) 


  # top_n(
  #   total_patents, 10
  # )

  x_df <- x_df %>% 
    group_by(
      facetcol
    ) %>% 
    mutate(
      totalperfacet = sum(amtparent_type)
    ) %>% 
    ungroup() %>% 
    filter(
      totalperfacet >= showminfacet
    )%>% 

    group_by(
      facetcol, namedcolumn, amtparent_type, year
    ) %>% 
    slice(1) %>% 
    ungroup()

  

    #show these top actual 
  #show these top labels 
  x_df_show_onlythesetop <- x_df %>% 
  group_by(
    namedcolumn, facetcol
  ) %>% 
  summarise(
    totalpatents_co = sum(amtparent_type, na.rm = TRUE)
  )%>% 
  ungroup()  %>% 
  group_by(
    facetcol
  ) %>% 
  arrange(
    -totalpatents_co
  ) %>%       
  slice(1:slicetopn)  %>% 
  ungroup()  
      
  x_df <- x_df %>% 
   inner_join(
    x_df_show_onlythesetop %>% 
      select(
        namedcolumn, facetcol
      ),
    by = c("namedcolumn", "facetcol")
  )
  
    #show these top labels 
  x_df_show_onlythesetoplabel <- x_df_show_onlythesetop %>% 
  group_by(
    facetcol
  ) %>% 
  arrange(
    -totalpatents_co
  ) %>% 
    slice(1:slicetopnlabel) %>% 
    ungroup()


  # x_df <- x_df %>% 
  #   inner_join(
  #     x_df_show_onlythesetop %>% 
  #       select(
  #         namedcolumn, facetcol
  #       ),
  #     by = c("namedcolumn", "facetcol")
  #   )
  
# the ends
x_df_label <- x_df %>% 
  group_by(
    namedcolumn, facetcol
  ) %>% 
  mutate(
    totalpatents_co = sum(amtparent_type, na.rm = TRUE)
  )%>% 
  ungroup() %>% 
  inner_join(
    x_df_show_onlythesetoplabel %>% 
      select(
        namedcolumn, facetcol
      ),
    by = c("namedcolumn", "facetcol")
  )%>% 
  group_by(
    facetcol
  ) %>% 
  mutate(
    total_in_facet = sum(amtparent_type, na.rm = TRUE)
  )%>% 
  ungroup() %>% 
  mutate(
    percent_co_in_facet = paste0(
      round(
      totalpatents_co/total_in_facet,
      2
    )*100,
    "%"
  )
  )%>% 
  # filter(
  #   assignee_organization %in% x_df_summary_label$assignee_organization
  # ) %>% 
  mutate(
       label =  
      paste0( addUnits(amtparent_type), ";",  percent_patents)
        #     (assignee_organization %in% c(
        # x_df_summary$assignee_organization
      # ))&(year == max(year))~ paste0( addUnits(amtparent_type), "; ",  percent_patents, "; ",assignee_organization), 

    
    
   # label =  case_when(
   #    (assignee_organization %in% c(
   #      x_df_summary_label$assignee_organization
   #    ))~ paste0( addUnits(amtparent_type), "; ",  percent_patents), 
   #      #     (assignee_organization %in% c(
   #      # x_df_summary$assignee_organization
   #    # ))&(year == max(year))~ paste0( addUnits(amtparent_type), "; ",  percent_patents, "; ",assignee_organization), 
   # 
   #    TRUE ~ NA_character_
   #  )
  ) %>% 
  group_by(
    namedcolumn, facetcol
  )%>% 
  mutate(
    label = if_else(
      year == max(year), 
      paste0(namedcolumn, ": ", label, "(", year, ")|T:", totalpatents_co, ";",percent_co_in_facet
      ),
      label
    )
  ) %>% 
  ungroup()  %>% 
  mutate(
    endyear = substr(year, 4,4)
  )#%>% 
  # filter(
  #   (endyear %in% c("5", "0"))|(grepl(";", label, perl = TRUE) )
  # )

# the mids - that get ggrepel
x_df_label_mids <- x_df_label %>% 
  group_by(
    namedcolumn, facetcol
  )%>%
  filter(
    year != max(year)
  ) %>% 
  ungroup()#%>% 
  # filter(
  #   (endyear %in% c("5", "0"))
  # )

x_df_label <- x_df_label %>% 
  group_by(
    namedcolumn, facetcol
  )%>%
  filter(
    year == max(year)
  ) %>% 
  ungroup()




ensurerangedots <- crossing(
  year = c(min(x_df$year %>% unique()):2025) , 
  facet = x_df$facetcol%>% unique()
)

ensurerangedots_yaxis <- crossing(
  amtparent_type = c(-3:0) , 
  facet = x_df$facetcol%>% unique()
)


if(use_cowplot == "no")
{
  x_df_ggplot <-  
  ggplot(
  ) + 
  geom_point(
    data =x_df ,
        aes(
      x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn
    ),
    alpha = .8,
    size = pointsize
  ) + 
  geom_line(
        data =x_df ,
    aes(
      x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn
    ),

    alpha = .8, 
    size =pointsize
  ) + 
  theme_minimal() + 
  scale_x_continuous(breaks = scales::pretty_breaks(10))  

x_df_ggplot <- x_df_ggplot + 
  geom_point(
    data = ensurerangedots,
    aes(
      x = year,
      y =0 

    ), 
    alpha = 0,
    size = 0
  )+ 
    geom_point(
    data = ensurerangedots_yaxis,
    aes(
      x = 2000,
      y = amtparent_type

    ), 
    alpha = 0,
    size = 0
  )
  

 x_df_ggplot <- x_df_ggplot+ 
   # look at 
   geom_text_repel(
    data = x_df_label,
    aes(
            x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn,
      label = label, 
      ),
# vjust="inward",hjust="inward",
        alpha = 1,
    size = sizefontlabel_title, 
       max.overlaps = Inf, 
      min.segment.length = 0, # draw all line segments
# shows https://ggrepel.slowkow.com/articles/examples.html how to not repel from edges
          xlim = c(NA, NA),
 point.padding= unit(0.1, "lines"), 
      ylim = c(NA, NA),

    na.rm = TRUE) + 
geom_text_repel(
    data =  x_df_label_mids,
    aes(
            x = year,
      y =amtparent_type, 
      # group = namedcolumn, 
      color = namedcolumn,
      label = label
      ),
# vjust="inward",hjust="inward",
        alpha = .8,
    size = sizefontlabel, 
point.padding= unit(0.1, "lines"), 
    na.rm = TRUE) +
   ggtitle(
     label = paste0(
       "#Patents granted each year by company (colored)", ifelse(if_faceted=="yes", "; paneled by crop", "" ) 
       ), 
     subtitle = paste0(
       "Showing crops with top ",
       showminfacet, " patents; 
       Labeled by Firm: #Patents, %Patents by Firm for crop that year|Total: #Patents, %Patents by Firm for crop since 1970"
     )
       
       
       
     ) + 
  ylab(
    "#Patents"
  )


  # geom_label(
  #   aes(
  #     label = label
  #   )
  # )
 if(if_faceted != "no")
 {
   x_df_ggplot <- x_df_ggplot +
     facet_wrap(~facetcol, scales = "free")+
    theme(
      
      # panel.background = element_rect(fill = 'black', colour = 'black'),
      # panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      # text = element_text(size = 14),
      # plot.title = element_text(size = 20, face = "bold"),
      # plot.subtitle = element_text(size = 20, face = "bold"),
      strip.text = element_text(size = sizefont),
      # axis.title.x.top = element_text( size = 20 ),
      axis.text.x = element_text( size = sizefont ),
      axis.text.y = element_text( size = sizefont ),
      # legend.text=element_text(size=20),
      legend.title=element_text(size=sizefont),
      # axis.title=element_text(size=20,face="bold"),
      title = element_text(size = sizefont) ,
      # axis.title.x=element_blank(),
      # axis.text.x=element_blank(),
      # axis.ticks.x=element_blank(), 
      # axis.title.y=element_blank(),
      #   axis.text.y=element_blank(),
      #   axis.ticks.y=element_blank()#, 
      legend.position = "none"
      # legend.title = element_blank(),
      # legend.key.size = unit(1, 'cm')
    )  
                            #getPalette(colourCount)) 
   
 }
if(if_faceted == "no")
 {
x_df_ggplot <- x_df_ggplot +
    theme(
      
      # panel.background = element_rect(fill = 'black', colour = 'black'),
      # panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      # text = element_text(size = 14),
      # plot.title = element_text(size = 20, face = "bold"),
      # plot.subtitle = element_text(size = 20, face = "bold"),
      # strip.text = element_text(size = 20),
      # axis.title.x.top = element_text( size = 20 ),
      axis.text.x = element_text( size = sizefont ),
      axis.text.y = element_text( size = sizefont ),
      # legend.text=element_text(size=20),
      # legend.title=element_text(size=20),
      # axis.title=element_text(size=20,face="bold"),      # legend.text=element_text(size=20),
      legend.title=element_text(size=sizefont),

      title = element_text(size = sizefont) ,
      # axis.title.x=element_blank(),
      # axis.text.x=element_blank(),
      # axis.ticks.x=element_blank(), 
      # axis.title.y=element_blank(),
      #   axis.text.y=element_blank(),
      #   axis.ticks.y=element_blank()#, 
      legend.position = "none"
      # legend.title = element_blank(),
      # legend.key.size = unit(1, 'cm')
    ) 
}
 
  if(length(x_df$namedcolumn %>% unique()) >12)
 
{
  require(randomcoloR)
set.seed(1234232)
# n <- x_df_label$namedcolumn
# qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# # set.seed(123)
# 
# colourCount = length(unique(x_df_label$namedcolumn))
# getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))
# use_thispalette = col_vector[1: colourCount]

    use_thispalette <- distinctColorPalette(length(unique(x_df$namedcolumn)))
    x_df_ggplot <- x_df_ggplot + 
       scale_color_manual(values = use_thispalette)
      

  }
  
  if(!(length(x_df$namedcolumn %>% unique()) >12))
{
 x_df_ggplot <- x_df_ggplot  + 
    scale_color_carto_d(type = "qualitative")# require(rcartocolor)
    
 }
 
 pdf(
    paste0(
     output_folder, 
      file_name, 
      ".pdf"
      ),
    # width = 60,
    # height = 35,
    width = widthdf,
    height = heightdf#,
    # units = "in", 
    # res = 300
    # compress = TRUE
  )
print(
  x_df_ggplot + 
  scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))
)
dev.off()
}


if(use_cowplot != "no")
{
  cleantext <- function(x){
  stripWhitespace(str_squish(removeNumbers(removePunctuation(tolower(gsub("[^[:alpha:] ]", " ", x))))))
} 

  use_these_facetvec <- x_df$facetcol %>% 
    unique()
  
  i <- 1
  list_of_cowplots <- list()
  while(i <= length(use_these_facetvec))
  {
    currentfacet = use_these_facetvec[i]
    func_x_df <- x_df %>% 
    filter(
      facetcol == currentfacet
    )

    
    func_x_df_label <- x_df_label %>% 
    filter(
      facetcol == currentfacet
    )

    
    func_x_df_label_mids <- x_df_label_mids %>% 
    filter(
      facetcol == currentfacet
    )

    
    x_df_cowplot <- ggplot() + 
        geom_point(
    data =func_x_df ,
        aes(
      x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn
    ),
    alpha = .8,
    size = pointsize
  ) + 
  geom_line(
        data =func_x_df ,
    aes(
      x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn
    ),

    alpha = .8, 
    size =pointsize
  ) + 
  theme_minimal() + 
  scale_x_continuous(breaks = scales::pretty_breaks(10))  

x_df_cowplot <- x_df_cowplot + 
  geom_point(
    data = ensurerangedots,
    aes(
      x = year,
      y =0 

    ), 
    alpha = 0,
    size = 0
  )+ 
    geom_point(
    data = ensurerangedots_yaxis,
    aes(
      x = 2000,
      y = amtparent_type

    ), 
    alpha = 0,
    size = 0
  )

 x_df_cowplot <- x_df_cowplot+ 
   # look at 
   geom_text_repel(
    data = func_x_df_label,
    aes(
            x = year,
      y =amtparent_type, 
      group = namedcolumn, 
      color = namedcolumn,
      label = label, 
      ),
# vjust="inward",hjust="inward",
        alpha = 1,
    size = sizefontlabel_title, 
       max.overlaps = Inf, 
      min.segment.length = 0, # draw all line segments
# shows https://ggrepel.slowkow.com/articles/examples.html how to not repel from edges
          xlim = c(NA, NA),
 point.padding= unit(0.1, "lines"), 
      ylim = c(NA, NA),

    na.rm = TRUE) + 
geom_text_repel(
    data =  func_x_df_label_mids,
    aes(
            x = year,
      y =amtparent_type, 
      # group = namedcolumn, 
      color = namedcolumn,
      label = label
      ),
# vjust="inward",hjust="inward",
        alpha = .8,
    size = sizefontlabel, 
point.padding= unit(0.1, "lines"), 
    na.rm = TRUE) + 
  ylab(
    "#Patents"
  )  + 
    scale_color_carto_d(type = "qualitative") + 
  scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))+
   theme_minimal() + 
    theme(
      
      # panel.background = element_rect(fill = 'black', colour = 'black'),
      # panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      # text = element_text(size = 14),
      # plot.title = element_text(size = 20, face = "bold"),
      # plot.subtitle = element_text(size = 20, face = "bold"),
      # strip.text = element_text(size = 20),
      # axis.title.x.top = element_text( size = 20 ),
      axis.text.x = element_text( size = sizefont ),
      axis.text.y = element_text( size = sizefont ),
      # legend.text=element_text(size=20),
      # legend.title=element_text(size=20),
      # axis.title=element_text(size=20,face="bold"),      # legend.text=element_text(size=20),
      legend.title=element_text(size=sizefont),

      title = element_text(size = sizefont) ,
      # axis.title.x=element_blank(),
      # axis.text.x=element_blank(),
      # axis.ticks.x=element_blank(), 
      # axis.title.y=element_blank(),
      #   axis.text.y=element_blank(),
      #   axis.ticks.y=element_blank()#, 
      legend.position = "none"
      # legend.title = element_blank(),
      # legend.key.size = unit(1, 'cm')
    )
 
 
if(skip_eachcrop !="yes")
{
  png(
    paste0(
     output_folder, 
      file_name, 
     cleantext(currentfacet), 
      ".png"
      ),
    # width = 60,
    # height = 35,
    width = 25,
    height = 14.4,
    units = "in", 
    res = 300
)
 print(
  x_df_cowplot +
   ggtitle(
     label = paste0(
       "#Patents granted each year by company (colored) for ", currentfacet
       ), 
     subtitle = paste0(
       "Showing only top ",
       slicetopn , " firms; 
       Labeled by Firm: #Patents, %Patents by Firm for crop that year|
       Total: #Patents, %Patents by Firm for crop since 1970"
     )
       
       
       
     ) 
)
dev.off()
}

x_df_cowplot <- x_df_cowplot + 
   ggtitle(
     currentfacet
   )
 
list_of_cowplots[[i]] <- x_df_cowplot
i <- i+1

  }

  require(cowplot)
  functitle <- ggdraw() + 
  draw_label(
    paste0(
       "#Patents granted each year by company (colored) for patents containing 230 crop names in patent title or abstract;" , 
    paste0(
       "Showing only top ",
       slicetopn , " firms; 
        "
     ), 

    paste0(
       "
        Labeled by Firm: #Patents, %Patents by Firm for crop that year|"), 

    paste0(
       "
       Total: #Patents, %Patents by Firm for crop since 1970"
     )
    ), 
    fontface = 'bold',
    x = 0,
    hjust = 0,
      size = 80
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

  # j <- 1 
  # rm(rows_of_plotlist)
  # rows_of_plotlist <- list()
  # while(j <= sqrt(length(currentfacet))){
  #   
  #   rows_of_plotlist[[j]] <- 
  #   
  #   j <- j+1
  # }
  

   pdf(
    paste0(
     output_folder, 
      file_name, 
     "plot_samecolor",
      ".pdf"
      ),
    # width = 60,
    # height = 35,
    width = widthdf,
    height = heightdf

    # units = "in", 
    # res = 300
    # compress = TRUE
  )
heresmylistofplots = cowplot::plot_grid(
        plotlist = list_of_cowplots #,
        # nrow = length(list_of_cowplots),
        # labels = "AUTO",
        # # label_size = 12,
        # align = "v"#,
        # rel_heights = c(rep(1, each = sqrt(length(use_these_facetvec))))
       
)
print(
  {
    cowplot::plot_grid(
      functitle,
      heresmylistofplots ,
      ncol = 1,
      # rel_heights values control vertical title margins
      rel_heights = c(.1, 1)
    )
    
  }
  #         cowplot::plot_grid(
  # heresmylistofplots       
  # )
)

dev.off()

}

}

```

### use function
```{r }
soycropquery_unnest_df_likelyplants_themed %>% 
linegraph_dominanceoveral_func(x = ., output_folder = "X:/msi/work/farmer welfare/seed/R analysis/images/", 
      file_name = "220914_overall_patentseed",  widthdf = 25, heightdf = 14.4,namecol = .$assignee_organization,  showtopn_or_other = 10, slicetopnlabel= 6,slicetopn = 10,    if_faceted = "no", faceted_col = NULL, sizefont = 20 ) 

soycropquery_unnest_df_likelyplants_themed %>% 
linegraph_dominanceoveral_func(x = ., output_folder = "X:/msi/work/farmer welfare/seed/R analysis/images/", 
      file_name = "220914_overall_patentseed_namestandard",  widthdf = 25, heightdf = 14.4,namecol = .$Namestandard,  showtopn_or_other = 10, slicetopnlabel= 6,slicetopn = 10, if_faceted = "no", faceted_col = NULL, sizefont = 20) 


```

#### use - facet wrap
```{r }
soycropquery_unnest_df_likelyplants_themed %>% 
linegraph_dominanceoveral_func(x = ., output_folder = "X:/msi/work/farmer welfare/seed/R analysis/images/", 
      file_name = "220914_overall_patentseed_namestandard_cropfacet",  widthdf = 128*2, heightdf =72*2 ,namecol = .$Namestandard, showtopn_or_other = 10, slicetopnlabel= 4,slicetopn = 10,   if_faceted = "yes", faceted_col = .$crop, sizefont = 45,showminfacet = 20 , sizefontlabel = 12, sizefontlabel_title = 14) 


```

#####  use of cowplot

```{r }
# for individuals
soycropquery_unnest_df_likelyplants_themed %>% 
linegraph_dominanceoveral_func(x = ., output_folder = "X:/msi/work/farmer welfare/seed/R analysis/images/220918_bycropcowplot/", 
      file_name = "e_",  widthdf = 128*2, heightdf =72*2 ,namecol = .$Namestandard,  showtopn_or_other = 10, slicetopnlabel= 6,slicetopn = 10,    if_faceted = "yes", faceted_col = .$crop,  sizefont = 40,sizefontlabel = 8, sizefontlabel_title = 10,  use_cowplot = "yes", skip_eachcrop = "no") 

```


```{r }
# for one graph
soycropquery_unnest_df_likelyplants_themed %>% 
linegraph_dominanceoveral_func(x = ., output_folder = "X:/msi/work/farmer welfare/seed/R analysis/images/", 
      file_name = "220914_overall_patentseed_namestandard_cropfacet_cowplot",  widthdf = 128*2, heightdf =72*2 ,namecol = .$Namestandard,  showtopn_or_other = 10, slicetopnlabel= 4,slicetopn = 10,   if_faceted = "yes", faceted_col = .$crop, sizefont = 45,showminfacet = 20 , sizefontlabel = 12, sizefontlabel_title = 14, use_cowplot = "yes", skip_eachcrop = "yes" ) 


```
<!-- ## lineplot dominance facet by crop -->
<!-- ```{r } -->

<!-- linegraph_dominanceoveral_func <- function(x, output_folder,  -->
<!--       file_name,  widthdf = 128, heightdf = 72) { -->

<!--    x_df_summary <- x %>% -->
<!--      filter( -->
<!--        !is.na(assignee_organization) -->
<!--      ) %>%  -->
<!--   group_by( -->
<!--     assignee_organization -->
<!--   ) %>%  -->
<!--   summarise( -->
<!--     total_patents = length(unique(patent_number)) -->
<!--   ) %>%  -->
<!--   ungroup() %>%  -->
<!--   arrange( -->
<!--     -total_patents -->
<!--   ) %>%  -->
<!--   slice(1:12) -->
<!--    x_df_summary_label <- x %>% -->
<!--      filter( -->
<!--        !is.na(assignee_organization) -->
<!--      ) %>%  -->
<!--   group_by( -->
<!--     assignee_organization -->
<!--   ) %>%  -->
<!--   summarise( -->
<!--     total_patents = length(unique(patent_number)) -->
<!--   ) %>%  -->
<!--   ungroup() %>%  -->
<!--   arrange( -->
<!--     -total_patents -->
<!--   ) %>%  -->
<!--   slice(1:3) -->


<!-- x_df <-  x%>% -->
<!--   mutate( -->
<!--     assignee_organization =  -->
<!--       case_when( -->
<!--         assignee_organization %in% x_df_summary$assignee_organization ~ assignee_organization,  -->
<!--         TRUE ~ "Other" -->
<!--       )  -->
<!--   ) %>%  -->
<!--   filter( -->
<!--     assignee_organization != "Other" -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--     year -->
<!--   )%>%  -->
<!--   mutate( -->
<!--     numpatent_year = length(unique(patent_number)) -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--      assignee_organization, year -->
<!--   )%>% -->
<!--   summarise( -->
<!--     amtparent_type = length(unique(patent_number)),  -->
<!--     percent_patents = percent(amtparent_type/numpatent_year) -->
<!--   )%>% -->
<!--   ungroup() -->


<!--   # top_n( -->
<!--   #   total_patents, 10 -->
<!--   # ) -->

<!-- x_df_label <- x_df %>%  -->
<!--   # filter( -->
<!--   #   assignee_organization %in% x_df_summary_label$assignee_organization -->
<!--   # ) %>%  -->
<!--   mutate( -->
<!--        label =   -->
<!--       paste0( addUnits(amtparent_type), "; ",  percent_patents) -->
<!--         #     (assignee_organization %in% c( -->
<!--         # x_df_summary$assignee_organization -->
<!--       # ))&(year == max(year))~ paste0( addUnits(amtparent_type), "; ",  percent_patents, "; ",assignee_organization),  -->



<!--    # label =  case_when( -->
<!--    #    (assignee_organization %in% c( -->
<!--    #      x_df_summary_label$assignee_organization -->
<!--    #    ))~ paste0( addUnits(amtparent_type), "; ",  percent_patents),  -->
<!--    #      #     (assignee_organization %in% c( -->
<!--    #      # x_df_summary$assignee_organization -->
<!--    #    # ))&(year == max(year))~ paste0( addUnits(amtparent_type), "; ",  percent_patents, "; ",assignee_organization),  -->
<!--    #  -->
<!--    #    TRUE ~ NA_character_ -->
<!--    #  ) -->
<!--   ) %>%  -->
<!--   group_by( -->
<!--     assignee_organization -->
<!--   )%>%  -->
<!--     mutate(label = if_else(year == max(year), paste0(label, "; ", assignee_organization), label)) %>%  -->
<!--   ungroup()  -->

<!-- x_df_ggplot <-  x_df %>%  -->
<!--   ggplot( -->
<!--     aes( -->
<!--       x = year, -->
<!--       y =amtparent_type,  -->
<!--       group = assignee_organization,  -->
<!--       color = assignee_organization -->
<!--     ) -->
<!--   ) +  -->
<!--   geom_point( -->
<!--     alpha = .8, -->
<!--     size = 2 -->
<!--   ) +  -->
<!--   geom_line( -->
<!--     alpha = .8,  -->
<!--     size = 2 -->
<!--   ) +  -->
<!--   geom_text( -->
<!--     data = x_df_label, -->
<!--     aes(label = label), -->
<!--     nudge_x = 1, -->
<!--     alpha = .8, -->
<!--     size = 5,  -->
<!--     na.rm = TRUE)+  -->
<!--   theme_minimal() +  -->
<!--   facet_wrap( -->
<!--     ~ jj -->
<!--   ) +  -->
<!--   scale_x_continuous(breaks = scales::pretty_breaks(10))  +  -->
<!--     scale_color_carto_d(type = "qualitative")+  -->
<!--     theme( -->

<!--       # panel.background = element_rect(fill = 'black', colour = 'black'), -->
<!--       # panel.grid.major = element_blank(), panel.grid.minor = element_blank(), -->
<!--       # text = element_text(size = 14), -->
<!--       # plot.title = element_text(size = 20, face = "bold"), -->
<!--       # plot.subtitle = element_text(size = 20, face = "bold"), -->
<!--       # strip.text = element_text(size = 20), -->
<!--       # axis.title.x.top = element_text( size = 20 ), -->
<!--       axis.text.x = element_text( size = 20 ), -->
<!--       axis.text.y = element_text( size = 20 ), -->
<!--       # legend.text=element_text(size=20), -->
<!--       # legend.title=element_text(size=20), -->
<!--       # axis.title=element_text(size=20,face="bold"), -->
<!--       title = element_text(size = 20) , -->
<!--       # axis.title.x=element_blank(), -->
<!--       # axis.text.x=element_blank(), -->
<!--       # axis.ticks.x=element_blank(),  -->
<!--       # axis.title.y=element_blank(), -->
<!--       #   axis.text.y=element_blank(), -->
<!--       #   axis.ticks.y=element_blank()#,  -->
<!--       legend.position = "none" -->
<!--       # legend.title = element_blank(), -->
<!--       # legend.key.size = unit(1, 'cm') -->
<!--     )  -->

<!--   # geom_label( -->
<!--   #   aes( -->
<!--   #     label = label -->
<!--   #   ) -->
<!--   # ) -->

<!--  pdf( -->
<!--     paste0( -->
<!--      output_folder,  -->
<!--       file_name,  -->
<!--       ".pdf" -->
<!--       ), -->
<!--     # width = 60, -->
<!--     # height = 35, -->
<!--     width = widthdf, -->
<!--     height = heightdf#, -->
<!--     # units = "in",  -->
<!--     # res = 300 -->
<!--     # compress = TRUE -->
<!--   ) -->
<!-- print( -->
<!--   x_df_ggplot -->
<!-- ) -->
<!-- dev.off() -->

<!-- } -->

<!-- ``` -->


```{r }

      png(
    paste0("X:/msi/work/farmer welfare/seed/R analysis/images", "220912_seedpatent_cos" , ".png"),
    
    # "C:/Users/Jaina/Documents/work/RFSP/20201115_locationmap_wrapallmetric_themes.pdf",
    # width = 4096,
    # height = 1713,
  #  width = 4096,
  # height = 1713, 
    width = 60,
    height = 35,
    units = "in", 
    res = 300
    # compress = TRUE
  )

soycropquery_unnest_df %>%
  mutate(
    year =  year(lubridate::as_date(patent_date)),
    decade = round(as.numeric(year) / 10) * 10
  ) %>% 
  group_by(
     assignee_organization, decade
  )%>%
  summarise(
    amtparent_type = length(unique(patent_number))
  )%>%
  ungroup() %>% 
  # group_by(
  #   assignee_organization
  # ) %>%
  # mutate(
  #   amtparent_all = sum(amtparent_type), 
  #   counter = row_number()
  # ) %>% 
  # ungroup() %>% 
  # group_by(
  #   Type
  # ) %>% 
  # # group_by(
  # #   Type
  # # ) %>% 
  mutate(
    # totalgroup = sum(amtparent_type), 
    percentlabel =amtparent_type, 
    # newlabel = case_when(
    #   amtparent_type <=50 ~ "Other",
    #   TRUE ~ assignee_organization
    # )
    ) %>%
    group_by(decade) %>%
    top_n(10) %>%
    ungroup %>%
    mutate(decade = as.factor(decade),
           name = reorder_within(assignee_organization, amtparent_type, decade)) %>%
    ggplot(
    aes(
      x = assignee_organization,
      y = amtparent_type,
      fill = assignee_organization
    )
      ) +

    geom_col(show.legend = FALSE) +
    geom_text(
    aes(
      label = percentlabel
    ),
    size = 12,
    position = position_stack(vjust = .5, reverse = FALSE)
  ) +

    facet_wrap(~decade, scales = "free_y") +
    coord_flip() +
    scale_x_reordered() +
    scale_y_continuous(expand = c(0,0)) +
  theme_minimal() + 
 
      # case_when(
      #   counter >=1 ~ paste0(percent(round(amtparent_type/totalgroup,2))), 
      #   TRUE ~ ""
  #     # )
  # top_n(10,amtparent_type )%>% 
  # # slice_max(
  # #   amtparent_type, 20
  # # ) %>% 
  # # ungroup() %>% 
  # mutate(
  #   decade = "yes",
  #   name = reorder_within(newlabel, amtparent_type, decade)
  # ) %>% 
  # 
  # 
  # ggplot(
  #   aes(
  #     x = newlabel, 
  #     y = amtparent_type, 
  #     fill = newlabel
  #   )
  # ) + 
  # geom_bar(
  #   # aes(
  #   #   
  #   #   
  #   # ),
  #   # position="stack",
  #   stat="identity"
  # )+
  # scale_x_reordered() +
  # geom_text(
  #   aes(
  #     label = percentlabel
  #   ), 
  #   size = 20,
  #   position = position_stack(vjust = 0.5, reverse = FALSE)
  # ) + 
  #  theme_minimal()+
  #  # scale_fill_manual(
  #  #   values =safe_colorblind_palette, 
  #  #    name = "" ) + 
  #  coord_flip()  + 
  # # scale_x_continuous(breaks = scales::pretty_breaks(10)) + 
      theme(
    # panel.background = element_rect(fill = 'black', colour = 'black'),
     axis.text.y = element_text( size =30 ),

     axis.text.x = element_text( size = 30 ),
      strip.text = element_text(size = 50),
      legend.position = "none",
         # legend.text=element_text(size=50),

  )+ 
  scale_y_continuous(labels = addUnits)
dev.off()

```

# output themes to rename
```{r }
writesamplethemes <- function(x, outputname, folder){
  
  x %>% 
    group_by(patent_number) %>% 
    slice(1) %>%
    ungroup() %>% 
    group_by(
      topic
    ) %>% 
    sample_n(20, wt =gamma ) %>% 
    ungroup() %>% 
    mutate(
      finalabstract = paste0( patent_title, ": ",patent_abstract, ". ",round(gamma,2), " (", assignee_organization, " - ",patent_year,")"  )
    ) %>% 
    select(
     terms,    terms_tfidf, finalabstract
    ) %>% 
    distinct()%>% 
    group_by(
      terms,    terms_tfidf
    ) %>% 
    mutate(samplen = paste0("sample_", row_number())) %>% 
    ungroup() %>% 
    spread(
      key = samplen, 
      value = finalabstract
    ) %>% 
    writexl::write_xlsx(
      paste0(
        folder, "/", outputname,".xlsx"
      )
    )
    
}

soycropquery_merger %>% 
  writesamplethemes(x =., outputname = "221106_themes_renamed", folder ="X:/msi/work/farmer welfare/seed/themes" )

```

# graph summary merger alluvial

##  import themes
```{r }

patent_themes <- read_rds(
  paste0(
              "X:/msi/work/farmer welfare/seed/R analysis/",
              "230111  topic model LU",
              ".rds")
  )



```

## helpful funcs

### margin spacer
```{r }
    margin_spacer <- function(x) {
  # where x is the column in your dataset
  left_length <- nchar(levels(factor(x)))[1]
  if (left_length > 8) {
    return((left_length - 8) * 4)
  }
  else
    return(0)
}

addline_format <- function(x,...){
    gsub('\\s','\n',x)
}
```
### addunits func
```{r }
addUnits <- function(n) {
  labels <- ifelse(abs(n) < 1000, n,  # less than thousands
                   ifelse(abs(n) < 1e6, paste0(round(n/1e3), 'k'),  # in thousands
                          ifelse(abs(n) < 1e9, paste0(round(n/1e6), 'M'),  # in millions
                                 ifelse(abs(n) < 1e12, paste0(round(n/1e9), 'B'), # in billions
                                        ifelse(abs(n) < 1e15, paste0(round(n/1e12), 'T'), # in trillions
                                               'too big!'
                                        )))))
  return(labels)
}


```

## func alluvial 1

### func to process labels

#### get finalname generic
```{r }

processlabel_bytype_generic <- function(
  passthrudf =   alluv_df_by15, 
  passthrudf_yearlistdf = yearlist,
  which_to_change1 = alluv_df_by15$crop_type,
  top_strata_colsplitby   = 4,  
  top_strata =  12,
  howderived_acq_or_orig = "yes",
  passthru_if_take_tops = 4
  # sendthru = "bypatent_acq", 
  # col_to_split = alluv_df_by15$patent_type2
  ){
  
  #     passthrudf =   alluv_df_by15
  # passthrudf_yearlistdf = yearlist
  # which_to_change1 = alluv_df_by15$crop_type
  # top_strata_colsplitby   = 6
  # top_strata =  12
  # howderived_acq_or_orig = "yes"
  # passthru_if_take_tops = 4

#   # 
#   passthrudf =   alluv_df_by15
#   passthrudf_yearlistdf = yearlist
#   which_to_change1 = alluv_df_by15$crop_type
#   top_strata_colsplitby   = 4
#   top_strata =  12
#   howderived_acq_or_orig = "yes"
# passthru_if_take_tops = 4
#   
#   passthrudf =   alluv_df_by15
#   passthrudf_yearlistdf = yearlist
#   which_to_change1 = alluv_df_by15$patent_type2
#   top_strata_colsplitby   = 2
#   top_strata =  12
#   howderived_acq_or_orig = "yes"
# passthru_if_take_tops = 4


      passthrudf_filteryr <-      passthrudf %>%  filter(
        patentyear_by5 %in% passthrudf_yearlistdf
      ) 
    
    ##### first step is to categorize
    passthrudf_by15_lu5yr <- passthrudf %>% 
            cbind(
      tibble(
        col_splitby = which_to_change1
      )#, 
      # tibble(
      #   col_id = which_col_is_id
      # )

    )  %>%

      filter(
        # patent_merger_id %in% c(passthrudf_filteryr$patent_merger_id)
     by15 %in% passthrudf_yearlistdf

      ) %>% 
 
      group_by(
        patent_merger_id,by15
      ) %>% 
      filter(
        # this makes it so that for by15=2015, if merger happened in 2018, it'll still use 2017 name (bc that's what it was in 2015; actually, should use max to capture any ) 
        ground_year == min(ground_year)
      )%>% 
      # slice(which.max(ground_year )) %>% 
      ungroup() %>% 
      rename(
        name_new_by15 = name_new_offpatent
      )%>% 
      select(
        name_new_by15,patent_merger_id, by15,col_id, name_standard_patent2, col_splitby, patentyear_by5
      ) %>% 
      distinct() 
    

          
           passthrudf_by15_lu5yr_crop_top12 <- passthrudf_by15_lu5yr%>% 
      group_by(
       col_splitby
      ) %>% 
      summarise(
        numpatents_colsplitby =length(unique(col_id))
      ) %>% 
      ungroup() %>% 
      arrange(
        -numpatents_colsplitby
      ) %>% 
      slice(1:top_strata_colsplitby) %>% 
      ungroup()

passthrudf_by15_lu5yr_cat <-   passthrudf_by15_lu5yr%>%
      left_join(
        passthrudf_by15_lu5yr_crop_top12 ,  
        by =  c("col_splitby")
      ) %>% 
      mutate(
       name_new_by15_col_splitby_crop  = 
         case_when(
           is.na(numpatents_colsplitby) ~   "q", #paste0("Not top ", top_strata_colsplitby), 
           TRUE ~ substr(col_splitby,1,1 ) 
         ),
              name_new_by15_col_splitby_crop_full  = 
         case_when(
           is.na(numpatents_colsplitby) ~   paste0("Not top ", top_strata_colsplitby), 
           TRUE ~  col_splitby 
         )

     ) %>% 
  group_by(name_new_by15_col_splitby_crop) %>% 
  arrange(name_new_by15_col_splitby_crop_full) %>% 
  mutate(
    name_new_by15_col_splitby_crop = 
      paste0(  
        name_new_by15_col_splitby_crop,
        cumsum(!duplicated(name_new_by15_col_splitby_crop_full))
      ),  
   name_new_by15_col_splitby_crop =  gsub("1$",  "", name_new_by15_col_splitby_crop )
  )%>% 
    ungroup() %>% 
  
      mutate(
        howderived =
          case_when( 
            name_new_by15!= name_standard_patent2 ~ "Acquired", 
            TRUE ~ "Original"
          ), 
        howderived_1  =howderived , 
        howderived = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop,
            TRUE  ~paste0(substr(howderived_1,1,1),"_", name_new_by15_col_splitby_crop)
            
            ), 
        name_new_by15_col_splitby_crop_full = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop_full,
            TRUE  ~paste0(howderived_1, "_", stringr::str_to_title(name_new_by15_col_splitby_crop_full))
            
            ), 
        name_new_by15_col_splitby_crop = 
          case_when(
            howderived_acq_or_orig == "no" ~ name_new_by15_col_splitby_crop,
            TRUE  ~ paste0(substr(howderived_1,1,1),"_", name_new_by15_col_splitby_crop)
            
            ), 

        if_created_thatyear = 
          case_when(
            patentyear_by5 == by15~ "Created that Year", 
            TRUE ~ "Acquired that Year"
          ), 
        patent_type2_if_created_thatyear = paste0(
        name_new_by15_col_splitby_crop,"_", if_created_thatyear
      )


      ) 

passthrudf_by15_lu5yr_catLU <- passthrudf_by15_lu5yr_cat %>% 
  select(
    name_new_by15_col_splitby_crop, name_new_by15_col_splitby_crop_full 
  ) %>% 
mutate(
 name_new_by15_col_splitby_crop  = gsub(".*_","",name_new_by15_col_splitby_crop ), 
 name_new_by15_col_splitby_crop_full  = gsub(".*_","",name_new_by15_col_splitby_crop_full )
  ) %>% 
    distinct()

# passthrudf_by15_lu5yr_catLU %>%
#   writexl::write_xlsx(
#     "X:/msi/work/farmer welfare/seed/R analysis/images/merger/230108_shortname_keylu.xlsx"
#   )
    
       passthrudf_by15_lu5yr_totals_top12 <- passthrudf_by15_lu5yr%>% 
      group_by(
        by15, name_new_by15
      ) %>% 
      summarise(
        numpatents =length(unique(col_id))
      ) %>% 
      ungroup() %>% 
     group_by(
        by15 
      ) %>% 
      arrange(
        -numpatents
      ) %>% 
      slice(1:top_strata) %>% 
      ungroup()

    
   passthrudf_by15_lu5yr_strata <- passthrudf_by15_lu5yr_cat  %>% 
     left_join(
       #deciding which co names to keep
       passthrudf_by15_lu5yr_totals_top12, 
       by = c("by15", "name_new_by15")
     ) %>% 
     mutate(
       name_new_by15_strata = 
         case_when(
           is.na(numpatents) ~ paste0("Not top ", top_strata), 
           TRUE ~ name_new_by15
         )
     ) %>% 
     #remove below for confusion; only keeps tops
     select(
       -numpatents
     ) %>% 
      group_by(name_new_by15_strata, by15 ) %>% 
      mutate(
        #total patents in that year by firm
        totalpatents_by15 =  length(unique(col_id)), 
        num_companies = length(unique(name_new_by15))
      ) %>% 
      ungroup()  %>% 
     select(
       -name_new_by15
     ) %>% 
     rename(
       name_new_by15 = name_new_by15_strata
     )
      #total patents in that year: total by year, total by acq or dev, 
    
        ##### second step is to get totals for each company label by year, filtering out offpatent
   passthrudf_by15_lu5yr_strata_totals <- passthrudf_by15_lu5yr_strata %>% 
      filter(
        name_new_by15 != "Offpatent"
      ) %>% 
      
      group_by( by15 ) %>% 
      mutate(
        totalpatents_year =  length(unique(col_id))
      ) %>% 
      ungroup() %>% 
    group_by(
      by15, if_created_thatyear 
    ) %>% 
    mutate(
      #total by acq or dev
      created_or_acq_num =  length(unique(col_id))
    ) %>% 
    ungroup() %>% 
     mutate(
       name_new_by15_col_splitby_crop  = gsub(".*_","",name_new_by15_col_splitby_crop)  
     ) %>% 
     #total by crop
   group_by(
      by15,   name_new_by15_col_splitby_crop 
    ) %>% 
    mutate(
      numcrops_thatyear =  length(unique(col_id))
    ) %>% 
    ungroup()  %>% 
     #total by crop and acq or dev
  group_by(
      by15, name_new_by15,  howderived
    ) %>% 
    mutate(
      numcrops_thatyear_acq_or_dev =  length(unique(col_id))
    ) %>% 
    ungroup()  %>% 

     select(
    patent_merger_id, name_standard_patent2,  by15,name_new_by15, totalpatents_year, if_created_thatyear, name_new_by15_col_splitby_crop, numcrops_thatyear, created_or_acq_num,numcrops_thatyear_acq_or_dev
     ) %>% 
     distinct()

    #label the individual co years 
passthrudf_by15_lu5yr_labelpre <-   passthrudf_by15_lu5yr_strata %>% 
  #only have mdified crop name
  select(
    -contains("name_new_by15_col_splitby_crop")
  ) %>% 
   left_join(
     passthrudf_by15_lu5yr_strata_totals,
     by = c("patent_merger_id", "name_standard_patent2", "by15", "if_created_thatyear",  "name_new_by15")
     #  %>% 
       # select(
       #   name_new_by15,patent_merger_id, by15, name_standard_patent2, patent_type2, 
       #   
       # ), 
     # by = c("name_new_by15", "patent_merger_id", "by15","name_standard_patent2", "patent_type2" )
   ) %>% 
   mutate(
     percent_patents_year_byfirm =
       case_when(
         
         name_new_by15 == "Offpatent"~ "0%",
         TRUE ~paste0(round(100*totalpatents_by15/totalpatents_year,0),"%")
       )
   )  %>% 
     group_by(name_new_by15, by15,howderived ) %>% 
         # this is total acq or dev  by crop
         mutate(
           num_howderived_by15 = length(unique(col_id))
         ) %>% 
         ungroup() %>% 
             #this is total acquired or dev

     group_by(name_new_by15, by15,howderived_1 ) %>% 
  #this is total 
         # num 
         mutate(
           num_howderived_by15_1 = length(unique(col_id))
         ) %>% 
         ungroup() %>% 
           # this is howderived divided by total number of  crop patents existing in that year (that aren't  offpatent)
         mutate(
           # percent_patents_thatyear = 
           # percent_acquired_howderived = percent(num_howderived_by15/totalpatents_by15)
          percent_acquired_howderived = 
            # should be by  crop 
            paste0(round(100*numcrops_thatyear_acq_or_dev/numcrops_thatyear,0),"%")
            # below is how it was prev;  
            # paste0(round(100*num_howderived_by15/totalpatents_by15,0),"%")
              
          #  )
         ) 


passthrudf_by15_lu5yr_label_crop <-passthrudf_by15_lu5yr_labelpre %>% 
      select(
        name_new_by15, by15,howderived, percent_acquired_howderived  
      ) %>% 
      distinct() %>% 
  mutate(
    percent_acquired_howderived = round(
      as.numeric(
      gsub("%",  "", percent_acquired_howderived),0
      )
    ),  
    howderived_only = gsub("_.*", "", howderived),
    howderived_crop = gsub(".*_", "", howderived)

  ) %>% 
  filter(
    !is.na(percent_acquired_howderived), 
    percent_acquired_howderived  >=2#,
    # !(percent_acquired_howderived %in%  c("1%",  "2%"))
  ) %>% 
  mutate(
    howd_percent =  paste0(str_pad(percent_acquired_howderived,4,side =  c("left"),  "0" ) ,"%", howderived_crop )
  ) %>%
  group_by(
    name_new_by15, by15, howderived_only
  ) %>% 
  summarise(
   label_crop_percent = paste(str_remove(unique(rev(sort(howd_percent))), "^0+"),   collapse =  " ")
  ) %>% 
    ungroup() %>% 
  mutate(
    # label_crop_percent = str_remove(label_crop_percent, "^0+"),
    label_crop_percent = paste0(howderived_only,  ": ", label_crop_percent)
  )%>%
  group_by(
    name_new_by15, by15
  ) %>% 
  summarise(
    label_crop_percent = paste(unique(sort(label_crop_percent)), collapse =   "; ")
  )%>% 
    ungroup()
  

passthrudf_by15_lu5yr_label_crop_offpatent <- passthrudf_by15_lu5yr_labelpre %>% 
    filter(
    name_new_by15 == "Offpatent"
  ) %>% 
  mutate(
        howderived_only = gsub("_.*", "", howderived),
    howderived_crop = gsub(".*_", "", howderived)

  ) %>% 
      group_by(
        name_new_by15, by15,howderived_crop
      ) %>% 
  mutate(
    offpatentnum_bycrop= length(unique(col_id))
  ) %>% 
  ungroup() %>% 
  group_by(
        name_new_by15, by15
      ) %>% 
  mutate(
    offpatentnum_total = length(unique(col_id))
  ) %>% 
  ungroup() %>% 
  mutate(
    howd_percent =  tolower(paste0(str_pad(round(100*offpatentnum_bycrop/offpatentnum_total,0),4,side =  c("left"),  "0" ) ,"%", howderived_crop ))
  ) %>%
  group_by(
    name_new_by15, by15,offpatentnum_total
  ) %>% 
  summarise(
   label_crop_percent = paste(str_remove(unique(rev(sort(howd_percent))), "^0+"),   collapse =  " ")
  ) %>% 
    ungroup() %>% 
  mutate(
    finallabel = paste0(
                name_new_by15, " composition: ", offpatentnum_total," (",
                label_crop_percent,")"
              )
  ) %>% 
  select(
    name_new_by15,by15, finallabel
  ) %>% 
  distinct()

# %>% 
#   mutate(
#     percent_acquired_howderived = round(
#       as.numeric(
#       gsub("%",  "", percent_acquired_howderived),0
#       )
#     ),  
# 
#   )
  
  
     # View(passthrudf_by15_lu5yr_label_crop %>% arrange(name_new_by15, by15))
lookup <- c(`Original_Patent_num` = "Original", `Acquired_Patent_num` = "Acquired")

passthrudf_by15_lu5yr_label   <- passthrudf_by15_lu5yr_labelpre  %>% 
  filter(name_new_by15 != "Offpatent") %>% 
      select(
        name_new_by15, by15, num_companies,totalpatents_by15,percent_patents_year_byfirm
      ) %>% 
      distinct() %>% 
  left_join(
        passthrudf_by15_lu5yr_labelpre %>% 
          select(
            name_new_by15, num_howderived_by15_1, by15, howderived_1
          ) %>% 
          distinct() %>% 
          spread(
            key = howderived_1, 
            value = num_howderived_by15_1 
          ) %>% 
          rename(
            any_of(lookup)
# 
#             Original_Patent_num = Original,
#             Acquired_Patent_num = Acquired
          ),
        by =  c ("name_new_by15", "by15")
        
      ) %>% 
  left_join(
    passthrudf_by15_lu5yr_label_crop,
        by =  c ("name_new_by15", "by15")
  ) %>% 
  
      mutate(
        label_crop_percent =  label_crop_percent,
        finallabel = 
          case_when(
              name_new_by15 == "Offpatent"~ paste0(
                name_new_by15, ": ", totalpatents_by15," (",
                label_crop_percent,")"
              ),
              name_new_by15 == paste0("Not top ", top_strata) ~ paste0(
                name_new_by15, ": ", totalpatents_by15, " ", 
               percent_patents_year_byfirm , 
                " #Firms: ", num_companies, " Avg: ",
                round(totalpatents_by15/num_companies,0) , " (",
                label_crop_percent,")"

              ) ,
              TRUE ~ paste0(
                name_new_by15, ": ", totalpatents_by15,
                " ", percent_patents_year_byfirm  , " (",
                label_crop_percent,")"
              )
          ), 
        finallabel = gsub("; 0%pvp|; 0%pvp", "; ",  finallabel),        
        finallabel = gsub(" 0%pvp", "",  finallabel),
        finallabel = gsub(" 0%p ", "; ",  finallabel), 
        finallabel = gsub("; A:; |O:; ; |O:; ; | ; A:; |O: 0%p; |O: NA 0%p; |A: NA 0%p|())", "", finallabel), 
        finallabel = gsub("O:; ", "O: ", finallabel),        
        finallabel = gsub("; A: 0%p)", ")", finallabel),
        finallabel= 
          # case_when(
          #  substr( finallabel,   ) 
            paste0(
          finallabel, ")"
        # )
          )
      ) %>% 
  select_at(
    c(names(passthrudf_by15_lu5yr_label_crop_offpatent))
  ) %>% 
  bind_rows(
    passthrudf_by15_lu5yr_label_crop_offpatent
  )
 

passthrudf_by15_lu5yr_labelyear <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 0)

passthrudf_by15_lu5yr_labelyear_top4 <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = passthru_if_take_tops)

passthrudf_by15_lu5yr_labelyear_final <-  passthrudf_by15_lu5yr_labelyear  %>% 
  left_join(
    passthrudf_by15_lu5yr_labelyear_top4 %>% 
      rename(
        top4label  = finalyearlabel
      ),
    by  =  c("by15")
  )  %>%  
  mutate(
    finalyearlabel  =  
      paste0(finalyearlabel,"; ", top4label)
    
  )  %>%
  select(
  by15,  finalyearlabel
  )  %>%  
  distinct()

   # now year labels
  # then get totals of year   
  #make label for each year

passthrudf_by15_spread <- passthrudf_by15_lu5yr_strata  %>% 
     mutate(
       name_new_by15_col_splitby_crop  = gsub(".*_","",tolower(name_new_by15_col_splitby_crop)  )
     )  %>% 
  left_join(
    passthrudf_by15_lu5yr_label %>% 
      select(by15,name_new_by15 , finallabel) %>% 
      distinct(), 
    by = c("by15", "name_new_by15")
  ) %>% 
    left_join(
    passthrudf_by15_lu5yr_labelyear_final %>% 
      select(by15,finalyearlabel) %>% 
      distinct(), 
    by = c("by15" )
  ) %>% 
  select(
    patent_merger_id, name_standard_patent2,finallabel, finalyearlabel, howderived,name_new_by15_col_splitby_crop,name_new_by15_col_splitby_crop_full
  ) %>% 
  mutate(
      finalyearlabel = paste0("YR=", finalyearlabel)
  ) %>% 
  # left_join(
  #   passthrudf_by15_lu5yr_catLU  %>% 
  #     mutate(
  #       name_new_by15_col_splitby_crop =   tolower(name_new_by15_col_splitby_crop)
  #     ),
  #   by  = c("name_new_by15_col_splitby_crop" )
  # ) %>%  
  mutate(
  name_new_by15_col_splitby_crop_full =  paste0(
    gsub(
      ".*_","", 
      name_new_by15_col_splitby_crop_full
      
      ), " (",  name_new_by15_col_splitby_crop,")"
  )  
  ) %>%  
  select(
    -name_new_by15_col_splitby_crop , -howderived
  )%>%  
  rename(
    howderived = name_new_by15_col_splitby_crop_full 
  )

# 2 is only with howacq
passthrudf_by15_spread2 <- passthrudf_by15_spread %>% 
    distinct() %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) 
# 3 is  with finalname
passthrudf_by15_spread3 <- passthrudf_by15_spread %>% 
  select(-howderived) %>%
  distinct() %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) %>% 
  mutate(
    howderived = "only_final"
  )
# rm(passthrudf_by15_spread2)
# rm(passthrudf_by15_spread3)
rm(passthru_if_take_tops)
rm(passthrudf_by15_lu5yr)
rm(passthrudf_yearlistdf)
rm(passthrudf_filteryr)
# rm(passthrudf_by15_spread3)
rm(passthrudf_by15_lu5yr_totals_top12)
rm(passthrudf_by15_lu5yr_strata_totals)
rm(passthrudf_by15_lu5yr_strata)
rm(passthrudf_by15_lu5yr_labelyear_top4)
rm(passthrudf_by15_lu5yr_labelyear_final)
rm(passthrudf_by15_lu5yr_labelyear)
rm(passthrudf_by15_lu5yr_labelpre)
rm(passthrudf_by15_lu5yr_label_crop_offpatent)
rm(passthrudf_by15_lu5yr_label_crop)
 rm(passthrudf_by15_lu5yr_label)
rm(passthrudf_by15_lu5yr_crop_top12)
rm(passthrudf_by15_lu5yr_catLU)
rm(passthrudf_by15_lu5yr_cat)
rm(passthrudf_by15_lu5yr)
rm(passthru_if_take_tops)
 rm(passthrudf)
 # rm(passthrudf_by15_spread)
 # rm(passthrudf_by15_spread2)
 # rm(passthrudf_by15_spread3)
passthrudf_by15_spread2 %>% 
  bind_rows(
    passthrudf_by15_spread3
  )


}
```

##### labelyear func generic
```{r }
processlabel_bytype_generic_labelyear <- function( passthru_process_stratadf, passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 4){
  # passthru_process_stratadf = passthrudf_by15_lu5yr_strata
  # passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals
  # if_top4 = 4
  # if_top4=0
  if((if_top4 >=1))
  {
     top4cos_in_year <- passthru_process_stratadf%>% 
            filter(
      name_new_by15 != "Offpatent",  
      !grepl( x  =name_new_by15,  pattern= "not top|name not",  ignore.case=TRUE,perl  = TRUE)
      
    ) %>% 

      group_by(
        name_new_by15 , by15
      ) %>% 
      summarise(
        numpatents_total_bycoyear = length(unique(col_id))
      ) %>% 
      ungroup() %>% 
      group_by(by15) %>% 
      arrange(
        -numpatents_total_bycoyear
      ) %>%
      slice(1:if_top4) %>% 
      ungroup()
    
    passthru_process_stratadf_filter <- passthru_process_stratadf%>% 
      inner_join(
        top4cos_in_year, 
        by = c("by15", "name_new_by15")
      )
  }
    if(!(if_top4  >=1))
  {
      passthru_process_stratadf_filter <- passthru_process_stratadf
       
    }
   # now year labels
    # then get totals of year   
  passthru_process_stratadf_filter_labelyear_totals <-   passthru_process_stratadf_filter %>% 
  #only have mdified crop name
  select(
    -contains("name_new_by15_col_splitby_crop")
  ) %>% 
   left_join(
     passthru_process_strata_totals ,#%>% 
       # select(
       #   -numcrops_thatyear
       # ), # %>% 
       # select(
       #   name_new_by15,patent_merger_id, by15, name_standard_patent2, patent_type2, 
       #   
       # ), 
     by = c("name_new_by15", "patent_merger_id", "by15","name_standard_patent2", "if_created_thatyear" )
   )  %>% 
     filter(
      name_new_by15 != "Offpatent"
    ) %>% 
   mutate(
        #this gets the crop
    howderived_short = gsub(".*_", "", howderived)
  ) 
  
      passthru_process_lu5yr_labelyear_totalLU  <-passthru_process_stratadf_filter_labelyear_totals  %>% 
          mutate(
      total_percent_num_patents_bytype =  
        round(100*numcrops_thatyear/totalpatents_year,0),
        howd_percent_total =  paste0(str_pad(total_percent_num_patents_bytype,4,side =  c("left"),  "0" ) ,"%", howderived_short )

  ) %>% 
    group_by(
          by15, totalpatents_year  
    ) %>% 
    summarise(
      label_total_if_createdthatyear_usethis = 

           paste(
             str_remove(
  
          rev(sort(unique(howd_percent_total ) )  ), 
           "^0+"),
        collapse = " "

        )
       
    ) %>% 
    ungroup()   %>% 
        mutate(
          label_total_if_createdthatyear_usethis = tolower(label_total_if_createdthatyear_usethis)
        )
       
  
     if(!(if_top4  >=1))
  {
       passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals #%>% 
         # mutate(
         #  created_or_acq_num= numcrops_thatyear
         # )
       

       
     }
  
  
  
     if((if_top4  >=1))
  {
        passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals  %>%
    group_by(
      by15,if_created_thatyear
    ) %>% 
    
      mutate(
        #  make this total  or by  top  4
        created_or_acq_num  =  
          # case_when(
          #   !(if_top4  >=1)  ~  created_or_acq_num,
             # (if_top4  >=1)  ~ 
          length(unique(col_id))
          # )
      )  %>% 
    ungroup()   

        
        
     }
  
 passthru_process_stratadf_filter_labelyear_totals <- passthru_process_stratadf_filter_labelyear_totals %>% 
    # group_by(
    #   howderived_short,by15
    # ) %>%
    # mutate(
    #  numcrops_thatyear = length(unique(col_id))  
    # ) %>% 
    # ungroup()

  # top  row first
    # group_by(
    #   howderived_short, by15
    # ) %>% 
    # #don't  actually need  below
    # mutate(
    #   #global  corn, soy,  by year: originated or 
    #   num_patents_bytype = length(unique(
    #     id
    #   )
    #   )
    # )%>% 
    # ungroup() %>% 
    mutate(
      #this should be D  or P
      total_percent_num_patents_bytype =  
        round(100*created_or_acq_num/totalpatents_year,0)
    )  %>% 
    select(
      by15, patent_merger_id, howderived_short , if_created_thatyear ,col_id, total_percent_num_patents_bytype,totalpatents_year, created_or_acq_num,
      numcrops_thatyear
     
    ) %>% 
    
    #  group_by(
    #   by15
    # ) %>% 
    # mutate(
    #   bytype_by15 = paste0(
    #     totalpatents_year, " ",
    #     paste(
    #     paste0(
    #       rev(sort( unique(total_percent_num_patents_bytype ))),
    #       "%", howderived_short
    #     ), 
    #     collapse = " "
    #   ) 
    #   )
    # )%>% 
    ungroup() %>% 
   
    # then created_or_acq_num is total for  second line
    #   mutate(
    #     if_created_thatyear = 
    #       case_when(
    #         patentyear_by5 == by15~ "Created that Year", 
    #         TRUE ~ "Acquired that Year"
    #       )
    #     
    #   ) %>% 
    # filter(
    #   if_created_thatyear == "Created that Year"
    # ) %>% 
  # then by passed or developed by crop
  group_by(
    by15,   total_percent_num_patents_bytype,totalpatents_year,
    created_or_acq_num, if_created_thatyear, 
    # aka by crop
    howderived_short,
    #this is to get divided by total patents by  crop
    numcrops_thatyear
  ) %>% 
    summarise(
        total_developed_thatyearbytype = length(unique(col_id))
      ) %>% 
      ungroup() %>% 
    mutate(
      per_total_developed_thatyearbytype = 
        case_when(
          !(if_top4  >=1) ~ 
          round(100*total_developed_thatyearbytype/created_or_acq_num,0), 
          (if_top4  >=1) ~ 
          round(100*total_developed_thatyearbytype/numcrops_thatyear,0)

        )
    )#  %>% 
    # gather(
    #   key =  eachrowtype, 
    #   value = value,
    #   num_patents_bytype,  total_developed_thatyearbytype
    # ) %>% 
    # distinct() %>% 
    # mutate(
    #   label_by_if_created_thatyear =  paste0(
    #     total_developed_thatyearbytype,  
    #     "%", howderived_short
    #   )
    # )
  # filter(
  #   per_total_developed_thatyearbytype >=2
  # )
  # 
  # passthru_process_stratadf_filter_labelyear_totals %>%
  #   filter(
  #       by15   == "1980"#, howderived_short == "c"
  #   ) %>% arrange(by15, howderived_short,if_created_thatyear  ) %>%   View()
  # 
  
passthru_process_lu5yr_labelyear <-passthru_process_stratadf_filter_labelyear_totals  %>% 
  mutate(
    howd_percent =  paste0(str_pad(per_total_developed_thatyearbytype,4,side =  c("left"),  "0" ) ,"%", howderived_short ),
        howd_percent_total =  paste0(str_pad(total_percent_num_patents_bytype,4,side =  c("left"),  "0" ) ,"%", howderived_short )

  ) %>% 
    group_by(
          by15, totalpatents_year,created_or_acq_num,if_created_thatyear  
    ) %>% 
    summarise(
      label_by_if_created_thatyear = paste(
         str_remove( #rev(sort(howd_percent)), "^0+")
          rev(sort(unique(howd_percent )   )), 
           "^0+"),
        collapse = " "
      ),
      label_total_if_createdthatyear = 

           paste(
             str_remove(
  
          rev(sort(unique(howd_percent_total ) )  ), 
           "^0+"),
        collapse = " "

        )
       
    ) %>% 
    ungroup()  %>% 
    mutate(
      label_by_if_created_thatyear = tolower(label_by_if_created_thatyear),
      dev_or_pass = 
        case_when(
          #this is  for  totals
          ((if_created_thatyear== "Created that Year")&( !(if_top4  >=1))) ~ 
            paste0(
              "D: ", created_or_acq_num, " (",  label_by_if_created_thatyear, ")"
            ),  
          ((if_created_thatyear!= "Created that Year")&( !(if_top4  >=1)))  ~ 
            paste0(
              "R: ", created_or_acq_num," (", label_by_if_created_thatyear, ")"
              ),
          #this is  for  tops only
          
          ((if_created_thatyear== "Created that Year")&( (if_top4  >=1))) ~ 
            paste0(
              "Top",if_top4,"_", "D: ", created_or_acq_num," ",
              round(100*created_or_acq_num/totalpatents_year ,0 ),"%",   " of total",
              " (",  label_by_if_created_thatyear, ")"
            ),  
          ((if_created_thatyear!= "Created that Year")&( (if_top4  >=1)))  ~ 
            paste0(
              "Top",if_top4,"_", 
              "R: ", created_or_acq_num," ", 
              round(100*created_or_acq_num/totalpatents_year ,0 ),"%",  " of total", 
               " (", label_by_if_created_thatyear, ")"
            )
          
        )
    ) %>% 
  group_by(
    by15,  totalpatents_year
  )  %>%  
  arrange(rev(label_total_if_createdthatyear ))  %>% 
  mutate(
    label_total_if_createdthatyear = tolower(label_total_if_createdthatyear),

    label_total_if_createdthatyear  =
      case_when(
         (row_number()==1)#&(grepl("D:|P:",dev_or_pass , perl = TRUE))  
         ~  label_total_if_createdthatyear,
       row_number()>=2#&(grepl("D:|P:",dev_or_pass , perl = TRUE)) 
       ~ lag(label_total_if_createdthatyear)#, 
       # TRUE ~ 
       
      )
  ) %>%   
    ungroup()   %>%  
  group_by(
    by15,  totalpatents_year, label_total_if_createdthatyear
  ) %>% 
  summarise(
    final_label_year   =  paste(
      sort(unique(dev_or_pass)),
      collapse = "; "
    )
  ) %>% 
  ungroup()%>% 
  left_join(
    passthru_process_lu5yr_labelyear_totalLU , 
    by = c("by15", "totalpatents_year")
  ) %>%
    mutate(
      finalyearlabel  = 
        case_when( 
         !(if_top4  >=1) ~  paste0(
         by15,  ": ",totalpatents_year, " (", label_total_if_createdthatyear_usethis,  "); ",
          final_label_year
        ),   
        (if_top4  >=1) ~ 
          final_label_year
          )
        
    ) %>% 
  select(
    by15,  finalyearlabel
  ) %>%
  distinct()
   
 passthru_process_lu5yr_labelyear   
  
}
```

#### get finalname by patent/PVP x acqquired/developed
```{r }
processlabel_bytype <- function(
  passthrudf =   alluv_df_by15, 
  passthrudf_yearlistdf = yearlist#, 
  # sendthru = "bypatent_acq", 
  # col_to_split = alluv_df_by15$patent_type2
  ){
  
  
      passthrudf_filteryr <-      passthrudf %>%  filter(
        patentyear_by5 %in% passthrudf_yearlistdf
      ) 

    
    ##### first step is to categorize
    passthrudf_by15_lu5yr <- passthrudf %>% 
    #         cbind(
    #   tibble(
    #     col_splitby = col_to_split
    #   )  
    #   
    # )  %>% 

      filter(
        patent_merger_id %in% c(passthrudf_filteryr$patent_merger_id)
      ) %>% 

      group_by(
        patent_merger_id,by15
      ) %>% 
      filter(
        # this makes it so that for by15=2015, if merger happened in 2018, it'll still use 2017 name (bc that's what it was in 2015; actually, should use max to capture any ) 
        ground_year == min(ground_year)
      )%>% 
      # slice(which.max(ground_year )) %>% 
      ungroup() %>% 
      rename(
        name_new_by15 = name_new_offpatent
      )%>% 
      select(
        name_new_by15, patent_merger_id,by15, name_standard_patent2, patent_type2, patentyear_by5
      ) %>% 
      distinct() %>%
      mutate(
        howderived = 
          case_when(
            name_new_by15!= name_standard_patent2 ~ "Acquired", 
            TRUE ~ "Original"
          ), 
        howderived_1  = howderived,
        howderived = paste0(howderived, "_", patent_type2), 
        if_created_thatyear = 
          case_when(
            patentyear_by5 == by15~ "Developed", 
            TRUE ~ "Passed On"
          ), 
        patent_type2_if_created_thatyear = paste0(
        patent_type2,"_", if_created_thatyear
      )


      ) 
    
       passthrudf_by15_lu5yr_totals_top12 <- passthrudf_by15_lu5yr%>% 
      group_by(
        by15, name_new_by15
      ) %>% 
      summarise(
        numpatents =length(unique(id))
      ) %>% 
      ungroup() %>% 
     group_by(
        by15 
      ) %>% 
      arrange(
        -numpatents
      ) %>% 
      slice(1:top_strata) %>% 
      ungroup()

    
   passthrudf_by15_lu5yr_strata <- passthrudf_by15_lu5yr  %>% 
     left_join(
       passthrudf_by15_lu5yr_totals_top12, 
       by = c("by15", "name_new_by15")
     ) %>% 
     mutate(
       name_new_by15_strata = 
         case_when(
           is.na(numpatents) ~ paste0("Not top ", top_strata), 
           TRUE ~ name_new_by15
         )
     ) %>% 
      group_by(name_new_by15_strata, by15 ) %>% 
      mutate(
        #total patents in that year by firm
        totalpatents_by15 =  length(unique(id)), 
        num_companies = length(unique(name_new_by15))
      ) %>% 
      ungroup()  %>% 
     select(
       -name_new_by15
     ) %>% 
     rename(
       name_new_by15 = name_new_by15_strata
     )
      #total patents in that year
    
        ##### second step is to get totals for each company label by year, filtering out offpatent
   passthrudf_by15_lu5yr_strata_totals <- passthrudf_by15_lu5yr_strata %>% 
      filter(
        name_new_by15 != "Offpatent"
      ) %>% 
      
      group_by( by15 ) %>% 
      mutate(
        totalpatents_year =  length(unique(
          id))
      ) %>% 
      ungroup() %>% 
    group_by(
      by15, if_created_thatyear 
    ) %>% 
    mutate(
      created_or_acq_num =  length(unique(id))
    ) %>% 
    ungroup()
     

    #label the individual co years 
passthrudf_by15_lu5yr_label_pre <-   passthrudf_by15_lu5yr_strata %>% 
   left_join(
     passthrudf_by15_lu5yr_strata_totals#,  %>% 
       # select(
       #   name_new_by15,patent_merger_id, by15, name_standard_patent2, patent_type2, 
       #   
       # ), 
     # by = c("name_new_by15", "patent_merger_id", "by15","name_standard_patent2", "patent_type2" )
   ) %>% 
   mutate(
     percent_patents_year_byfirm =
       case_when(
         
         name_new_by15 == "Offpatent"~ "0%",
         TRUE ~paste0(round(100*totalpatents_by15/totalpatents_year,0),"%")
       )
   )  %>% 
     group_by(name_new_by15, by15,howderived ) %>% 
         # num 
         mutate(
           num_howderived_by15 = length(unique(id))
         ) %>% 
         ungroup() %>% 
         mutate(
           # percent_patents_thatyear = 
           # percent_acquired_howderived = percent(num_howderived_by15/totalpatents_by15)
          percent_acquired_howderived = 
           # case_when(
              # name_new_by15 == "Offpatent"~ "0%",
            #  TRUE ~
            paste0(round(100*num_howderived_by15/totalpatents_by15,0),"%")
              
          #  )
         ) %>% 
  # this below is  solely acquired or  origin (not   pvP or  patent)
  group_by(
    howderived_1,name_new_by15, by15
  ) %>% 
         # num 
         mutate(
           num_howderived_by15_1 = length(unique(id))
         ) %>% 
         ungroup()

passthrudf_by15_lu5yr_label  <- passthrudf_by15_lu5yr_label_pre  %>% 
      select(
        name_new_by15, totalpatents_by15,by15,howderived, percent_acquired_howderived,  percent_patents_year_byfirm, num_companies
      ) %>% 
      distinct() %>% 
      spread(
        key = howderived, 
        value = percent_acquired_howderived 
      ) %>% 
      left_join(
        passthrudf_by15_lu5yr_label_pre %>% 
          select(
            name_new_by15, num_howderived_by15_1, by15, howderived_1
          ) %>% 
          distinct() %>% 
          spread(
            key = howderived_1, 
            value = num_howderived_by15_1 
          ) %>% 
          rename(
            Original_Patent_num = Original,
            Acquired_Patent_num = Acquired
          ),
        by =  c ("name_new_by15", "by15")
        
      ) %>% 
      mutate(
        finallabel = 
          case_when(
              name_new_by15 == "Offpatent"~ paste0(
                name_new_by15, ": ", totalpatents_by15,
                " (O: ",    
                replace_na(Original_Patent,"0%"), "p ", replace_na(Original_PVP,"0%") ,"pvp; A: ",   
                
                replace_na(Acquired_Patent,"0%"), "p ", replace_na(Acquired_PVP,"0%") ,"pvp)"
              ),
              name_new_by15 == paste0("Not top ", top_strata) ~ paste0(
                name_new_by15, ": ", totalpatents_by15,
                " ", percent_patents_year_byfirm , 
                " #Firms: ", num_companies, " Avg: ",
                round(totalpatents_by15/num_companies,0) ,
                " (O: ", Original_Patent_num, " ",
                replace_na(Original_Patent,"0%"), "p ", replace_na(Original_PVP,"0%") ,"pvp; A: ", Acquired_Patent_num,  " ",
                
                replace_na(Acquired_Patent,"0%"), "p ", replace_na(Acquired_PVP,"0%") ,"pvp)"
              ) ,
              TRUE ~ paste0(
                name_new_by15, ": ", totalpatents_by15,
                " ", percent_patents_year_byfirm ,
                
                " (O: ",Original_Patent_num, " ",
                replace_na(Original_Patent,"0%"), "p ", replace_na(Original_PVP,"0%") ,"pvp; A: ",   Acquired_Patent_num,  " ",
                
                replace_na(Acquired_Patent,"0%"), "p ", replace_na(Acquired_PVP,"0%") ,"pvp)"
              )
          ), 
        finallabel = gsub("; 0%pvp|; 0%pvp", "; ",  finallabel),        
        finallabel = gsub(" 0%pvp", "",  finallabel),
        finallabel = gsub(" 0%p ", "; ",  finallabel), 
        finallabel = gsub("; A:; |O:; ; |O:; ; | ; A:; |O: 0%p; |O: NA 0%p; |A: NA 0%p|()", "", finallabel), 
        finallabel = gsub("O:; ", "O: ", finallabel),        
        finallabel = gsub("; A: 0%p)", ")", finallabel)
      ) 
 

   
  # then get totals of year   
  passthrudf_by15_lu5yr_labelyear_totals <-  passthrudf_by15_lu5yr_strata  %>% 
    left_join(
      passthrudf_by15_lu5yr_strata_totals
    ) %>% 
     filter(
      name_new_by15 != "Offpatent"
    ) %>% 

    group_by(
      patent_type2, by15
    ) %>% 
    mutate(
      num_patents_bytype = length(unique(
        id
      )
      )
    )%>% 
    ungroup() %>% 
    #   mutate(
    #     if_created_thatyear = 
    #       case_when(
    #         patentyear_by5 == by15~ "Created that Year", 
    #         TRUE ~ "Acquired that Year"
    #       )
    #     
    #   ) %>% 
    # filter(
    #   if_created_thatyear == "Created that Year"
    # ) %>% 
      group_by(by15, patent_type2_if_created_thatyear, num_patents_bytype,totalpatents_year ,created_or_acq_num) %>% 
      summarise(
        total_developed_thatyearbytype = length(unique(id))
      ) %>% 
      ungroup() 
  
  
  #make label for each year
  passthrudf_by15_lu5yr_labelyear <-passthrudf_by15_lu5yr_strata %>% 
    left_join(
      passthrudf_by15_lu5yr_labelyear_totals
    ) %>%

    mutate(
      percent_patents_bytype = 
         # case_when(
         # 
         # name_new_by15 == "Offpatent"~ "",
        # TRUE ~ 
        paste0(
        #num_patents_bytype," ",
        round(100*num_patents_bytype/totalpatents_year,0),"%"
        ), 
      percent_developed_thatyearbytype =
        paste0(
          #total_developed_thatyearbytype," ",
          round(100*total_developed_thatyearbytype/created_or_acq_num,0),"%")
      
    ) %>% 
    select(
      by15,totalpatents_year, patent_type2_if_created_thatyear, percent_developed_thatyearbytype,percent_patents_bytype, created_or_acq_num
    ) %>% 
    # distinct() %>% 
    # spread(
    #   key = if_created_thatyear,
    #   value = created_or_acq_num
    #   
    # ) %>% 
    gather(
      key = type,
      value = value,
      percent_developed_thatyearbytype:created_or_acq_num
    ) %>% 
    distinct() %>% 
    mutate(
      patent_type2_type = paste0(patent_type2_if_created_thatyear, "_",  type  )
    ) %>% 
    select(
      by15, totalpatents_year, patent_type2_type, value
    ) %>% 
    distinct() %>% 
    spread(
      key = patent_type2_type, 
      value = value
    ) %>% 
    mutate(
      finalyearlabel = paste0(
        # https://stackoverflow.com/questions/66913147/in-r-dplyr-mutate-referencing-column-names-by-string
        #https://stackoverflow.com/questions/68349087/refer-to-column-name-from-variable-in-across-in-dplyr
        by15,": ", totalpatents_year, " total (", "", 
        `Patent_Acquired that Year_percent_patents_bytype`,  "p ", 
        `PVP_Acquired that Year_percent_patents_bytype` , "pvp); ",
        # can be patent created or pvp created; same nums
        "D: ",  `Patent_Created that Year_created_or_acq_num` , " (", 
        `Patent_Created that Year_percent_developed_thatyearbytype`, "p ",
        `PVP_Created that Year_percent_developed_thatyearbytype`, "pvp); ",
    # can be patent acq or pvp acq; same nums

        "P: ",  `Patent_Acquired that Year_created_or_acq_num` , " (", 
        `Patent_Acquired that Year_percent_developed_thatyearbytype`, "p ",
       `PVP_Acquired that Year_percent_developed_thatyearbytype`, "pvp)"
        
      )
    ) %>% 
    mutate(
      finalyearlabel = gsub("NAp", "0%p",finalyearlabel ), 
      finalyearlabel = gsub("NA ", "0 ",finalyearlabel ), 
      
    )

   

# passthrudf_by15_lu5yr_labelyear <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 0)
# 
# passthrudf_by15_lu5yr_labelyear_top4 <-passthrudf_by15_lu5yr_strata %>%  processlabel_bytype_generic_labelyear( passthru_process_stratadf = ., passthru_process_strata_totals = passthrudf_by15_lu5yr_strata_totals, if_top4 = 4)
# 
# passthrudf_by15_lu5yr_labelyear_final <-  passthrudf_by15_lu5yr_labelyear  %>% 
#   left_join(
#     passthrudf_by15_lu5yr_labelyear_top4 %>% 
#       rename(
#         top4label  = finalyearlabel
#       ),
#     by  =  c("by15")
#   )  %>%  
#   mutate(
#     finalyearlabel  =  paste0(finalyearlabel,"; ", top4label)
#   )  %>%  
#   select(
#   by15,  finalyearlabel
#   )  %>%  
#   distinct()

  
passthrudf_by15_spread <- passthrudf_by15_lu5yr_strata %>% 
  left_join(
    passthrudf_by15_lu5yr_label %>% 
      select(by15,name_new_by15 , finallabel) %>% 
      distinct(), 
    by = c("by15", "name_new_by15")
  ) %>% 
    left_join(
    passthrudf_by15_lu5yr_labelyear %>% 
      select(by15,finalyearlabel) %>% 
      distinct(), 
    by = c("by15" )
  ) %>% 
  select(
    patent_merger_id, name_standard_patent2,finallabel, finalyearlabel, howderived
  ) %>% 
  mutate(
      finalyearlabel = paste0("YR=", finalyearlabel)
  ) 

# 2 is only with howacq
passthrudf_by15_spread2 <- passthrudf_by15_spread %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) 
# 3 is  with finalname
passthrudf_by15_spread3 <- passthrudf_by15_spread %>% 
  select(-howderived) %>% 
    spread(
      key = finalyearlabel,
      value = finallabel
    ) %>% 
  mutate(
    howderived = "only_final"
  )

passthrudf_by15_spread2 %>% 
  bind_rows(
    passthrudf_by15_spread3
  )
}
```

### actual func
```{r }
 # alluvial::Refugees %>% glimpse()
graphalluvial <-function(alluv_df, stratacol ,crops_to_use = c("soybean", "corn", "cotton", "wheat", "tomato"), top_strata = 12, textsize = 4, textout = 10, outwidth, outheight,folderout,savefileas, yearlist = c(1980:2022), whichcolisID, whichcolisfacet, passthru_if_take_topssend = 5, top_strata_colsplitbysend, order_by_cropLU= NULL, alluv_titleinclude = "", if_alluv_loop = 0, alluv_label_legend, 
                         shrink_factor = 1, alluv_size= 3, alluv_remove_parentheses_vallabs= "no" ,alluv_remove_parentheses_ylabs = "no", 
                                 alluv_title_expo =  "Ownership of Acquired (A) or Origin (O) count and percent of certificates from ", 
                            alluv_xlabel=  "5-Year Interval: Total PVP or patent count; Developed (D); or Retained (R) during that 5-year interval, with %composition shown", 
                                   alluv_subtitle =   
         "Origin means that the patent or PVP applicant organization is the same name as the extant parent firm name. \nAcquired means that applicant organization was acquired by a parent firm."  

                         ){

  require(lubridate)
  require(alluvial)
  require(ggalluvial)
  require(scales)
  require(tidyverse)
          require(rcartocolor)

# # 
#  alluv_df <- combined_pvp_patent_doc_wcos_merger_cluster %>%
#     mutate(
#     .cluster = paste0(crop, "-", .cluster)
#   ) %>% 
# 
#    mutate(
#     col_id = 0,
#     ground_year = as.numeric(ground_year),
#     patent_year =patent_year,
#     crop_type = crop
#   ) %>%
#   filter(
#     patent_type == "patent"
#   ) %>%
#   select(
#     -finalname , -finalname_offpatent
#   )
# crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage")
# top_strata = 12
# textsize = 6
# textout = 45
# outwidth =60
# outheight=35
# folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger"
# savefileas = "230203_patent_topcluster"
# yearlist = c(1980:2022)
# whichcolisID = alluv_df$patent_number
# whichcolisfacet= alluv_df$.cluster
# passthru_if_take_topssend = 5
#               # show num of top crops
#               top_strata_colsplitbysend = 6
# 
# 

    # crops_to_use = c("soybean", "corn", "cotton" )
 # crop_dontuse = c(
 #   (
 #     x %>% 
 #     filter(
 #       !crop %in% c(crops_to_use)
 #     )
 #   )$crop
 #   
 # )
 # top_strata = 12
 # yearlist = c(1980:2022)
 # textsize = 4
 # textout = 40
 #   outwidth = 60
 #   outheight = 35
 #   folderout ="X:/msi/work/farmer welfare/seed/R analysis/images/merger"
 #      folderout ="D:/seed"

   #    folderout ="C:/Users/Jeffrey.Nian/Documents/Comp/seed/images/merger"

         # folderout ="D:/seed/images/merger"

   # savefileas= "221106_alluvium_themes"
   #   savefileas= "230109_alluvium_themes"
   #   savefileas= "230117_alluvium_crop"


   # alluv_df <- soycropquery_merger  
   # top_strata = 10
  # x_filtercrop <- x %>% 
  #   filter(crop %in% crops_to_use)
  # 
  # x_filtercrop_other <- x_filtercrop %>% 
  #   bind_rows(
  #     x %>% 
  #       filter(
  #        !(crop %in% c(crop_dontuse)),
  #         !universal_id_start %in% c(x_filtercrop$universal_id_start)
  #       ) %>% 
  #       mutate(
  #         crop = "Other"
  #       )
  #     
  #   )  
     # so 2018 -> 2015
    # lubridate::year(round_date(as.Date(paste(2018, 12, 31, sep = "-")) , "5 years"))
    alluv_df_by15 <-  alluv_df%>%
      # select(
      #   -col_id
      # ) %>% 
      cbind(
        tibble(
          col_id = whichcolisID
        ), 
        tibble(
          col_facet = whichcolisfacet
        ), 
        tibble(
          col_loopthru = if_alluv_loop
        )

      )  %>% 
   mutate(
     # ground_year_year=  as.Date(paste(ground_year, 12, 31, sep = "-"))
     ground_year_year=   as.Date(ISOdate(ground_year, 12, 31)),
     patent_year = as.Date(ISOdate(patent_year, 12, 31))
   ) %>% 
   mutate(
     # by15 = parse_date_time(BeginTime, '%d/%m/%y %I:%M %p'),
     by15 = lubridate::year(round_date(ground_year_year, "5 years")), 
     patentyear_by5 = lubridate::year(round_date(patent_year, "5 years"))

     ) %>% 
      select(-ground_year_year)
# 
#     alluv_df_by15_finalyearlu <-  alluv_df_by15 %>% 
#       group_by(patent_merger_id, name_standard_patent2 ) %>% 
#       filter(
#         patentyear_by5 == max(patentyear_by5)
#       ) %>% 
#       ungroup() %>%  
#       select(
#         patent_merger_id, name_standard_patent2, name_new_offpatent    
#       )
    
 # alluv_df_by15_spread <-  alluv_df_by15 %>% 
 #     processlabel_bytype(
 #  passthrudf =   ., 
 #  passthrudf_yearlistdf = yearlist,
 #  top_strata=12
 #  )
    rm(q)
    rm(list_alluv_ggplots)
q <- 1
alluv_list_loopthru <- if_alluv_loop %>% unique() %>% sort()
list_alluv_ggplots <- list()

    while(q <= length(alluv_list_loopthru) )
    {
  alluv_current_loop <-    alluv_list_loopthru[q] 
      
  alluv_df_by15_spread <-  alluv_df_by15 %>% 
  filter(
    col_loopthru == alluv_current_loop
  ) %>% 
     processlabel_bytype_generic(

    passthrudf =   ., 
  passthrudf_yearlistdf = yearlist,
  which_to_change1 = .$col_facet,
  # which_col_is_id = .$col_id,
  top_strata_colsplitby   = top_strata_colsplitbysend,  
  top_strata =  top_strata,
  howderived_acq_or_orig = "yes",
  passthru_if_take_tops = passthru_if_take_topssend

  
  )
# 
#   alluv_df_by15_spread <-  alluv_df_by15 %>% 
#     mutate(
#         patent_type2 =
#           case_when( 
#             name_new_offpatent== name_standard_patent2 ~ paste0("original."  , patent_type2) , 
#             TRUE ~ paste0("acquired." , patent_type2)
#           ), 
#     )  %>% 
#      processlabel_bytype_generic(
#   passthrudf =   ., 
#   passthrudf_yearlistdf = yearlist,
#   which_to_change1 = .$patent_type2,
#   top_strata_colsplitby   = 4,  
#   howderived_acq_or_orig = "yes", 
#     top_strata =  12,
#   passthru_if_take_tops = 4
#   )
# 

alluv_df_by15_spread2 <-alluv_df_by15_spread %>% 
  cbind(
     data.frame(
       final_name =   rev(alluv_df_by15_spread)[1]
     )
  )
names(alluv_df_by15_spread2)[ncol(alluv_df_by15_spread2)] <- "final_name"

        alluv_df_by15_topcos_color <- alluv_df_by15_spread2 %>% 
          filter(
            howderived ==  "only_final" 
          ) %>% 
      group_by(final_name) %>% 
      summarise(
        num_ids = length(unique(patent_merger_id))
      ) %>% 
      ungroup() %>% 
      arrange(
        -num_ids
      ) %>% 
      slice(1:12)
            
# alluv_df_by15_withfinal <- alluv_df_by15%>% 
#   left_join(
#     alluv_df_by15_lu5yr, 
#     by = c("patent_merger_id","by15", "name_standard_patent2")
#   ) %>% 
#   group_by(
#     name_new_by15, patent_merger_id,by15, name_standard_patent2
#   ) %>% 
#   slice(1) %>% 
#   ungroup()
        require(rcartocolor)

   alluv_df_by15_spread_sum <- alluv_df_by15_spread2 %>% 
     filter(
       howderived != "only_final" 
     ) %>% 
     group_by_at(
       c(
         "final_name",
         "howderived",
         alluv_df_by15_spread %>% 
           select(
             contains("YR")
           ) %>% 
           names()
         )
     ) %>% 
    # group_by(
    #   crop,final_name,`YR1990`,`YR1995`,`YR2000`,`YR2005`,`YR2010`,`YR2015`,`YR2020`
    # ) %>% 
    summarise(
      freq = length(unique(patent_merger_id))
            # freq = length(unique(col_id))

    ) %>% 
     ungroup() %>% 
     mutate(
       rowid = row_number()
     )  
   
 alluv_df_by15_spread_sum_long <-alluv_df_by15_spread_sum  %>%
    gather(
      key = by15,
      value = value,
      contains("YR")
      ) %>% 
  mutate(
    final_name = 
      case_when(
        final_name %in% c(alluv_df_by15_topcos_color$final_name)~ final_name,
        TRUE ~ "Other"
      ) #,
# howderived = as.factor(as.character(howderived))
  )
 
   alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread2 %>% 
          filter(
       howderived == "only_final" 
     ) %>% 
     group_by_at(
       c(
         "final_name",
         alluv_df_by15_spread %>% 
           select(
             contains("YR")
           ) %>% 
           names()
         )
     ) %>% 
    # group_by(
    #   crop,final_name,`YR1990`,`YR1995`,`YR2000`,`YR2005`,`YR2010`,`YR2015`,`YR2020`
    # ) %>% 
    summarise(
      freq = length(unique(patent_merger_id))
    ) %>% 
     ungroup() %>% 
     mutate(
       rowid = row_number()
     )  %>%
    gather(
      key = by15,
      value = value,
      contains("YR")
      ) %>% 
     mutate(
       howderived = "Original to Acquired"#,
       # howderived = as.factor(as.character(howderived))
       ) #%>% 
  # mutate(
  #   final_name = 
  #     case_when(
  #       final_name %in% c(alluv_df_by15_topcos_color$final_name)~ final_name,
  #       TRUE ~ "Other"
  #     )
  # ) 

 
 # %>% 
   # mutate(
   #   howderived = 
   #     case_when(
   #       howderived == "Original_PVP" ~ "Original P"
   #     )
   # )
  # x_prepped_rename_usda <- x_prepped_rename_sum %>%
  #  filter(
  #    grepl("stine",`YR2000`, ignore.case = TRUE)
  #  )%>% arrange(patent_number,ground_year)  #%>% 


  # https://stackoverflow.com/questions/70283357/alluvial-plot-with-2-different-sources-but-a-converging-shared-variable-r

#   maxcolors <- length(unique((alluv_df_by15_topcos_color$final_name))
#     set.seed(111)
# 
#   require(RColorBrewer)
#   require(randomcoloR)
#  # n <- 60
# qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# # pie(rep(1,maxcolors), col=sample(col_vector,maxcolors))  
#  
# getPalette = colorRampPalette(brewer.pal(maxcolors, "Set1"))
# use_thispalette = col_vector[1: maxcolors]
# 
#   safe_colorblind_palette <- use_thispalette

 #   require(randomcoloR)
 # safe_colorblind_palette <- distinctColorPalette(maxcolors)
 #  require(rcartocolor)
#   nColor <- length(unique(x_prepped_rename_sum_cross$final_name))
# use_these_colors = carto_pal(nColor, "multi.pal")
# is_alluvia_form(x_prepped_rename_sum,
#                 weight = "countpatent")
  # curriculum data in alluvia format
# majors_alluvia <- 
#   to_alluvia_form(
#  x_prepped_rename_sum_cross,
#   key = "by15", 
#   value = "countpatent",
#   id = "rowid"
# )
   howderivedlu <- alluv_df_by15_spread_sum_long %>% 
     ungroup() %>% 
     bind_rows(
       alluv_df_by15_spread_sum_finalname 
     ) %>%   
     group_by(
      howderived 
     ) %>% 
     summarise(
       freq = sum(freq, na.rm =TRUE)
     ) %>% 

     ungroup() %>% 
     arrange(
       -freq
     ) %>% 
     mutate(
       crop_type = tolower(gsub(" \\(.*","", howderived))
     ) 

   
  if(!is.null(order_by_cropLU))
  {
   howderivedlu <- howderivedlu %>% 
     left_join(
       order_by_cropLU, 
       by = ("crop_type")
     )  %>% 
         arrange(
           -numpatent
         ) %>% 
     mutate(
       howderived2 = paste0(row_number(),howderived)
     )
  } 
   
   if(is.null(order_by_cropLU))
   {
     howderivedlu <- howderivedlu %>% 
       mutate(
         howderived2 = howderived
       )
   }
   
      
   
   alluv_df_by15_spread_sum_long <-alluv_df_by15_spread_sum_long  %>% 
left_join(
  howderivedlu %>% 
    select(
      howderived, howderived2
    ), 
  by = ("howderived")
)

if( alluv_remove_parentheses_vallabs != "no" )
{
  alluv_df_by15_spread_sum_long <- alluv_df_by15_spread_sum_long %>% 
    mutate(
      value = gsub(" \\(.*","", value)
    )
  alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread_sum_finalname %>% 
    mutate(
      value = gsub(" \\(.*","", value)
    )
}
if( alluv_remove_parentheses_ylabs != "no" )
{
  alluv_df_by15_spread_sum_long <- alluv_df_by15_spread_sum_long %>% 
    mutate(
      by15 = gsub(":.*|YR=","", by15)
    )%>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
  alluv_df_by15_spread_sum_finalname <- alluv_df_by15_spread_sum_finalname %>% 
    mutate(
      by15 = gsub(":.*|YR=","", by15)
    )%>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
  
  howderivedlu <- howderivedlu %>% 
    mutate(
      howderived2=  toupper(gsub(" \\(.*","", howderived) ) 
    )
}

   
     set.seed(123)
  large_palette <-  tibble(
  colors = c(
   
  carto_pal(12, "Safe")#,
  # carto_pal(7, "ArmyRose"),
  #  carto_pal(7, "ag_Sunset"),
  #  carto_pal(7, "ag_GrnYl"),
     # carto_pal(7, "Earth")


)
)%>% 
    arrange(runif(n()))
  
  #add more colors if needed
  if(length(howderivedlu$howderived2 )>= length(large_palette$colors))
  {
    large_palette <- large_palette%>% 
      bind_rows(
        tibble(
          colors = c( 
            # carto_pal(12, "Safe"),
            carto_pal(7, "ArmyRose"),
            carto_pal(7, "ag_Sunset"),
            carto_pal(7, "ag_GrnYl"),
            carto_pal(7, "Earth")
            
            
          )
        )
      )%>% 
      arrange(runif(n()))
  }
  large_palette <- large_palette %>% 
    filter(
      colors %in% c(
        "#88CCEE", "#CC6677", "#DDCC77", "#888888", "#44AA99", "#999933", "#f0c6c3"
      )
    )
  use_this_palette <- large_palette$colors[1:length(
    howderivedlu$howderived2
    #   c(
    #   alluv_df_by15_spread_sum_long$howderived,
    #    alluv_df_by15_spread_sum_finalname$howderived
    # ) %>% unique()
    )]
  names(use_this_palette) <- levels (
    c(howderivedlu$howderived2
    )
    # c(
    # 
    #   alluv_df_by15_spread_sum_long$howderived,
    #    alluv_df_by15_spread_sum_finalname$howderived
    # ) %>% unique())
  )
   # 
   # if((alluv_df_by15_spread_sum_long$howderived %>% unique() %>% length())>=3)
   # {
     
  # }
#     if(!(alluv_df_by15_spread_sum_long$howderived %>% unique() %>% length())>=3)
#    {
#  use_this_palette <- tibble(
#   colors = c(
#   carto_pal(12, "Safe")[1],
#     # carto_pal(12, "Safe")[12],
# 
#   # carto_pal(12, "Safe")[12]
#   carto_pal(7, "Earth")[5]
# ), 
# labels =
#     c(alluv_df_by15_spread_sum_long$howderived %>% unique(),
# alluv_df_by15_spread_sum_finalname$howderived %>% unique()
# )
# ) 



    # }
outplot <- alluv_df_by15_spread_sum_long %>% 
  ggplot(
    aes(
      x = by15,
      stratum = value,
      alluvium = rowid , 
      y = freq, 
      # color = final_name,
      label = value
      # Third variable on the X-axis
    )
  ) + 
     # geom_stratum() +
      # stat_stratum(
      #   # aes(fill=final_name),
      #   decreasing = FALSE,
      #   aes.bind = "flow",
      #   alpha = .4
      #   ) +
      # stat_alluvium(geom = "text", aes(label = subject),
      #           lode.guidance = "backfront")
      

      #   aes(fill = concentration),
      #   lode_backfront()
      #   ) +
# geom_stratum(
#   alpha = .5
# ) +
  # geom_text(
  #   aes(label = value, fill = final_name), stat = "stratum"
  #   )+
# geom_flow(
#   stat = "alluvium", lode.guidance = "forward", decreasing = FALSE) +
     # stat_flow(
     #    aes(fill = final_name),
     #    # aes(label = after_stat(stratum)),
     #    decreasing = FALSE,
     #    
     #    aes.bind = "flow"
     #  ) +      # geom_alluvium(
      # stat_stratum(
      #           # aes(fill=Cluster),
      #   geom = "text",
      #   aes(label = after_stat(stratum)),
      #   decreasing = FALSE,
      #   size = textsize,
      #   aes.bind = "flow"
      #   ) +
  # stat_alluvium(
  #    stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .3
  # ) +
  # stat_alluvium(
  #  data = alluv_df_by15_spread_sum_long,
  #  aes(
  #           x = by15,
  #     stratum = value,
  #     alluvium = rowid , 
  #     y = freq, 
  #     # color = final_name,
  #     label = value,
  #     fill =  howderived 
  # 
  # 
  #  ),
  #    stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .8
  # ) + 

  #   scale_fill_carto_d(
#   name = "",
#   palette = "Safe"
#   ) + 
# scale_color_carto_d(
#   # name = "Firm",
#   
#   palette = "Safe"
#   ) + 
 # stat_alluvium(
 #   data = alluv_df_by15_spread_sum_finalname,
 #   aes(
 #      x = by15,
 #      stratum = value,
 #      alluvium = rowid ,
 #      y = freq,
 #      # fill = NA  ,
 #            fill = howderived  ,
 # 
 #      # color = final_name,
 #      label = value
 # 
 #   ),
 #     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = 0#, alpha = 0#, fill =  carto_pal(7, "Earth")[5]#  "black"
 #  ) +
 stat_alluvium(
   data = alluv_df_by15_spread_sum_finalname,
   aes(
      x = by15,
      stratum = value,
      alluvium = rowid ,
      y = freq,
      # fill = howacquired  ,
      # color = final_name,
      label = value

   ),
     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .5 , 
   # this allows a background of all 
   fill =  carto_pal(7, "Earth")[5]#  "black"
  ) +

  stat_alluvium(
   data = alluv_df_by15_spread_sum_long,
   aes(
            x = by15,
      stratum = value,
      alluvium = rowid , 
      y = freq, 
      # color = final_name,
      label = value,
      fill =  howderived2


   ),
     stat = "alluvium", lode.guidance = "forward", decreasing = FALSE, aes.bind = "flow",na.rm = TRUE, alpha = .8
  ) + 
    geom_stratum(
    # aes(
    #   # label = after_stat(value),
    #   # color =   final_name
    #
    # ),
    # width = 1/4, 
    na.rm = TRUE,
    decreasing = FALSE,
    alpha =.8,
    size = alluv_size,
    fill = NA,
    color = "black"
  ) +
#      geom_label(
#        aes(
#          # label = value
#          label =  value 
#          # label = stat(stratum)
#          # label = after_stat(stratum)
#            ),
#        fill = alpha("white", .3),
#        color = alpha("black", 0),
#        stat = "stratum",
#      # decreasing = FALSE,
#      na.rm = TRUE#,
# # size = textsize,
#        # width = 1/4,
# #        min.size = textsize,
# # reflow = TRUE,
# # grow = TRUE#, 
# # contrast = TRUE
# ) +

     ggfittext::geom_fit_text(
       aes(
         # label = value
         label =  value 
         # label = stat(stratum)
         # label = after_stat(stratum)
           ),
       # fill = alpha("white", .3),
       stat = "stratum",
     decreasing = FALSE,
     na.rm = TRUE,
# size = textsize,
       # width = 1/4,
       min.size = textsize,
reflow = TRUE,
grow = TRUE#, 
# contrast = TRUE
) +

  # scale_fill_manual(values = safe_colorblind_palette) +
  # scale_color_manual(values = safe_colorblind_palette)+
  theme_minimal()+
# scale_fill_manual(
#   name  =  "",
#   # values =  c( )
#     values = use_this_palette$colors,
#     labels=use_this_palette$labels,
#   # limits  =  use_this_palette$colors#,
#   drop = FALSE
# 
#   
# ) +
  # scale_fill_carto_d("Safe") +
#   scale_color_manual(
#   name  =  "Crop",
# 
#     values = use_this_palette#,
#     # labels=use_this_palette$labels#,
#   # drop = FALSE
# 
# 
# ) +
  scale_fill_manual(
  name  =  alluv_label_legend,

    values = use_this_palette#,
    # labels=use_this_palette$labels#,
  # drop = FALSE


) +

  # geom_text(stat = "stratum", size = 4) + 
  # theme_void() #+
  # scale_fill_brewer(type = "qual", palette = "Set3") _ 
# geom_alluvium(aes(fill = final_name),
#                 alpha = .75, decreasing = FALSE, width = 1/2) +
#   geom_stratum(aes(stratum = name_new), decreasing = FALSE, width = 1/2) + 
#  ggfittext::geom_fit_text(
#        aes(label = after_stat(name_new)),
#        stat = "stratum", 
#      decreasing = FALSE,
# # size = textsize,
#        # width = 1/4, 
#        min.size = textsize, 
# reflow = TRUE, 
# grow = FALSE
# ) +

      theme(
        # panel.background = element_rect(fill = 'black', colour = 'black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        # text = element_text(size = 14),
        plot.title = element_text(size = textout, face = "bold"),
        plot.subtitle = element_text(size = textout, face = "bold"),
        strip.text = element_text(size = textout),
        # axis.title.x.top = element_text( size = 20 ),
        axis.text.x = element_text( 
          size = textout, 
          angle = 40, 
          hjust = 1
          ),
        plot.margin = margin(l = 0 + margin_spacer( alluv_df_by15_spread_sum_long$by15), t = 80, b = 80),
        # axis.text.y = element_text( size = 20 ),
        axis.title.x=element_text( size = textout ),

        legend.text=element_text(size=textout),
        # legend.title=element_text(size=20),
        # axis.title=element_text(size=20,face="bold"),
        title = element_text(size = textout) ,
        # axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        plot.background = element_rect(color = alpha("black", .6), size = 3),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "top", 
        legend.title = element_text(size=textout),
        legend.direction = "horizontal",
         # legend.title = element_blank(),
        legend.key.size = unit(2, 'cm')
      )  + 
  scale_x_discrete(labels=function(x){gsub("; ", "\n", x)}) + 
      ggtitle(
      paste0(
        toupper(alluv_current_loop) , ": ", 
        alluv_titleinclude,  ": ", 
        alluv_title_expo, 
           # "Ownership of Acquired (A) or Origin (O) count and percent of certificates from " , 
        # alluv_title_expo =  "Ownership of Acquired (A) or Origin (O) count and percent of certificates from "
           min(yearlist), "-", max(yearlist)
           
        )  ,
            alluv_subtitle
         #  alluv_subtitle =   
         # "Origin means that the patent or PVP applicant organization is the same name as the extant parent firm name. \nAcquired means that applicant organization was acquired by a parent firm."  

 
      ) +
        xlab(
   alluv_xlabel
   # alluv_xlabel=  "5-Year Interval: Total PVP or patent count; Developed (D); or Passed on (P) during that 5-year interval, with %composition shown"
           # label= "5-Year Interval: Total PVP or patent count; Developed (D); or Passed on (P) during that 5-year interval, with %composition shown"
          
        )
#       scale_fill_manual(values = safe_colorblind_palette)+ 
  # facet_wrap(~crop, "free")
list_alluv_ggplots[[q]] <- outplot
q <- q+1
    }

heresmylistofplots = cowplot::plot_grid(
        plotlist = list_alluv_ggplots ,
        nrow = length(list_alluv_ggplots),
        ncol = 1,
        # labels = "AUTO",
        # # label_size = 12,
        align = "v"#,
        # rel_heights = c(rep(1, each = sqrt(length(use_these_facetvec))))
       
)

   
    
#  if(!exists(paste0(
#     # "/home/jaina/Documents/work/2021 ML/unsupervised/",
#     foldername)))
# {
#   dir.create(foldername)
#  }

heightdf_use <- ((length(list_alluv_ggplots)*shrink_factor))*outheight


 pdf(
    paste0(folderout,"/", savefileas, ".pdf"),
  width = outwidth,
    height = heightdf_use

    # width = 60,
    # height = 300 #,
    # units = "in", 
    # res = 300
  )
  print(
    heresmylistofplots
  #   ggplot(
  #     data = as.data.frame(x),
  #     aes(
  #       y = num_divided,
  #       axis1 = bankname, 
  #       axis2 = label, 
  #       axis3 = parentlabel
  #     )
  #   ) +
  #     geom_alluvium(
  #       aes(fill = label),
  #       # width = 0, knot.pos = 0, reverse = FALSE
  #     ) +
  #     # guides(fill = FALSE) +
  #     geom_stratum(width = 1/8, reverse = FALSE) +
  #     geom_text(stat = "stratum", aes(label = after_stat(stratum)),
  #               reverse = FALSE) +
  #     scale_x_continuous(breaks = 1:3, labels = c("Lender", "County", "Integrator")) +
  #     # coord_flip() +
  #     ggtitle("Titanic survival by class and sex")
  #   

  
    
  ) 
  
  
  
  dev.off()

    
  
  rm(crops_to_use)
rm(top_strata)
rm(textsize)
rm(textout)
rm(outwidth)
rm(outheight)
rm(folderout)
rm(savefileas)
rm(yearlist)
rm(whichcolisID)
rm(whichcolisfacet)
rm(passthru_if_take_topssend)
              # show num of top crops
              rm(top_strata_colsplitbysend)
              
              rm(alluv_df_by15)
              rm(alluv_df_by15_spread)
              rm(alluv_df_by15_spread_sum)
              rm(alluv_df_by15_spread_sum_finalname)
              rm(alluv_df_by15_spread_sum_long)
              rm(alluv_df_by15_spread2)
              rm(alluv_df_by15_topcos_color)
              rm(alluv_df)
              rm(howderivedlu)
              rm(large_palette)
              rm(outplot)
              rm(order_by_cropLU)
              rm(top_strata_colsplitbysend)
              rm(use_this_palette)
              

}
```

### set up a cowplot for alluv func
```{r }
graphalluv_cowplot_loop <- function( alluv_cowplot_gg){
  
  
}

```

### use func alluv 
#### basic p and pvp; acq or dev
##### all crops
```{r }
soycropquery_merger %>% 
graphalluvial(alluv_df = ., stratacol ,crops_to_use = c("soybean", "corn", "cotton", "wheat", "forage"), top_strata = 12, textsize = 6, textout = 45, outwidth =60, outheight=35,folderout = "X:/msi/work/farmer welfare/seed/R analysis/images/merger" ,savefileas = "230203_allcrops_top", yearlist = c(1980:2022), whichcolisID = .$patent_number, whichcolisfacet= .$crop_type, passthru_if_take_topssend = 5,
              # show num of top crops
              top_strata_colsplitbysend = 6, 
              order_by_cropLU = soycropquery_merger %>% 
                group_by(crop_type) %>% 
                summarise(
                  numpatent = length(unique(patent_number))
                ) %>% 
                ungroup()
              
              )

```
